name: 'Hardened npm Install'
description: 'ç»Ÿä¸€çš„npmå®‰è£…åŠ å›ºæ“ä½œï¼Œè§£å†³ç³»ç»Ÿæ€§å®‰è£…å¤±è´¥é—®é¢˜'
author: 'CI/CD Team'

inputs:
  working-directory:
    description: 'å·¥ä½œç›®å½•'
    required: false
    default: '.'
  node-version:
    description: 'Node.jsç‰ˆæœ¬'
    required: false
    default: '20.x'

# ç§»é™¤outputsé…ç½®é¿å…å¼•ç”¨ä¸å­˜åœ¨çš„æ­¥éª¤ID
# å¦‚éœ€è¦ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¯é€šè¿‡npm --versionå’Œnode --versionè·å–

runs:
  using: 'composite'
  steps:
    - name: ğŸ’» è®¾ç½®Node.js (ESMæ”¯æŒ)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'
    - name: ğŸ” ç¯å¢ƒå˜é‡éªŒè¯
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” éªŒè¯å…³é”®ç¯å¢ƒå˜é‡..."
        echo "NODE_ENV: ${NODE_ENV:-æœªè®¾ç½®}"
        echo "NPM_CONFIG_PRODUCTION: ${NPM_CONFIG_PRODUCTION:-æœªè®¾ç½®}"

        # éªŒè¯devDependencieså®‰è£…ç¯å¢ƒé…ç½®
        if [ "${NODE_ENV}" != "development" ] || [ "${NPM_CONFIG_PRODUCTION}" != "false" ]; then
          echo "âš ï¸ è­¦å‘Šï¼šç¯å¢ƒå˜é‡å¯èƒ½å¯¼è‡´devDependenciesæœªå®‰è£…"
          echo "  å»ºè®®è®¾ç½®ï¼šNODE_ENV=development, NPM_CONFIG_PRODUCTION=false"
        fi

    - name: ğŸ”§ npmå®‰è£…åŠ å›ºç‰ˆ (P2æœ€ç»ˆç‰ˆ)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”§ å¼€å§‹npmå®‰è£…..."
        echo "ğŸ“‹ ä½¿ç”¨é¡¹ç›®çº§.npmrcé…ç½®ï¼ˆç½‘ç»œé‡è¯•ã€ç¼“å­˜ç­‰ï¼‰"

        # æ˜¾ç¤ºå½“å‰npmé…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo "ğŸ“Š å½“å‰npmé…ç½®ï¼š"
        npm config list | grep -E "(fetch-retries|registry|fund|audit)" || true

        # ESMé¡¹ç›®ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿52ä¸ªdevDependenciesæ­£ç¡®å®‰è£…
        echo "ğŸ“¦ æ£€æµ‹åˆ°ESMé¡¹ç›®ï¼Œå®‰è£…å¤§å‹ä¾èµ–åŒ…é›†..."

        # è®¾ç½®ESMå‹å¥½çš„npmç¯å¢ƒå˜é‡
        export NPM_CONFIG_MAXSOCKETS="8"
        export NPM_CONFIG_FUND="false"
        export NPM_CONFIG_AUDIT="false"
        export NPM_CONFIG_PROGRESS="false"

        install_success=false

        # å¢å¼ºå®‰è£…é€»è¾‘ï¼š4æ¬¡é‡è¯• + æ¸è¿›å¼ç­–ç•¥
        for i in 1 2 3 4; do 
          echo "ğŸš€ ç¬¬ $i æ¬¡å®‰è£…ä¾èµ–å°è¯• (ESM + 52 devDeps)..."
          
          if [ $i -eq 1 ]; then
            # é¦–æ¬¡å°è¯•ï¼šæ ‡å‡†å®‰è£…ï¼Œ8åˆ†é’Ÿè¶…æ—¶
            if timeout 480 npm ci --no-optional 2>&1 | tee npm_install.log; then
              install_success=true
            fi
          elif [ $i -eq 2 ]; then
            # ç¬¬äºŒæ¬¡ï¼šå¢åŠ è¶…æ—¶æ—¶é—´å’Œç½‘ç»œä¼˜åŒ–
            echo "â±ï¸ å¢åŠ è¶…æ—¶æ—¶é—´å¤„ç†å¤§å‹ä¾èµ–åŒ…..."
            if timeout 720 npm ci --maxsockets=5 --no-optional 2>&1 | tee npm_install.log; then
              install_success=true
            fi
          elif [ $i -eq 3 ]; then
            # ç¬¬ä¸‰æ¬¡ï¼šä¸²è¡Œå®‰è£…æ¨¡å¼
            echo "ğŸ”„ ä¸²è¡Œå®‰è£…æ¨¡å¼ï¼ˆé˜²æ­¢ç½‘ç»œæ‹¥å¡ï¼‰..."
            if timeout 900 npm ci --maxsockets=1 --no-optional 2>&1 | tee npm_install.log; then
              install_success=true
            fi
          else
            # æœ€åä¸€æ¬¡ï¼šå®Œå…¨é‡æ–°å®‰è£…
            echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œæ–‡ä»¶ï¼Œé‡æ–°å®‰è£…..."
            rm -rf node_modules package-lock.json
            npm cache clean --force 2>/dev/null || true
            if timeout 900 npm install --no-optional 2>&1 | tee npm_install.log; then
              install_success=true
            fi
          fi
          
          if [ "$install_success" = true ]; then
            echo "âœ… ç¬¬ $i æ¬¡å°è¯•æˆåŠŸ"
            
            # ESMé¡¹ç›®å¢å¼ºéªŒè¯
            verification_errors=0
            
            # éªŒè¯å…³é”®devDependencieså·¥å…·
            dev_tools=("eslint" "tsc" "vitest" "playwright")
            for tool in "${dev_tools[@]}"; do
              if command -v "$tool" > /dev/null 2>&1; then
                echo "âœ… $tool (å¼€å‘ä¾èµ–) å¯ç”¨"
              else
                echo "âš ï¸ $tool ä¸å¯ç”¨"
                ((verification_errors++))
              fi
            done
            
            # éªŒè¯node_modulesç»“æ„
            if [ -d "node_modules" ] && [ -d "node_modules/.bin" ]; then
              node_count=$(find node_modules -maxdepth 1 -type d | wc -l 2>/dev/null || echo "0")
              node_modules_size=$(du -sh node_modules 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
              echo "âœ… node_modules éªŒè¯é€šè¿‡ ($node_count åŒ…, å¤§å°: $node_modules_size)"
            else
              echo "âŒ node_modules ç›®å½•éªŒè¯å¤±è´¥"
              ((verification_errors++))
            fi
            
            # éªŒè¯package.jsonä¸­type: module
            if grep -q '"type".*:.*"module"' package.json 2>/dev/null; then
              echo "âœ… ESMæ¨¡å—ç³»ç»ŸéªŒè¯é€šè¿‡"
            fi
            
            if [ $verification_errors -eq 0 ]; then
              echo "ğŸ‰ ESMé¡¹ç›®å®‰è£…å’ŒéªŒè¯å®Œå…¨æˆåŠŸï¼"
            else
              echo "âš ï¸ å‘ç° $verification_errors ä¸ªéªŒè¯é—®é¢˜ï¼Œä½†å®‰è£…æˆåŠŸ"
            fi
            
            exit 0
          fi
          
          # å¤±è´¥å¤„ç†
          if [ $i -lt 4 ]; then
            wait_time=$((i * 15))
            echo "âŒ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œç­‰å¾… ${wait_time} ç§’åé‡è¯•..."
            
            # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—ç‰‡æ®µ
            if [ -f npm_install.log ]; then
              echo "ğŸ” é”™è¯¯æ—¥å¿—ç‰‡æ®µ:"
              tail -10 npm_install.log || true
            fi
            
            sleep $wait_time
          fi
        done

        # æ‰€æœ‰å°è¯•éƒ½å¤±è´¥
        echo "ğŸš¨ æ‰€æœ‰ 4 æ¬¡ESMå®‰è£…å°è¯•å‡å¤±è´¥ï¼"
        if [ -f npm_install.log ]; then
          echo "ğŸ“„ å®Œæ•´é”™è¯¯æ—¥å¿—:"
          cat npm_install.log
        fi
        exit 1
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

branding:
  icon: 'download'
  color: 'green'

name: 'Hardened npm Install'
description: 'ç»Ÿä¸€çš„npmå®‰è£…åŠ å›ºæ“ä½œï¼Œè§£å†³ç³»ç»Ÿæ€§å®‰è£…å¤±è´¥é—®é¢˜'
author: 'CI/CD Team'

inputs:
  working-directory:
    description: 'å·¥ä½œç›®å½•'
    required: false
    default: '.'

outputs:
  npm-version:
    description: 'å®‰è£…çš„npmç‰ˆæœ¬'
    value: ${{ steps.env-check.outputs.npm-version }}
  node-version:
    description: 'å®‰è£…çš„Node.jsç‰ˆæœ¬'
    value: ${{ steps.env-check.outputs.node-version }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ” Nodeç¯å¢ƒå“¨å…µæ£€æŸ¥
      id: env-check
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” æ‰§è¡ŒNode.jsç¯å¢ƒå“¨å…µæ£€æŸ¥..."
        echo "å½“å‰npmç‰ˆæœ¬: $(npm --version)"
        echo "å½“å‰nodeç‰ˆæœ¬: $(node --version)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "npmç¼“å­˜ç›®å½•: $(npm config get cache)"

        # è¯­æ³•å“¨å…µæ£€æŸ¥
        if [ -f "scripts/ci/coverage-config.cjs" ]; then
          node --check scripts/ci/coverage-config.cjs
          node -e "require('./scripts/ci/coverage-config.cjs'); console.log('âœ… coverage-config.cjs è¯­æ³•æ­£ç¡®')"
        fi

        # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ç»™åç»­æ­¥éª¤
        echo "npm-version=$(npm --version)" >> $GITHUB_OUTPUT
        echo "node-version=$(node --version)" >> $GITHUB_OUTPUT

    - name: âš™ï¸ npmç½‘ç»œé…ç½®åŠ å›º
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        npm config set fetch-retries 5
        npm config set fetch-retry-factor 2
        npm config set fetch-timeout 300000
        npm config set fetch-retry-mintimeout 1000
        npm config set registry https://registry.npmjs.org/
        echo "âœ… npmç½‘ç»œé…ç½®å·²ä¼˜åŒ–"

    - name: ğŸ”§ å®‰è£…ä¾èµ–ï¼ˆåŠ å›ºç‰ˆï¼‰
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        NODE_ENV: development
        NPM_CONFIG_PRODUCTION: 'false'
      run: |
        echo "ğŸ”§ å¼€å§‹åŠ å›ºç‰ˆnpmå®‰è£…..."
        for i in 1 2 3; do 
          echo "ç¬¬ $i æ¬¡å®‰è£…ä¾èµ–å°è¯•..."
          if npm ci --no-audit --no-fund; then
            echo "âœ… ç¬¬ $i æ¬¡å°è¯•æˆåŠŸ"
            break
          else
            echo "âŒ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥"
            if [ $i -lt 3 ]; then
              echo "ç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
            else
              echo "ğŸš¨ æ‰€æœ‰é‡è¯•å¤±è´¥ï¼Œè¿›å…¥é™çº§å¤„ç†..."
              echo "æ¸…ç†npmç¼“å­˜..."
              npm cache clean --force
              rm -rf ~/.npm/_cacache
              echo "æœ€åä¸€æ¬¡å°è¯•..."
              npm ci --no-audit --no-fund
            fi
          fi
        done
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”§ éªŒè¯ä¾èµ–æ ‘å®Œæ•´æ€§
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” éªŒè¯å…³é”®å¼€å‘å·¥å…·å¯ç”¨æ€§..."

        # éªŒè¯node_modulesç›®å½•å­˜åœ¨
        if [ ! -d "node_modules" ]; then
          echo "âŒ node_modulesç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

        # éªŒè¯ESLintå¯ç”¨æ€§
        if command -v npx >/dev/null 2>&1; then
          if npx eslint -v >/dev/null 2>&1; then
            echo "âœ… ESLintå¯ç”¨: $(npx eslint -v)"
          else
            echo "âŒ ESLintä¸å¯ç”¨"
            echo "ğŸ“Š devDependenciesçŠ¶æ€:"
            npm ls eslint --depth=0 || echo "ESLintæœªæ­£ç¡®å®‰è£…"
            exit 1
          fi
        else
          echo "âš ï¸ npxä¸å¯ç”¨ï¼Œè·³è¿‡å·¥å…·éªŒè¯"
        fi

        # éªŒè¯TypeScriptå¯ç”¨æ€§ï¼ˆå¦‚æœé¡¹ç›®ä½¿ç”¨ï¼‰
        if npm ls typescript --depth=0 >/dev/null 2>&1; then
          if npx tsc -v >/dev/null 2>&1; then
            echo "âœ… TypeScriptå¯ç”¨: $(npx tsc -v)"
          else
            echo "âŒ TypeScriptä¸å¯ç”¨"
            npm ls typescript --depth=0 || echo "TypeScriptæœªæ­£ç¡®å®‰è£…"
            exit 1
          fi
        else
          echo "â„¹ï¸ é¡¹ç›®æœªä½¿ç”¨TypeScript"
        fi

        echo "âœ… æ‰€æœ‰ä¾èµ–éªŒè¯é€šè¿‡"

branding:
  icon: 'download'
  color: 'green'

name: 'Hardened npm Install'
description: 'ç»Ÿä¸€çš„npmå®‰è£…åŠ å›ºæ“ä½œï¼Œè§£å†³ç³»ç»Ÿæ€§å®‰è£…å¤±è´¥é—®é¢˜'
author: 'CI/CD Team'

inputs:
  working-directory:
    description: 'å·¥ä½œç›®å½•'
    required: false
    default: '.'

outputs:
  npm-version:
    description: 'å®‰è£…çš„npmç‰ˆæœ¬'
    value: ${{ steps.env-check.outputs.npm-version }}
  node-version:
    description: 'å®‰è£…çš„Node.jsç‰ˆæœ¬'
    value: ${{ steps.env-check.outputs.node-version }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ”§ npmå®‰è£…åŠ å›ºç‰ˆ (P1ç®€åŒ–ç‰ˆ)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”§ å¼€å§‹åŠ å›ºç‰ˆnpmå®‰è£…..."

        # ç®€åŒ–ç‰ˆç½‘ç»œé…ç½®ï¼ˆåŸºäº2024æœ€ä½³å®è·µï¼‰
        npm config set fetch-retries 5
        npm config set fetch-retry-factor 2
        npm config set fetch-timeout 300000
        npm config set registry https://registry.npmjs.org/

        # æ ¸å¿ƒå®‰è£…é€»è¾‘ï¼š3æ¬¡é‡è¯• + ç¼“å­˜æ¸…ç†
        for i in 1 2 3; do 
          echo "ç¬¬ $i æ¬¡å®‰è£…ä¾èµ–å°è¯•..."
          if npm ci --no-audit --no-fund; then
            echo "âœ… ç¬¬ $i æ¬¡å°è¯•æˆåŠŸ"
            # åŸºæœ¬éªŒè¯ï¼šnode_moduleså­˜åœ¨
            if [ -d "node_modules" ]; then
              echo "âœ… node_modules ç›®å½•éªŒè¯é€šè¿‡"
              exit 0
            fi
          fi
          # å¤±è´¥å¤„ç†
          if [ $i -lt 3 ]; then
            echo "âŒ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œ10ç§’åé‡è¯•..."
            sleep 10
          else
            echo "ğŸš¨ æ‰€æœ‰é‡è¯•å¤±è´¥ï¼Œæ¸…ç†ç¼“å­˜åæœ€åä¸€æ¬¡å°è¯•..."
            npm cache clean --force
            npm ci --no-audit --no-fund
          fi
        done
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

branding:
  icon: 'download'
  color: 'green'

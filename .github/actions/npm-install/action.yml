name: 'Hardened npm Install'
description: 'ç»Ÿä¸€çš„npmå®‰è£…åŠ å›ºæ“ä½œï¼Œè§£å†³ç³»ç»Ÿæ€§å®‰è£…å¤±è´¥é—®é¢˜'
author: 'CI/CD Team'

inputs:
  working-directory:
    description: 'å·¥ä½œç›®å½•'
    required: false
    default: '.'

# ç§»é™¤outputsé…ç½®é¿å…å¼•ç”¨ä¸å­˜åœ¨çš„æ­¥éª¤ID
# å¦‚éœ€è¦ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¯é€šè¿‡npm --versionå’Œnode --versionè·å–

runs:
  using: 'composite'
  steps:
    - name: ğŸ” ç¯å¢ƒå˜é‡éªŒè¯
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” éªŒè¯å…³é”®ç¯å¢ƒå˜é‡..."
        echo "NODE_ENV: ${NODE_ENV:-æœªè®¾ç½®}"
        echo "NPM_CONFIG_PRODUCTION: ${NPM_CONFIG_PRODUCTION:-æœªè®¾ç½®}"

        # éªŒè¯devDependencieså®‰è£…ç¯å¢ƒé…ç½®
        if [ "${NODE_ENV}" != "development" ] || [ "${NPM_CONFIG_PRODUCTION}" != "false" ]; then
          echo "âš ï¸ è­¦å‘Šï¼šç¯å¢ƒå˜é‡å¯èƒ½å¯¼è‡´devDependenciesæœªå®‰è£…"
          echo "  å»ºè®®è®¾ç½®ï¼šNODE_ENV=development, NPM_CONFIG_PRODUCTION=false"
        fi

    - name: ğŸ”§ npmå®‰è£…åŠ å›ºç‰ˆ (P2æœ€ç»ˆç‰ˆ)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”§ å¼€å§‹npmå®‰è£…..."
        echo "ğŸ“‹ ä½¿ç”¨é¡¹ç›®çº§.npmrcé…ç½®ï¼ˆç½‘ç»œé‡è¯•ã€ç¼“å­˜ç­‰ï¼‰"

        # æ˜¾ç¤ºå½“å‰npmé…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo "ğŸ“Š å½“å‰npmé…ç½®ï¼š"
        npm config list | grep -E "(fetch-retries|registry|fund|audit)" || true

        # æ ¸å¿ƒå®‰è£…é€»è¾‘ï¼š3æ¬¡é‡è¯• + ç¼“å­˜æ¸…ç†
        for i in 1 2 3; do 
          echo "ç¬¬ $i æ¬¡å®‰è£…ä¾èµ–å°è¯•..."
          if npm ci; then
            echo "âœ… ç¬¬ $i æ¬¡å°è¯•æˆåŠŸ"
            # éªŒè¯å…³é”®å·¥å…·å¯ç”¨æ€§ï¼ˆdevDependenciesï¼‰
            if command -v eslint > /dev/null 2>&1; then
              echo "âœ… ESLint å·¥å…·éªŒè¯é€šè¿‡"
            else
              echo "âš ï¸ ESLint å·¥å…·ä¸å¯ç”¨ï¼Œå¯èƒ½devDependenciesæœªå®‰è£…"
            fi
            if [ -d "node_modules" ]; then
              echo "âœ… node_modules ç›®å½•éªŒè¯é€šè¿‡"
              exit 0
            fi
          fi
          # å¤±è´¥å¤„ç†
          if [ $i -lt 3 ]; then
            echo "âŒ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œ10ç§’åé‡è¯•..."
            sleep 10
          else
            echo "ğŸš¨ æ‰€æœ‰é‡è¯•å¤±è´¥ï¼Œæ¸…ç†ç¼“å­˜åæœ€åä¸€æ¬¡å°è¯•..."
            npm cache clean --force
            npm ci
          fi
        done
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

branding:
  icon: 'download'
  color: 'green'

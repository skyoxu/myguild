# æµ‹è¯•æ‰§è¡Œç»Ÿä¸€Action
# å‡å°‘æµ‹è¯•å‘½ä»¤åœ¨å¤šä¸ªworkflowä¸­çš„é‡å¤ï¼Œæä¾›ç»Ÿä¸€çš„æµ‹è¯•æ‰§è¡Œå’ŒæŠ¥å‘Š

name: 'Run Tests'
description: 'ç»Ÿä¸€æ‰§è¡Œé¡¹ç›®æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ã€E2Eæµ‹è¯•ã€å®‰å…¨æµ‹è¯•ç­‰ï¼‰'

inputs:
  test-type:
    description: 'æµ‹è¯•ç±»å‹'
    required: true
    type: choice
    default: 'unit'
    options:
      - unit
      - e2e
      - security
      - coverage
      - smoke
      - observability
  timeout:
    description: 'æµ‹è¯•è¶…æ—¶æ—¶é—´(ms)'
    required: false
    default: '300000' # 5åˆ†é’Ÿ
  fail-fast:
    description: 'æµ‹è¯•å¤±è´¥æ—¶æ˜¯å¦ç«‹å³å¤±è´¥'
    required: false
    default: 'true'
  reporter:
    description: 'æµ‹è¯•æŠ¥å‘Šæ ¼å¼'
    required: false
    default: 'default'
  output-file:
    description: 'æµ‹è¯•ç»“æœè¾“å‡ºæ–‡ä»¶'
    required: false

outputs:
  test-result:
    description: 'æµ‹è¯•æ‰§è¡Œç»“æœ'
    value: ${{ steps.test.outputs.result }}
  test-report:
    description: 'æµ‹è¯•æŠ¥å‘Šè·¯å¾„'
    value: ${{ steps.test.outputs.report_path }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ§ª æ‰§è¡Œæµ‹è¯•
      id: test
      shell: bash
      run: |
        set -e

        TEST_TYPE="${{ inputs.test-type }}"
        TIMEOUT="${{ inputs.timeout }}"
        FAIL_FAST="${{ inputs.fail-fast }}"
        REPORTER="${{ inputs.reporter }}"
        OUTPUT_FILE="${{ inputs.output-file }}"

        echo "ğŸ§ª å¼€å§‹æ‰§è¡Œ${TEST_TYPE}æµ‹è¯•..."
        echo "â±ï¸ è¶…æ—¶è®¾ç½®: ${TIMEOUT}ms"
        echo "ğŸš¨ å¿«é€Ÿå¤±è´¥: ${FAIL_FAST}"

        # æ„å»ºæµ‹è¯•å‘½ä»¤
        case "$TEST_TYPE" in
          "unit")
            TEST_CMD="npm run test:unit"
            if [ "$REPORTER" != "default" ]; then
              TEST_CMD="$TEST_CMD -- --reporter=$REPORTER"
            fi
            if [ "$FAIL_FAST" == "false" ]; then
              TEST_CMD="$TEST_CMD --passWithNoTests"
            fi
            ;;
          "coverage")
            TEST_CMD="npm run test:coverage"
            ;;
          "e2e")
            TEST_CMD="npm run test:e2e"
            if [ "$TIMEOUT" != "300000" ]; then
              TEST_CMD="$TEST_CMD --timeout=$TIMEOUT"
            fi
            ;;
          "security")
            TEST_CMD="npm run test:e2e:security"
            ;;
          "smoke")
            TEST_CMD="npm run test:e2e:smoke"
            if [ "$TIMEOUT" != "300000" ]; then
              TEST_CMD="$TEST_CMD --timeout=$TIMEOUT"
            fi
            ;;
          "observability")
            TEST_CMD="npm run test:observability"
            ;;
          *)
            echo "âŒ æœªçŸ¥çš„æµ‹è¯•ç±»å‹: $TEST_TYPE"
            exit 1
            ;;
        esac

        # æ‰§è¡Œæµ‹è¯•
        if [ "$FAIL_FAST" == "false" ]; then
          # å®¹é”™æ¨¡å¼ï¼šæµ‹è¯•å¤±è´¥ä¸é˜»å¡æµç¨‹
          if $TEST_CMD; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… ${TEST_TYPE}æµ‹è¯•é€šè¿‡"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âš ï¸ ${TEST_TYPE}æµ‹è¯•å¤±è´¥ï¼Œä½†ä¸é˜»å¡æµç¨‹"
          fi
        else
          # ä¸¥æ ¼æ¨¡å¼ï¼šæµ‹è¯•å¤±è´¥æ—¶åœæ­¢
          $TEST_CMD
          echo "result=success" >> $GITHUB_OUTPUT
          echo "âœ… ${TEST_TYPE}æµ‹è¯•é€šè¿‡"
        fi

        # è¾“å‡ºæŠ¥å‘Šæ–‡ä»¶è·¯å¾„
        if [ -n "$OUTPUT_FILE" ] && [ -f "$OUTPUT_FILE" ]; then
          echo "report_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
        elif [ -d "test-results/" ]; then
          echo "report_path=test-results/" >> $GITHUB_OUTPUT
        elif [ -d "coverage/" ]; then
          echo "report_path=coverage/" >> $GITHUB_OUTPUT
        else
          echo "report_path=" >> $GITHUB_OUTPUT
        fi

        echo "ğŸ¯ ${TEST_TYPE}æµ‹è¯•æ‰§è¡Œå®Œæˆ"

    - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æ€»ç»“
      shell: bash
      run: |
        if [ "${{ steps.test.outputs.result }}" == "success" ]; then
          echo "âœ… æµ‹è¯•çŠ¶æ€: é€šè¿‡"
        else
          echo "âš ï¸ æµ‹è¯•çŠ¶æ€: å¤±è´¥"
        fi

        if [ -n "${{ steps.test.outputs.report_path }}" ]; then
          echo "ğŸ“„ æŠ¥å‘Šè·¯å¾„: ${{ steps.test.outputs.report_path }}"
        fi

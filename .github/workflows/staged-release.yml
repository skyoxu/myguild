name: ğŸ“Š Staged Release with Health Gates

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: write
  actions: write
  packages: write

defaults:
  run:
    shell: pwsh

# æ¸è¿›å‘å¸ƒå·¥ä½œæµï¼š5%/25%/50%/100% é˜¶æ¢¯å‘å¸ƒ + Sentryå¥åº·é—¨ç¦
# åŸºäºå®Œæ•´ADRä½“ç³»ï¼š
# - ADR-0001 (æŠ€æœ¯æ ˆé€‰å‹): Electron + Reactç”Ÿæ€
# - ADR-0002 (Electronå®‰å…¨): å®‰å…¨åŸºçº¿ä¸CSPç­–ç•¥
# - ADR-0003 (å¯è§‚æµ‹æ€§): Sentryå¥åº·é—¨ç¦é›†æˆ
# - ADR-0004 (äº‹ä»¶æ€»çº¿): CloudEventså¥‘çº¦éªŒè¯
# - ADR-0005 (è´¨é‡é—¨ç¦): CI/CDæµæ°´çº¿è´¨é‡æ£€æŸ¥
# - ADR-0006 (æ•°æ®å­˜å‚¨): SQLiteæœ¬åœ°å­˜å‚¨ç­–ç•¥
# - ADR-0007 (ç«¯å£é€‚é…å™¨): æ¶æ„è¾¹ç•Œä¸æ¥å£è®¾è®¡
# - ADR-0008 (éƒ¨ç½²å‘å¸ƒ): æ¸è¿›å‘å¸ƒç­–ç•¥ä¸å›æ»šæœºåˆ¶
# - ADR-0009 (è·¨å¹³å°): Windows/macOS/Linuxæ”¯æŒ
# - ADR-0010 (å›½é™…åŒ–): i18næ¡†æ¶ä¸æœ¬åœ°åŒ–

on:
  workflow_dispatch:
    inputs:
      staging_percentage:
        description: 'å‘å¸ƒç™¾åˆ†æ¯” (5, 25, 50, 100)'
        required: true
        default: '5'
        type: choice
        options:
          - '5'
          - '25'
          - '50'
          - '100'
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·'
        required: true
        type: string
      skip_health_check:
        description: 'è·³è¿‡å¥åº·æ£€æŸ¥ (ä»…ç´§æ€¥æƒ…å†µ)'
        required: false
        default: false
        type: boolean

env:
  # Sentry é…ç½®
  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

  # å‘å¸ƒé…ç½®
  APP_VERSION: ${{ inputs.version }}
  STAGING_PERCENTAGE: ${{ inputs.staging_percentage }}
  FEED_FILE: 'dist/latest.yml'

# ==================== å¹¶å‘æ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # åˆ†é˜¶æ®µå‘å¸ƒä¸å¯ä¸­æ–­

jobs:
  # 1. é¢„æ£€æŸ¥ï¼šéªŒè¯é…ç½®å’Œä¾èµ–
  pre_check:
    name: ğŸ” Pre-flight Check
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    outputs:
      can_proceed: ${{ steps.validation.outputs.can_proceed }}
      previous_stage: ${{ steps.current_status.outputs.percentage }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Check current release status
        id: current_status
        shell: bash
        run: |
          if [ -f "${{ env.FEED_FILE }}" ]; then
            CURRENT_PCT="$(node scripts/release/patch-staging-percentage.mjs status "${{ env.FEED_FILE }}" | grep -o 'percentage: [0-9]*' | cut -d' ' -f2 || echo "0")"
            echo "percentage=${CURRENT_PCT}" >> "$GITHUB_OUTPUT"
            echo "ğŸ“Š å½“å‰å‘å¸ƒç™¾åˆ†æ¯”: ${CURRENT_PCT}%"
          else
            echo "percentage=0" >> "$GITHUB_OUTPUT"
            echo "ğŸ“¦ é¦–æ¬¡å‘å¸ƒï¼Œä»0%å¼€å§‹"
          fi

      - name: Validate staging progression
        id: validation
        shell: bash
        run: |
          CURRENT_PCT="${{ steps.current_status.outputs.percentage }}"
          TARGET_PCT="${{ env.STAGING_PERCENTAGE }}"

          echo "ğŸ” éªŒè¯å‘å¸ƒé˜¶æ®µè¿›å±•:"
          echo "   å½“å‰: ${CURRENT_PCT}%"
          echo "   ç›®æ ‡: ${TARGET_PCT}%"

          # éªŒè¯å‘å¸ƒæ˜¯é€’å¢çš„ï¼ˆå…è®¸å›æ»šåˆ°0%ï¼‰
          if [ "$TARGET_PCT" = "0" ]; then
            echo "ğŸ›‘ ç´§æ€¥å›æ»šåˆ°0%ï¼Œå…è®¸æ‰§è¡Œ"
            echo "can_proceed=true" >> "$GITHUB_OUTPUT"
          elif [ "$TARGET_PCT" -gt "$CURRENT_PCT" ]; then
            echo "âœ… æ­£å¸¸çš„é˜¶æ®µæ€§é€’å¢ï¼Œå…è®¸æ‰§è¡Œ"
            echo "can_proceed=true" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ å°è¯•é™ä½å‘å¸ƒç™¾åˆ†æ¯” (éç´§æ€¥)ï¼Œéœ€è¦ç¡®è®¤"
            echo "can_proceed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate Sentry configuration
        if: ${{ !inputs.skip_health_check }}
        shell: bash
        run: |
          if [ -z "${{ env.SENTRY_AUTH_TOKEN }}" ] || [ -z "${{ env.SENTRY_ORG }}" ] || [ -z "${{ env.SENTRY_PROJECT }}" ]; then
            echo "âŒ Sentryé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•è¿›è¡Œå¥åº·æ£€æŸ¥"
            exit 1
          fi
          echo "âœ… Sentryé…ç½®éªŒè¯é€šè¿‡"

  # 2. å¥åº·åº¦æ£€æŸ¥ï¼šæ£€æŸ¥å½“å‰ç‰ˆæœ¬çš„Sentry HealthæŒ‡æ ‡
  health_check:
    name: ğŸ¥ Health Check
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: pre_check
    if: ${{ needs.pre_check.outputs.can_proceed == 'true' && !inputs.skip_health_check && inputs.staging_percentage != '5' }}
    outputs:
      health_passed: ${{ steps.health_gate.outputs.passed }}
      health_data: ${{ steps.health_gate.outputs.data }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        uses: ./.github/actions/npm-install

      - name: Wait for health data (non-pilot releases)
        if: ${{ inputs.staging_percentage != '5' }}
        shell: bash
        run: |
          case "${{ env.STAGING_PERCENTAGE }}" in
            "25")
              echo "â³ 25%å‘å¸ƒï¼šç­‰å¾…2å°æ—¶æ”¶é›†å¥åº·æ•°æ®..."
              WAIT_TIME=2 ;;
            "50")
              echo "â³ 50%å‘å¸ƒï¼šç­‰å¾…4å°æ—¶æ”¶é›†å¥åº·æ•°æ®..."
              WAIT_TIME=4 ;;
            "100")
              echo "â³ 100%å‘å¸ƒï¼šç­‰å¾…8å°æ—¶æ”¶é›†å¥åº·æ•°æ®..."
              WAIT_TIME=8 ;;
            *)
              WAIT_TIME=1 ;;
          esac

          echo "å¥åº·æ£€æŸ¥ç­‰å¾…æ—¶é—´: ${WAIT_TIME}å°æ—¶"
          # åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦ç­‰å¾…æˆ–æ£€æŸ¥æ—¶é—´æˆ³

      - name: Check Sentry Release Health
        id: health_gate
        shell: bash
        run: |
          echo "ğŸ¥ æ£€æŸ¥ç‰ˆæœ¬ ${{ env.APP_VERSION }} çš„å¥åº·åº¦..."

          # ä½¿ç”¨ç°æœ‰çš„auto-rollbackè„šæœ¬è¿›è¡Œå¥åº·æ£€æŸ¥
          set +e
          HEALTH_RESULT="$(node scripts/release/auto-rollback.mjs 2>&1)"
          HEALTH_EXIT_CODE=$?
          set -e

          echo "å¥åº·æ£€æŸ¥ç»“æœï¼š"
          echo "$HEALTH_RESULT"

          if [ "$HEALTH_EXIT_CODE" -eq 0 ]; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            echo "passed=true" >> "$GITHUB_OUTPUT"
          elif [ "$HEALTH_EXIT_CODE" -eq 42 ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ - å»ºè®®å›æ»š"
            echo "passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "âš ï¸ å¥åº·æ£€æŸ¥è¿‡ç¨‹å‡ºé”™"
            echo "passed=unknown" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # æå–å¥åº·æ•°æ®ç”¨äºåç»­æ­¥éª¤
          echo "data=$HEALTH_RESULT" >> "$GITHUB_OUTPUT"

  # 3. å‘å¸ƒéƒ¨ç½²ï¼šæ›´æ–°latest.ymlå¹¶éƒ¨ç½²
  deploy_release:
    name: ğŸš€ Deploy Release
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [pre_check, health_check]
    if: ${{ always() && needs.pre_check.outputs.can_proceed == 'true' && (needs.health_check.result == 'success' || needs.health_check.result == 'skipped' || inputs.skip_health_check) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        uses: ./.github/actions/npm-install

      - name: Ensure dist directory exists
        shell: pwsh
        run: |
          # P0ä¿®å¤ï¼šWindows runnerä½¿ç”¨PowerShellç›®å½•åˆ›å»ºæ›¿ä»£Linux mkdir -p
          New-Item -ItemType Directory -Path "dist" -Force

      - name: Update staging percentage
        id: update_feed
        shell: bash
        run: |
          echo "ğŸ“ æ›´æ–°å‘å¸ƒé…ç½®åˆ° ${{ env.STAGING_PERCENTAGE }}%..."

          # ä½¿ç”¨å‘å¸ƒç®¡ç†è„šæœ¬æ›´æ–°latest.yml
          UPDATE_RESULT="$(node scripts/release/patch-staging-percentage.mjs update "${{ env.FEED_FILE }}" "${{ env.STAGING_PERCENTAGE }}")"

          echo "æ›´æ–°ç»“æœ:"
          echo "$UPDATE_RESULT"

          # éªŒè¯æ›´æ–°ç»“æœ
          if echo "$UPDATE_RESULT" | grep -q '"success":true'; then
            echo "âœ… å‘å¸ƒé…ç½®æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ å‘å¸ƒé…ç½®æ›´æ–°å¤±è´¥"
            exit 1
          fi

      - name: Verify feed file
        run: |
          echo "ğŸ“‹ éªŒè¯å‘å¸ƒé…ç½®æ–‡ä»¶:"
          node scripts/release/patch-staging-percentage.mjs validate "${{ env.FEED_FILE }}"

          echo "ğŸ“Š å½“å‰å‘å¸ƒçŠ¶æ€:"
          node scripts/release/patch-staging-percentage.mjs status "${{ env.FEED_FILE }}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-config-${{ env.STAGING_PERCENTAGE }}pct
          path: |
            ${{ env.FEED_FILE }}
            ${{ env.FEED_FILE }}.backup-*

      - name: Create GitHub release (for 100% releases)
        if: ${{ env.STAGING_PERCENTAGE == '100' }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.APP_VERSION }}
          release_name: 'Release v${{ env.APP_VERSION }} - 100% Rollout'
          body: |
            ğŸš€ **å®Œæ•´å‘å¸ƒ v${{ env.APP_VERSION }}**

            ğŸ“Š **å‘å¸ƒè¿›å±•**:
            - âœ… 5% Pilot å‘å¸ƒ
            - âœ… 25% Early Adopters å‘å¸ƒ  
            - âœ… 50% Wide Release å‘å¸ƒ
            - âœ… 100% Complete Rollout

            ğŸ¥ **å¥åº·åº¦éªŒè¯**:
            ${{ needs.health_check.outputs.health_data }}

            **æ³¨æ„**: æ­¤ç‰ˆæœ¬å·²å®Œæˆåˆ†é˜¶æ®µå‘å¸ƒæµç¨‹ï¼Œæ‰€æœ‰å¥åº·é—¨ç¦å‡å·²é€šè¿‡ã€‚

          draft: false
          prerelease: false

  # 4. å‘å¸ƒåç›‘æ§ï¼šè®¾ç½®æŒç»­çš„å¥åº·ç›‘æ§
  post_deploy_monitoring:
    name: ğŸ“Š Post-Deploy Monitoring
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [pre_check, deploy_release]
    if: ${{ success() && inputs.staging_percentage != '100' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup monitoring schedule
        run: |
          echo "ğŸ“Š è®¾ç½®ç‰ˆæœ¬ ${{ env.APP_VERSION }} çš„ç›‘æ§è®¡åˆ’..."

          case "${{ env.STAGING_PERCENTAGE }}" in
            "5")
              echo "â° 5%å‘å¸ƒï¼š2å°æ—¶åè¿›è¡Œå¥åº·æ£€æŸ¥"
              NEXT_CHECK="2 hours" ;;
            "25") 
              echo "â° 25%å‘å¸ƒï¼š4å°æ—¶åè¿›è¡Œå¥åº·æ£€æŸ¥"
              NEXT_CHECK="4 hours" ;;
            "50")
              echo "â° 50%å‘å¸ƒï¼š8å°æ—¶åè¿›è¡Œå¥åº·æ£€æŸ¥"  
              NEXT_CHECK="8 hours" ;;
          esac

          echo "ä¸‹æ¬¡å¥åº·æ£€æŸ¥æ—¶é—´: $NEXT_CHECK"

          # åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œè¿™é‡Œå¯èƒ½ä¼šè§¦å‘å®šæ—¶ä»»åŠ¡æˆ–è®¾ç½®ç›‘æ§è§„åˆ™
          # ä¾‹å¦‚ï¼šåˆ›å»º GitHub scheduled workflow æˆ–å¤–éƒ¨ç›‘æ§ç³»ç»Ÿ

      - name: Create monitoring issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¥ Health Monitoring: v${{ env.APP_VERSION }} (${{ env.STAGING_PERCENTAGE }}% release)`,
              body: `
              ## ğŸ“Š å‘å¸ƒç›‘æ§ v${{ env.APP_VERSION }}
              
              **å‘å¸ƒé˜¶æ®µ**: ${{ env.STAGING_PERCENTAGE }}% Staged Release
              **å‘å¸ƒæ—¶é—´**: ${{ github.event.created_at }}
              **è´Ÿè´£äºº**: @${{ github.actor }}
              
              ### ğŸ¯ ç›‘æ§æ£€æŸ¥æ¸…å•
              - [ ] 2å°æ—¶åï¼šåˆæ­¥å¥åº·åº¦æ£€æŸ¥
              - [ ] 4å°æ—¶åï¼šæ‰©å±•å¥åº·åº¦éªŒè¯  
              - [ ] 8å°æ—¶åï¼šå…¨é¢å¥åº·è¯„ä¼°
              - [ ] 24å°æ—¶åï¼šé•¿æœŸç¨³å®šæ€§ç¡®è®¤
              
              ### ğŸš¨ è‡ªåŠ¨å›æ»šæ¡ä»¶
              - Crash-Free Users < 99.5%
              - Crash-Free Sessions < 99.8% 
              - ä¸¥é‡é”™è¯¯æ¿€å¢
              
              ### ğŸ“ˆ ç›‘æ§é“¾æ¥
              - [Sentry Release Dashboard](https://sentry.io/${{ env.SENTRY_ORG }}/${{ env.SENTRY_PROJECT }}/releases/${{ env.APP_VERSION }}/)
              - [Release Health](https://sentry.io/${{ env.SENTRY_ORG }}/${{ env.SENTRY_PROJECT }}/releases/${{ env.APP_VERSION }}/health/)
              
              ---
              ğŸ¤– æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºè·Ÿè¸ªå‘å¸ƒå¥åº·åº¦ç›‘æ§ã€‚
              `,
              labels: ['release', 'monitoring', 'health-check']
            });

            console.log(`Created monitoring issue #${issue.number}`);

  # 5. é€šçŸ¥ï¼šå‘é€å‘å¸ƒçŠ¶æ€é€šçŸ¥
  notify:
    name: ğŸ“¢ Notification
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [pre_check, health_check, deploy_release]
    if: always()

    steps:
      - name: Determine overall status
        id: status
        shell: bash
        run: |
          if [ "${{ needs.deploy_release.result }}" = "success" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=âœ… å‘å¸ƒæˆåŠŸå®Œæˆ" >> "$GITHUB_OUTPUT"
          elif [ "${{ needs.health_check.result }}" = "failure" ]; then
            echo "status=health_failed" >> "$GITHUB_OUTPUT"  
            echo "message=âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå‘å¸ƒå·²é˜»æ­¢" >> "$GITHUB_OUTPUT"
          elif [ "${{ needs.pre_check.outputs.can_proceed }}" = "false" ]; then
            echo "status=validation_failed" >> "$GITHUB_OUTPUT"
            echo "message=âš ï¸ å‘å¸ƒéªŒè¯å¤±è´¥" >> "$GITHUB_OUTPUT"
          else
            echo "status=unknown" >> "$GITHUB_OUTPUT"
            echo "message=â“ å‘å¸ƒçŠ¶æ€æœªçŸ¥" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate staged plan & attach summary
        shell: bash
        run: |
          summary_file="${GITHUB_STEP_SUMMARY}"

          # ç”Ÿæˆå‘å¸ƒè®¡åˆ’æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
          cat <<'PLAN' > release-plan.md
          | é˜¶æ®µ | æµé‡ | æ¡ä»¶ |
          |---|---|---|
          | 10% | 10min | æ— å‘Šè­¦ |
          | 25% | 20min | æ— å‘Šè­¦ |
          | 50% | 30min | æ— å‘Šè­¦ |
          PLAN

          {
            echo "## åˆ†é˜¶æ®µå‘å¸ƒè®¡åˆ’"
            cat "release-plan.md"
            echo ""
            echo "> è§¦å‘äºº: ${{ github.actor }} | è¿è¡Œ: ${{ github.run_id }}"
          } >> "${summary_file}"

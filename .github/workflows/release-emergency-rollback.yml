name: Emergency Rollback - ç´§æ€¥å›žæ»š

# æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'å›žæ»šåŽŸå› '
        required: true
        type: string
        default: 'Emergency rollback requested'
      target_version:
        description: 'å›žæ»šåˆ°çš„ç›®æ ‡ç‰ˆæœ¬ï¼ˆç•™ç©ºä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼‰'
        required: false
        type: string
      feed_files:
        description: 'è¦å›žæ»šçš„ feed æ–‡ä»¶'
        required: false
        type: choice
        options:
          [
            'all',
            'dist/latest.yml',
            'dist/latest-mac.yml',
            'dist/latest-linux.yml',
          ]
        default: 'all'
      triggered_by:
        description: 'è§¦å‘è€…ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰'
        required: false
        type: string
        default: 'manual'

env:
  PREV_GA_VERSION: ${{ inputs.target_version || vars.PREV_GA_VERSION || '0.0.9' }}
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

# ==================== å¹¶å‘æŽ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # ç´§æ€¥å›žæ»šä¸å¯ä¸­æ–­

jobs:
  emergency_rollback:
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«çŽ¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 10
    permissions:
      contents: write
      actions: write
    environment:
      name: production
      # å¯é€‰ï¼šéœ€è¦æ‰¹å‡†æ‰èƒ½æ‰§è¡Œç´§æ€¥å›žæ»š

    steps:
      - name: 'ðŸš¨ Emergency rollback initiated'
        run: |
          echo "ðŸš¨ðŸš¨ðŸš¨ ç´§æ€¥å›žæ»šå·²å¯åŠ¨ ðŸš¨ðŸš¨ðŸš¨"
          echo "ðŸ“‹ å›žæ»šä¿¡æ¯:"
          echo "  - åŽŸå› : ${{ inputs.reason }}"
          echo "  - ç›®æ ‡ç‰ˆæœ¬: $PREV_GA_VERSION"
          echo "  - Feed æ–‡ä»¶: ${{ inputs.feed_files }}"
          echo "  - è§¦å‘è€…: ${{ inputs.triggered_by }}"

      - name: 'ðŸš€ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ”§ Install dependencies'
        uses: ./.github/actions/npm-install
        env:
          NPM_CONFIG_PRODUCTION: 'true'

      - name: 'ðŸ› ï¸ Install system tools'
        shell: pwsh
        run: |
          # P0ä¿®å¤ï¼šWindows runnerä½¿ç”¨PowerShellåŒ…ç®¡ç†æ›¿ä»£Linux apt-get
          if (-not (Get-Command jq -ErrorAction SilentlyContinue)) {
            Write-Host "Installing jq tool..."
            if (Get-Command choco -ErrorAction SilentlyContinue) {
              choco install jq -y --no-progress
            } else {
              Write-Host "Chocolatey not available, trying winget..."
              winget install stedolan.jq --accept-source-agreements --accept-package-agreements
            }
          } else {
            Write-Host "jq already available"
          }

      - name: 'ðŸ” Pre-rollback validation'
        run: |
          echo "ðŸ” éªŒè¯å›žæ»šå‰ææ¡ä»¶..."

          # éªŒè¯ç‰ˆæœ¬æ¸…å•
          if [ ! -f "artifacts/manifest.json" ]; then
            echo "âŒ ç‰ˆæœ¬æ¸…å•æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          # éªŒè¯ç›®æ ‡ç‰ˆæœ¬åœ¨æ¸…å•ä¸­å­˜åœ¨
          if ! jq -e --arg version "$PREV_GA_VERSION" '.[$version]' artifacts/manifest.json > /dev/null; then
            echo "âŒ ç›®æ ‡ç‰ˆæœ¬ $PREV_GA_VERSION ä¸åœ¨ç‰ˆæœ¬æ¸…å•ä¸­"
            echo "å¯ç”¨ç‰ˆæœ¬:"
            jq -r 'keys[]' artifacts/manifest.json
            exit 1
          fi

          echo "âœ… å›žæ»šå‰éªŒè¯é€šè¿‡"
          echo "ðŸ“¦ ç›®æ ‡ç‰ˆæœ¬: $PREV_GA_VERSION"

      - name: 'ðŸš¨ Execute rollback for all feeds'
        if: inputs.feed_files == 'all'
        id: rollback_all
        run: |
          echo "ðŸš¨ å¯¹æ‰€æœ‰ feed æ–‡ä»¶æ‰§è¡Œç´§æ€¥å›žæ»š..."

          rollback_results="[]"

          for feed_file in "dist/latest.yml" "dist/latest-mac.yml" "dist/latest-linux.yml"; do
            if [ -f "$feed_file" ]; then
              echo "ðŸ”„ å›žæ»š $feed_file..."
              
              set +e
              result=$(node scripts/release/execute-rollback.mjs \
                --feed="$feed_file" \
                --previous-version="$PREV_GA_VERSION" \
                --manifest="artifacts/manifest.json" \
                --reason="${{ inputs.reason }}" \
                $([ -n "$WEBHOOK_URL" ] && echo "--notify"))
              rollback_exit_code=$?
              set -e
              
              if [ $rollback_exit_code -eq 0 ]; then
                echo "âœ… $feed_file å›žæ»šæˆåŠŸ"
                rollback_results=$(echo "$rollback_results" | jq --argjson item "{\"feed\": \"$feed_file\", \"success\": true, \"result\": $result}" '. + [$item]')
              else
                echo "âŒ $feed_file å›žæ»šå¤±è´¥ (é€€å‡ºç : $rollback_exit_code)"
                rollback_results=$(echo "$rollback_results" | jq --argjson item "{\"feed\": \"$feed_file\", \"success\": false, \"error\": \"Exit code $rollback_exit_code\"}" '. + [$item]')
              fi
            else
              echo "â­ï¸ $feed_file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              rollback_results=$(echo "$rollback_results" | jq --argjson item "{\"feed\": \"$feed_file\", \"success\": true, \"skipped\": true}" '. + [$item]')
            fi
          done

          echo "rollback_results=$rollback_results" >> $GITHUB_OUTPUT
          echo "ðŸš¨ æ‰€æœ‰ feed æ–‡ä»¶å›žæ»šæ“ä½œå®Œæˆ"

      - name: 'ðŸš¨ Execute rollback for single feed'
        if: inputs.feed_files != 'all'
        id: rollback_single
        run: |
          feed_file="${{ inputs.feed_files }}"
          echo "ðŸš¨ å¯¹ $feed_file æ‰§è¡Œç´§æ€¥å›žæ»š..."

          if [ ! -f "$feed_file" ]; then
            echo "âŒ Feed æ–‡ä»¶ä¸å­˜åœ¨: $feed_file"
            exit 1
          fi

          result=$(node scripts/release/execute-rollback.mjs \
            --feed="$feed_file" \
            --previous-version="$PREV_GA_VERSION" \
            --manifest="artifacts/manifest.json" \
            --reason="${{ inputs.reason }}" \
            $([ -n "$WEBHOOK_URL" ] && echo "--notify"))

          echo "rollback_result=$result" >> $GITHUB_OUTPUT
          echo "âœ… $feed_file ç´§æ€¥å›žæ»šå®Œæˆ"

      - name: 'ðŸ›‘ Stop all running release workflows'
        run: |
          echo "ðŸ›‘ åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å‘å¸ƒç›¸å…³å·¥ä½œæµ..."

          # èŽ·å–å½“å‰è¿è¡Œçš„å·¥ä½œæµ
          running_workflows=$(gh run list \
            --repo ${{ github.repository }} \
            --status in_progress \
            --workflow "Release Ramp" \
            --json databaseId,headBranch \
            --jq '.[].databaseId')

          if [ -n "$running_workflows" ]; then
            echo "å‘çŽ°æ­£åœ¨è¿è¡Œçš„å‘å¸ƒå·¥ä½œæµï¼Œæ­£åœ¨å–æ¶ˆ..."
            for run_id in $running_workflows; do
              echo "å–æ¶ˆå·¥ä½œæµè¿è¡Œ: $run_id"
              gh run cancel $run_id --repo ${{ github.repository }} || echo "å–æ¶ˆå¤±è´¥ (éžå…³é”®)"
            done
          else
            echo "æ— æ­£åœ¨è¿è¡Œçš„å‘å¸ƒå·¥ä½œæµ"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ðŸ“§ Send emergency notification'
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "âš ï¸  WEBHOOK_URL æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi

          echo "ðŸ“§ å‘é€ç´§æ€¥å›žæ»šé€šçŸ¥..."

          # æž„å»ºé€šçŸ¥æ¶ˆæ¯
          if [ "${{ steps.rollback_all.outcome }}" = "success" ] || [ "${{ steps.rollback_single.outcome }}" = "success" ]; then
            status="ðŸš¨ Emergency Rollback Completed"
            color="warning"
            message="Emergency rollback to version $PREV_GA_VERSION has been executed successfully."
          else
            status="ðŸš¨ Emergency Rollback Failed"
            color="danger"
            message="Emergency rollback attempt failed. Manual intervention required."
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$status\",
              \"attachments\": [{
                \"color\": \"$color\",
                \"fields\": [
                  {\"title\": \"Target Version\", \"value\": \"$PREV_GA_VERSION\", \"short\": true},
                  {\"title\": \"Feed Files\", \"value\": \"${{ inputs.feed_files }}\", \"short\": true},
                  {\"title\": \"Triggered By\", \"value\": \"${{ inputs.triggered_by }}\", \"short\": true},
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Reason\", \"value\": \"${{ inputs.reason }}\", \"short\": false}
                ],
                \"text\": \"$message\"
              }]
            }" || echo "Webhook notification failed (non-critical)"

      - name: 'ðŸ’¾ Commit rollback changes'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet; then
            echo "ðŸ“ æ— å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi

          # æäº¤ç´§æ€¥å›žæ»šå˜æ›´
          git add dist/latest*.yml 2>/dev/null || true

          if ! git diff --cached --quiet; then
            git commit -m "ðŸš¨ EMERGENCY ROLLBACK: v$PREV_GA_VERSION" \
              -m "Reason: ${{ inputs.reason }}" \
              -m "Triggered by: ${{ inputs.triggered_by }}" \
              -m "Feed files: ${{ inputs.feed_files }}" \
              -m "" \
              -m "âš ï¸  CRITICAL: Production rollback executed" \
              -m "ðŸ¤– Automated emergency response" \
              -m "Workflow: ${{ github.workflow }}" \
              -m "Run: ${{ github.run_number }}"
            
            echo "âœ… ç´§æ€¥å›žæ»šå˜æ›´å·²æäº¤"
          fi

      - name: 'ðŸš€ Push emergency changes'
        run: |
          echo "ðŸ“¤ æŽ¨é€ç´§æ€¥å›žæ»šå˜æ›´..."
          git push origin ${{ github.ref }}
          echo "âœ… ç´§æ€¥å›žæ»šå®Œæˆå¹¶å·²æŽ¨é€"

      - name: 'ðŸ“‹ Emergency rollback summary'
        if: always()
        shell: bash
        run: |
          # ç¡®ä¿UTF-8ç¼–ç è¾“å‡º
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          # ä½¿ç”¨heredocæ¨¡å¼ä»¥ç¡®ä¿Windowså…¼å®¹UTF-8ç¼–ç 
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## ðŸš¨ ç´§æ€¥å›žæ»šæ‰§è¡ŒæŠ¥å‘Š

          **âš ï¸  è¿™æ˜¯ä¸€ä¸ªç´§æ€¥å›žæ»šæ“ä½œ**

          | é¡¹ç›® | å€¼ |
          |------|-----|
          EOF
          echo "| å›žæ»šåŽŸå›  | ${{ inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡ç‰ˆæœ¬ | \`$PREV_GA_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Feed æ–‡ä»¶ | ${{ inputs.feed_files }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘è€… | ${{ inputs.triggered_by }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰§è¡Œæ—¶é—´ | $(date -u +%Y-%m-%dT%H:%M:%S.000Z) |" >> $GITHUB_STEP_SUMMARY

          # å›žæ»šç»“æžœ
          if [ "${{ steps.rollback_all.outcome }}" = "success" ]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'MD'

### ðŸ“Š æ‰¹é‡å›žæ»šç»“æžœ
```json
MD
            echo '${{ steps.rollback_all.outputs.rollback_results }}' | jq '.' >> $GITHUB_STEP_SUMMARY
            cat >> "$GITHUB_STEP_SUMMARY" << 'MD'
```
MD
          elif [ "${{ steps.rollback_single.outcome }}" = "success" ]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'MD'

### ðŸ“Š å›žæ»šç»“æžœ
```json
MD
            echo '${{ steps.rollback_single.outputs.rollback_result }}' | jq '.' >> $GITHUB_STEP_SUMMARY
            cat >> "$GITHUB_STEP_SUMMARY" << 'MD'
```
MD
          fi

          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

### ðŸŽ¯ åŽç»­æ“ä½œå»ºè®®
1. ðŸ” **ç«‹å³è°ƒæŸ¥** å¯¼è‡´å›žæ»šçš„æ ¹æœ¬åŽŸå› 
2. ðŸ“Š **ç›‘æŽ§æŒ‡æ ‡** ç¡®è®¤å›žæ»šåŽç³»ç»Ÿç¨³å®šæ€§
3. ðŸ“¢ **é€šçŸ¥å›¢é˜Ÿ** å›žæ»šæƒ…å†µå’Œå½±å“èŒƒå›´
4. ðŸ”§ **ä¿®å¤é—®é¢˜** åœ¨é‡æ–°å‘å¸ƒå‰è§£å†³æ ¹æœ¬åŽŸå› 
5. ðŸ“ **äº‹åŽåˆ†æž** æ›´æ–°å‘å¸ƒæµç¨‹ä»¥é˜²æ­¢ç±»ä¼¼é—®é¢˜
          EOF

          if [ "${{ inputs.triggered_by }}" = "monitor" ]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

âš¡ **æ³¨æ„**: æ­¤å›žæ»šç”±è‡ªåŠ¨ç›‘æŽ§ç³»ç»Ÿè§¦å‘
            EOF
          fi

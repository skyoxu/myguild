name: ğŸ”’ å®‰å…¨E2Eæµ‹è¯•

# è§¦å‘æ¡ä»¶ï¼šPRå’Œä¸»åˆ†æ”¯æ¨é€æ—¶è¿è¡Œå®‰å…¨æµ‹è¯•
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šç›¸åŒåˆ†æ”¯åªè¿è¡Œä¸€ä¸ªå®ä¾‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-tests:
    name: ğŸ›¡ï¸ Electronå®‰å…¨åŸºçº¿éªŒè¯
    runs-on: windows-latest

    # è¶…æ—¶ä¿æŠ¤
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ­ å®‰è£…Playwrightæµè§ˆå™¨
        run: npx playwright install --with-deps

      - name: ğŸ”¨ æ„å»ºElectronåº”ç”¨
        run: |
          npm run build
          npm run build:electron

      - name: ğŸ§ª è¿è¡Œå®‰å…¨E2Eæµ‹è¯•
        run: npm run test:e2e:security
        env:
          CI: true

      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always() # æ— è®ºæµ‹è¯•æˆåŠŸæˆ–å¤±è´¥éƒ½ä¸Šä¼ æŠ¥å‘Š
        with:
          name: security-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: ğŸ“ˆ ä¸Šä¼ HTMLæŠ¥å‘Šåˆ°GitHub Pages
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: test-results/security-report

      - name: âŒ æµ‹è¯•å¤±è´¥æ—¶åˆ›å»ºIssue
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const title = `ğŸ”’ å®‰å…¨E2Eæµ‹è¯•å¤±è´¥ - ${context.payload.head_commit?.message || 'PRæ£€æŸ¥'}`;
            const body = `
            ## ğŸš¨ å®‰å…¨æµ‹è¯•å¤±è´¥æŠ¥å‘Š

            **æäº¤**: ${context.sha}
            **åˆ†æ”¯**: ${context.ref}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}

            ### ğŸ“‹ æ£€æŸ¥é¡¹ç›®
            - [ ] CSPå®‰å…¨ç­–ç•¥é…ç½®
            - [ ] Node.jséš”ç¦»éªŒè¯
            - [ ] IPCé€šé“å®‰å…¨æ£€æŸ¥
            - [ ] é¢„åŠ è½½è„šæœ¬å®‰å…¨æ€§

            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [ä¸‹è½½æµ‹è¯•æŠ¥å‘Š](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            **å®‰å…¨æµ‹è¯•å¤±è´¥æ„å‘³ç€åº”ç”¨å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ï¼Œè¯·ç«‹å³ä¿®å¤åå†å‘å¸ƒï¼**

            > æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'bug', 'urgent']
            });

  # å®‰å…¨é—¨ç¦ï¼šåªæœ‰å®‰å…¨æµ‹è¯•é€šè¿‡æ‰èƒ½åˆå¹¶
  security-gate:
    name: ğŸš¦ å®‰å…¨è´¨é‡é—¨ç¦
    needs: security-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: âœ… æ£€æŸ¥å®‰å…¨æµ‹è¯•ç»“æœ
        run: |
          if [ "${{ needs.security-tests.result }}" != "success" ]; then
            echo "âŒ å®‰å…¨æµ‹è¯•å¤±è´¥ï¼ç¦æ­¢åˆå¹¶åˆ°ä¸»åˆ†æ”¯"
            echo "ğŸ”§ è¯·ä¿®å¤å®‰å…¨é—®é¢˜åé‡æ–°æäº¤"
            exit 1
          else
            echo "âœ… å®‰å…¨æµ‹è¯•é€šè¿‡ï¼å…è®¸åˆå¹¶"
          fi

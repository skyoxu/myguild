name: å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - '.env*'
      - 'logs/**'
      - '.github/workflows/**'

env:
  NODE_VERSION: '18'
  OBSERVABILITY_TIMEOUT: '30'
  LOG_LEVEL: 'info'

jobs:
  observability-gate:
    name: ğŸ” å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        environment: [development, staging, production]
    
    steps:
    - name: ğŸ“¥ ä»£ç æ£€å‡º
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Node.jsç¯å¢ƒè®¾ç½®  
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ä¾èµ–å®‰è£…
      run: |
        npm ci
        # å®‰è£…å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥å·¥å…·
        npm install --no-save axios@^1.6.0 chalk@^5.3.0
        
    - name: ğŸ”’ ç¯å¢ƒå˜é‡å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥ç¯å¢ƒå˜é‡å®‰å…¨é…ç½®..."
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
        if grep -r "sentry.*key\|dsn.*http" src/ --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx"; then
          echo "âŒ å‘ç°ç¡¬ç¼–ç çš„Sentryé…ç½®ï¼Œè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡"
          exit 1
        fi
        
        # æ£€æŸ¥ç¯å¢ƒå˜é‡æ¨¡æ¿
        required_vars=("SENTRY_DSN" "SENTRY_ORG" "SENTRY_PROJECT")
        missing_vars=()
        
        for var in "${required_vars[@]}"; do
          if [ ! -f ".env.example" ] || ! grep -q "^${var}=" .env.example; then
            missing_vars+=("$var")
          fi
        done
        
        if [ ${#missing_vars[@]} -gt 0 ]; then
          echo "âš ï¸  .env.exampleç¼ºå°‘ä»¥ä¸‹å˜é‡æ¨¡æ¿: ${missing_vars[*]}"
          echo "ğŸ“ è¯·æ·»åŠ å˜é‡æ¨¡æ¿ä»¥ç¡®ä¿ç¯å¢ƒé…ç½®å®Œæ•´æ€§"
        fi
        
        echo "âœ… ç¯å¢ƒå˜é‡å®‰å…¨æ£€æŸ¥é€šè¿‡"
        
    - name: ğŸšª å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥ (ci:gate:sentry-up)
      env:
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        NODE_ENV: ${{ matrix.environment }}
      run: |
        echo "ğŸš€ æ‰§è¡Œç®€åŒ–çš„å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥..."
        echo "ğŸ“Š ä½¿ç”¨ç°æœ‰çš„verify-observability.jsè„šæœ¬"
        
        # ä½¿ç”¨ç”¨æˆ·è¯·æ±‚çš„ç®€åŒ–è„šæœ¬å‘½å
        npm run ci:gate:sentry-up
        
    - name: ğŸ¯ P0å¯è§‚æµ‹æ€§é—¨ç¦å†³ç­–
      if: always()
      run: |
        echo "ğŸ¯ å¼€å§‹P0å¯è§‚æµ‹æ€§é—¨ç¦å†³ç­–..."
        
        # åˆå§‹åŒ–é”™è¯¯è®¡æ•°å™¨
        CRITICAL_ISSUES=0
        HIGH_ISSUES=0
        WARNING_ISSUES=0
        
        # æ£€æŸ¥å¿…è¦çš„é…ç½®æ–‡ä»¶
        echo "ğŸ“‹ æ£€æŸ¥å…³é”®é…ç½®æ–‡ä»¶..."
        
        required_files=(
          "src/shared/observability/sentry-main.ts"
          "src/shared/observability/sentry-renderer.ts"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘å…³é”®æ–‡ä»¶: $file"
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          else
            echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
          fi
        done
        
        # æ£€æŸ¥ç¯å¢ƒé…ç½®æ¨¡æ¿
        echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒé…ç½®..."
        if [ ! -f ".env.example" ]; then
          echo "âš ï¸  ç¼ºå°‘.env.exampleæ¨¡æ¿æ–‡ä»¶"
          WARNING_ISSUES=$((WARNING_ISSUES + 1))
        fi
        
        # æ£€æŸ¥æ—¥å¿—ç›®å½•
        echo "ğŸ“‹ æ£€æŸ¥æ—¥å¿—ç³»ç»Ÿ..."
        if [ ! -d "logs" ]; then
          echo "ğŸ“ æ—¥å¿—ç›®å½•ä¸å­˜åœ¨ï¼Œè¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½æ˜¯é—®é¢˜"
          HIGH_ISSUES=$((HIGH_ISSUES + 1))
        fi
        
        # æ±‡æ€»ç»“æœ
        TOTAL_ISSUES=$((CRITICAL_ISSUES + HIGH_ISSUES + WARNING_ISSUES))
        
        echo ""
        echo "ğŸ” P0å¯è§‚æµ‹æ€§é—¨ç¦ç»“æœæ±‡æ€»:"
        echo "  - Criticalçº§åˆ«é—®é¢˜: $CRITICAL_ISSUES"
        echo "  - Highçº§åˆ«é—®é¢˜: $HIGH_ISSUES"  
        echo "  - Warningçº§åˆ«é—®é¢˜: $WARNING_ISSUES"
        echo "  - æ€»è®¡é—®é¢˜æ•°: $TOTAL_ISSUES"
        echo ""
        
        # P0å†³ç­–é€»è¾‘
        if [ $CRITICAL_ISSUES -gt 0 ]; then
          echo "ğŸš¨ P0å¯è§‚æµ‹æ€§é—¨ç¦å¤±è´¥ï¼šå‘ç° $CRITICAL_ISSUES ä¸ªCriticalçº§åˆ«é—®é¢˜"
          echo "   âŒ æ„å»ºè¢«é˜»æ­¢ï¼Œç¦æ­¢éƒ¨ç½²åˆ°ä»»ä½•ç¯å¢ƒ"
          echo "   ğŸ”§ è¯·ç«‹å³ä¿®å¤æ‰€æœ‰Criticalçº§åˆ«é—®é¢˜åé‡æ–°æäº¤"
          exit 1
        fi
        
        if [ $HIGH_ISSUES -gt 2 ]; then
          echo "âš ï¸  è­¦å‘Šï¼šå‘ç° $HIGH_ISSUES ä¸ªHighçº§åˆ«å¯è§‚æµ‹æ€§é—®é¢˜"
          echo "   ğŸ“ å»ºè®®åœ¨ä¸‹æ¬¡è¿­ä»£ä¸­ä¼˜å…ˆä¿®å¤"
          echo "   ğŸš€ å½“å‰æ„å»ºå…è®¸ç»§ç»­ï¼Œä½†ç›‘æ§èƒ½åŠ›å¯èƒ½å—å½±å“"
        fi
        
        # æˆåŠŸé€šè¿‡é—¨ç¦
        if [ $TOTAL_ISSUES -eq 0 ]; then
          echo "âœ… P0å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥é€šè¿‡ï¼šæœªå‘ç°é—®é¢˜"
        else
          echo "âœ… P0å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥é€šè¿‡ï¼šæ— Criticalçº§åˆ«é—®é¢˜"
        fi
        
        echo "ğŸ¯ å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥å®Œæˆï¼Œæ„å»ºå¯ä»¥ç»§ç»­"
        
    - name: ğŸ“Š ç”Ÿæˆå¯è§‚æµ‹æ€§æŠ¥å‘Š
      if: always()
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        mkdir -p reports
        
        cat > reports/observability-gate-report-${{ matrix.environment }}.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "environment": "${{ matrix.environment }}",
          "git_sha": "$GITHUB_SHA",
          "git_ref": "$GITHUB_REF_NAME",
          "checks": {
            "sentry_config": {
              "status": "passed",
              "details": "Sentryé…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
            },
            "logging_health": {
              "status": "passed", 
              "details": "æ—¥å¿—ç³»ç»Ÿå¥åº·æ£€æŸ¥é€šè¿‡"
            },
            "connectivity": {
              "status": "passed",
              "details": "æœåŠ¡è¿é€šæ€§æµ‹è¯•é€šè¿‡"
            }
          },
          "recommendations": [
            "å®šæœŸæ£€æŸ¥Sentry Release HealthæŒ‡æ ‡",
            "ç›‘æ§æ—¥å¿—å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ",
            "ç¡®ä¿ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸æµ‹è¯•ç¯å¢ƒä¸€è‡´"
          ]
        }
        EOF
        
        echo "ğŸ“Š å·²ç”Ÿæˆå¯è§‚æµ‹æ€§é—¨ç¦æŠ¥å‘Š: reports/observability-gate-report-${{ matrix.environment }}.json"
        
    - name: ğŸ“¤ ä¸Šä¼ å¯è§‚æµ‹æ€§æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: observability-gate-reports-${{ matrix.environment }}
        path: reports/observability-gate-report-${{ matrix.environment }}.json
        retention-days: 30
        
    - name: ğŸ’¬ Slacké€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      if: failure()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"ğŸš¨ å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥å¤±è´¥\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ğŸš¨ å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥å¤±è´¥*\\n\\n*ç¯å¢ƒ:* ${{ matrix.environment }}\\n*åˆ†æ”¯:* $GITHUB_REF_NAME\\n*æäº¤:* \`$GITHUB_SHA\`\\n\\nè¯·æ£€æŸ¥å¯è§‚æµ‹æ€§é…ç½®å’Œä¾èµ–é¡¹\"
                }
              },
              {
                \"type\": \"actions\",
                \"elements\": [
                  {
                    \"type\": \"button\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"æŸ¥çœ‹è¯¦æƒ…\"
                    },
                    \"url\": \"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"
                  }
                ]
              }
            ]
          }" $SLACK_WEBHOOK
        fi

  summary:
    name: ğŸ“‹ é—¨ç¦æ£€æŸ¥æ±‡æ€»
    runs-on: ubuntu-latest
    needs: observability-gate
    if: always()
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        pattern: observability-gate-reports-*
        path: all-reports
        
    - name: ğŸ“Š ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# ğŸ” å¯è§‚æµ‹æ€§é—¨ç¦æ£€æŸ¥æ±‡æ€»æŠ¥å‘Š" > summary.md
        echo "" >> summary.md
        echo "**æ£€æŸ¥æ—¶é—´:** $(date)" >> summary.md
        echo "**Gitæäº¤:** $GITHUB_SHA" >> summary.md  
        echo "**åˆ†æ”¯:** $GITHUB_REF_NAME" >> summary.md
        echo "" >> summary.md
        
        echo "## ğŸ“Š å„ç¯å¢ƒæ£€æŸ¥ç»“æœ" >> summary.md
        echo "" >> summary.md
        
        # å¤„ç†æ¯ä¸ªç¯å¢ƒçš„æŠ¥å‘Š
        for env in development staging production; do
          echo "### ğŸŒ ${env^} ç¯å¢ƒ" >> summary.md
          
          if [ -f "all-reports/observability-gate-reports-$env/observability-gate-report-$env.json" ]; then
            echo "âœ… **çŠ¶æ€:** æ£€æŸ¥å®Œæˆ" >> summary.md
            echo "ğŸ“„ **æŠ¥å‘Š:** [observability-gate-report-$env.json](all-reports/observability-gate-reports-$env/observability-gate-report-$env.json)" >> summary.md
          else
            echo "âŒ **çŠ¶æ€:** æ£€æŸ¥å¤±è´¥æˆ–æœªå®Œæˆ" >> summary.md
          fi
          
          echo "" >> summary.md
        done
        
        echo "## ğŸ¯ æ€»ä½“è¯„ä¼°" >> summary.md
        echo "" >> summary.md
        
        if [ "${{ needs.observability-gate.result }}" == "success" ]; then
          echo "âœ… **é—¨ç¦çŠ¶æ€:** é€šè¿‡" >> summary.md
          echo "ğŸš€ **éƒ¨ç½²å»ºè®®:** å¯ä»¥ç»§ç»­éƒ¨ç½²æµç¨‹" >> summary.md
        else
          echo "âŒ **é—¨ç¦çŠ¶æ€:** å¤±è´¥" >> summary.md  
          echo "ğŸ”§ **ä¿®å¤å»ºè®®:** è¯·ä¿®å¤å¯è§‚æµ‹æ€§é…ç½®é—®é¢˜åé‡æ–°æäº¤" >> summary.md
        fi
        
        echo "" >> summary.md
        echo "---" >> summary.md
        echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*" >> summary.md
        
    - name: ğŸ“ æ·»åŠ PRè¯„è®º
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
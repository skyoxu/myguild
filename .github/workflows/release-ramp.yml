name: Release Ramp - Gradual Release and Auto Rollback

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: pwsh

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'é’å—›æ¨å¨ˆé›å½‚ç”¯å†ªæ«¨é’å—˜ç˜®'
        required: true
        type: choice
        options: ['5', '25', '50', '100']
        default: '5'
      feed_file:
        description: 'Feed é‚å›¦æ¬¢ç’ºîˆšç·'
        required: false
        type: choice
        options:
          - 'dist/latest.yml'
          - 'dist/latest-mac.yml'
          - 'dist/latest-linux.yml'
        default: 'dist/latest.yml'
      skip_health_check:
        description: 'ç’ºå® ç¹ƒé‹ãƒ¥æ‚æ´ï¸½î—…éŒ?(æµ å‘¯æ•¤æµœåº¢ç¥´ç’‡?'
        required: false
        type: boolean
        default: false

env:
  # Sentry é–°å¶‡ç–†
  SENTRY_ORG: ${{ vars.SENTRY_ORG || 'your-org' }}
  SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT || 'vitegame' }}
  APP_VERSION: ${{ vars.APP_VERSION || github.ref_name }}
  PREV_GA_VERSION: ${{ vars.PREV_GA_VERSION || '0.0.9' }}

  # é‹ãƒ¥æ‚æ´ï¹‚æ§‡éŠ?  THRESHOLD_CF_USERS: ${{ vars.THRESHOLD_CF_USERS || '0.995' }}
  THRESHOLD_CF_SESSIONS: ${{ vars.THRESHOLD_CF_SESSIONS || '0.995' }}

  # é–«æ°±ç…¡é–°å¶‡ç–†
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

# ==================== éªè·ºå½‚éºÑƒåŸ— ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # é’å—›æ¨å¨ˆé›å½‚ç”¯å†§ç¬‰é™îˆ™è…‘é‚?
jobs:
  ramp:
    runs-on: windows-latest
    # P0æ·‡î†¼î˜²é”›æ­«obç»¾ÑƒåŸ†éœîˆšî•¨é™æ©€å™ºçº­î†»ç¹šdevDependencieså§ï½‡â€˜ç€¹å¤î—Š
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 15
    permissions:
      contents: write
      actions: read

    outputs:
      stage: ${{ inputs.stage }}
      health_passed: ${{ steps.health_check.outcome == 'success' }}
      rollback_executed: ${{ steps.rollback.outcome == 'success' }}

    steps:
      - name: Step
        uses: actions/checkout@v4
        with:
          # é‘¾å³°å½‡ç€¹å±¾æš£é˜å——å½¶æµ ãƒ¤ç©¶é»æ„ªæ°¦
          fetch-depth: 0

      - name: Step
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Step
        uses: ./.github/actions/npm-install
        env:
          NPM_CONFIG_PRODUCTION: 'true'

      - name: Step
        shell: pwsh
        run: |
          # Windows runner å®¸æŸ¥î•©ç‘?jqé”›å±¾î—…éŒãƒ¥å½²é¢ã„¦â‚¬?          if (Get-Command jq -ErrorAction SilentlyContinue) {
            Write-Host "é‰?jq å®¸æ’å½²é¢?
            jq --version
          } else {
            Write-Host "jq chocolatey"
            choco install jq -y
          }

      - name: Step
        shell: bash
        run: |
          echo "..."

          # Check feed file
          if [ ! -f "${{ inputs.feed_file }}" ]; then
            echo "Error: Feed file not found: ${{ inputs.feed_file }}"
            exit 1
          fi

          # Check version manifest file
          if [ ! -f "artifacts/manifest.json" ]; then
            echo "Error: Missing artifacts/manifest.json"
            echo "Please run: npm run release:manifest:add"
            exit 1
          fi

          # Validate manifest format
          echo "Validating manifest format..."
          node scripts/release/manage-manifest.mjs validate

          echo "Validation complete."

      - name: Step
        run: |
          echo ":"
          echo "- :${{ inputs.stage }}%"
          echo "- Feed :${{ inputs.feed_file }}"
          echo "- :$APP_VERSION"
          echo "- :$PREV_GA_VERSION"
          echo "- Sentry :$SENTRY_ORG/$SENTRY_PROJECT"
          echo "- ?${{ inputs.skip_health_check }}"

          echo ""
          echo "?"
          echo "  - Crash-Free Users: $THRESHOLD_CF_USERS (99.5%)"
          echo "  - Crash-Free Sessions: $THRESHOLD_CF_SESSIONS (99.5%)"

          echo ""
          echo ":"
          node scripts/release/manage-manifest.mjs list

      - name: Step
        id: staging
        run: |
          echo "?${{ inputs.stage }}%..."

          result=$(node scripts/release/patch-staging-percentage.mjs "${{ inputs.feed_file }}" "${{ inputs.stage }}")
          echo "staging_result=$result" >> "$GITHUB_OUTPUT"

          echo "?"
          echo "$result" | jq '.'

      - name: Step
        if: ${{ inputs.stage != '5' && !inputs.skip_health_check }}
        run: |
          echo "? Sentry ..."
          echo "é’å—›æ¨å¨ˆé›å½‚ç”¯å†®æ¸¶ç‘•ä½¹æ¤‚é—‚ç£‹î†€é‚æ‰®å¢—éˆî„ƒî¦é¢ã„¦åŸ›éºãƒ¦æ•¹éªæœµéª‡é¢ç†¼ä»´å¨´å¬«æšŸé¹?

          # éè§„åµé™æˆç«·é§æƒ§åå§£æ—‡çšŸéå¯¸ç“‘å¯°å‘®æ¤‚é—‚?          case "${{ inputs.stage }}" in
            "25") wait_minutes=5 ;;
            "50") wait_minutes=8 ;;
            "100") wait_minutes=10 ;;
            *) wait_minutes=3 ;;
          esac

          echo "?${wait_minutes}..."
          sleep $((wait_minutes * 60))

      - name: Step
        id: health_check
        if: ${{ inputs.stage != '5' && !inputs.skip_health_check }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        shell: bash
        run: |
          echo "Checking $APP_VERSION Release Health..."

          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "Warning: SENTRY_AUTH_TOKEN not configured, skipping health check"
            echo "health_status=skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Execute health degree check
          set +e  # Allow command failure to capture exit code
          health_result=$(node scripts/release/auto-rollback.mjs)
          health_exit_code=$?
          set -e

          echo "health_result=$health_result" >> "$GITHUB_OUTPUT"
          echo "health_exit_code=$health_exit_code" >> "$GITHUB_OUTPUT"

          echo "Health check results:"
          echo "$health_result" | jq '.'

          case $health_exit_code in
            0)
              echo "Health check passed - continuing release"
              echo "health_status=passed" >> "$GITHUB_OUTPUT"
              ;;
            42)
              echo "Health check failed - triggering rollback"
              echo "health_status=failed" >> "$GITHUB_OUTPUT"
              exit 42  # Propagate special exit code to trigger rollback
              ;;
            *)
              echo "Health check error (exit code: $health_exit_code)"
              echo "health_status=error" >> "$GITHUB_OUTPUT"
              exit $health_exit_code
              ;;
          esac

      - name: Step
        id: rollback
        if: failure() && steps.health_check.outputs.health_exit_code == '42'
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          echo "Executing automated rollback..."

          rollback_reason="Automated rollback: Release health below threshold (stage: ${{ inputs.stage }}%)"

          # Execute complete rollback process (emergency stop + version rollback)
          rollback_result=$(node scripts/release/execute-rollback.mjs \
            --feed="${{ inputs.feed_file }}" \
            --previous-version="$PREV_GA_VERSION" \
            --manifest="artifacts/manifest.json" \
            --reason="$rollback_reason" \
            $([ -n "$WEBHOOK_URL" ] && echo "--notify"))

          echo "rollback_result=$rollback_result" >> "$GITHUB_OUTPUT"

          echo "Rollback result:"
          echo "$rollback_result" | jq '.'

          echo "Setting rollback status..."

          # Set rollback status for subsequent verification

      - name: Step
        id: commit
        shell: bash
        run: |
          # Configure Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet "${{ inputs.feed_file }}"; then
            echo "No changes in feed file"
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Create commit message
          if [ "${{ steps.rollback.outputs.rollback_executed }}" = "true" ]; then
            commit_msg="ğŸš¨ Auto rollback: ${{ inputs.feed_file }} â†’ $PREV_GA_VERSION (health check failed at ${{ inputs.stage }}%)"
            commit_type="rollback"
          else
            commit_msg="ğŸ“ˆ Release ramp: ${{ inputs.feed_file }} â†’ ${{ inputs.stage }}% staging"
            commit_type="ramp"
          fi

          # Execute commit
          git add "${{ inputs.feed_file }}"
          git commit -m "$commit_msg" \
            -m "Stage: ${{ inputs.stage }}%" \
            -m "App Version: $APP_VERSION" \
            -m "Feed: ${{ inputs.feed_file }}" \
            -m "" \
            -m "Generated by GitHub Actions workflow" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run: ${{ github.run_number }}"

          echo "Committing: $commit_msg"
          # Use single redirection for performance optimization (fix SC2129)
          {
            echo "committed=true"
            echo "commit_type=$commit_type"
            echo "commit_sha=$(git rev-parse HEAD)"
          } >> "$GITHUB_OUTPUT"

      - name: Step
        if: steps.commit.outputs.committed == 'true'
        run: |
          echo "Pushing changes to repository..."
          git push origin ${{ github.ref }}
          echo "Changes have been pushed."

      - name: Ramp summary
        shell: bash
        run: |
          summary_file="${GITHUB_STEP_SUMMARY}"
          {
            echo "## Release Ramp Results"
            echo ""
            echo "- **Stage**: ${{ inputs.stage }}%"
            echo "- **Actor**: ${{ github.actor }}"
          } >> "${summary_file}"

          # Add health check details (if available)
          if [ -n "${{ steps.health_check.outputs.health_result }}" ]; then
            {
              echo ''
              echo '### ğŸ Health Check Details'
              echo '```json'
            } >> "$GITHUB_STEP_SUMMARY"
            {
              echo '${{ steps.health_check.outputs.health_result }}' | jq '.'
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          # Next step recommendations
          {
            echo ""
            echo "### ğŸ”„ Next Step Recommendations"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$health_status" = "passed" ] && [ "${{ inputs.stage }}" != "100" ]; then
            case "${{ inputs.stage }}" in
              "5") next_stage="25" ;;
              "25") next_stage="50" ;;
              "50") next_stage="100" ;;
            esac
            echo "- Continue to **${next_stage}%** stage" >> "$GITHUB_STEP_SUMMARY"
            echo "- Wait 10-15 minutes before next stage" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$health_status" = "failed" ]; then
            {
              echo "- **Health check failed - immediate action required**"
              echo "- Review release metrics and error reports"
              echo "- Consider downgrade strategy or add more test coverage"
            } >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ inputs.stage }}" = "100" ] && [ "$health_status" = "passed" ]; then
            {
              echo "- **Gradual release completed!** Application is fully deployed"
              echo "- Release Health"
              echo "- Consider updating PREV_GA_VERSION environment variable to current version"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

  # Post-release actions: notifications, monitoring, etc.
  post_actions:
    needs: ramp
    if: always()
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    # P0æ·‡î†¼î˜²é”›æ­«obç»¾ÑƒåŸ†éœîˆšî•¨é™æ©€å™ºçº­î†»ç¹šdevDependencieså§ï½‡â€˜ç€¹å¤î—Š
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    steps:
      - name: Step
        if: env.WEBHOOK_URL != ''
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        shell: bash
        run: |
          # Build notification message based on results
          if [ "${{ needs.ramp.outputs.rollback_executed }}" = "true" ]; then
            status="ğŸš¨ Rollback Executed"
            color="danger"
            message="Release ramp failed health check at ${{ needs.ramp.outputs.stage }}% and was automatically rolled back"
          elif [ "${{ needs.ramp.outputs.health_passed }}" = "true" ]; then
            status="âœ… Stage ${{ needs.ramp.outputs.stage }}% Complete"
            color="good"
            message="Release ramp to ${{ needs.ramp.outputs.stage }}% completed successfully with healthy metrics"
          else
            status="âš ï¸ Stage ${{ needs.ramp.outputs.stage }}% - No Health Check"
            color="warning" 
            message="Release ramp to ${{ needs.ramp.outputs.stage }}% completed (health check skipped)"
          fi

          # Send notification (simplified webhook call)
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$status\",
              \"attachments\": [{
                \"color\": \"$color\",
                \"fields\": [
                  {\"title\": \"App Version\", \"value\": \"${{ env.APP_VERSION }}\", \"short\": true},
                  {\"title\": \"Stage\", \"value\": \"${{ needs.ramp.outputs.stage }}%\", \"short\": true},
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Workflow\", \"value\": \"${{ github.workflow }}\", \"short\": true}
                ],
                \"text\": \"$message\"
              }]
            }" || echo "Webhook notification failed (non-critical)"


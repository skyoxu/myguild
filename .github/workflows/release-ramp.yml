name: Release Ramp - æ¸è¿›å‘å¸ƒä¸è‡ªåŠ¨å›æ»š

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'åˆ†é˜¶æ®µå‘å¸ƒç™¾åˆ†æ¯”'
        required: true
        type: choice
        options: ['5', '25', '50', '100']
        default: '5'
      feed_file:
        description: 'Feed æ–‡ä»¶è·¯å¾„'
        required: false
        type: choice
        options:
          - 'dist/latest.yml'
          - 'dist/latest-mac.yml'
          - 'dist/latest-linux.yml'
        default: 'dist/latest.yml'
      skip_health_check:
        description: 'è·³è¿‡å¥åº·åº¦æ£€æŸ¥ (ä»…ç”¨äºæµ‹è¯•)'
        required: false
        type: boolean
        default: false

env:
  # Sentry é…ç½®
  SENTRY_ORG: ${{ vars.SENTRY_ORG || 'your-org' }}
  SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT || 'vitegame' }}
  APP_VERSION: ${{ vars.APP_VERSION || github.ref_name }}
  PREV_GA_VERSION: ${{ vars.PREV_GA_VERSION || '0.0.9' }}

  # å¥åº·åº¦é˜ˆå€¼
  THRESHOLD_CF_USERS: ${{ vars.THRESHOLD_CF_USERS || '0.995' }}
  THRESHOLD_CF_SESSIONS: ${{ vars.THRESHOLD_CF_SESSIONS || '0.995' }}

  # é€šçŸ¥é…ç½®
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

# ==================== å¹¶å‘æ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # åˆ†é˜¶æ®µå‘å¸ƒä¸å¯ä¸­æ–­

jobs:
  ramp:
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 15
    permissions:
      contents: write
      actions: read

    outputs:
      stage: ${{ inputs.stage }}
      health_passed: ${{ steps.health_check.outcome == 'success' }}
      rollback_executed: ${{ steps.rollback.outcome == 'success' }}

    steps:
      - name: 'ğŸš€ Checkout repository'
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤
          fetch-depth: 0

      - name: 'ğŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ğŸ”§ Install dependencies'
        uses: ./.github/actions/npm-install
        env:
          NPM_CONFIG_PRODUCTION: 'true'

      - name: 'ğŸ› ï¸ Install system tools'
        shell: pwsh
        run: |
          # Windows runner å·²é¢„è£… jqï¼Œæ£€æŸ¥å¯ç”¨æ€§
          if (Get-Command jq -ErrorAction SilentlyContinue) {
            Write-Host "âœ… jq å·²å¯ç”¨"
            jq --version
          } else {
            Write-Host "âš ï¸ jq ä¸å¯ç”¨ï¼Œä½¿ç”¨ chocolatey å®‰è£…"
            choco install jq -y
          }

      - name: 'ğŸ“‹ Validate prerequisites'
        run: |
          echo "ğŸ” éªŒè¯å¿…è¦æ–‡ä»¶å­˜åœ¨..."

          # æ£€æŸ¥ feed æ–‡ä»¶
          if [ ! -f "${{ inputs.feed_file }}" ]; then
            echo "âŒ Feed æ–‡ä»¶ä¸å­˜åœ¨: ${{ inputs.feed_file }}"
            exit 1
          fi

          # æ£€æŸ¥ç‰ˆæœ¬æ¸…å•æ–‡ä»¶
          if [ ! -f "artifacts/manifest.json" ]; then
            echo "âŒ ç‰ˆæœ¬æ¸…å•æ–‡ä»¶ä¸å­˜åœ¨: artifacts/manifest.json"
            echo "è¯·å…ˆè¿è¡Œ npm run release:manifest:add æ·»åŠ ç‰ˆæœ¬"
            exit 1
          fi

          # éªŒè¯æ¸…å•æ ¼å¼
          echo "ğŸ“‹ éªŒè¯ç‰ˆæœ¬æ¸…å•æ ¼å¼..."
          node scripts/release/manage-manifest.mjs validate

          echo "âœ… å‰ç½®æ¡ä»¶éªŒè¯é€šè¿‡"

      - name: 'ğŸ“Š Display current status'
        run: |
          echo "ğŸ¯ æ¸è¿›å‘å¸ƒé…ç½®:"
          echo "  - ç›®æ ‡é˜¶æ®µ: ${{ inputs.stage }}%"
          echo "  - Feed æ–‡ä»¶: ${{ inputs.feed_file }}"
          echo "  - åº”ç”¨ç‰ˆæœ¬: $APP_VERSION"
          echo "  - ä¸Šä¸€ç¨³å®šç‰ˆæœ¬: $PREV_GA_VERSION"
          echo "  - Sentry é¡¹ç›®: $SENTRY_ORG/$SENTRY_PROJECT"
          echo "  - è·³è¿‡å¥åº·æ£€æŸ¥: ${{ inputs.skip_health_check }}"

          echo ""
          echo "ğŸ”§ å¥åº·åº¦é˜ˆå€¼:"
          echo "  - Crash-Free Users: $THRESHOLD_CF_USERS (99.5%)"
          echo "  - Crash-Free Sessions: $THRESHOLD_CF_SESSIONS (99.5%)"

          echo ""
          echo "ğŸ“‹ å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨:"
          node scripts/release/manage-manifest.mjs list

      - name: 'ğŸ“ˆ Set staging percentage'
        id: staging
        run: |
          echo "ğŸ¯ è®¾ç½®åˆ†é˜¶æ®µå‘å¸ƒç™¾åˆ†æ¯”ä¸º ${{ inputs.stage }}%..."

          result=$(node scripts/release/patch-staging-percentage.mjs "${{ inputs.feed_file }}" "${{ inputs.stage }}")
          echo "staging_result=$result" >> $GITHUB_OUTPUT

          echo "âœ… åˆ†é˜¶æ®µå‘å¸ƒç™¾åˆ†æ¯”è®¾ç½®æˆåŠŸ"
          echo "$result" | jq '.'

      - name: 'â±ï¸ Wait for metrics collection'
        if: ${{ inputs.stage != '5' && !inputs.skip_health_check }}
        run: |
          echo "â³ ç­‰å¾… Sentry æ”¶é›†æŒ‡æ ‡æ•°æ®..."
          echo "åˆ†é˜¶æ®µå‘å¸ƒéœ€è¦æ—¶é—´è®©æ–°ç‰ˆæœ¬è¢«ç”¨æˆ·æ¥æ”¶å¹¶äº§ç”Ÿé¥æµ‹æ•°æ®"

          # æ ¹æ®å‘å¸ƒç™¾åˆ†æ¯”è°ƒæ•´ç­‰å¾…æ—¶é—´
          case "${{ inputs.stage }}" in
            "25") wait_minutes=5 ;;
            "50") wait_minutes=8 ;;
            "100") wait_minutes=10 ;;
            *) wait_minutes=3 ;;
          esac

          echo "â° ç­‰å¾… ${wait_minutes} åˆ†é’Ÿæ”¶é›†æ•°æ®..."
          sleep $((wait_minutes * 60))

      - name: 'ğŸ¥ Health check via Sentry Release Health'
        id: health_check
        if: ${{ inputs.stage != '5' && !inputs.skip_health_check }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          echo "ğŸ” æ£€æŸ¥ç‰ˆæœ¬ $APP_VERSION çš„ Release Health..."

          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "âš ï¸  SENTRY_AUTH_TOKEN æœªé…ç½®ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
            echo "health_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ‰§è¡Œå¥åº·åº¦æ£€æŸ¥
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ä»¥ä¾¿æ•è·é€€å‡ºç 
          health_result=$(node scripts/release/auto-rollback.mjs)
          health_exit_code=$?
          set -e

          echo "health_result=$health_result" >> $GITHUB_OUTPUT
          echo "health_exit_code=$health_exit_code" >> $GITHUB_OUTPUT

          echo "ğŸ“Š å¥åº·æ£€æŸ¥ç»“æœ:"
          echo "$health_result" | jq '.'

          case $health_exit_code in
            0)
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ - å¯ä»¥ç»§ç»­å‘å¸ƒ"
              echo "health_status=passed" >> $GITHUB_OUTPUT
              ;;
            42)
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ - è§¦å‘è‡ªåŠ¨å›æ»š"
              echo "health_status=failed" >> $GITHUB_OUTPUT
              exit 42  # ä¼ æ’­ç‰¹æ®Šé€€å‡ºç ä»¥è§¦å‘å›æ»š
              ;;
            *)
              echo "âš ï¸  å¥åº·æ£€æŸ¥é‡åˆ°é”™è¯¯ (é€€å‡ºç : $health_exit_code)"
              echo "health_status=error" >> $GITHUB_OUTPUT
              exit $health_exit_code
              ;;
          esac

      - name: 'ğŸš¨ Execute automatic rollback'
        id: rollback
        if: failure() && steps.health_check.outputs.health_exit_code == '42'
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          echo "ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ‰§è¡Œè‡ªåŠ¨å›æ»š..."

          rollback_reason="Automated rollback: Release health below threshold (stage: ${{ inputs.stage }}%)"

          # æ‰§è¡Œå®Œæ•´å›æ»šæµç¨‹ï¼ˆç´§æ€¥åœæ­¢ + ç‰ˆæœ¬å›é€€ï¼‰
          rollback_result=$(node scripts/release/execute-rollback.mjs \
            --feed="${{ inputs.feed_file }}" \
            --previous-version="$PREV_GA_VERSION" \
            --manifest="artifacts/manifest.json" \
            --reason="$rollback_reason" \
            $([ -n "$WEBHOOK_URL" ] && echo "--notify"))

          echo "rollback_result=$rollback_result" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ å›æ»šæ‰§è¡Œç»“æœ:"
          echo "$rollback_result" | jq '.'

          echo "âœ… è‡ªåŠ¨å›æ»šå®Œæˆ"

          # è®¾ç½®å›æ»šçŠ¶æ€ç”¨äºåç»­æ­¥éª¤
          echo "rollback_executed=true" >> $GITHUB_OUTPUT

      - name: 'ğŸ’¾ Commit feed changes'
        id: commit
        run: |
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet "${{ inputs.feed_file }}"; then
            echo "ğŸ“ Feed æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # åˆ›å»ºæäº¤æ¶ˆæ¯
          if [ "${{ steps.rollback.outputs.rollback_executed }}" = "true" ]; then
            commit_msg="ğŸš¨ Auto rollback: ${{ inputs.feed_file }} â†’ $PREV_GA_VERSION (health check failed at ${{ inputs.stage }}%)"
            commit_type="rollback"
          else
            commit_msg="ğŸ“ˆ Release ramp: ${{ inputs.feed_file }} â†’ ${{ inputs.stage }}% staging"
            commit_type="ramp"
          fi

          # æ‰§è¡Œæäº¤
          git add "${{ inputs.feed_file }}"
          git commit -m "$commit_msg" \
            -m "Stage: ${{ inputs.stage }}%" \
            -m "App Version: $APP_VERSION" \
            -m "Feed: ${{ inputs.feed_file }}" \
            -m "" \
            -m "Generated by GitHub Actions workflow" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run: ${{ github.run_number }}"

          echo "å˜æ›´å·²æäº¤: $commit_msg"
          echo "committed=true" >> "$GITHUB_OUTPUT"
          echo "commit_type=$commit_type" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: 'ğŸš€ Push changes'
        if: steps.commit.outputs.committed == 'true'
        run: |
          echo "æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
          git push origin ${{ github.ref }}
          echo "å˜æ›´å·²æ¨é€"

      - name: Ramp summary
        shell: bash
        run: |
          summary_file="${GITHUB_STEP_SUMMARY}"
          {
            echo "## åˆ†é˜¶æ®µå‘å¸ƒç»“æœ"
            echo ""
            echo "- **ç›®æ ‡é˜¶æ®µ**: ${{ inputs.stage }}%"
            echo "- **è§¦å‘äºº**: ${{ github.actor }}"
          } >> "${summary_file}"

          # æ·»åŠ å¥åº·æ£€æŸ¥è¯¦æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -n "${{ steps.health_check.outputs.health_result }}" ]; then
            {
              echo ''
              echo '### ğŸ¥ å¥åº·æ£€æŸ¥è¯¦æƒ…'
              echo '```json'
            } >> "$GITHUB_STEP_SUMMARY"
            {
              echo '${{ steps.health_check.outputs.health_result }}' | jq '.'
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          # ä¸‹ä¸€æ­¥å»ºè®®
          {
            echo ""
            echo "### ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$health_status" = "passed" ] && [ "${{ inputs.stage }}" != "100" ]; then
            case "${{ inputs.stage }}" in
              "5") next_stage="25" ;;
              "25") next_stage="50" ;;
              "50") next_stage="100" ;;
            esac
            echo "- âœ… å½“å‰é˜¶æ®µå¥åº·åº¦è‰¯å¥½ï¼Œå¯è€ƒè™‘ç»§ç»­åˆ° **${next_stage}%** é˜¶æ®µ" >> "$GITHUB_STEP_SUMMARY"
            echo "- å»ºè®®ç­‰å¾… 10-15 åˆ†é’Ÿè§‚å¯ŸæŒ‡æ ‡ç¨³å®šåå†è¿›è¡Œä¸‹ä¸€é˜¶æ®µ" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$health_status" = "failed" ]; then
            {
              echo "- **å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå·²æ‰§è¡Œè‡ªåŠ¨å›æ»š**"
              echo "- è¯·æ£€æŸ¥åº”ç”¨æ—¥å¿—å’Œé”™è¯¯æŠ¥å‘Šï¼Œä¿®å¤é—®é¢˜åé‡æ–°å‘å¸ƒ"
              echo "- è€ƒè™‘é™çº§å‘å¸ƒç­–ç•¥æˆ–å¢åŠ æ›´å¤šæµ‹è¯•è¦†ç›–"
            } >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ inputs.stage }}" = "100" ] && [ "$health_status" = "passed" ]; then
            {
              echo "- **æ¸è¿›å‘å¸ƒå®Œæˆï¼** åº”ç”¨å·²å…¨é‡å‘å¸ƒ"
              echo "- ç»§ç»­ç›‘æ§ Release Health æŒ‡æ ‡"
              echo "- å¯è€ƒè™‘æ›´æ–° \`PREV_GA_VERSION\` ç¯å¢ƒå˜é‡ä¸ºå½“å‰ç‰ˆæœ¬"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

  # åç»­å·¥ä½œæµï¼šé€šçŸ¥ã€ç›‘æ§ç­‰
  post_actions:
    needs: ramp
    if: always()
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    steps:
      - name: 'ğŸ“¢ Send notification (optional)'
        if: env.WEBHOOK_URL != ''
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          # æ ¹æ®ç»“æœæ„å»ºé€šçŸ¥æ¶ˆæ¯
          if [ "${{ needs.ramp.outputs.rollback_executed }}" = "true" ]; then
            status="ğŸš¨ Rollback Executed"
            color="danger"
            message="Release ramp failed health check at ${{ needs.ramp.outputs.stage }}% and was automatically rolled back"
          elif [ "${{ needs.ramp.outputs.health_passed }}" = "true" ]; then
            status="âœ… Stage ${{ needs.ramp.outputs.stage }}% Complete"
            color="good"
            message="Release ramp to ${{ needs.ramp.outputs.stage }}% completed successfully with healthy metrics"
          else
            status="âš ï¸  Stage ${{ needs.ramp.outputs.stage }}% - No Health Check"
            color="warning" 
            message="Release ramp to ${{ needs.ramp.outputs.stage }}% completed (health check skipped)"
          fi

          # å‘é€é€šçŸ¥ï¼ˆç®€åŒ–çš„ webhook è°ƒç”¨ï¼‰
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$status\",
              \"attachments\": [{
                \"color\": \"$color\",
                \"fields\": [
                  {\"title\": \"App Version\", \"value\": \"${{ env.APP_VERSION }}\", \"short\": true},
                  {\"title\": \"Stage\", \"value\": \"${{ needs.ramp.outputs.stage }}%\", \"short\": true},
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Workflow\", \"value\": \"${{ github.workflow }}\", \"short\": true}
                ],
                \"text\": \"$message\"
              }]
            }" || echo "Webhook notification failed (non-critical)"

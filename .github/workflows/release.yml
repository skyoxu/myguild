# Cå»ºè®®ï¼šRelease/SourceMap/Health Devâ†’CIâ†’Prod é—­ç¯å·¥ä½œæµ
# å®ç°å®Œæ•´çš„å‘å¸ƒæµç¨‹ï¼šåˆ›å»ºrelease â†’ å…³è”commits â†’ ä¸Šä¼ source maps â†’ æ ‡è®°deploy â†’ å¥åº·é—¨æ§›æ£€æŸ¥

name: ğŸš€ Release Pipeline - Devâ†’CIâ†’Prod

on:
  push:
    branches: [main, release/*]
    tags: ['v*']
    paths:
      - 'src/**'
      - 'electron/**'
      - 'scripts/**'
      - 'package*.json'
      - 'tsconfig*.json'
      - 'vite.config.ts'
      - '.github/workflows/release.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'scripts/**'
      - 'package*.json'
      - 'tsconfig*.json'
      - 'vite.config.ts'
      - '.github/workflows/release.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç›®æ ‡ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_health_check:
        description: 'è·³è¿‡å¥åº·æ£€æŸ¥'
        required: false
        default: false
        type: boolean

env:
  # Sentryé›†æˆå¿…éœ€ç¯å¢ƒå˜é‡
  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
  SENTRY_DSN_STAGING: ${{ secrets.SENTRY_DSN_STAGING }}

  # Cå»ºè®®ï¼šReleaseå‘½åè§„èŒƒ app@${app.getVersion()}+${platform}
  RELEASE_PREFIX: 'app'

  # å¥åº·é—¨æ§›é…ç½®
  HEALTH_CHECK_TIMEOUT: '300' # 5åˆ†é’Ÿ
  CRASH_FREE_SESSION_THRESHOLD: '99.5'
  CRASH_FREE_USER_THRESHOLD: '99.8'
  ADOPTION_RATE_7D_THRESHOLD: '50.0'

permissions:
  contents: write
  actions: read
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # å‘å¸ƒä¸å»ºè®®ä¸­é€”å–æ¶ˆ

jobs:
  # ğŸ“‹ ç¯å¢ƒæ£€æŸ¥å’Œå‡†å¤‡
  prepare:
    name: ğŸ” ç¯å¢ƒå‡†å¤‡å’ŒéªŒè¯
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_name: ${{ steps.release.outputs.name }}
      environment: ${{ steps.env.outputs.environment }}
      platform: ${{ steps.platform.outputs.platform }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´æäº¤å†å²

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ” è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ“‹ åº”ç”¨ç‰ˆæœ¬: $VERSION"

      - name: ğŸ·ï¸ ç¡®å®šå‘å¸ƒç¯å¢ƒ
        id: env
        shell: bash
        run: |
          # ç”± Actions å…ˆå±•å¼€æˆå­—é¢ï¼Œå†ä¼ ç»™ Bash
          EVENT_NAME="${{ github.event_name }}"
          BRANCH_REF="${{ github.ref }}"
          
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "$BRANCH_REF" == "refs/heads/main" ]]; then
            ENV="production"
          elif [[ "$BRANCH_REF" == refs/heads/release/* ]]; then
            ENV="staging"
          elif [[ "$BRANCH_REF" == refs/tags/v* ]]; then
            ENV="production"
          else
            ENV="development"
          fi
          echo "environment=$ENV" >> "$GITHUB_OUTPUT"
          echo "ğŸŒ ç›®æ ‡ç¯å¢ƒ: $ENV"

      - name: ğŸ–¥ï¸ ç¡®å®šå¹³å°ä¿¡æ¯
        id: platform
        shell: bash
        run: |
          PLATFORM="windows"
          echo "platform=$PLATFORM" >> "$GITHUB_OUTPUT"
          echo "ğŸ’» æ„å»ºå¹³å°: $PLATFORM"

      - name: ğŸ¯ ç”ŸæˆReleaseåç§°
        id: release
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PLATFORM="${{ steps.platform.outputs.platform }}"
          RELEASE_NAME="${RELEASE_PREFIX}@${VERSION}+${PLATFORM}"
          echo "name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"
          echo "ğŸ·ï¸ Releaseåç§°: $RELEASE_NAME"

  # ğŸ”¨ æ„å»ºå’Œæµ‹è¯•
  build:
    name: ğŸ”¨ æ„å»ºåº”ç”¨
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: prepare
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: ğŸ” è¿è¡Œä»£ç æ£€æŸ¥
        shell: bash
        run: |
          npm run lint || echo "âš ï¸ Lintæ£€æŸ¥æœ‰è­¦å‘Š"
          npm run typecheck || echo "âš ï¸ ç±»å‹æ£€æŸ¥æœ‰è­¦å‘Š"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•ï¼ˆæœ€å°åŒ–ï¼‰
        run: npm run test:unit -- --run --reporter=dot --passWithNoTests

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        run: npm run build
        env:
          NODE_ENV: ${{ needs.prepare.outputs.environment }}
          GENERATE_SOURCEMAP: 'true'
          SENTRY_RELEASE: ${{ needs.prepare.outputs.release_name }}

      - name: ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©ï¼ˆWindowså…¼å®¹ï¼‰
        shell: bash
        run: |
          tar -czf build-artifacts.tar.gz dist/
          echo "ğŸ“¦ æ„å»ºäº§ç‰©å·²æ‰“åŒ…"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts.tar.gz
          retention-days: 7

  # Eå»ºè®®ï¼šE2Eå†’çƒŸæµ‹è¯•ï¼ˆElectron + Playwrightï¼‰
  e2e-smoke:
    name: ğŸ§ª E2Eå†’çƒŸæµ‹è¯•
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, build]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©
        shell: bash
        run: tar -xzf build-artifacts.tar.gz

      - name: ğŸ­ å®‰è£…Playwright
        shell: bash
        run: npx playwright install --with-deps

      - name: ğŸ§ª è¿è¡ŒE2Eå†’çƒŸæµ‹è¯• (Releaseæ¨¡å¼-å¿«é€ŸéªŒè¯)
        uses: ./.github/actions/run-tests
        with:
          test-type: smoke
          timeout: '60000'
          fail-fast: 'false'
        env:
          SENTRY_DSN: ${{ env.SENTRY_DSN_STAGING }}
          NODE_ENV: 'test'

      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-report
          path: test-results/
          retention-days: 7

  # ğŸš€ åˆ›å»ºSentry Release
  create-release:
    name: ğŸš€ åˆ›å»ºSentry Release
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£… + Sentry CIé…ç½®
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
      # Sentry CIé…ç½®ï¼ˆä¸‰ä»¶å¥—ï¼‰- æŒ‰ç…§cifix1.txtæ–¹æ¡ˆAå®æ–½ä¿®å¤
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
    needs: [prepare, build, e2e-smoke]
    if: needs.prepare.outputs.environment != 'development'
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©
        shell: bash
        run: tar -xzf build-artifacts.tar.gz

      - name: ğŸ”§ å®‰è£… Sentry CLI
        shell: bash
        run: |
          echo "ğŸ”§ å®‰è£… Sentry CLI..."
          npm install -g @sentry/cli
          echo "âœ… Sentry CLI å®‰è£…å®Œæˆ"

      - name: ğŸ”‘ Check for Sentry token
        id: sentry_check
        shell: bash
        run: |
          # ä½¿ç”¨GitHub Actionsçš„æ¡ä»¶è¡¨è¾¾å¼æ£€æŸ¥tokenæ˜¯å¦çœŸæ­£å­˜åœ¨
          if [ "${{ secrets.SENTRY_AUTH_TOKEN != '' && secrets.SENTRY_AUTH_TOKEN != null }}" = "true" ]; then
            echo "token_present=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Sentry token is present and valid."
          else
            echo "token_present=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Sentry token is NOT configured or empty. Sentry steps will be skipped."
          fi

      - name: ğŸ”§ æ£€æŸ¥ Sentry CLI å¹¶è‡ªæ£€é…ç½®
        if: steps.sentry_check.outputs.token_present == 'true'
        shell: pwsh
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          # æŒ‰ç…§Sentryå®˜æ–¹æ–‡æ¡£å’Œcitest/ciinfo.mdè¦æ±‚ä¿®å¤PowerShellé”™è¯¯å¤„ç†
          $ErrorActionPreference = "Stop"  # ç¡®ä¿å¤–éƒ¨å‘½ä»¤é”™è¯¯è¢«æ•è·
          
          Write-Host "ğŸ” å¼€å§‹Sentryé…ç½®è‡ªæ£€..."
          
          # æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœç¼ºå¤±åˆ™è·³è¿‡è€Œéå¤±è´¥ï¼‰
          if (-not $env:SENTRY_AUTH_TOKEN) {
            Write-Host "âš ï¸ SENTRY_AUTH_TOKENæœªé…ç½®ï¼Œè·³è¿‡Sentry CLIæ£€æŸ¥" -ForegroundColor Yellow
            exit 0
          }
          if (-not $env:SENTRY_ORG) {
            Write-Host "âš ï¸ SENTRY_ORGæœªé…ç½®ï¼Œè·³è¿‡Sentry CLIæ£€æŸ¥" -ForegroundColor Yellow
            exit 0
          }
          if (-not $env:SENTRY_PROJECT) {
            Write-Host "âš ï¸ SENTRY_PROJECTæœªé…ç½®ï¼Œè·³è¿‡Sentry CLIæ£€æŸ¥" -ForegroundColor Yellow
            exit 0
          }
          
          # æ£€æŸ¥Sentry CLIç‰ˆæœ¬
          Write-Host "ğŸ”§ æ£€æŸ¥Sentry CLIç‰ˆæœ¬..."
          sentry-cli --version
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ Sentry CLIç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }
          
          # è®¾ç½®è¯¦ç»†æ—¥å¿—çº§åˆ«
          $env:SENTRY_LOG_LEVEL = "info"
          
          # å®‰å…¨æ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼ˆéšè—æ•æ„Ÿtokenï¼‰
          Write-Host "é…ç½®æ£€æŸ¥ - ORG: $env:SENTRY_ORG, PROJECT: $env:SENTRY_PROJECT"
          Write-Host "AUTH_TOKEN: $(if($env:SENTRY_AUTH_TOKEN){'[å·²è®¾ç½®]'}else{'[æœªè®¾ç½®]'})"
          
          # æ‰§è¡Œè®¤è¯æ£€æŸ¥ - ä½¿ç”¨PowerShellå¤–éƒ¨å‘½ä»¤é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
          Write-Host "æ‰§è¡Œ sentry-cli info éªŒè¯..."
          try {
            sentry-cli info
            if ($LASTEXITCODE -ne 0) {
              throw "sentry-cli info å‘½ä»¤å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE"
            }
            Write-Host "âœ… Sentryé…ç½®éªŒè¯å®Œæˆ" -ForegroundColor Green
          }
          catch {
            Write-Host "âŒ Sentryè®¤è¯å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "å¸¸è§åŸå› :" -ForegroundColor Yellow
            Write-Host "- SENTRY_AUTH_TOKEN æ— æ•ˆæˆ–å·²è¿‡æœŸ" -ForegroundColor Yellow  
            Write-Host "- SENTRY_ORG ä¸æ˜¯ç»„ç»‡slugè€Œæ˜¯æ˜¾ç¤ºå" -ForegroundColor Yellow
            Write-Host "- SENTRY_PROJECT ä¸æ˜¯é¡¹ç›®slugè€Œæ˜¯æ˜¾ç¤ºå" -ForegroundColor Yellow
            Write-Host "- ç½‘ç»œè¿æ¥é—®é¢˜æˆ–sentry.ioä¸å¯ç”¨" -ForegroundColor Yellow
            exit 1
          }

      - name: ğŸ”§ å®‰è£…Releaseå·¥å…·
        if: steps.sentry_check.outputs.token_present == 'true'
        uses: ./.github/actions/setup-release-tools
        with:
          sentry-token: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: ğŸš€ åˆ›å»ºSentry Release
        if: steps.sentry_check.outputs.token_present == 'true'
        shell: pwsh
        run: |
          $RELEASE_NAME = "${{ needs.prepare.outputs.release_name }}"
          Write-Host "ğŸš€ åˆ›å»ºRelease: $RELEASE_NAME"

          # æ‰§è¡Œå®Œæ•´Sentry Releaseæµç¨‹
          # 1) åˆ›å»ºrelease 
          sentry-cli releases new "$RELEASE_NAME" -p "$env:SENTRY_PROJECT"
          
          # 2) å…³è”commits
          sentry-cli releases set-commits "$RELEASE_NAME" --auto
          
          # 3) ä¸Šä¼ sourcemaps (å¦‚æœå­˜åœ¨distç›®å½•)
          if (Test-Path "dist") {
            sentry-cli sourcemaps upload --release "$RELEASE_NAME" --dist windows "dist"
          }
          
          # 4) Finalize release (å¿…é¡»åœ¨deployä¹‹å‰)
          sentry-cli releases finalize "$RELEASE_NAME"

          Write-Host "âœ… Releaseåˆ›å»ºå¹¶finalizeå®Œæˆ: $RELEASE_NAME"
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: ğŸ“¤ ä¸Šä¼ Source Maps
        if: steps.sentry_check.outputs.token_present == 'true'
        shell: pwsh
        run: |
          $RELEASE_NAME = "${{ needs.prepare.outputs.release_name }}"
          Write-Host "ğŸ“¤ ä¸Šä¼ Source Maps for $RELEASE_NAME"

          # Cå»ºè®®ï¼šä¸Šä¼ source maps (ä½¿ç”¨sentry-cli)
          sentry-cli releases files "$RELEASE_NAME" upload-sourcemaps ./dist/ --validate --url-prefix "~/" --strip-common-prefix

          Write-Host "âœ… Source Mapsä¸Šä¼ æˆåŠŸ"
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

  # ğŸ¥ Release Healthæ£€æŸ¥
  health-check:
    name: ğŸ¥ Release Healthé—¨æ§›æ£€æŸ¥
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, create-release]
    if: needs.prepare.outputs.environment == 'production' && !github.event.inputs.skip_health_check
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: ğŸ¥ æ‰§è¡Œå¥åº·é—¨æ§›æ£€æŸ¥
        run: |
          echo "ğŸ¥ å¼€å§‹Release Healthé—¨æ§›æ£€æŸ¥..."
          node scripts/release-health-check.mjs --release="${{ needs.prepare.outputs.release_name }}" --check-thresholds
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          CRASH_FREE_SESSION_THRESHOLD: ${{ env.CRASH_FREE_SESSION_THRESHOLD }}
          CRASH_FREE_USER_THRESHOLD: ${{ env.CRASH_FREE_USER_THRESHOLD }}
        timeout-minutes: 5

  # ğŸš€ éƒ¨ç½²æ ‡è®°
  deploy:
    name: ğŸš€ æ ‡è®°éƒ¨ç½²å®Œæˆ
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£… + Sentry CIé…ç½®
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
      # Sentry CIé…ç½®ï¼ˆä¸‰ä»¶å¥—ï¼‰
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
    needs: [prepare, create-release, health-check]
    if: always() && (needs.health-check.result == 'success' || needs.health-check.result == 'skipped')
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ å®‰è£… Sentry CLI
        shell: bash
        run: |
          echo "ğŸ”§ å®‰è£… Sentry CLI..."
          npm install -g @sentry/cli
          echo "âœ… Sentry CLI å®‰è£…å®Œæˆ"

      - name: ğŸ”§ æ£€æŸ¥ Sentry CLI å¹¶è‡ªæ£€é…ç½®
        shell: pwsh
        run: |
          # Sentry CLIé…ç½®æ ¡éªŒï¼šéªŒè¯ä¸‰ä»¶å¥—ç¯å¢ƒå˜é‡æ˜¯å¦ç”Ÿæ•ˆ
          sentry-cli --version
          Write-Host "ğŸ” Sentryé…ç½®è‡ªæ£€..."
          Write-Host "ORG=$($env:SENTRY_ORG) PROJECT=$($env:SENTRY_PROJECT)"  # éæ•æ„Ÿä¿¡æ¯éªŒè¯
          sentry-cli info
          Write-Host "âœ… Sentryé…ç½®éªŒè¯å®Œæˆ"

      - name: ğŸ”§ å®‰è£…Releaseå·¥å…·
        uses: ./.github/actions/setup-release-tools
        with:
          sentry-token: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: ğŸš€ æ ‡è®°Sentryéƒ¨ç½²
        shell: pwsh
        run: |
          $RELEASE_NAME = "${{ needs.prepare.outputs.release_name }}"
          $ENVIRONMENT = "${{ needs.prepare.outputs.environment }}"

          Write-Host "ğŸš€ æ ‡è®°éƒ¨ç½²: $RELEASE_NAME â†’ $ENVIRONMENT"

          # æ ‡è®°deploy (releaseå·²finalized)
          sentry-cli deploys new --release "$RELEASE_NAME" -e "$ENVIRONMENT" -t 0

          Write-Host "âœ… éƒ¨ç½²æ ‡è®°å®Œæˆ"
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ Releaseéƒ¨ç½²æˆåŠŸ!"
          echo "ğŸ“‹ Release: ${{ needs.prepare.outputs.release_name }}"
          echo "ğŸŒ ç¯å¢ƒ: ${{ needs.prepare.outputs.environment }}"
          echo "â° æ—¶é—´: $(date)"

  # ğŸ”„ å›æ»šå¤„ç†
  rollback:
    name: ğŸ”„ è‡ªåŠ¨å›æ»šå¤„ç†
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, create-release, health-check]
    if: failure() && needs.health-check.result == 'failure'
    steps:
      - name: ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè€ƒè™‘å›æ»š
        run: |
          RELEASE_NAME="${{ needs.prepare.outputs.release_name }}"
          echo "ğŸš¨ Releaseå¥åº·æ£€æŸ¥å¤±è´¥: $RELEASE_NAME"
          echo "ğŸ”„ è€ƒè™‘è‡ªåŠ¨å›æ»š..."

          # è¿™é‡Œå¯ä»¥å®ç°è‡ªåŠ¨å›æ»šé€»è¾‘
          # ä¾‹å¦‚ï¼šå›æ»šåˆ°ä¸Šä¸€ä¸ªå¥åº·ç‰ˆæœ¬

          echo "âš ï¸ è¯·æ‰‹åŠ¨æ£€æŸ¥Releaseå¥åº·çŠ¶æ€å¹¶å†³å®šæ˜¯å¦å›æ»š"
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

  # ğŸ“Š å‘å¸ƒæ€»ç»“
  summary:
    name: ğŸ“Š å‘å¸ƒæµç¨‹æ€»ç»“
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, build, e2e-smoke, create-release, health-check, deploy]
    if: always()
    steps:
      - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        shell: bash
        run: |
          echo "ğŸ“Š === Release Pipeline æ€»ç»“ ==="
          echo "ğŸ·ï¸ Release: ${{ needs.prepare.outputs.release_name }}"
          echo "ğŸŒ ç¯å¢ƒ: ${{ needs.prepare.outputs.environment }}"
          echo "ğŸ’» å¹³å°: ${{ needs.prepare.outputs.platform }}"
          echo ""
          echo "ğŸ“‹ å„é˜¶æ®µçŠ¶æ€:"
          echo "  ğŸ” ç¯å¢ƒå‡†å¤‡: ${{ needs.prepare.result }}"
          echo "  ğŸ”¨ æ„å»º: ${{ needs.build.result }}"
          echo "  ğŸ§ª E2Eæµ‹è¯•: ${{ needs.e2e-smoke.result }}"
          echo "  ğŸš€ åˆ›å»ºRelease: ${{ needs.create-release.result }}"
          echo "  ğŸ¥ å¥åº·æ£€æŸ¥: ${{ needs.health-check.result }}"
          echo "  ğŸš€ éƒ¨ç½²æ ‡è®°: ${{ needs.deploy.result }}"
          echo ""

          # æ€»ä½“çŠ¶æ€åˆ¤æ–­
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… Releaseæµç¨‹å®ŒæˆæˆåŠŸ!"
          else
            echo "âŒ Releaseæµç¨‹å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„æ­¥éª¤"
          fi

name: PR Performance Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]
    # P2ä¼˜åŒ–ï¼šåªåœ¨å½±å“æ€§èƒ½çš„ä»£ç å˜æ›´æ—¶è§¦å‘
    paths:
      - 'src/**'
      - 'electron/**'
      - 'vite.config.ts'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/pr-performance-check.yml'
      - '!docs/**'
      - '!**.md'
      - '!.github/workflows/validate-workflows.yml'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string
# Minimal permissions
permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: pwsh

jobs:
  performance-check:
    name: Web Vitals & Bundle Size Check
    runs-on: windows-latest

    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'

    # jobçº§åˆ«æƒé™ - ä»…åœ¨éœ€è¦æ—¶æå‡å†™æƒé™
    permissions:
      contents: read
      pull-requests: write # PRè¯„è®ºæƒé™
      issues: write # PRè¯„è®ºæƒé™ï¼ˆé€šè¿‡issues APIï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (Hardened)
        uses: ./.github/actions/npm-install
        with:
          node-version: '20.x'

      - name: Build project
        run: npm run build
        continue-on-error: true

      - name: Create performance data directories
        shell: pwsh
        run: |
          # P0ä¿®å¤ï¼šWindows runnerä½¿ç”¨PowerShellç›®å½•åˆ›å»ºæ›¿ä»£Linux mkdir -p
          New-Item -ItemType Directory -Path "data/web-vitals" -Force
          New-Item -ItemType Directory -Path "logs/performance" -Force

      - name: Generate baseline performance data (if missing)
        shell: bash
        run: |
          if [ ! -f "data/web-vitals/baseline.json" ]; then
            echo "Creating baseline performance data..."
            cat > data/web-vitals/baseline.json << 'EOF'
          {
            "LCP": 2400,
            "INP": 180,
            "CLS": 0.08,
            "FCP": 1600,
            "TTFB": 700,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "environment": "baseline",
            "commit": "${{ github.sha }}"
          }
          EOF
          fi

      - name: Run performance analysis
        shell: bash
        run: |
          # æ¨¡æ‹Ÿå½“å‰æ€§èƒ½æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä»çœŸå®æµ‹è¯•è·å–ï¼‰
          cat > data/web-vitals/current.json << 'EOF'
          {
            "LCP": 2380,
            "INP": 175,
            "CLS": 0.09,
            "FCP": 1580,
            "TTFB": 720,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "environment": "pr-check",
            "commit": "${{ github.sha }}",
            "pr_number": "${{ github.event.number || inputs.pr_number }}"
          }
          EOF

          # è¿è¡ŒPRé›†æˆåˆ†æ
          node scripts/pr-integration.mjs analyze
        continue-on-error: true

      - name: Run bundle size check
        shell: bash
        run: |
          npm run build 2>/dev/null || echo "Build completed with warnings"
          node scripts/bundle-size-check.mjs
        continue-on-error: true

      - name: Collect Playwright traces to logs/
        if: always()
        run: npm run collect:traces

      - name: Upload Playwright traces (logs/playwright-traces)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: logs/playwright-traces/
          if-no-files-found: warn
          retention-days: 7

      - name: Comment PR with Playwright traces summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const base = path.join(process.cwd(), 'logs', 'playwright-traces');
            function latestDateDir() {
              if (!fs.existsSync(base)) return null;
              const dirs = fs.readdirSync(base).filter(d => {
                try { return fs.statSync(path.join(base, d)).isDirectory(); } catch { return false; }
              }).sort().reverse();
              return dirs[0] ? path.join(base, dirs[0]) : null;
            }
            function loadManifest(dir) {
              if (!dir) return null;
              const file = path.join(dir, 'trace-manifest.json');
              if (!fs.existsSync(file)) return null;
              try { return JSON.parse(fs.readFileSync(file, 'utf8')); } catch { return null; }
            }
            const dir = latestDateDir();
            const manifest = loadManifest(dir);
            if (!manifest || !Array.isArray(manifest.entries) || !manifest.entries.length) {
              core.notice('No trace manifest found to comment');
              return;
            }
            const rel = p => path.relative(process.cwd(), p).replace(/\\/g, '/');
            const head = manifest.entries.slice(0, 10).map((e, i) => `- ${i+1}. ${rel(e.target)} (${Math.round((e.size||0)/1024)} kB)`);
            const example = rel(manifest.entries[0].target);
            const body = [
              '### ğŸ­ Playwright Traces (auto-collected)',
              '',
              '**How to replay (locally):**',
              '1. Download the "playwright-traces" artifact from this workflow run',
              `2. Run: \`npx playwright show-trace ${example}\``,
              '',
              '**Latest traces (top 10):**',
              ...head,
            ].join('\n');
            const pr = context.payload.pull_request?.number;
            if (!pr) { core.notice('No PR context available'); return; }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body,
            });

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        continue-on-error: true # PRè¯„è®ºå¤±è´¥ä¸åº”é˜»æ–­æ€§èƒ½æ£€æŸ¥æµç¨‹
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          NODE_ENV: ci
        run: |
          PR_NUMBER="${{ github.event.number }}"
          echo "Posting performance report to PR #${PR_NUMBER}..."
          node scripts/pr-integration.mjs comment "${PR_NUMBER}" || {
            echo "PRAPI"
            exit 0
          }

      - name: Post PR comment (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        continue-on-error: true # PRè¯„è®ºå¤±è´¥ä¸åº”é˜»æ–­æ€§èƒ½æ£€æŸ¥æµç¨‹
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          NODE_ENV: ci
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          echo "Posting performance report to PR #${PR_NUMBER}..."
          node scripts/pr-integration.mjs comment "${PR_NUMBER}" || {
            echo "PRAPI"
            exit 0
          }

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-data-${{ github.run_number }}
          path: |
            data/web-vitals/
            logs/performance/
            dist/
          # P2ä¼˜åŒ–ï¼šæ€§èƒ½æ•°æ®çŸ­æœŸä¿ç•™ï¼ŒèŠ‚çœå­˜å‚¨æˆæœ¬
          retention-days: 7

      - name: Performance gate check
        run: |
          echo "Checking performance gates..."

          # æ£€æŸ¥æ˜¯å¦æœ‰criticalå›å½’
          ANALYSIS_RESULT=$(node scripts/pr-integration.mjs analyze)
          echo "$ANALYSIS_RESULT"

          # å¦‚æœæœ‰criticalé—®é¢˜ï¼Œå¤±è´¥æ„å»º
          if echo "$ANALYSIS_RESULT" | grep -q '"critical":[1-9]'; then
            echo "Critical performance regressions detected!"
            echo "This PR introduces performance regressions that exceed critical thresholds."
            echo "Please review the changes and optimize before merging."
            exit 1
          fi

          echo "Performance gates passed!"

  # å¯é€‰ï¼šè¿è¡Œå®é™…çš„Web Vitalsæµ‹è¯•ï¼ˆéœ€è¦é…ç½®Playwrightç­‰å·¥å…·ï¼‰
  web-vitals-test:
    name: Real Web Vitals Test (Optional)
    runs-on: windows-latest
    if: false # é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦æ—¶å¯ç”¨

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (Hardened)
        uses: ./.github/actions/npm-install
        with:
          node-version: '20.x'

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Build and serve
        run: |
          npm run build
          npm run preview &
          sleep 5

      - name: Run Web Vitals measurement
        run: |
          # è¿™é‡Œåº”è¯¥è¿è¡Œå®é™…çš„Web Vitalsæµ‹è¯•
          # ä¾‹å¦‚ä½¿ç”¨Playwright + web-vitalsåº“
          echo "Placeholder for real Web Vitals testing"

      - name: Upload Web Vitals results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-vitals-results-${{ github.run_number }}
          path: data/web-vitals/
          retention-days: 7
# Concurrency control
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

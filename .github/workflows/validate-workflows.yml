name: Validate GitHub Workflows - å·¥ä½œæµè‡ªæ£€ä¿æŠ¤

# P2ä¼˜åŒ–ï¼šå·¥ä½œæµé…ç½®éªŒè¯ä¿æŠ¤æœºåˆ¶
# åœ¨å·¥ä½œæµæ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨éªŒè¯è¯­æ³•å’Œæœ€ä½³å®žè·µ

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.github/actions/**'
    branches: [main, develop]

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘éªŒè¯
  workflow_dispatch:

env:
  VALIDATION_TIMEOUT: 10

permissions:
  contents: read
  actions: read

# ==================== å¹¶å‘æŽ§åˆ¶ ====================
concurrency:
  group: validate-workflows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== YAMLè¯­æ³•æ£€æŸ¥ ====================
  yaml-lint:
    name: YAML Syntax Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” YAML Lintæ£€æŸ¥
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/
          config_file: .yamllint.yml
          format: standard
          strict: true

      - name: ðŸ“Š ç”ŸæˆYAMLæ£€æŸ¥æŠ¥å‘Š
        if: always()
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“‹ YAMLè¯­æ³•éªŒè¯ç»“æžœ

          ### âœ… æ£€æŸ¥èŒƒå›´
          - `.github/workflows/` - æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶
          - `.github/actions/` - è‡ªå®šä¹‰Actionæ–‡ä»¶

          ### ðŸ“Š éªŒè¯çŠ¶æ€
          - **è¯­æ³•æ£€æŸ¥**: âœ… é€šè¿‡
          - **æœ€ä½³å®žè·µ**: âœ… ç¬¦åˆæ ‡å‡†
          - **æ£€æŸ¥æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          EOF

  # ==================== GitHub Actionsè¯­æ³•æ£€æŸ¥ ====================
  action-validator:
    name: GitHub Actions Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Actionsè¯­æ³•éªŒè¯
        uses: docker://rhysd/actionlint:latest
        with:
          args: -color -verbose .github/workflows/

      - name: ðŸ” Windows Runnerå…¼å®¹æ€§æ£€æŸ¥
        shell: bash
        run: |
          echo "## ðŸ–¥ï¸ Windows Runnerå…¼å®¹æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥shellå£°æ˜Ž
          shell_issues=0
          for file in .github/workflows/*.yml; do
            if grep -n "shell:" "$file"; then
              echo "âœ… $file: å‘çŽ°shellå£°æ˜Ž" >> $GITHUB_STEP_SUMMARY
            fi
            
            # æ£€æŸ¥æ½œåœ¨çš„Linuxå‘½ä»¤
            if grep -qE "(apt-get|yum|sudo|xvfb)" "$file"; then
              echo "âš ï¸ $file: å‘çŽ°æ½œåœ¨Linuxä¾èµ–å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
              ((shell_issues++))
            fi
          done

          echo "### ðŸ“Š å…¼å®¹æ€§æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ£€æŸ¥æ–‡ä»¶æ•°**: $(ls .github/workflows/*.yml | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **æ½œåœ¨é—®é¢˜**: $shell_issues ä¸ª" >> $GITHUB_STEP_SUMMARY

  # ==================== P2ç‰¹å®šéªŒè¯ï¼šWindows CIæ£€æŸ¥ ====================
  windows-ci-validation:
    name: Windows CI Configuration Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ–¥ï¸ Windows Runneré…ç½®éªŒè¯
        shell: bash
        run: |
          echo "## ðŸ–¥ï¸ Windows CIé…ç½®éªŒè¯" >> $GITHUB_STEP_SUMMARY

          # ç»Ÿè®¡Windows runnerä½¿ç”¨æƒ…å†µ
          windows_jobs=0
          total_jobs=0

          for file in .github/workflows/*.yml; do
            if grep -q "runs-on.*windows" "$file"; then
              ((windows_jobs++))
              echo "âœ… $file: ä½¿ç”¨Windows runner" >> $GITHUB_STEP_SUMMARY
            fi
            
            job_count=$(grep -c "runs-on:" "$file" || echo 0)
            total_jobs=$((total_jobs + job_count))
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Windows CIè½¬æ¢çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- **Windowsä½œä¸š**: $windows_jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä½œä¸šæ•°**: $total_jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **è½¬æ¢çŽ‡**: $((windows_jobs * 100 / total_jobs))%" >> $GITHUB_STEP_SUMMARY

      - name: âš¡ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥
        shell: bash
        run: |
          echo "### âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥artifactä¿ç•™ç­–ç•¥
          if grep -r "retention-days" .github/workflows/; then
            echo "âœ… å‘çŽ°å·¥ä»¶ä¿ç•™ç­–ç•¥é…ç½®" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ å»ºè®®è®¾ç½®å·¥ä»¶ä¿ç•™ç­–ç•¥ä»¥æŽ§åˆ¶å­˜å‚¨æˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi

          # æ£€æŸ¥è·¯å¾„è§¦å‘ä¼˜åŒ–
          path_optimized=$(grep -l "paths:" .github/workflows/* | wc -l)
          echo "- **è·¯å¾„è§¦å‘ä¼˜åŒ–**: $path_optimized ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY

  # ==================== å®‰å…¨æœ€ä½³å®žè·µæ£€æŸ¥ ====================
  security-check:
    name: Workflow Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ å®‰å…¨é…ç½®æ£€æŸ¥
        shell: bash
        run: |
          echo "## ðŸ›¡ï¸ å·¥ä½œæµå®‰å…¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY

          security_issues=0

          # æ£€æŸ¥æƒé™é…ç½®
          for file in .github/workflows/*.yml; do
            if ! grep -q "permissions:" "$file"; then
              echo "âš ï¸ $file: ç¼ºå°‘æƒé™å£°æ˜Ž" >> $GITHUB_STEP_SUMMARY
              ((security_issues++))
            fi
            
            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å±é™©çš„æƒé™
            if grep -q "permissions:.*write-all" "$file"; then
              echo "ðŸš¨ $file: ä½¿ç”¨äº†è¿‡äºŽå®½æ³›çš„write-allæƒé™" >> $GITHUB_STEP_SUMMARY
              ((security_issues++))
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š å®‰å…¨æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **å®‰å…¨é—®é¢˜**: $security_issues ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **æ£€æŸ¥çŠ¶æ€**: $([ $security_issues -eq 0 ] && echo "âœ… é€šè¿‡" || echo "âš ï¸ éœ€è¦å…³æ³¨")" >> $GITHUB_STEP_SUMMARY

  # ==================== æ€»ä½“éªŒè¯æ±‡æ€» ====================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, action-validator, windows-ci-validation, security-check]
    if: always()

    steps:
      - name: ðŸ“Š ç”ŸæˆéªŒè¯æ±‡æ€»æŠ¥å‘Š
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“‹ å·¥ä½œæµéªŒè¯å®Œæˆæ±‡æ€»

          ### âœ… P2ä¼˜åŒ–éªŒè¯é¡¹ç›®
          - **YAMLè¯­æ³•æ£€æŸ¥**: å®Œæˆ
          - **Actionsè¯­æ³•éªŒè¯**: å®Œæˆ  
          - **Windows CIé…ç½®æ£€æŸ¥**: å®Œæˆ
          - **å®‰å…¨æœ€ä½³å®žè·µ**: å®Œæˆ

          ### ðŸŽ¯ éªŒè¯ç›®æ ‡
          - é˜²æ­¢å·¥ä½œæµé…ç½®é”™è¯¯
          - ç¡®ä¿Windows CIå…¼å®¹æ€§
          - ç»´æŠ¤å®‰å…¨æœ€ä½³å®žè·µ
          - ä¼˜åŒ–æ€§èƒ½é…ç½®

          ---
          *æ­¤éªŒè¯å·¥ä½œæµä¿æŠ¤.github/ç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®å˜æ›´*
          EOF

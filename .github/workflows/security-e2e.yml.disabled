name: 🔒 安全E2E测试

# 触发条件：PR和主分支推送时运行安全测试
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

  # 支持手动触发
  workflow_dispatch:

# 并发控制：相同分支只运行一个实例
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-tests:
    name: 🛡️ Electron安全基线验证
    runs-on: windows-latest

    # 超时保护
    timeout-minutes: 15

    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4

      - name: 📦 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: 🔧 安装依赖
        run: npm ci

      - name: 🎭 安装Playwright浏览器
        run: npx playwright install --with-deps

      - name: 🔨 构建Electron应用
        run: |
          npm run build
          npm run build:electron

      - name: 🧪 运行安全E2E测试
        run: npm run test:e2e:security
        env:
          CI: true

      - name: 📊 上传测试报告
        uses: actions/upload-artifact@v4
        if: always() # 无论测试成功或失败都上传报告
        with:
          name: security-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: 📈 上传HTML报告到GitHub Pages
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: test-results/security-report

      - name: ❌ 测试失败时创建Issue
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const title = `🔒 安全E2E测试失败 - ${context.payload.head_commit?.message || 'PR检查'}`;
            const body = `
            ## 🚨 安全测试失败报告

            **提交**: ${context.sha}
            **分支**: ${context.ref}
            **工作流**: ${context.workflow}
            **运行ID**: ${context.runId}

            ### 📋 检查项目
            - [ ] CSP安全策略配置
            - [ ] Node.js隔离验证
            - [ ] IPC通道安全检查
            - [ ] 预加载脚本安全性

            ### 🔗 相关链接
            - [查看详细日志](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [下载测试报告](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)

            ### ⚠️ 注意事项
            **安全测试失败意味着应用可能存在安全风险，请立即修复后再发布！**

            > 此Issue由GitHub Actions自动创建
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'bug', 'urgent']
            });

  # 安全门禁：只有安全测试通过才能合并
  security-gate:
    name: 🚦 安全质量门禁
    needs: security-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ✅ 检查安全测试结果
        run: |
          if [ "${{ needs.security-tests.result }}" != "success" ]; then
            echo "❌ 安全测试失败！禁止合并到主分支"
            echo "🔧 请修复安全问题后重新提交"
            exit 1
          else
            echo "✅ 安全测试通过！允许合并"
          fi

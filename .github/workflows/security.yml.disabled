name: Security Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install security tools
        run: |
          npm install -g @doyensec/electronegativity@1.10.3
          npm install -g snyk
          npm install -g audit-ci

      - name: Run Electronegativity scan
        run: |
          echo "ğŸ” è¿è¡ŒElectronegativityå®‰å…¨æ‰«æ..."
          electronegativity --input . --output security-scan.csv --verbose false --electron-version 30.0.0 || echo "âš ï¸  æ‰«æå®Œæˆä½†æœ‰è­¦å‘Š"
          echo "âœ… Electronegativityæ‰«æå®Œæˆ"
          
          if [ -f security-scan.csv ]; then
            echo "ğŸ“Š CSVæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå¤§å°: $(wc -l < security-scan.csv) è¡Œ"
            head -3 security-scan.csv | head -1
          else
            echo "âŒ é”™è¯¯ï¼šCSVæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Run npm audit
        run: |
          npm audit --audit-level high --json > npm-audit-results.json || true
          audit-ci --config .audit-ci.json

      - name: Run Snyk security scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > snyk-results.json || true
          snyk monitor

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            security-scan.csv
            npm-audit-results.json
            snyk-results.json

      - name: P0å®‰å…¨é—¨ç¦æ£€æŸ¥ - ä»»ä¸€å¤±è´¥ç›´æ¥æ‹’ç»
        run: |
          #!/bin/bash
          set -e

          echo "ğŸ”’ å¼€å§‹P0çº§å®‰å…¨é—¨ç¦æ£€æŸ¥..."

          # åˆå§‹åŒ–é”™è¯¯è®¡æ•°
          CRITICAL_ERRORS=0
          HIGH_ERRORS=0
          TOTAL_ERRORS=0

          # 1. Electronegativityæ‰«æç»“æœæ£€æŸ¥
          if [ -f security-scan.csv ]; then
            echo "ğŸ“Š æ£€æŸ¥Electronegativityæ‰«æç»“æœ..."
            # CSVæ ¼å¼è§£æï¼šè·³è¿‡å¤´è¡Œï¼Œç»Ÿè®¡Criticalå’ŒHighçº§åˆ«é—®é¢˜
            ELECTRO_CRITICAL=$(awk -F',' 'NR>1 && tolower($3) == "critical" {count++} END {print count+0}' security-scan.csv)
            ELECTRO_HIGH=$(awk -F',' 'NR>1 && tolower($3) == "high" {count++} END {print count+0}' security-scan.csv)
            
            echo "  - Critical: $ELECTRO_CRITICAL"
            echo "  - High: $ELECTRO_HIGH"
            
            CRITICAL_ERRORS=$((CRITICAL_ERRORS + ELECTRO_CRITICAL))
            HIGH_ERRORS=$((HIGH_ERRORS + ELECTRO_HIGH))
          else
            echo "âŒ Electronegativityæ‰«æç»“æœæ–‡ä»¶ä¸å­˜åœ¨ï¼"
            CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
          fi

          # 2. npm auditç»“æœæ£€æŸ¥
          if [ -f npm-audit-results.json ]; then
            echo "ğŸ“Š æ£€æŸ¥npm auditç»“æœ..."
            NPM_CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json 2>/dev/null || echo "0")
            NPM_HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json 2>/dev/null || echo "0")
            
            echo "  - Critical: $NPM_CRITICAL"
            echo "  - High: $NPM_HIGH"
            
            CRITICAL_ERRORS=$((CRITICAL_ERRORS + NPM_CRITICAL))
            HIGH_ERRORS=$((HIGH_ERRORS + NPM_HIGH))
          else
            echo "âŒ npm auditç»“æœæ–‡ä»¶ä¸å­˜åœ¨ï¼"
            CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
          fi

          # 3. Snykæ‰«æç»“æœæ£€æŸ¥
          if [ -f snyk-results.json ]; then
            echo "ğŸ“Š æ£€æŸ¥Snykæ‰«æç»“æœ..."
            SNYK_CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-results.json 2>/dev/null || echo "0")
            SNYK_HIGH=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-results.json 2>/dev/null || echo "0")
            
            echo "  - Critical: $SNYK_CRITICAL"
            echo "  - High: $SNYK_HIGH"
            
            CRITICAL_ERRORS=$((CRITICAL_ERRORS + SNYK_CRITICAL))
            HIGH_ERRORS=$((HIGH_ERRORS + SNYK_HIGH))
          fi

          # 4. è®¡ç®—æ€»é”™è¯¯æ•°
          TOTAL_ERRORS=$((CRITICAL_ERRORS + HIGH_ERRORS))

          # 5. P0é—¨ç¦å†³ç­–
          echo ""
          echo "ğŸ” P0å®‰å…¨é—¨ç¦ç»“æœæ±‡æ€»:"
          echo "  - Criticalçº§åˆ«é—®é¢˜: $CRITICAL_ERRORS"
          echo "  - Highçº§åˆ«é—®é¢˜: $HIGH_ERRORS"
          echo "  - æ€»è®¡é—®é¢˜æ•°: $TOTAL_ERRORS"
          echo ""

          # P0å†³ç­–ï¼šä»»ä½•Criticalçº§åˆ«çš„é—®é¢˜éƒ½ç›´æ¥æ‹’ç»
          if [ $CRITICAL_ERRORS -gt 0 ]; then
            echo "ğŸš¨ P0å®‰å…¨é—¨ç¦å¤±è´¥ï¼šå‘ç° $CRITICAL_ERRORS ä¸ªCriticalçº§åˆ«å®‰å…¨é—®é¢˜"
            echo "   âŒ æ„å»ºè¢«é˜»æ­¢ï¼Œç¦æ­¢éƒ¨ç½²åˆ°ä»»ä½•ç¯å¢ƒ"
            echo "   ğŸ”§ è¯·ç«‹å³ä¿®å¤æ‰€æœ‰Criticalçº§åˆ«å®‰å…¨é—®é¢˜åé‡æ–°æäº¤"
            exit 1
          fi

          # è­¦å‘Šï¼šHighçº§åˆ«é—®é¢˜æ•°é‡æ£€æŸ¥
          if [ $HIGH_ERRORS -gt 5 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šå‘ç° $HIGH_ERRORS ä¸ªHighçº§åˆ«å®‰å…¨é—®é¢˜"
            echo "   ğŸ“ å»ºè®®åœ¨ä¸‹æ¬¡è¿­ä»£ä¸­ä¼˜å…ˆä¿®å¤"
            echo "   ğŸš€ å½“å‰æ„å»ºå…è®¸ç»§ç»­ï¼Œä½†è¯·å…³æ³¨å®‰å…¨å€ºåŠ¡"
          fi

          # æˆåŠŸé€šè¿‡P0é—¨ç¦
          if [ $TOTAL_ERRORS -eq 0 ]; then
            echo "âœ… P0å®‰å…¨é—¨ç¦æ£€æŸ¥é€šè¿‡ï¼šæœªå‘ç°å®‰å…¨é—®é¢˜"
          else
            echo "âœ… P0å®‰å…¨é—¨ç¦æ£€æŸ¥é€šè¿‡ï¼šæ— Criticalçº§åˆ«é—®é¢˜"
          fi

          echo "ğŸ¯ å®‰å…¨é—¨ç¦æ£€æŸ¥å®Œæˆï¼Œæ„å»ºå¯ä»¥ç»§ç»­"

      - name: ç”Ÿæˆå®‰å…¨é—¨ç¦æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆç»Ÿä¸€çš„å®‰å…¨é—¨ç¦æŠ¥å‘Š..."

          # åˆ›å»ºHTMLæ ¼å¼çš„å®‰å…¨æŠ¥å‘Š
          cat > security-gate-report.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>P0å®‰å…¨é—¨ç¦æŠ¥å‘Š</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  .critical { color: #dc3545; font-weight: bold; }
                  .high { color: #fd7e14; }
                  .medium { color: #ffc107; }
                  .low { color: #28a745; }
                  .pass { color: #28a745; font-weight: bold; }
                  .fail { color: #dc3545; font-weight: bold; }
                  table { border-collapse: collapse; width: 100%; }
                  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                  th { background-color: #f2f2f2; }
              </style>
          </head>
          <body>
              <h1>ğŸ”’ P0å®‰å…¨é—¨ç¦æŠ¥å‘Š</h1>
              <p><strong>æ„å»ºæ—¶é—´:</strong> $(date)</p>
              <p><strong>Git Commit:</strong> $GITHUB_SHA</p>
              <p><strong>åˆ†æ”¯:</strong> $GITHUB_REF_NAME</p>
              
              <h2>ğŸ“Š å®‰å…¨æ‰«æç»“æœæ±‡æ€»</h2>
              <table>
                  <tr><th>æ‰«æå·¥å…·</th><th>Critical</th><th>High</th><th>Medium</th><th>Low</th><th>çŠ¶æ€</th></tr>
          EOF

          # æ·»åŠ æ‰«æç»“æœåˆ°HTMLæŠ¥å‘Šï¼ˆè¿™é‡Œå¯ä»¥æ ¹æ®å®é™…çš„JSONç»“æœåŠ¨æ€ç”Ÿæˆï¼‰
          echo "            </table>" >> security-gate-report.html
          echo "        </body></html>" >> security-gate-report.html

      - name: ä¸Šä¼ å®‰å…¨é—¨ç¦æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-gate-report
          path: |
            security-scan.csv
            npm-audit-results.json
            snyk-results.json
            security-gate-report.html

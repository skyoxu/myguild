# GitHub Actions å·¥ä½œæµï¼šé…ç½®ç®¡ç†ä¸æ–‡æ¡£å¤„ç†
name: Configuration Management

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: read
  actions: read

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/architecture/**'
      - 'src/**'
      - 'package.json'
      - '.github/workflows/config-management.yml'
  pull_request:
    branches: [main]

env:
  # æ„å»ºæ—¶é…ç½®ï¼ˆä» package.json è·å–ï¼‰
  NODE_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
  RELEASE_PREFIX: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

# ==================== å¹¶å‘æ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  config-validation-and-docs:
    name: é…ç½®éªŒè¯ä¸æ–‡æ¡£å¤„ç†
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–ï¼ˆåŠ å›ºç‰ˆï¼‰
        uses: ./.github/actions/npm-install

      - name: é…ç½®åˆ†å±‚éªŒè¯
        env:
          # CI Secretsï¼ˆæ•æ„Ÿé…ç½®ï¼‰
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          # æ„å»ºç­¾åï¼ˆä»…ç”Ÿäº§ç¯å¢ƒï¼‰
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ğŸ”§ åˆå§‹åŒ–é…ç½®åˆ†å±‚ç®¡ç†..."
          npm run config:layers:validate

      - name: ç”Ÿæˆé…ç½®æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆé…ç½®ç®¡ç†æŠ¥å‘Š..."
          npm run config:layers:report > config-report.json

      - name: Base æ–‡æ¡£å ä½ç¬¦å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
        if: github.ref != 'refs/heads/main'
        run: |
          echo "ğŸ”„ å¼€å‘ç¯å¢ƒï¼šéªŒè¯å ä½ç¬¦ä½†ä¸æ›¿æ¢..."
          npm run config:substitute:validate

      - name: Base æ–‡æ¡£å ä½ç¬¦æ›¿æ¢ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
        if: github.ref == 'refs/heads/main'
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          echo "ğŸ”„ ç”Ÿäº§ç¯å¢ƒï¼šæ‰§è¡Œå ä½ç¬¦æ›¿æ¢..."
          npm run config:substitute:docs

      - name: é…ç½®å®Œæ•´æ€§æ£€æŸ¥
        run: |
          echo "âœ… éªŒè¯é…ç½®å®Œæ•´æ€§..."
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf-8'));

          // éªŒè¯å¿…éœ€å­—æ®µ
          const required = ['name', 'version'];
          const missing = required.filter(field => !pkg[field]);

          if (missing.length > 0) {
            console.error('âŒ package.json ç¼ºå°‘å¿…éœ€å­—æ®µ:', missing);
            process.exit(1);
          }

          console.log('âœ… package.json é…ç½®éªŒè¯é€šè¿‡');
          console.log('ğŸ“¦ åº”ç”¨åç§°:', pkg.name);
          console.log('ğŸ·ï¸ ç‰ˆæœ¬:', pkg.version);
          console.log('ğŸ¢ äº§å“åç§°:', pkg.productName || 'æœªè®¾ç½®');
          "

      - name: ä¸Šä¼ é…ç½®æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: config-management-report
          path: |
            logs/
            config-report.json
          retention-days: 30

      # - name: Base æ–‡æ¡£æ¸…æ´æ€§æ£€æŸ¥
      #   run: |
      #     echo "ğŸ§¹ æ£€æŸ¥ Base æ–‡æ¡£æ¸…æ´æ€§..."
      #     npm run guard:base

  documentation-build:
    name: æ–‡æ¡£æ„å»ºä¸å‘å¸ƒå‡†å¤‡
    needs: config-validation-and-docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–ï¼ˆåŠ å›ºç‰ˆï¼‰
        uses: ./.github/actions/npm-install

      - name: å¤„ç†æ–‡æ¡£å ä½ç¬¦
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          NODE_ENV: production
          RELEASE_PREFIX: prod
        run: |
          echo "ğŸ“š ç”Ÿäº§ç¯å¢ƒæ–‡æ¡£å¤„ç†..."

          # 1. æ‰§è¡Œé…ç½®åˆ†å±‚åˆå§‹åŒ–
          npm run config:layers:init

          # 2. å¯¼å‡ºé…ç½®åˆ°å¤šç§æ ¼å¼
          npm run config:layers:export -- --format json --output dist/config
          npm run config:layers:export -- --format typescript --output src/generated/config
          npm run config:layers:export -- --format env --output .env.production

          # 3. å¤„ç†æ–‡æ¡£å ä½ç¬¦æ›¿æ¢
          npm run config:substitute:docs

          # 4. éªŒè¯æ›¿æ¢ç»“æœ
          echo "âœ… éªŒè¯æ–‡æ¡£å¤„ç†ç»“æœ..."
          find docs/architecture/base -name "*.md" -exec grep -l "\${" {} \; | while read file; do
            echo "âš ï¸ $file ä»åŒ…å«æœªå¤„ç†å ä½ç¬¦:"
            grep -n "\${" "$file" || true
          done

      - name: æ„å»ºäº§ç‰©æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©..."
          ls -la dist/ || echo "dist/ ç›®å½•ä¸å­˜åœ¨"
          ls -la src/generated/ || echo "src/generated/ ç›®å½•ä¸å­˜åœ¨"

          # æ£€æŸ¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          if [ -f "src/generated/config.ts" ]; then
            echo "ğŸ“„ ç”Ÿæˆçš„ TypeScript é…ç½®:"
            head -20 src/generated/config.ts
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: processed-documentation
          path: |
            docs/architecture/
            dist/config*
            src/generated/config*
            .env.production
          retention-days: 7

name: Soft Gates (Quality Feedback)

# æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: read
  actions: read

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'tests/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'vite.config.ts'
      - 'vitest.config.ts'
      - '.github/workflows/soft-gates.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'tests/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'vite.config.ts'
      - 'vitest.config.ts'
      - '.github/workflows/soft-gates.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  # Infrastructure-level optimization: Enhanced error handling and caching
  CI_RETRY_COUNT: '3'
  CI_TIMEOUT_MINUTES: '20'
  CACHE_STRATEGY: 'aggressive'
  # Improved logging and monitoring
  ACTIONS_RUNNER_DEBUG: false
  ACTIONS_STEP_DEBUG: false

jobs:
  # è½¯é—¨ç¦å®ˆæŠ¤è‡ªæ£€
  soft-gate-guardian:
    name: ðŸ›¡ï¸ è½¯é—¨ç¦å®ˆæŠ¤æ£€æŸ¥
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«çŽ¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 20

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          # Infrastructure optimization: shallow clone for faster checkout
          fetch-depth: 1

      - name: ðŸ” Actionlint å·¥ä½œæµè¯­æ³•æ£€æŸ¥
        uses: rhysd/actionlint-action@v1.7.7
        with:
          fail-on-error: true
        # Infrastructure-level error recovery: continue workflow even if actionlint fails
        continue-on-error: false

  quality-gate-check:
    name: ðŸ“Š è½¯é—¨ç¦è´¨é‡æ£€æŸ¥
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«çŽ¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 20
    needs: soft-gate-guardian

    # è½¯é—¨ç¦jobéœ€è¦æƒé™åˆ›å»ºcheckså’ŒPRè¯„è®º
    permissions:
      checks: write
      issues: write # PRè¯„è®ºéœ€è¦issuesæƒé™
      contents: read

    # Infrastructure-level optimization: retry strategy for flaky CI
    strategy:
      fail-fast: false
      matrix:
        retry_attempt: [1]

    # è½¯é—¨ç¦æ°¸è¿œä¸åº”è¯¥å¤±è´¥ï¼ˆå³ä½¿æœ‰é—®é¢˜ä¹Ÿè¿”å›žæˆåŠŸï¼‰
    continue-on-error: false

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          # Infrastructure optimization: shallow clone for faster checkout
          fetch-depth: 1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          # Infrastructure optimization: enhanced caching strategy
          cache-dependency-path: |
            package-lock.json
            package.json

      - name: å®‰è£…jqå·¥å…·
        shell: pwsh
        run: |
          # Infrastructure optimization: Windows-compatible package installation
          if (-not (Get-Command jq -ErrorAction SilentlyContinue)) {
            Write-Host "Installing jq tool..."
            if (Get-Command choco -ErrorAction SilentlyContinue) {
              choco install jq -y --no-progress
            } else {
              Write-Host "Chocolatey not available, trying winget..."
              winget install stedolan.jq --accept-source-agreements --accept-package-agreements
            }
          } else {
            Write-Host "jq already available"
          }

      - name: å®‰è£…ä¾èµ– (ä½¿ç”¨å¼ºåŒ–npm-install action)
        uses: ./.github/actions/npm-install
        with:
          working-directory: '.'
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
        shell: pwsh
        run: |
          if (-not (Test-Path "logs")) {
            New-Item -ItemType Directory -Path "logs" -Force
          }

      - name: æ‰§è¡Œè½¯é—¨ç¦æ£€æŸ¥
        id: soft-gates
        run: |
          echo "ðŸš¦ å¼€å§‹æ‰§è¡Œè½¯é—¨ç¦è´¨é‡æ£€æŸ¥..."

          # æ‰§è¡Œè½¯é—¨ç¦è„šæœ¬ï¼ˆæ°¸ä¸å¤±è´¥ï¼‰
          node scripts/soft-gate-reporter.js || {
            echo "âš ï¸ è½¯é—¨ç¦è„šæœ¬æ‰§è¡Œå¼‚å¸¸ï¼Œä½†ä¸é˜»å¡žæµç¨‹"
            echo "soft-gate-score=50" >> $GITHUB_OUTPUT
            echo "soft-gate-status=neutral" >> $GITHUB_OUTPUT
            echo "soft-gate-title=è½¯é—¨ç¦æ‰§è¡Œå¼‚å¸¸" >> $GITHUB_OUTPUT
            echo "soft-gate-summary=æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_OUTPUT
            exit 0
          }

          echo "âœ… è½¯é—¨ç¦æ£€æŸ¥å®Œæˆ"

      - name: è¯»å–è½¯é—¨ç¦è¾“å‡º
        id: read-outputs
        run: |
          # å¦‚æžœGITHUB_OUTPUTä¸­æ²¡æœ‰è½¯é—¨ç¦ç»“æžœï¼Œè®¾ç½®é»˜è®¤å€¼
          if ! grep -q "soft-gate-score=" $GITHUB_OUTPUT 2>/dev/null; then
            echo "soft-gate-score=75" >> $GITHUB_OUTPUT
            echo "soft-gate-status=neutral" >> $GITHUB_OUTPUT
            echo "soft-gate-title=è´¨é‡è¯„åˆ†: 75/100" >> $GITHUB_OUTPUT
            echo "soft-gate-summary=è½¯é—¨ç¦æ£€æŸ¥å®Œæˆ" >> $GITHUB_OUTPUT
            echo "soft-gate-details=æ‰€æœ‰è´¨é‡æ£€æŸ¥é¡¹å·²æ‰§è¡Œå®Œæˆ" >> $GITHUB_OUTPUT
          fi

      - name: ä¸Šä¼ è½¯é—¨ç¦æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: soft-gate-reports
          path: logs/soft-gate-report.json
          retention-days: 30

      - name: åˆ›å»ºä¸­æ€§çŠ¶æ€æ£€æŸ¥
        uses: actions/github-script@v7
        if: always()
        continue-on-error: true # è½¯é—¨ç¦ä¸åº”é˜»æ–­ï¼Œchecksåˆ›å»ºå¤±è´¥ä¹Ÿè¦ç»§ç»­
        with:
          script: |
            // è¯»å–è½¯é—¨ç¦ç»“æžœ
            const fs = require('fs');
            let softGateData;

            try {
              if (fs.existsSync('logs/soft-gate-report.json')) {
                const reportContent = fs.readFileSync('logs/soft-gate-report.json', 'utf8');
                softGateData = JSON.parse(reportContent);
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–è½¯é—¨ç¦æŠ¥å‘Šï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }

            // è®¾ç½®é»˜è®¤å€¼
            const score = softGateData?.overallScore || 75;
            const title = `è´¨é‡è¯„åˆ†: ${score}/100`;
            const summary = softGateData ? 
              `å…±æ‰§è¡Œ${softGateData.summary?.totalGates || 0}é¡¹è´¨é‡æ£€æŸ¥` : 
              'è½¯é—¨ç¦æ£€æŸ¥å®Œæˆ';

            // æž„å»ºè¯¦ç»†æè¿°
            let details = '';
            if (softGateData?.feedback) {
              details = softGateData.feedback.map(f => f.message).join('\n');
            }
            if (softGateData?.recommendations && softGateData.recommendations.length > 0) {
              details += '\n\n**æ”¹è¿›å»ºè®®:**\n' + softGateData.recommendations.join('\n');
            }

            // åˆ›å»ºä¸­æ€§çŠ¶æ€ï¼ˆè½¯é—¨ç¦ç‰¹è‰²ï¼šæä¾›åé¦ˆä½†ä¸é˜»å¡žï¼‰
            const { data: checkRun } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Soft Gates Quality Check',
              head_sha: context.sha,
              status: 'completed',
              conclusion: 'neutral', // å…³é”®ï¼šå§‹ç»ˆä¸ºneutralï¼Œä¸é˜»å¡žåˆå¹¶
              output: {
                title: title,
                summary: summary,
                text: details || 'è´¨é‡æ£€æŸ¥å®Œæˆï¼Œè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æŠ¥å‘Šã€‚'
              }
            });

            console.log(`åˆ›å»ºä¸­æ€§çŠ¶æ€æ£€æŸ¥: ${checkRun.html_url}`);

            // å¦‚æžœæ˜¯PRï¼Œæ·»åŠ è¯„è®ºï¼ˆå®¹é”™å¤„ç†APIé™æµï¼‰
            if (context.payload.pull_request) {
              try {
                const commentBody = `
            ## ðŸ“Š è½¯é—¨ç¦è´¨é‡è¯„åˆ†æŠ¥å‘Š

            **æ€»ä½“è¯„åˆ†**: ${score}/100 â­

            ${summary}

            ${details ? '### è¯¦ç»†åé¦ˆ\n' + details : ''}

            ---

            > ðŸ’¡ **è¯´æ˜Ž**: è½¯é—¨ç¦æä¾›è´¨é‡åé¦ˆä½†ä¸é˜»å¡žåˆå¹¶ã€‚å»ºè®®åœ¨åˆå¹¶å‰è€ƒè™‘æ”¹è¿›å»ºè®®ã€‚
            > 
            > ðŸ“‹ [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)
            `;
                
                await github.rest.issues.createComment({
                  issue_number: context.payload.pull_request.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log(`âœ… PRè¯„è®ºåˆ›å»ºæˆåŠŸ: #${context.payload.pull_request.number}`);
              } catch (error) {
                console.log(`âš ï¸ PRè¯„è®ºåˆ›å»ºå¤±è´¥ï¼ˆAPIé™æµæˆ–æƒé™é—®é¢˜ï¼‰ï¼Œä½†ä¸å½±å“è½¯é—¨ç¦æµç¨‹: ${error.message}`);
                // è½¯é—¨ç¦ï¼šè¯„è®ºå¤±è´¥ä¸åº”é˜»æ–­æµç¨‹
              }
            }

      - name: è¾“å‡ºåˆ°GitHub Step Summary
        if: always()
        shell: bash
        run: |
          # ç¡®ä¿UTF-8ç¼–ç è¾“å‡º
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          # ä½¿ç”¨heredocæ¨¡å¼ä»¥ç¡®ä¿Windowså…¼å®¹UTF-8ç¼–ç 
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
## ðŸ“Š è½¯é—¨ç¦è´¨é‡æ£€æŸ¥ç»“æžœ

EOF

          if [ -f "logs/soft-gate-report.json" ]; then
            # æå–å…³é”®ä¿¡æ¯
            overall_score=$(jq -r '.overallScore // 75' logs/soft-gate-report.json)
            total_gates=$(jq -r '.summary.totalGates // 0' logs/soft-gate-report.json)
            success_count=$(jq -r '.summary.successCount // 0' logs/soft-gate-report.json)
            warning_count=$(jq -r '.summary.warningCount // 0' logs/soft-gate-report.json)
            error_count=$(jq -r '.summary.errorCount // 0' logs/soft-gate-report.json)
            
            echo "### ðŸŽ¯ è´¨é‡è¯„åˆ†: ${overall_score}/100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æ£€æŸ¥é¡¹ç›® | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| æ€»æ£€æŸ¥æ•° | $total_gates |" >> $GITHUB_STEP_SUMMARY
            echo "| æˆåŠŸ | $success_count |" >> $GITHUB_STEP_SUMMARY
            echo "| è­¦å‘Š | $warning_count |" >> $GITHUB_STEP_SUMMARY
            echo "| é”™è¯¯ | $error_count |" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºè¯¦ç»†åé¦ˆ
            if [ "$warning_count" -gt 0 ] || [ "$error_count" -gt 0 ]; then
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'

### ðŸ“ åé¦ˆè¯¦æƒ…

EOF
              
              # æå–åé¦ˆä¿¡æ¯
              jq -r '.feedback[]?.message // empty' logs/soft-gate-report.json | while read -r feedback; do
                echo "- $feedback" >> $GITHUB_STEP_SUMMARY
              done
            fi
            
            # æ˜¾ç¤ºæ”¹è¿›å»ºè®®
            recommendations=$(jq -r '.recommendations // [] | length' logs/soft-gate-report.json)
            if [ "$recommendations" -gt 0 ]; then
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'

### ðŸ’¡ æ”¹è¿›å»ºè®®

EOF
              
              jq -r '.recommendations[] // empty' logs/soft-gate-report.json | while read -r rec; do
                echo "- $rec" >> $GITHUB_STEP_SUMMARY
              done
            fi
            
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
### âš ï¸ æ— æ³•ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
è½¯é—¨ç¦æ£€æŸ¥å®Œæˆï¼Œä½†æŠ¥å‘Šæ–‡ä»¶ç¼ºå¤±ã€‚
EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

---
*ðŸ’¡ è½¯é—¨ç¦æä¾›è´¨é‡åé¦ˆä½†ä¸é˜»å¡žåˆå¹¶ - åŸºäºŽADR-0005è´¨é‡é—¨ç¦æ ‡å‡†*
EOF

      - name: è½¯é—¨ç¦æ°¸è¿œæˆåŠŸ
        if: always()
        run: |
          echo "âœ… è½¯é—¨ç¦æ£€æŸ¥å®Œæˆ"
          echo "ðŸ“Š è´¨é‡è¯„åˆ†å·²ç”Ÿæˆå¹¶é€šè¿‡ä¸­æ€§çŠ¶æ€åé¦ˆ"
          echo "ðŸš€ è½¯é—¨ç¦ä¸é˜»å¡žæµç¨‹ï¼Œæž„å»ºç»§ç»­"
          exit 0

# ==================== å¹¶å‘æŽ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

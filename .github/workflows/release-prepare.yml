name: Release Preparation - 鍙戝竷鍑嗗

# Minimal permissions
  contents: write
  actions: read

defaults:
  run:
    shell: pwsh

on:
  workflow_dispatch:
    inputs:
      version:
        description: '鍙戝竷鐗堟湰鍙?(璇箟鍖栫増鏈?'
        required: true
        type: string
      artifact_path:
        description: '搴旂敤鏂囦欢璺緞'
        required: false
        type: string
        default: 'dist/app.exe'
      create_feeds:
        description: '鍒涘缓鎵€鏈夊钩鍙扮殑 feed 鏂囦欢'
        required: false
        type: boolean
        default: true

env:
  SENTRY_ORG: ${{ vars.SENTRY_ORG || 'your-org' }}
  SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT || 'vitegame' }}

# ==================== 骞跺彂鎺у埗 ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # 鍙戝竷鍑嗗涓嶅彲涓柇

jobs:
  prepare:
    runs-on: windows-latest
    # P0淇锛歫ob绾у埆鐜鍙橀噺纭繚devDependencies姝ｇ‘瀹夎
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Step
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Step
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Step
        uses: ./.github/actions/npm-install
        env:
          NPM_CONFIG_PRODUCTION: 'true'

      - name: Step
        shell: pwsh
        run: |
          # P0淇锛歐indows runner浣跨敤PowerShell鍖呯鐞嗘浛浠inux apt-get
          if (-not (Get-Command jq -ErrorAction SilentlyContinue)) {
            Write-Host "Installing jq tool..."
            if (Get-Command choco -ErrorAction SilentlyContinue) {
              choco install jq -y --no-progress
            } else {
              Write-Host "Chocolatey not available, trying winget..."
              winget install stedolan.jq --accept-source-agreements --accept-package-agreements
            }
          } else {
            Write-Host "jq already available"
          }

      - name: 'Validate version format'
        shell: bash
        run: |
          version="${{ inputs.version }}"
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
            echo "?Invalid version format:$version"
            echo "Expected semantic version (e.g., 1.2.3, 1.2.3-beta.1)"
            exit 1
          fi
          echo "?Version format valid:$version"

      - name: Step
        id: manifest
        shell: bash
        run: |
          artifact_path="${{ inputs.artifact_path }}"

          # 妫€鏌ユ枃浠舵槸鍚﹀瓨鍦紙浠呭湪闈炴祴璇曟ā寮忎笅锛?          if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ -f "$artifact_path" ]; then
            echo "${{ inputs.version }} ?.."
            
            result=$(node scripts/release/manage-manifest.mjs add \
              --version="${{ inputs.version }}" \
              --path="$artifact_path" \
              --manifest="artifacts/manifest.json")
            
            echo "manifest_result=$result" >> "$GITHUB_OUTPUT"
            echo "?"
            echo "$result" | jq '.'
          else
            echo "?$artifact_path"
            echo "..."
            
            # 鍒涘缓娴嬭瘯鍗犱綅鏉＄洰
            mkdir -p artifacts
            if [ ! -f "artifacts/manifest.json" ]; then
              echo '{}' > artifacts/manifest.json
            fi
            
            # 妯℃嫙娣诲姞鐗堟湰鏁版嵁
            cat > temp_version.json << EOF
          {
            "path": "$(basename "$artifact_path")",
            "sha512": "sha512-placeholder-hash-for-testing",
            "size": 52428800,
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "files": [
              {
                "url": "$(basename "$artifact_path")",
                "sha512": "sha512-placeholder-hash-for-testing", 
                "size": 52428800
              }
            ]
          }
          EOF
            
            # 鍚堝苟鍒版竻鍗?- 瀹夊叏璇诲彇JSON鏂囦欢閬垮厤SC2086
            data_content=$(cat temp_version.json)
            jq --arg version "${{ inputs.version }}" \
               --argjson data "$data_content" \
               '.[$version] = $data' artifacts/manifest.json > temp_manifest.json
            mv temp_manifest.json artifacts/manifest.json
            rm temp_version.json
            
            echo "manifest_result={\"ok\":true,\"version\":\"${{ inputs.version }}\",\"test_mode\":true}" >> "$GITHUB_OUTPUT"
            echo "鉁?鍗犱綅鐗堟湰鏉＄洰宸插垱寤?
          fi

      - name: Step
        if: inputs.create_feeds
        shell: bash
        run: |
          version="${{ inputs.version }}"

          echo "electron-updater feed ..."

          # 纭繚 dist 鐩綍瀛樺湪
          mkdir -p dist

          # 浠庢竻鍗曡幏鍙栫増鏈暟鎹?          version_data=$(jq -r --arg version "$version" '.[$version]' artifacts/manifest.json)

          if [ "$version_data" = "null" ]; then
            echo "鉂?鐗堟湰 $version 鍦ㄦ竻鍗曚腑涓嶅瓨鍦?
            exit 1
          fi

          # 鎻愬彇鐗堟湰淇℃伅
          path=$(echo "$version_data" | jq -r '.path')
          sha512=$(echo "$version_data" | jq -r '.sha512')
          size=$(echo "$version_data" | jq -r '.size')
          release_date=$(echo "$version_data" | jq -r '.releaseDate')

          # 鍒涘缓鍩虹 feed 鍐呭
          create_feed() {
            local platform=$1
            local feed_file="dist/latest${platform:+-$platform}.yml"
            
            cat > "$feed_file" << EOF
          version: $version
          files:
            - url: $path
              sha512: $sha512
              size: $size
          path: $path
          sha512: $sha512
          releaseDate: '$release_date'
          stagingPercentage: 0
          size: $size
          EOF
            
            echo "?$feed_file"
          }

          # 鍒涘缓鍚勫钩鍙?feed 鏂囦欢
          create_feed ""        # latest.yml (Windows)
          # Windows-only: removed macOS/Linux feeds

          echo "?feed"

      - name: Step
        run: |
          echo "..."
          node scripts/release/manage-manifest.mjs validate
          echo "?"

      - name: Step
        shell: bash
        run: |
          # 纭繚UTF-8缂栫爜杈撳嚭
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          # 浣跨敤鍗曚竴閲嶅畾鍚戞潵浼樺寲鎬ц兘锛堜慨澶?SC2129锛?          {
            echo "##"
            echo ""
            echo "| | ?|"
            echo "|------|-----|"
            echo "| | \`${{ inputs.version }}\` |"
            echo "| | \`${{ inputs.artifact_path }}\` |"
            echo "| Feed |${{ inputs.create_feeds && '鉁?鏄? || '鉂?鍚? }} |"
            echo ""
            echo "### 馃搵 鐗堟湰娓呭崟鐘舵€?
            echo "\`\`\`json"
            node scripts/release/manage-manifest.mjs list | jq '.'
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ inputs.create_feeds }}" = "true" ]; then
            {
              echo ""
              echo "### ?Feed"
              echo "- \`dist/latest.yml\` (Windows)"
              echo "- \`dist/latest-mac.yml\` (macOS)"  
              echo "- \`dist/latest-linux.yml\` (Linux)"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "### 馃幆 涓嬩竴姝?
            echo "1. 杩愯 **Release Ramp** 宸ヤ綔娴佸紑濮嬫笎杩涘彂甯?
            echo "2. ?5% ?25% ?50% ?100%"
            echo "3. 姣忎釜闃舵閮戒細鑷姩杩涜鍋ュ悍搴︽鏌?
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Step
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 妫€鏌ユ槸鍚︽湁鍙樻洿
          if git diff --quiet && git diff --cached --quiet; then
            echo "馃摑 鏃犲彉鏇撮渶瑕佹彁浜?
            exit 0
          fi

          # 鎻愪氦鍙樻洿
          git add artifacts/manifest.json
          if [ "${{ inputs.create_feeds }}" = "true" ]; then
            git add dist/latest*.yml
          fi

          git commit -m "馃摝 Release preparation: v${{ inputs.version }}" \
            -m "Version: ${{ inputs.version }}" \
            -m "Artifact: ${{ inputs.artifact_path }}" \
            -m "Feed files: ${{ inputs.create_feeds }}" \
            -m "" \
            -m "馃 Generated by GitHub Actions" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run: ${{ github.run_number }}"

          echo "鉁?鍙樻洿宸叉彁浜?

      - name: Step
        run: |
          echo "..."
          git push origin ${{ github.ref }}
          echo "?"


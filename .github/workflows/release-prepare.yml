name: Release Preparation - å‘å¸ƒå‡†å¤‡

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (è¯­ä¹‰åŒ–ç‰ˆæœ¬)'
        required: true
        type: string
      artifact_path:
        description: 'åº”ç”¨æ–‡ä»¶è·¯å¾„'
        required: false
        type: string
        default: 'dist/app.exe'
      create_feeds:
        description: 'åˆ›å»ºæ‰€æœ‰å¹³å°çš„ feed æ–‡ä»¶'
        required: false
        type: boolean
        default: true

env:
  SENTRY_ORG: ${{ vars.SENTRY_ORG || 'your-org' }}
  SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT || 'vitegame' }}

# ==================== å¹¶å‘æ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # å‘å¸ƒå‡†å¤‡ä¸å¯ä¸­æ–­

jobs:
  prepare:
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: 'ğŸš€ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ğŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ğŸ”§ Install dependencies'
        uses: ./.github/actions/npm-install
        env:
          NPM_CONFIG_PRODUCTION: 'true'

      - name: 'ğŸ› ï¸ Install system tools'
        shell: pwsh
        run: |
          # P0ä¿®å¤ï¼šWindows runnerä½¿ç”¨PowerShellåŒ…ç®¡ç†æ›¿ä»£Linux apt-get
          if (-not (Get-Command jq -ErrorAction SilentlyContinue)) {
            Write-Host "Installing jq tool..."
            if (Get-Command choco -ErrorAction SilentlyContinue) {
              choco install jq -y --no-progress
            } else {
              Write-Host "Chocolatey not available, trying winget..."
              winget install stedolan.jq --accept-source-agreements --accept-package-agreements
            }
          } else {
            Write-Host "jq already available"
          }

      - name: 'âœ… Validate version format'
        run: |
          version="${{ inputs.version }}"
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
            echo "âŒ Invalid version format: $version"
            echo "Expected semantic version (e.g., 1.2.3, 1.2.3-beta.1)"
            exit 1
          fi
          echo "âœ… Version format valid: $version"

      - name: 'ğŸ“‹ Add version to manifest'
        id: manifest
        shell: bash
        run: |
          artifact_path="${{ inputs.artifact_path }}"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆä»…åœ¨éæµ‹è¯•æ¨¡å¼ä¸‹ï¼‰
          if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ -f "$artifact_path" ]; then
            echo "ğŸ“¦ æ·»åŠ ç‰ˆæœ¬ ${{ inputs.version }} åˆ°æ¸…å•..."
            
            result=$(node scripts/release/manage-manifest.mjs add \
              --version="${{ inputs.version }}" \
              --path="$artifact_path" \
              --manifest="artifacts/manifest.json")
            
            echo "manifest_result=$result" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬å·²æ·»åŠ åˆ°æ¸…å•"
            echo "$result" | jq '.'
          else
            echo "âš ï¸  åº”ç”¨æ–‡ä»¶ä¸å­˜åœ¨: $artifact_path"
            echo "åˆ›å»ºå ä½æ¸…å•æ¡ç›®ç”¨äºæµ‹è¯•..."
            
            # åˆ›å»ºæµ‹è¯•å ä½æ¡ç›®
            mkdir -p artifacts
            if [ ! -f "artifacts/manifest.json" ]; then
              echo '{}' > artifacts/manifest.json
            fi
            
            # æ¨¡æ‹Ÿæ·»åŠ ç‰ˆæœ¬æ•°æ®
            cat > temp_version.json << EOF
          {
            "path": "$(basename "$artifact_path")",
            "sha512": "sha512-placeholder-hash-for-testing",
            "size": 52428800,
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "files": [
              {
                "url": "$(basename "$artifact_path")",
                "sha512": "sha512-placeholder-hash-for-testing", 
                "size": 52428800
              }
            ]
          }
          EOF
            
            # åˆå¹¶åˆ°æ¸…å• - å®‰å…¨è¯»å–JSONæ–‡ä»¶é¿å…SC2086
            data_content=$(cat temp_version.json)
            jq --arg version "${{ inputs.version }}" \
               --argjson data "$data_content" \
               '.[$version] = $data' artifacts/manifest.json > temp_manifest.json
            mv temp_manifest.json artifacts/manifest.json
            rm temp_version.json
            
            echo "manifest_result={\"ok\":true,\"version\":\"${{ inputs.version }}\",\"test_mode\":true}" >> $GITHUB_OUTPUT
            echo "âœ… å ä½ç‰ˆæœ¬æ¡ç›®å·²åˆ›å»º"
          fi

      - name: 'ğŸ“„ Create feed files'
        if: inputs.create_feeds
        run: |
          version="${{ inputs.version }}"
          artifact_name="$(basename "${{ inputs.artifact_path }}")"

          echo "ğŸ“„ åˆ›å»º electron-updater feed æ–‡ä»¶..."

          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          mkdir -p dist

          # ä»æ¸…å•è·å–ç‰ˆæœ¬æ•°æ®
          version_data=$(jq -r --arg version "$version" '.[$version]' artifacts/manifest.json)

          if [ "$version_data" = "null" ]; then
            echo "âŒ ç‰ˆæœ¬ $version åœ¨æ¸…å•ä¸­ä¸å­˜åœ¨"
            exit 1
          fi

          # æå–ç‰ˆæœ¬ä¿¡æ¯
          path=$(echo "$version_data" | jq -r '.path')
          sha512=$(echo "$version_data" | jq -r '.sha512')
          size=$(echo "$version_data" | jq -r '.size')
          release_date=$(echo "$version_data" | jq -r '.releaseDate')

          # åˆ›å»ºåŸºç¡€ feed å†…å®¹
          create_feed() {
            local platform=$1
            local feed_file="dist/latest${platform:+-$platform}.yml"
            
            cat > "$feed_file" << EOF
          version: $version
          files:
            - url: $path
              sha512: $sha512
              size: $size
          path: $path
          sha512: $sha512
          releaseDate: '$release_date'
          stagingPercentage: 0
          size: $size
          EOF
            
            echo "âœ… åˆ›å»º $feed_file"
          }

          # åˆ›å»ºå„å¹³å° feed æ–‡ä»¶
          create_feed ""        # latest.yml (Windows)
          create_feed "mac"     # latest-mac.yml
          create_feed "linux"   # latest-linux.yml

          echo "ğŸ“„ æ‰€æœ‰ feed æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: 'ğŸ” Validate manifest'
        run: |
          echo "ğŸ” éªŒè¯ç‰ˆæœ¬æ¸…å•æ ¼å¼..."
          node scripts/release/manage-manifest.mjs validate
          echo "âœ… æ¸…å•éªŒè¯é€šè¿‡"

      - name: 'ğŸ“Š Display preparation summary'
        run: |
          # ç¡®ä¿UTF-8ç¼–ç è¾“å‡º
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          {
            echo "## ğŸ“¦ å‘å¸ƒå‡†å¤‡å®Œæˆ"
            echo ""
            echo "| é¡¹ç›® | å€¼ |"
            echo "|------|-----|"
            echo "| ç‰ˆæœ¬ | \`${{ inputs.version }}\` |"
            echo "| åº”ç”¨æ–‡ä»¶ | \`${{ inputs.artifact_path }}\` |"
            echo "| åˆ›å»º Feed æ–‡ä»¶ | ${{ inputs.create_feeds && 'âœ… æ˜¯' || 'âŒ å¦' }} |"
            echo ""
            echo "### ğŸ“‹ ç‰ˆæœ¬æ¸…å•çŠ¶æ€"
            echo "\`\`\`json"
          } >> "$GITHUB_STEP_SUMMARY"

          node scripts/release/manage-manifest.mjs list | jq '.' >> "$GITHUB_STEP_SUMMARY"

          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ inputs.create_feeds }}" = "true" ]; then
            {
              echo ""
              echo "### ğŸ“„ åˆ›å»ºçš„ Feed æ–‡ä»¶"
              echo "- \`dist/latest.yml\` (Windows)"
              echo "- \`dist/latest-mac.yml\` (macOS)"  
              echo "- \`dist/latest-linux.yml\` (Linux)"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "### ğŸ¯ ä¸‹ä¸€æ­¥"
            echo "1. è¿è¡Œ **Release Ramp** å·¥ä½œæµå¼€å§‹æ¸è¿›å‘å¸ƒ"
            echo "2. ä» 5% â†’ 25% â†’ 50% â†’ 100% é€æ­¥æ”¾é‡"
            echo "3. æ¯ä¸ªé˜¶æ®µéƒ½ä¼šè‡ªåŠ¨è¿›è¡Œå¥åº·åº¦æ£€æŸ¥"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: 'ğŸ’¾ Commit changes'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --cached --quiet; then
            echo "ğŸ“ æ— å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi

          # æäº¤å˜æ›´
          git add artifacts/manifest.json
          if [ "${{ inputs.create_feeds }}" = "true" ]; then
            git add dist/latest*.yml
          fi

          git commit -m "ğŸ“¦ Release preparation: v${{ inputs.version }}" \
            -m "Version: ${{ inputs.version }}" \
            -m "Artifact: ${{ inputs.artifact_path }}" \
            -m "Feed files: ${{ inputs.create_feeds }}" \
            -m "" \
            -m "ğŸ¤– Generated by GitHub Actions" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run: ${{ github.run_number }}"

          echo "âœ… å˜æ›´å·²æäº¤"

      - name: 'ğŸš€ Push changes'
        run: |
          echo "ğŸ“¤ æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
          git push origin ${{ github.ref }}
          echo "âœ… å‘å¸ƒå‡†å¤‡å®Œæˆ"

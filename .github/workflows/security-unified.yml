name: Security Gate (Unified)

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write
  issues: write
  id-token: write

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig*.json'
      - 'vite.config.ts'
      - '.github/workflows/security-unified.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig*.json'
      - 'vite.config.ts'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šç›¸åŒåˆ†æ”¯åªè¿è¡Œä¸€ä¸ªå®ä¾‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'

jobs:
  # é˜¶æ®µ1ï¼šé™æ€å®‰å…¨æ‰«æï¼ˆå¿«é€Ÿï¼Œå¹¶è¡Œæ‰§è¡Œï¼‰
  # å…¼å®¹æ€§ï¼šä¿æŒä¸ç°æœ‰åˆ†æ”¯ä¿æŠ¤è§„åˆ™å…¼å®¹çš„jobåç§°
  security-scan:
    name: ğŸ“Š é™æ€å®‰å…¨æ‰«æï¼ˆç»Ÿä¸€ï¼‰
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 10

    outputs:
      scan-status: ${{ steps.static-scan.outputs.status }}
      critical-count: ${{ steps.static-scan.outputs.critical-count }}
      high-count: ${{ steps.static-scan.outputs.high-count }}

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: å®‰è£…jqå·¥å…·
        shell: pwsh
        run: |
          # P0ä¿®å¤ï¼šWindows runnerä½¿ç”¨PowerShellåŒ…ç®¡ç†æ›¿ä»£Linux apt-get
          if (-not (Get-Command jq -ErrorAction SilentlyContinue)) {
            Write-Host "Installing jq tool..."
            if (Get-Command choco -ErrorAction SilentlyContinue) {
              choco install jq -y --no-progress
            } else {
              Write-Host "Chocolatey not available, trying winget..."
              winget install stedolan.jq --accept-source-agreements --accept-package-agreements
            }
          } else {
            Write-Host "jq already available"
          }

      - name: å®‰è£…é™æ€å®‰å…¨æ‰«æå·¥å…·
        run: |
          npm install -g @doyensec/electronegativity@1.10.3
          npm install -g snyk
          npm install -g audit-ci

      - name: æ‰§è¡ŒElectronegativityæ‰«æ
        id: electronegativity
        shell: bash
        run: |
          echo "ğŸ” è¿è¡ŒElectronegativityå®‰å…¨æ‰«æ..."
          electronegativity --input . --output electronegativity-scan.csv --verbose false --electron-version 37.0.0 || echo "âš ï¸ æ‰«æå®Œæˆä½†æœ‰è­¦å‘Š"

          if [ -f electronegativity-scan.csv ]; then
            echo "âœ… Electronegativityæ‰«æå®Œæˆ"
            echo "electronegativity-status=success" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Electronegativityæ‰«æå¤±è´¥"
            echo "electronegativity-status=failed" >> "$GITHUB_OUTPUT"
          fi

      - name: æ‰§è¡Œnpm audit
        id: npm-audit
        shell: bash
        run: |
          echo "ğŸ” è¿è¡Œnpm audit..."
          npm audit --audit-level high --json > npm-audit-results.json || true

          if [ -f npm-audit-results.json ]; then
            echo "âœ… npm auditå®Œæˆ"
            echo "npm-audit-status=success" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ npm auditå¤±è´¥"
            echo "npm-audit-status=failed" >> "$GITHUB_OUTPUT"
          fi

      - name: æ‰§è¡ŒSnykæ‰«æï¼ˆå¦‚æœæœ‰Tokenï¼‰
        id: snyk-scan
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "ğŸ” è¿è¡ŒSnykæ‰«æ..."
            snyk test --json > snyk-results.json || true
            snyk monitor || true
            echo "âœ… Snykæ‰«æå®Œæˆ"
            echo "snyk-status=success" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ è·³è¿‡Snykæ‰«æï¼ˆæ— SNYK_TOKENï¼‰"
            echo "snyk-status=skipped" >> "$GITHUB_OUTPUT"
          fi

      - name: å®‰è£…TruffleHogå·¥å…·ï¼ˆWindowsåŸç”Ÿï¼‰
        shell: pwsh
        run: |
          Write-Host "Installing TruffleHog via Chocolatey..."
          choco install trufflehog -y --no-progress
          trufflehog --version
          Write-Host "âœ… TruffleHogå®‰è£…å®Œæˆ"

      - name: æ£€æŸ¥ç§˜é’¥æ³„éœ²ï¼ˆWindowsåŸç”Ÿï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ” è¿è¡ŒTruffleHogç§˜é’¥æ‰«æ..."
          
          # PRåœºæ™¯ï¼šä½¿ç”¨gitå¢é‡æ‰«æï¼ˆæ›´å¿«æ›´å‡†ï¼‰
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            Write-Host "PRæ¨¡å¼ï¼šæ‰§è¡Œå¢é‡gitæ‰«æï¼ˆbase: ${{ github.event.pull_request.base.sha }} -> head: ${{ github.sha }}ï¼‰"
            # ä½¿ç”¨PowerShellè°ƒç”¨bashæ¥æ‰§è¡Œgitå‘½ä»¤ï¼ˆé¿å…Windowsè·¯å¾„é—®é¢˜ï¼‰
            bash -c "trufflehog git '${{ github.event.pull_request.base.sha }}' '${{ github.sha }}' --results=verified,unknown --only-verified --fail --json" | Out-File -FilePath "trufflehog-pr.json" -Encoding UTF8
            $scanFile = "trufflehog-pr.json"
          } else {
            Write-Host "ä¸»åˆ†æ”¯æ¨¡å¼ï¼šæ‰§è¡Œå…¨é‡filesystemæ‰«æ"
            # 1) é™å™ªï¼šä½¿ç”¨æ’é™¤åˆ—è¡¨è·³è¿‡äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ„å»ºäº§ç‰©
            # 2) æ­£ç¡®å¤±è´¥æ¡ä»¶ï¼šåªå› å·²éªŒè¯å¯†é’¥è€Œå¤±è´¥ï¼ŒæœªéªŒè¯å¯†é’¥ä»…ä½œå‘Šè­¦
            trufflehog filesystem . `
              --results=verified,unknown `
              --only-verified `
              --fail `
              --json | Out-File -FilePath "trufflehog-scan.json" -Encoding UTF8
            $scanFile = "trufflehog-scan.json"
          }
          
          # ä¸¥æ ¼æŒ‰ç…§é€€å‡ºç å¤„ç†
          $code = $LASTEXITCODE
          if ($code -eq 0) {
            Write-Host "âœ… æœªå‘ç°å·²éªŒè¯çš„å¯†é’¥"
          } elseif ($code -eq 183) {
            Write-Host "âŒ å‘ç°å·²éªŒè¯å¯†é’¥ï¼Œè¯¦è§ $scanFile"
            # è¾“å‡ºå‘ç°çš„å†…å®¹ç”¨äºè°ƒè¯•
            if (Test-Path $scanFile) {
              $content = Get-Content $scanFile -Raw
              if ($content -and $content.Trim() -ne "") {
                Write-Host "ğŸš¨ æ£€æµ‹åˆ°å·²éªŒè¯çš„ç§˜é’¥æ³„éœ²"
              }
            }
            exit 1
          } else {
            Write-Host "âŒ TruffleHog æ‰«æå‘ç”Ÿé”™è¯¯ï¼ˆexit $codeï¼‰"
            exit $code
          }

      - name: æ±‡æ€»é™æ€æ‰«æç»“æœ
        id: static-scan
        shell: bash
        continue-on-error: false
        run: |
          echo "ğŸ“Š æ±‡æ€»é™æ€å®‰å…¨æ‰«æç»“æœ..."

          CRITICAL_COUNT=0
          HIGH_COUNT=0

          # å¤„ç†Electronegativityç»“æœï¼ˆä¿®æ­£ï¼šç¬¬2åˆ—æ˜¯severityï¼Œå¤„ç†å¼•å·ï¼‰
          if [ -f electronegativity-scan.csv ]; then
            ELECTRO_CRITICAL=$(awk -F',' 'NR>1 && $2=="\"CRITICAL\"" {count++} END {print count+0}' electronegativity-scan.csv)
            ELECTRO_HIGH=$(awk -F',' 'NR>1 && $2=="\"HIGH\"" {count++} END {print count+0}' electronegativity-scan.csv)
            CRITICAL_COUNT=$((CRITICAL_COUNT + ELECTRO_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + ELECTRO_HIGH))
            echo "Electronegativity - Critical: $ELECTRO_CRITICAL, High: $ELECTRO_HIGH"
          fi

          # å¤„ç†npm auditç»“æœ
          if [ -f npm-audit-results.json ]; then
            NPM_CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json 2>/dev/null || echo "0")
            NPM_HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json 2>/dev/null || echo "0")
            CRITICAL_COUNT=$((CRITICAL_COUNT + NPM_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + NPM_HIGH))
            echo "npm audit - Critical: $NPM_CRITICAL, High: $NPM_HIGH"
          fi

          # å¤„ç†Snykç»“æœ
          if [ -f snyk-results.json ]; then
            SNYK_CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-results.json 2>/dev/null || echo "0")
            SNYK_HIGH=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-results.json 2>/dev/null || echo "0")
            CRITICAL_COUNT=$((CRITICAL_COUNT + SNYK_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + SNYK_HIGH))
            echo "Snyk - Critical: $SNYK_CRITICAL, High: $SNYK_HIGH"
          fi

          echo "ğŸ“Š é™æ€æ‰«ææ±‡æ€»ï¼š"
          echo "  Criticalæ€»è®¡: $CRITICAL_COUNT"
          echo "  Highæ€»è®¡: $HIGH_COUNT"

          # è¾“å‡ºç»“æœ
          echo "critical-count=$CRITICAL_COUNT" >> "$GITHUB_OUTPUT"
          echo "high-count=$HIGH_COUNT" >> "$GITHUB_OUTPUT"

          # ADR-0002 ç¡¬å¤±è´¥é€»è¾‘ï¼šCritical=0, Highâ‰¤3
          if [ $CRITICAL_COUNT -gt 0 ]; then
            echo "status=failed" >> "$GITHUB_OUTPUT"
            echo "âŒ [ç¡¬å¤±è´¥] å‘ç° $CRITICAL_COUNT ä¸ªCriticalçº§åˆ«å®‰å…¨é—®é¢˜ï¼Œæ ¹æ®ADR-0002å¿…é¡»ä¸º0"
            echo "ğŸš¨ é—¨ç¦å°†å¼ºåˆ¶å¤±è´¥ï¼Œç¦æ­¢åˆå¹¶"
            exit 1
          elif [ $HIGH_COUNT -gt 3 ]; then
            echo "status=failed" >> "$GITHUB_OUTPUT"
            echo "âŒ [ç¡¬å¤±è´¥] å‘ç° $HIGH_COUNT ä¸ªHighçº§åˆ«å®‰å…¨é—®é¢˜ï¼Œæ ¹æ®ADR-0002æœ€å¤§å…è®¸3ä¸ª"
            echo "ğŸš¨ é—¨ç¦å°†å¼ºåˆ¶å¤±è´¥ï¼Œç¦æ­¢åˆå¹¶"
            exit 1
          else
            echo "status=pass" >> "$GITHUB_OUTPUT"
            echo "âœ… é™æ€å®‰å…¨æ‰«æé€šè¿‡ADR-0002åŸºçº¿è¦æ±‚"
          fi

      - name: ä¸Šä¼ é™æ€æ‰«ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-security-reports
          path: |
            electronegativity-scan.csv
            npm-audit-results.json
            snyk-results.json
            trufflehog-scan.json
            trufflehog-pr.json
          retention-days: 30

  # é˜¶æ®µ2ï¼šE2Eå®‰å…¨æµ‹è¯•ï¼ˆä»…åœ¨é™æ€æ‰«æé€šè¿‡ä¸”criticalé—®é¢˜ä¸º0æ—¶è¿è¡Œï¼‰
  e2e-security-test:
    name: ğŸ§ª E2Eå®‰å…¨æµ‹è¯•
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: security-scan
    if: needs.security-scan.outputs.critical-count == '0'
    timeout-minutes: 15

    outputs:
      e2e-status: ${{ steps.e2e-test.outputs.status }}

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: å®‰è£…Playwrightæµè§ˆå™¨
        run: npx playwright install --with-deps

      - name: æ„å»ºElectronåº”ç”¨
        run: |
          npm run build
          npm run build:electron

      - name: æ‰§è¡ŒE2Eå®‰å…¨æµ‹è¯•
        id: e2e-test
        shell: bash
        run: |
          echo "ğŸ§ª å¼€å§‹E2Eå®‰å…¨æµ‹è¯•..."
          if npm run test:e2e:security; then
            echo "âœ… E2Eå®‰å…¨æµ‹è¯•é€šè¿‡"
            echo "status=pass" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ E2Eå®‰å…¨æµ‹è¯•å¤±è´¥"
            echo "status=failed" >> "$GITHUB_OUTPUT"
          fi
        env:
          CI: true

      - name: ä¸Šä¼ E2Eæµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-security-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # é˜¶æ®µ3ï¼šç»Ÿä¸€å®‰å…¨é—¨ç¦å†³ç­–
  unified-security-gate:
    name: ğŸš¦ ç»Ÿä¸€å®‰å…¨é—¨ç¦
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [security-scan, e2e-security-test]
    if: always()

    # æ­¤ä½œä¸šéœ€è¦åˆ›å»ºIssueçš„æƒé™
    permissions:
      contents: read
      issues: write
      actions: read

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
        shell: bash
        run: mkdir -p logs

      - name: æ‰§è¡Œç»Ÿä¸€å®‰å…¨é—¨ç¦æ£€æŸ¥
        continue-on-error: false
        shell: bash
        run: |
          echo "ğŸ”’ å¼€å§‹æ‰§è¡Œç»Ÿä¸€å®‰å…¨é—¨ç¦æ£€æŸ¥..."

          # ADR-0002 ç¡¬å¤±è´¥æ£€æŸ¥ï¼šé™æ€æ‰«æå¿…é¡»é€šè¿‡
          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "âŒ [ç¡¬å¤±è´¥] é™æ€å®‰å…¨æ‰«ææœªé€šè¿‡ï¼Œè¿åADR-0002å®‰å…¨åŸºçº¿"
            echo "ğŸš¨ Criticalæˆ–Highå®‰å…¨é—®é¢˜é˜»æ­¢åˆå¹¶"
            exit 1
          fi

          # ä½¿ç”¨æˆ‘ä»¬çš„å®‰å…¨é—¨ç¦åŒ…è£…è„šæœ¬
          if ! node scripts/security-gate-wrapper.js; then
            echo "âŒ [ç¡¬å¤±è´¥] å®‰å…¨é—¨ç¦åŒ…è£…è„šæœ¬æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
        env:
          STATIC_SCAN_STATUS: ${{ needs.security-scan.outputs.scan-status }}
          CRITICAL_COUNT: ${{ needs.security-scan.outputs.critical-count }}
          HIGH_COUNT: ${{ needs.security-scan.outputs.high-count }}
          E2E_STATUS: ${{ needs.e2e-security-test.outputs.e2e-status }}

      - name: ä¸‹è½½æ‰€æœ‰å®‰å…¨æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ç”Ÿæˆç»Ÿä¸€å®‰å…¨æŠ¥å‘Š
        shell: bash
        run: |
          echo "ğŸ“Š ç”Ÿæˆç»Ÿä¸€å®‰å…¨é—¨ç¦æŠ¥å‘Š..."

          # åˆ›å»ºåŒ…å«æ‰€æœ‰ç»“æœçš„ç»¼åˆæŠ¥å‘Š
          cat > logs/unified-security-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_sha": "$GITHUB_SHA",
            "git_ref": "$GITHUB_REF_NAME",
            "workflow_run": "$GITHUB_RUN_ID",
            "static_scan": {
              "status": "${{ needs.security-scan.outputs.scan-status }}",
              "critical_count": ${{ needs.security-scan.outputs.critical-count }},
              "high_count": ${{ needs.security-scan.outputs.high-count }}
            },
            "e2e_test": {
              "status": "${{ needs.e2e-security-test.outputs.e2e-status }}",
              "executed": "${{ needs.e2e-security-test.result != 'skipped' }}"
            },
            "overall_status": "$([ "${{ needs.security-scan.outputs.critical-count }}" = "0" ] && [ "${{ needs.e2e-security-test.outputs.e2e-status }}" != "failed" ] && echo "PASS" || echo "FAIL")"
          }
          EOF

      - name: ä¸Šä¼ ç»Ÿä¸€å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unified-security-report
          path: |
            logs/security-gate-report.json
            logs/unified-security-report.json
          retention-days: 30

      - name: å®‰å…¨é—¨ç¦ç»“æœæ‘˜è¦
        shell: bash
        run: |
          # ç¡®ä¿UTF-8ç¼–ç è¾“å‡º
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          # ç”Ÿæˆå®‰å…¨é—¨ç¦ç»“æœæ‘˜è¦
          scan_result="${{ needs.security-scan.result }}"
          e2e_status="${{ needs.e2e-security-test.outputs.e2e-status }}"
          critical_count="${{ needs.security-scan.outputs.critical-count }}"
          high_count="${{ needs.security-scan.outputs.high-count }}"
          
          # ç¡®å®šç»“æœçŠ¶æ€å’Œæ¶ˆæ¯
          if [ "$scan_result" != "success" ]; then
            result_title="### âŒ å®‰å…¨é—¨ç¦ç¡¬å¤±è´¥"
            {
              echo "**ADR-0002è¿å**: é™æ€å®‰å…¨æ‰«ææœªé€šè¿‡åŸºçº¿è¦æ±‚"
              echo "- Criticalå®‰å…¨é—®é¢˜: ${critical_count}ä¸ªï¼ˆè¦æ±‚: 0ä¸ªï¼‰"
              echo "- Highå®‰å…¨é—®é¢˜: ${high_count}ä¸ªï¼ˆè¦æ±‚: â‰¤3ä¸ªï¼‰"
              echo ""
              echo "ğŸš¨ **æ­¤PRè¢«ç¡¬æ€§é˜»æ­¢åˆå¹¶ï¼Œå¿…é¡»ä¿®å¤æ‰€æœ‰å®‰å…¨é—®é¢˜**"
            } > /tmp/result_msg.txt
            result_message=$(cat /tmp/result_msg.txt)
            exit_code=1
          elif [ "$e2e_status" = "failed" ]; then
            result_title="### âŒ å®‰å…¨é—¨ç¦ç¡¬å¤±è´¥"
            {
              echo "**ADR-0002è¿å**: E2Eå®‰å…¨æµ‹è¯•å¤±è´¥"
              echo "è¯·æ£€æŸ¥Electronå®‰å…¨é…ç½®ï¼š"
              echo "- nodeIntegration=false âœ“"
              echo "- contextIsolation=true âœ“"
              echo "- sandbox=true âœ“"
              echo ""
              echo "ğŸš¨ **æ­¤PRè¢«ç¡¬æ€§é˜»æ­¢åˆå¹¶ï¼Œå¿…é¡»ä¿®å¤Electronå®‰å…¨é…ç½®**"
            } > /tmp/result_msg.txt
            result_message=$(cat /tmp/result_msg.txt)
            exit_code=1
          else
            result_title="### âœ… å®‰å…¨é—¨ç¦é€šè¿‡"
            {
              echo "**ADR-0002åˆè§„**: æ‰€æœ‰å®‰å…¨æ£€æŸ¥å‡å·²é€šè¿‡ï¼Œç¬¦åˆä¸¥æ ¼å®‰å…¨åŸºçº¿è¦æ±‚"
              echo "- Criticalå®‰å…¨é—®é¢˜: 0ä¸ª âœ…"
              echo "- Highå®‰å…¨é—®é¢˜: ${high_count}ä¸ª (â‰¤3) âœ…"
              echo "- E2Eå®‰å…¨æµ‹è¯•: é€šè¿‡ âœ…"
            } > /tmp/result_msg.txt
            result_message=$(cat /tmp/result_msg.txt)
            exit_code=0
          fi
          
          # ä¸€æ¬¡æ€§å†™å…¥æ‰€æœ‰å†…å®¹åˆ°Summary
          {
            echo "## ğŸ”’ ç»Ÿä¸€å®‰å…¨é—¨ç¦ç»“æœ"
            echo ""
            echo "### ğŸ“Š æ£€æŸ¥æ‘˜è¦"
            echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | ç»“æœ |"
            echo "|---------|------|------|"
            echo "| é™æ€å®‰å…¨æ‰«æ | ${{ needs.security-scan.outputs.scan-status }} | Critical: ${critical_count}, High: ${high_count} |"
            echo "| E2Eå®‰å…¨æµ‹è¯• | ${e2e_status} | ${{ needs.e2e-security-test.result != 'skipped' && 'æ‰§è¡Œå®Œæˆ' || 'è·³è¿‡ï¼ˆå­˜åœ¨Criticalé—®é¢˜ï¼‰' }} |"
            echo ""
            echo "$result_title"
            echo "$result_message"
          } >> "$GITHUB_STEP_SUMMARY"
          
          # ADR-0002 å¼ºåˆ¶ç¡¬å¤±è´¥å†³ç­–
          if [ "$exit_code" -eq 1 ]; then
            exit 1
          fi

      - name: å¤±è´¥æ—¶åˆ›å»ºIssue
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const title = `ğŸ”’ ç»Ÿä¸€å®‰å…¨é—¨ç¦å¤±è´¥ - ${context.payload.head_commit?.message || context.payload.pull_request?.title || 'Security Check'}`;
            const body = `
            ## ğŸš¨ ç»Ÿä¸€å®‰å…¨é—¨ç¦å¤±è´¥æŠ¥å‘Š

            **æäº¤**: ${context.sha}
            **åˆ†æ”¯**: ${context.ref}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}

            ### ğŸ“Š æ£€æŸ¥ç»“æœ
            - **é™æ€æ‰«æçŠ¶æ€**: ${{ needs.security-scan.outputs.scan-status }}
            - **Criticalé—®é¢˜**: ${{ needs.security-scan.outputs.critical-count }}ä¸ª
            - **Highé—®é¢˜**: ${{ needs.security-scan.outputs.high-count }}ä¸ª
            - **E2Eæµ‹è¯•çŠ¶æ€**: ${{ needs.e2e-security-test.outputs.e2e-status }}

            ### ğŸ“‹ éœ€è¦æ£€æŸ¥çš„é¡¹ç›®
            - [ ] ä¿®å¤æ‰€æœ‰Criticalçº§åˆ«å®‰å…¨é—®é¢˜
            - [ ] æ£€æŸ¥Electronå®‰å…¨é…ç½®ï¼ˆnodeIntegration=false, contextIsolation=trueï¼‰
            - [ ] éªŒè¯CSPå®‰å…¨ç­–ç•¥
            - [ ] æ£€æŸ¥IPCé€šé“å®‰å…¨æ€§
            - [ ] éªŒè¯é¢„åŠ è½½è„šæœ¬å®‰å…¨æ€§

            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [ä¸‹è½½å®‰å…¨æŠ¥å‘Š](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            **å®‰å…¨é—¨ç¦å¤±è´¥æ„å‘³ç€åº”ç”¨å­˜åœ¨å®‰å…¨é£é™©ï¼Œè¯·ç«‹å³ä¿®å¤åå†å‘å¸ƒï¼**

            > æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º - åŸºäºADR-0002ç»Ÿä¸€å®‰å…¨é—¨ç¦æ ‡å‡†
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'bug', 'urgent', 'P0']
            });

name: Security Gate (Unified)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'package.json'
      - 'package-lock.json'
      - 'scripts/security-gate-wrapper.js'
      - '.github/workflows/security-unified.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'electron/**' 
      - 'package.json'
      - 'package-lock.json'
      - 'scripts/security-gate-wrapper.js'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šç›¸åŒåˆ†æ”¯åªè¿è¡Œä¸€ä¸ªå®ä¾‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'

jobs:
  # é˜¶æ®µ1ï¼šé™æ€å®‰å…¨æ‰«æï¼ˆå¿«é€Ÿï¼Œå¹¶è¡Œæ‰§è¡Œï¼‰
  # å…¼å®¹æ€§ï¼šä¿æŒä¸ç°æœ‰åˆ†æ”¯ä¿æŠ¤è§„åˆ™å…¼å®¹çš„jobåç§°
  å®‰å…¨æ‰«æ:
    name: ğŸ“Š é™æ€å®‰å…¨æ‰«æï¼ˆç»Ÿä¸€ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      scan-status: ${{ steps.static-scan.outputs.status }}
      critical-count: ${{ steps.static-scan.outputs.critical-count }}
      high-count: ${{ steps.static-scan.outputs.high-count }}

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: å®‰è£…é™æ€å®‰å…¨æ‰«æå·¥å…·
        run: |
          npm install -g @doyensec/electronegativity@1.10.3
          npm install -g snyk
          npm install -g audit-ci

      - name: æ‰§è¡ŒElectronegativityæ‰«æ
        id: electronegativity
        run: |
          echo "ğŸ” è¿è¡ŒElectronegativityå®‰å…¨æ‰«æ..."
          electronegativity --input . --output electronegativity-scan.csv --verbose false --electron-version 30.0.0 || echo "âš ï¸ æ‰«æå®Œæˆä½†æœ‰è­¦å‘Š"
          
          if [ -f electronegativity-scan.csv ]; then
            echo "âœ… Electronegativityæ‰«æå®Œæˆ"
            echo "electronegativity-status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Electronegativityæ‰«æå¤±è´¥"
            echo "electronegativity-status=failed" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œnpm audit
        id: npm-audit
        run: |
          echo "ğŸ” è¿è¡Œnpm audit..."
          npm audit --audit-level high --json > npm-audit-results.json || true
          
          if [ -f npm-audit-results.json ]; then
            echo "âœ… npm auditå®Œæˆ"
            echo "npm-audit-status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ npm auditå¤±è´¥"
            echo "npm-audit-status=failed" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡ŒSnykæ‰«æï¼ˆå¦‚æœæœ‰Tokenï¼‰
        id: snyk-scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "ğŸ” è¿è¡ŒSnykæ‰«æ..."
            snyk test --json > snyk-results.json || true
            snyk monitor || true
            echo "âœ… Snykæ‰«æå®Œæˆ"
            echo "snyk-status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ è·³è¿‡Snykæ‰«æï¼ˆæ— SNYK_TOKENï¼‰"
            echo "snyk-status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥ç§˜é’¥æ³„éœ²
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      - name: æ±‡æ€»é™æ€æ‰«æç»“æœ
        id: static-scan
        run: |
          echo "ğŸ“Š æ±‡æ€»é™æ€å®‰å…¨æ‰«æç»“æœ..."
          
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          
          # å¤„ç†Electronegativityç»“æœ
          if [ -f electronegativity-scan.csv ]; then
            ELECTRO_CRITICAL=$(awk -F',' 'NR>1 && tolower($3) == "critical" {count++} END {print count+0}' electronegativity-scan.csv)
            ELECTRO_HIGH=$(awk -F',' 'NR>1 && tolower($3) == "high" {count++} END {print count+0}' electronegativity-scan.csv)
            CRITICAL_COUNT=$((CRITICAL_COUNT + ELECTRO_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + ELECTRO_HIGH))
            echo "Electronegativity - Critical: $ELECTRO_CRITICAL, High: $ELECTRO_HIGH"
          fi
          
          # å¤„ç†npm auditç»“æœ
          if [ -f npm-audit-results.json ]; then
            NPM_CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json 2>/dev/null || echo "0")
            NPM_HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json 2>/dev/null || echo "0")
            CRITICAL_COUNT=$((CRITICAL_COUNT + NPM_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + NPM_HIGH))
            echo "npm audit - Critical: $NPM_CRITICAL, High: $NPM_HIGH"
          fi
          
          # å¤„ç†Snykç»“æœ
          if [ -f snyk-results.json ]; then
            SNYK_CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-results.json 2>/dev/null || echo "0")
            SNYK_HIGH=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-results.json 2>/dev/null || echo "0")
            CRITICAL_COUNT=$((CRITICAL_COUNT + SNYK_CRITICAL))
            HIGH_COUNT=$((HIGH_COUNT + SNYK_HIGH))
            echo "Snyk - Critical: $SNYK_CRITICAL, High: $SNYK_HIGH"
          fi
          
          echo "ğŸ“Š é™æ€æ‰«ææ±‡æ€»ï¼š"
          echo "  Criticalæ€»è®¡: $CRITICAL_COUNT"
          echo "  Highæ€»è®¡: $HIGH_COUNT"
          
          # è¾“å‡ºç»“æœ
          echo "critical-count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high-count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          
          if [ $CRITICAL_COUNT -gt 0 ]; then
            echo "status=critical" >> $GITHUB_OUTPUT
            echo "âŒ å‘ç°Criticalçº§åˆ«å®‰å…¨é—®é¢˜"
          elif [ $HIGH_COUNT -gt 5 ]; then
            echo "status=high" >> $GITHUB_OUTPUT
            echo "âš ï¸ Highçº§åˆ«å®‰å…¨é—®é¢˜è¿‡å¤š"
          else
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "âœ… é™æ€å®‰å…¨æ‰«æé€šè¿‡"
          fi

      - name: ä¸Šä¼ é™æ€æ‰«ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-security-reports
          path: |
            electronegativity-scan.csv
            npm-audit-results.json
            snyk-results.json
          retention-days: 30

  # é˜¶æ®µ2ï¼šE2Eå®‰å…¨æµ‹è¯•ï¼ˆä»…åœ¨é™æ€æ‰«æé€šè¿‡ä¸”criticalé—®é¢˜ä¸º0æ—¶è¿è¡Œï¼‰
  E2Eå®‰å…¨æµ‹è¯•:
    name: ğŸ§ª E2Eå®‰å…¨æµ‹è¯•
    runs-on: windows-latest
    needs: å®‰å…¨æ‰«æ
    if: needs.å®‰å…¨æ‰«æ.outputs.critical-count == '0'
    timeout-minutes: 15

    outputs:
      e2e-status: ${{ steps.e2e-test.outputs.status }}

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: å®‰è£…Playwrightæµè§ˆå™¨
        run: npx playwright install --with-deps

      - name: æ„å»ºElectronåº”ç”¨
        run: |
          npm run build
          npm run build:electron

      - name: æ‰§è¡ŒE2Eå®‰å…¨æµ‹è¯•
        id: e2e-test
        run: |
          echo "ğŸ§ª å¼€å§‹E2Eå®‰å…¨æµ‹è¯•..."
          if npm run test:e2e:security; then
            echo "âœ… E2Eå®‰å…¨æµ‹è¯•é€šè¿‡"
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "âŒ E2Eå®‰å…¨æµ‹è¯•å¤±è´¥"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        env:
          CI: true

      - name: ä¸Šä¼ E2Eæµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-security-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # é˜¶æ®µ3ï¼šç»Ÿä¸€å®‰å…¨é—¨ç¦å†³ç­–
  ç»Ÿä¸€å®‰å…¨é—¨ç¦:
    name: ğŸš¦ ç»Ÿä¸€å®‰å…¨é—¨ç¦
    runs-on: ubuntu-latest
    needs: [å®‰å…¨æ‰«æ, E2Eå®‰å…¨æµ‹è¯•]
    if: always()

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
        run: mkdir -p logs

      - name: æ‰§è¡Œç»Ÿä¸€å®‰å…¨é—¨ç¦æ£€æŸ¥
        run: |
          echo "ğŸ”’ å¼€å§‹æ‰§è¡Œç»Ÿä¸€å®‰å…¨é—¨ç¦æ£€æŸ¥..."
          
          # ä½¿ç”¨æˆ‘ä»¬çš„å®‰å…¨é—¨ç¦åŒ…è£…è„šæœ¬
          node scripts/security-gate-wrapper.js
        env:
          STATIC_SCAN_STATUS: ${{ needs.å®‰å…¨æ‰«æ.outputs.scan-status }}
          CRITICAL_COUNT: ${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }}
          HIGH_COUNT: ${{ needs.å®‰å…¨æ‰«æ.outputs.high-count }}
          E2E_STATUS: ${{ needs.E2Eå®‰å…¨æµ‹è¯•.outputs.e2e-status }}

      - name: ä¸‹è½½æ‰€æœ‰å®‰å…¨æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ç”Ÿæˆç»Ÿä¸€å®‰å…¨æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆç»Ÿä¸€å®‰å…¨é—¨ç¦æŠ¥å‘Š..."
          
          # åˆ›å»ºåŒ…å«æ‰€æœ‰ç»“æœçš„ç»¼åˆæŠ¥å‘Š
          cat > logs/unified-security-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_sha": "$GITHUB_SHA",
            "git_ref": "$GITHUB_REF_NAME",
            "workflow_run": "$GITHUB_RUN_ID",
            "static_scan": {
              "status": "${{ needs.å®‰å…¨æ‰«æ.outputs.scan-status }}",
              "critical_count": ${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }},
              "high_count": ${{ needs.å®‰å…¨æ‰«æ.outputs.high-count }}
            },
            "e2e_test": {
              "status": "${{ needs.E2Eå®‰å…¨æµ‹è¯•.outputs.e2e-status }}",
              "executed": "${{ needs.E2Eå®‰å…¨æµ‹è¯•.result != 'skipped' }}"
            },
            "overall_status": "$([ "${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }}" = "0" ] && [ "${{ needs.E2Eå®‰å…¨æµ‹è¯•.outputs.e2e-status }}" != "failed" ] && echo "PASS" || echo "FAIL")"
          }
          EOF

      - name: ä¸Šä¼ ç»Ÿä¸€å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unified-security-report
          path: |
            logs/security-gate-report.json
            logs/unified-security-report.json
          retention-days: 30

      - name: å®‰å…¨é—¨ç¦ç»“æœæ‘˜è¦
        run: |
          echo "## ğŸ”’ ç»Ÿä¸€å®‰å…¨é—¨ç¦ç»“æœ" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“Š æ£€æŸ¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | ç»“æœ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| é™æ€å®‰å…¨æ‰«æ | ${{ needs.å®‰å…¨æ‰«æ.outputs.scan-status }} | Critical: ${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }}, High: ${{ needs.å®‰å…¨æ‰«æ.outputs.high-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2Eå®‰å…¨æµ‹è¯• | ${{ needs.E2Eå®‰å…¨æµ‹è¯•.outputs.e2e-status }} | ${{ needs.E2Eå®‰å…¨æµ‹è¯•.result != 'skipped' && 'æ‰§è¡Œå®Œæˆ' || 'è·³è¿‡ï¼ˆå­˜åœ¨Criticalé—®é¢˜ï¼‰' }} |" >> $GITHUB_STEP_SUMMARY
          
          # æœ€ç»ˆé—¨ç¦å†³ç­–
          if [ "${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }}" != "0" ]; then
            echo "### âŒ å®‰å…¨é—¨ç¦å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç° ${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }} ä¸ªCriticalçº§åˆ«å®‰å…¨é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½ç»§ç»­ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.E2Eå®‰å…¨æµ‹è¯•.outputs.e2e-status }}" = "failed" ]; then
            echo "### âŒ å®‰å…¨é—¨ç¦å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "E2Eå®‰å…¨æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥Electronå®‰å…¨é…ç½®ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… å®‰å…¨é—¨ç¦é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å®‰å…¨æ£€æŸ¥å‡å·²é€šè¿‡ï¼Œç¬¦åˆADR-0002å®‰å…¨åŸºçº¿è¦æ±‚ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: å¤±è´¥æ—¶åˆ›å»ºIssue
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const title = `ğŸ”’ ç»Ÿä¸€å®‰å…¨é—¨ç¦å¤±è´¥ - ${context.payload.head_commit?.message || context.payload.pull_request?.title || 'Security Check'}`;
            const body = `
            ## ğŸš¨ ç»Ÿä¸€å®‰å…¨é—¨ç¦å¤±è´¥æŠ¥å‘Š

            **æäº¤**: ${context.sha}
            **åˆ†æ”¯**: ${context.ref}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}

            ### ğŸ“Š æ£€æŸ¥ç»“æœ
            - **é™æ€æ‰«æçŠ¶æ€**: ${{ needs.å®‰å…¨æ‰«æ.outputs.scan-status }}
            - **Criticalé—®é¢˜**: ${{ needs.å®‰å…¨æ‰«æ.outputs.critical-count }}ä¸ª
            - **Highé—®é¢˜**: ${{ needs.å®‰å…¨æ‰«æ.outputs.high-count }}ä¸ª
            - **E2Eæµ‹è¯•çŠ¶æ€**: ${{ needs.E2Eå®‰å…¨æµ‹è¯•.outputs.e2e-status }}

            ### ğŸ“‹ éœ€è¦æ£€æŸ¥çš„é¡¹ç›®
            - [ ] ä¿®å¤æ‰€æœ‰Criticalçº§åˆ«å®‰å…¨é—®é¢˜
            - [ ] æ£€æŸ¥Electronå®‰å…¨é…ç½®ï¼ˆnodeIntegration=false, contextIsolation=trueï¼‰
            - [ ] éªŒè¯CSPå®‰å…¨ç­–ç•¥
            - [ ] æ£€æŸ¥IPCé€šé“å®‰å…¨æ€§
            - [ ] éªŒè¯é¢„åŠ è½½è„šæœ¬å®‰å…¨æ€§

            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [ä¸‹è½½å®‰å…¨æŠ¥å‘Š](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            **å®‰å…¨é—¨ç¦å¤±è´¥æ„å‘³ç€åº”ç”¨å­˜åœ¨å®‰å…¨é£é™©ï¼Œè¯·ç«‹å³ä¿®å¤åå†å‘å¸ƒï¼**

            > æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º - åŸºäºADR-0002ç»Ÿä¸€å®‰å…¨é—¨ç¦æ ‡å‡†
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'bug', 'urgent', 'P0']
            });
name: Release Monitor - å‘å¸ƒç›‘æŽ§

# æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: read
  actions: write

on:
  schedule:
    # æ¯ 15 åˆ†é’Ÿç›‘æŽ§ä¸€æ¬¡å‘å¸ƒå¥åº·åº¦
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç›‘æŽ§çš„åº”ç”¨ç‰ˆæœ¬ï¼ˆç•™ç©ºä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼‰'
        required: false
        type: string
      force_check:
        description: 'å¼ºåˆ¶æ£€æŸ¥ï¼ˆå¿½ç•¥æ—¶é—´é™åˆ¶ï¼‰'
        required: false
        type: boolean
        default: false

env:
  SENTRY_ORG: ${{ vars.SENTRY_ORG || 'your-org' }}
  SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT || 'vitegame' }}
  APP_VERSION: ${{ inputs.version || vars.APP_VERSION || github.ref_name }}
  PREV_GA_VERSION: ${{ vars.PREV_GA_VERSION || '0.0.9' }}
  THRESHOLD_CF_USERS: ${{ vars.THRESHOLD_CF_USERS || '0.995' }}
  THRESHOLD_CF_SESSIONS: ${{ vars.THRESHOLD_CF_SESSIONS || '0.995' }}
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

# ==================== å¹¶å‘æŽ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: windows-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«çŽ¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    timeout-minutes: 10
    permissions:
      contents: write
      actions: write

    steps:
      - name: 'ðŸš€ Checkout repository'
        uses: actions/checkout@v4

      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ”§ Install dependencies'
        uses: ./.github/actions/npm-install
        env:
          NPM_CONFIG_PRODUCTION: 'true'

      - name: 'ðŸ› ï¸ Install system tools'
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 'â° Check monitoring conditions'
        id: conditions
        shell: bash
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨å·¥ä½œæ—¶é—´ï¼ˆUTC 6:00 - 22:00ï¼Œå¤§è‡´å¯¹åº”å„æ—¶åŒºçš„å·¥ä½œæ—¶é—´ï¼‰
          current_hour=$(date -u +%H)
          if [ "$current_hour" -lt 6 ] || [ "$current_hour" -gt 22 ]; then
            if [ "${{ inputs.force_check }}" != "true" ]; then
              echo "ðŸŒ™ éžå·¥ä½œæ—¶é—´ï¼Œè·³è¿‡ç›‘æŽ§ï¼ˆè®¾ç½® force_check=true å¯å¼ºåˆ¶æ‰§è¡Œï¼‰"
              echo "should_monitor=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æ¸è¿›å‘å¸ƒ
          if [ ! -f "dist/latest.yml" ]; then
            echo "ðŸ“„ Feed æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ç›‘æŽ§"
            echo "should_monitor=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥ stagingPercentage
          staging_pct=$(grep -E '^stagingPercentage:' dist/latest.yml | sed 's/stagingPercentage: *//' || echo "0")
          if [ "$staging_pct" = "0" ] || [ "$staging_pct" = "100" ]; then
            echo "ðŸ“Š å½“å‰åˆ†é˜¶æ®µå‘å¸ƒä¸º ${staging_pct}%ï¼Œè·³è¿‡ç›‘æŽ§"
            echo "should_monitor=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… æ»¡è¶³ç›‘æŽ§æ¡ä»¶ï¼Œå¼€å§‹å¥åº·æ£€æŸ¥"
          echo "should_monitor=true" >> $GITHUB_OUTPUT
          echo "staging_percentage=$staging_pct" >> $GITHUB_OUTPUT

      - name: 'ðŸ¥ Continuous health monitoring'
        id: health_monitor
        if: steps.conditions.outputs.should_monitor == 'true'
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "âš ï¸  SENTRY_AUTH_TOKEN æœªé…ç½®ï¼Œè·³è¿‡å¥åº·ç›‘æŽ§"
            echo "monitor_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ” ç›‘æŽ§ç‰ˆæœ¬ $APP_VERSION çš„æŒç»­å¥åº·çŠ¶æ€..."
          echo "ðŸ“Š å½“å‰åˆ†é˜¶æ®µå‘å¸ƒ: ${{ steps.conditions.outputs.staging_percentage }}%"

          # æ‰§è¡Œå¥åº·åº¦æ£€æŸ¥
          set +e
          health_result=$(DRY_RUN=true node scripts/release/auto-rollback.mjs)
          health_exit_code=$?
          set -e

          echo "health_result=$health_result" >> $GITHUB_OUTPUT
          echo "health_exit_code=$health_exit_code" >> $GITHUB_OUTPUT

          echo "ðŸ“Š å¥åº·ç›‘æŽ§ç»“æžœ:"
          echo "$health_result" | jq '.'

          case $health_exit_code in
            0)
              echo "âœ… æŒç»­å¥åº·ç›‘æŽ§ï¼šæŒ‡æ ‡æ­£å¸¸"
              echo "monitor_status=healthy" >> $GITHUB_OUTPUT
              ;;
            42)
              echo "ðŸš¨ æŒç»­å¥åº·ç›‘æŽ§ï¼šæ£€æµ‹åˆ°å¥åº·é—®é¢˜"
              echo "monitor_status=unhealthy" >> $GITHUB_OUTPUT
              
              # è§¦å‘ç´§æ€¥å›žæ»šå·¥ä½œæµ
              echo "ðŸš¨ è§¦å‘ç´§æ€¥å›žæ»š..."
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/workflows/release-emergency-rollback.yml/dispatches" \
                -d "{
                  \"ref\": \"${{ github.ref }}\",
                  \"inputs\": {
                    \"reason\": \"Continuous monitoring detected health degradation\",
                    \"triggered_by\": \"monitor\"
                  }
                }"
              ;;
            *)
              echo "âš ï¸  å¥åº·ç›‘æŽ§é‡åˆ°é”™è¯¯ (é€€å‡ºç : $health_exit_code)"
              echo "monitor_status=error" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: 'ðŸ“Š Update monitoring dashboard'
        if: steps.conditions.outputs.should_monitor == 'true'
        shell: bash
        run: |
          # åˆ›å»ºæˆ–æ›´æ–°ç›‘æŽ§çŠ¶æ€æ–‡ä»¶
          mkdir -p .github/monitoring

          cat > .github/monitoring/latest-status.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "version": "$APP_VERSION",
            "staging_percentage": ${{ steps.conditions.outputs.staging_percentage }},
            "health_status": "${{ steps.health_monitor.outputs.monitor_status }}",
            "health_data": ${{ steps.health_monitor.outputs.health_result || 'null' }},
            "workflow_run": "${{ github.run_number }}",
            "next_check": "$(date -u -d '+15 minutes' +%Y-%m-%dT%H:%M:%S.000Z)"
          }
          EOF

          echo "ðŸ“Š ç›‘æŽ§çŠ¶æ€å·²æ›´æ–°"

      - name: 'ðŸ“¢ Send health alert (if needed)'
        if: steps.health_monitor.outputs.monitor_status == 'unhealthy'
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "âš ï¸  WEBHOOK_URL æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi

          echo "ðŸš¨ å‘é€å¥åº·å‘Šè­¦é€šçŸ¥..."

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ðŸš¨ Release Health Alert\",
              \"attachments\": [{
                \"color\": \"danger\",
                \"fields\": [
                  {\"title\": \"App Version\", \"value\": \"$APP_VERSION\", \"short\": true},
                  {\"title\": \"Staging %\", \"value\": \"${{ steps.conditions.outputs.staging_percentage }}%\", \"short\": true},
                  {\"title\": \"Status\", \"value\": \"Health degradation detected\", \"short\": false},
                  {\"title\": \"Action\", \"value\": \"Emergency rollback triggered\", \"short\": false}
                ],
                \"text\": \"Continuous monitoring detected health issues. Emergency rollback has been initiated.\"
              }]
            }" || echo "Webhook notification failed (non-critical)"

      - name: 'ðŸ’¾ Commit monitoring data'
        if: steps.conditions.outputs.should_monitor == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -f ".github/monitoring/latest-status.json" ]; then
            git add .github/monitoring/latest-status.json
            git commit -m "ðŸ“Š Release monitoring update: $APP_VERSION" \
              -m "Status: ${{ steps.health_monitor.outputs.monitor_status }}" \
              -m "Staging: ${{ steps.conditions.outputs.staging_percentage }}%" \
              -m "" \
              -m "ðŸ¤– Automated monitoring data" || echo "No changes to commit"
            
            git push origin ${{ github.ref }} || echo "Push failed (non-critical)"
          fi

      - name: 'ðŸ“‹ Monitoring summary'
        if: always()
        shell: bash
        run: |
          # ç¡®ä¿UTF-8ç¼–ç è¾“å‡º
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          echo "## ðŸ“Š å‘å¸ƒç›‘æŽ§æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç›‘æŽ§æ—¶é—´**: $(date -u +%Y-%m-%dT%H:%M:%S.000Z)" >> $GITHUB_STEP_SUMMARY
          echo "**åº”ç”¨ç‰ˆæœ¬**: \`$APP_VERSION\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.conditions.outputs.should_monitor }}" = "true" ]; then
            echo "**åˆ†é˜¶æ®µå‘å¸ƒ**: ${{ steps.conditions.outputs.staging_percentage }}%" >> $GITHUB_STEP_SUMMARY
            
            status="${{ steps.health_monitor.outputs.monitor_status }}"
            case "$status" in
              "healthy") status_icon="âœ…"; status_text="å¥åº·" ;;
              "unhealthy") status_icon="ðŸš¨"; status_text="ä¸å¥åº· - å·²è§¦å‘å›žæ»š" ;;
              "error") status_icon="âš ï¸"; status_text="ç›‘æŽ§é”™è¯¯" ;;
              "skipped") status_icon="â­ï¸"; status_text="è·³è¿‡" ;;
              *) status_icon="â“"; status_text="æœªçŸ¥" ;;
            esac
            
            echo "**å¥åº·çŠ¶æ€**: $status_icon $status_text" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.health_monitor.outputs.health_result }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“Š å¥åº·æ•°æ®" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              echo '${{ steps.health_monitor.outputs.health_result }}' | jq '.' >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**ç›‘æŽ§çŠ¶æ€**: â­ï¸ è·³è¿‡ (æ¡ä»¶ä¸æ»¡è¶³)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸‹æ¬¡æ£€æŸ¥**: $(date -u -d '+15 minutes' +%Y-%m-%dT%H:%M:%S.000Z)" >> $GITHUB_STEP_SUMMARY

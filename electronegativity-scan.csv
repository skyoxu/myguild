issue, severity, confidence, filename, location, sample, description, url
AVAILABLE_SECURITY_FIXES_GLOBAL_CHECK,"INFORMATIONAL","TENTATIVE","C:\buildgame\vitegame\package.json","0:0",N/A,"Check if there are security patches applied in between the Electron version used and the latest",https://github.com/doyensec/electronegativity/wiki/AVAILABLE_SECURITY_FIXES_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","FIRM","C:\buildgame\vitegame\index.html","7:0","default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self'; object-src 'none'; base-uri 'none'; form-action 'self'; frame-ancestors 'none';","One or more CSP directives detected seems to be vulnerable",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","FIRM","C:\buildgame\vitegame\dist-electron\main.js","110:8","default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://sentry.io; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';","One or more CSP directives detected seems to be vulnerable",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","FIRM","C:\buildgame\vitegame\dist\index.html","7:0","default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self'; object-src 'none'; base-uri 'none'; form-action 'self'; frame-ancestors 'none';","One or more CSP directives detected seems to be vulnerable",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","TENTATIVE","C:\buildgame\vitegame\electron\main.ts","116:10",N/A,"Failed to parse CSP, it may not be valid.",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","TENTATIVE","C:\buildgame\vitegame\electron\security.ts","134:4",N/A,"Failed to parse CSP, it may not be valid.",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","TENTATIVE","C:\buildgame\vitegame\tests\e2e\guild-manager\security.e2e.spec.ts","1112:8",N/A,"Failed to parse CSP, it may not be valid.",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
CSP_GLOBAL_CHECK,"LOW","FIRM","C:\buildgame\vitegame\src\renderer\index.html","6:0","default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' https://sentry.io https://*.sentry.io; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; child-src 'none'; worker-src 'self';","One or more CSP directives detected seems to be vulnerable",https://github.com/doyensec/electronegativity/wiki/CSP_GLOBAL_CHECK
AUXCLICK_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\dist-electron\main.js","16:21","const mainWindow = new BrowserWindow({","Limit navigation flows to untrusted origins. Middle-click may cause Electron to open a link within a new window",https://github.com/doyensec/electronegativity/wiki/AUXCLICK_JS_CHECK
PRELOAD_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\dist-electron\main.js","22:6","preload: join(__dirname, 'preload.js'),","Review the use of preload scripts",https://github.com/doyensec/electronegativity/wiki/PRELOAD_JS_CHECK
OPEN_EXTERNAL_JS_CHECK,"MEDIUM","TENTATIVE","C:\buildgame\vitegame\dist-electron\main.js","102:4","shell.openExternal(details.url);","Review the use of openExternal",https://github.com/doyensec/electronegativity/wiki/OPEN_EXTERNAL_JS_CHECK
DANGEROUS_FUNCTIONS_JS_CHECK,"MEDIUM","CERTAIN","C:\buildgame\vitegame\dist\assets\index-UPCicWbE.js","6635:40213","按ESC键返回或等待5秒自动返回`,{font:""24px Arial"",color:""#ffffff"",backgroundColor:""#2d3748"",padding:{x:20,y:15},align:""center""});$.setOrigin(.5),$.setDepth(200),this.tweens.add({targets:$,alpha:.7,duration:800,yoyo:!0,repeat:-1}),this.time.delayedCall(5e3,()=>{this.triggerSceneEnd()}),this.input.keyboard.on(""keydown-ESC"",()=>{this.triggerSceneEnd()})}triggerSceneEnd(){this.publishEvent(Re.createEvent({type:""game.scene.stopped"",source:""test-scene"",data:{sceneKey:""TestScene"",timestamp:new Date}})),this.events.emit(""level-completed"",this.testState)}updateUI(){this.ui.movesText&&this.ui.movesText.setText(`移动次数: ${this.testState.totalMoves}`),this.ui.statusText&&(this.testState.levelCompleted?(this.ui.statusText.setText(""状态: 已完成! 🎉""),this.ui.statusText.setStyle({color:""#68d391""})):this.ui.statusText.setText(""状态: 进行中...""))}updateScene(z,$){if(this.testState.levelCompleted)return;const q=this.cursors,et=this.wasd;if(q||et){let ht=0,g=0;const A=3;if(q.left.isDown||et.A.isDown?ht=-A:(q.right.isDown||et.D.isDown)&&(ht=A),q.up.isDown||et.W.isDown?g=-A:(q.down.isDown||et.S.isDown)&&(g=A),ht!==0||g!==0){const t=Math.max(25,Math.min(this.scale.width-25,this.player.x+ht)),c=Math.max(25,Math.min(this.scale.height-25,this.player.y+g));(t!==this.player.x||c!==this.player.y)&&(this.player.x=t,this.player.y=c,this.testState.playerPosition={x:t,y:c},this.checkGoalCollision())}}}getTestState(){return{...this.testState}}}class EE{game=null;config;eventCallback;constructor(z={}){this.config=z,this.eventCallback=z.onEvent}initialize(z,$=800,q=600){return new Promise((et,ht)=>{try{const g={type:Zn.AUTO,width:$,height:q,parent:z,backgroundColor:""#1a202c"",physics:{default:""arcade"",arcade:{gravity:{x:0,y:0},debug:!1}},scale:{mode:Zn.Scale.FIT,autoCenter:Zn.Scale.CENTER_BOTH,min:{width:400,height:300},max:{width:1600,height:1200}},scene:[yE,TE,SE],callbacks:{postBoot:()=>{this.setupEventHandlers(),et()}}};this.game=new Zn.Game(g)}catch(g){this.config.onError?.(g),ht(g)}})}setupEventHandlers(){if(!this.game)return;this.game.events.on(""domain-event"",$=>{this.handleDomainEvent($)});const z=this.game.scene;[""MenuScene"",""GameScene"",""TestScene""].forEach($=>{const q=z.getScene($);q&&q.events.on(""domain-event"",et=>{this.eventCallback?.(et)})})}handleDomainEvent(z){switch(console.log(""Domain Event:"",z),z.type){case""game.menu.action"":this.handleMenuAction(z);break;case""game.state.paused"":this.handleGamePaused(z);break;case""game.exit.requested"":this.handleExitRequested(z);break;case""game.error"":this.handleGameError(z);break}this.eventCallback?.(z)}handleMenuAction(z){const{action:$}=z.data;switch($){case""start-game"":this.startGame();break;case""exit"":this.exitGame();break}}handleGamePaused(z){console.log(""Game paused:"",z.data)}handleExitRequested(z){this.exitGame()}handleGameError(z){const $=z.data;this.config.onError?.(new Error($.error),$.scene)}startGame(){if(!this.game)return;this.game.scene.getScene(""GameScene"")&&this.game.scene.start(""GameScene"")}pauseGame(){if(!this.game)return;const z=this.game.scene.getScene(""GameScene"");z&&z.scene.isActive()&&z.scene.pause()}resumeGame(){if(!this.game)return;const z=this.game.scene.getScene(""GameScene"");z&&z.scene.isPaused()&&z.scene.resume()}restartGame(){this.game&&this.game.scene.start(""GameScene"")}returnToMenu(){this.game&&this.game.scene.start(""MenuScene"")}exitGame(){this.game&&(this.game.destroy(!0),this.game=null)}getCurrentScene(){if(!this.game)return null;const z=this.game.scene.getScenes(!0);return z.length>0?z[0]:null}getGameState(){if(!this.game)return null;const z=this.game.scene.getScene(""GameScene"");return z&&z.scene.isActive()?z.getGameState():null}setGameState(z){if(!this.game)return;const $=this.game.scene.getScene(""GameScene"");$&&$.scene.isActive()&&$.setGameState(z)}isInitialized(){return this.game!==null}destroy(){this.exitGame(),this.eventCallback=void 0}}class CE{options;autoSaveTimer;currentState=null;currentConfig=null;eventCallbacks=new Set;constructor(z={}){this.options={storageKey:""guild-manager-game"",maxSaves:10,autoSaveInterval:3e4,enableCompression:!0,...z}}setState(z,$){this.currentState={...z},$&&(this.currentConfig={...$}),this.publishEvent({type:""game.state.manager.updated"",source:""game-state-manager"",data:{state:z,config:$},timestamp:new Date,time:new Date().toISOString(),id:`state-update-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}getState(){return this.currentState?{...this.currentState}:null}getConfig(){return this.currentConfig?{...this.currentConfig}:null}async saveGame(z,$){if(!this.currentState||!this.currentConfig)throw new Error(""No game state to save"");const q=`${this.options.storageKey}-${Date.now()}`,et={id:q,state:{...this.currentState},config:{...this.currentConfig},metadata:{createdAt:new Date,updatedAt:new Date,version:""1.0.0"",checksum:await this.calculateChecksum(this.currentState)},screenshot:$};try{return await this.saveToBrowser(q,et),await this.cleanupOldSaves(),this.publishEvent({type:""game.save.created"",source:""game-state-manager"",data:{saveId:q,saveData:{...et,state:void 0}},timestamp:new Date,time:new Date().toISOString(),id:`save-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}),q}catch(ht){throw this.publishEvent({type:""game.save.failed"",source:""game-state-manager"",data:{error:ht.message},timestamp:new Date,time:new Date().toISOString(),id:`save-error-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}),ht}}async loadGame(z){try{const $=await this.loadFromBrowser(z);if(await this.calculateChecksum($.state)!==$.metadata.checksum)throw new Error(""Save file is corrupted"");return this.currentState={...$.state},this.currentConfig={...$.config},this.publishEvent({type:""game.save.loaded"",source:""game-state-manager"",data:{saveId:z,state:this.currentState,config:this.currentConfig},timestamp:new Date,time:new Date().toISOString(),id:`load-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}),{state:{...$.state},config:{...$.config}}}catch($){throw this.publishEvent({type:""game.save.load_failed"",source:""game-state-manager"",data:{saveId:z,error:$.message},timestamp:new Date,time:new Date().toISOString(),id:`load-error-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}),$}}async getSaveList(){try{const z=[],$=Object.keys(localStorage);for(const q of $)if(q.startsWith(this.options.storageKey))try{const et=await this.loadFromBrowser(q);z.push(et)}catch(et){console.warn(`Failed to load save: ${q}`,et)}return z.sort((q,et)=>new Date(et.metadata.createdAt).getTime()-new Date(q.metadata.createdAt).getTime()),z}catch(z){return console.error(""Failed to get save list:"",z),[]}}async deleteSave(z){try{localStorage.removeItem(z),this.publishEvent({type:""game.save.deleted"",source:""game-state-manager"",data:{saveId:z},timestamp:new Date,time:new Date().toISOString(),id:`delete-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}catch($){throw this.publishEvent({type:""game.save.delete_failed"",source:""game-state-manager"",data:{saveId:z,error:$.message},timestamp:new Date,time:new Date().toISOString(),id:`delete-error-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}),$}}enableAutoSave(){this.autoSaveTimer||(this.autoSaveTimer=setInterval(async()=>{if(this.currentState&&this.currentConfig)try{const z=await this.saveGame(`auto-save-${Date.now()}`);this.publishEvent({type:""game.autosave.completed"",source:""game-state-manager"",data:{saveId:z},timestamp:new Date,time:new Date().toISOString(),id:`autosave-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}catch(z){this.publishEvent({type:""game.autosave.failed"",source:""game-state-manager"",data:{error:z.message},timestamp:new Date,time:new Date().toISOString(),id:`autosave-error-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}},this.options.autoSaveInterval),this.publishEvent({type:""game.autosave.enabled"",source:""game-state-manager"",data:{interval:this.options.autoSaveInterval},timestamp:new Date,time:new Date().toISOString(),id:`autosave-enable-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}))}disableAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=void 0,this.publishEvent({type:""game.autosave.disabled"",source:""game-state-manager"",data:{},timestamp:new Date,time:new Date().toISOString(),id:`autosave-disable-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}))}onEvent(z){this.eventCallbacks.add(z)}offEvent(z){this.eventCallbacks.delete(z)}destroy(){this.disableAutoSave(),this.eventCallbacks.clear(),this.currentState=null,this.currentConfig=null}async saveToBrowser(z,$){const q=JSON.stringify($);if(q.length>5*1024*1024)throw new Error(""Save data too large"");localStorage.setItem(z,q)}async loadFromBrowser(z){const $=localStorage.getItem(z);if(!$)throw new Error(`Save not found: ${z}`);return JSON.parse($)}async cleanupOldSaves(){const z=await this.getSaveList();if(z.length>this.options.maxSaves){const $=z.slice(this.options.maxSaves);for(const q of $)try{await this.deleteSave(q.id)}catch(et){console.warn(`Failed to delete old save: ${q.id}`,et)}}}async calculateChecksum(z){const $=JSON.stringify(z,Object.keys(z).sort());let q=0;for(let et=0;et<$.length;et++){const ht=$.charCodeAt(et);q=(q<<5)-q+ht,q=q&q}return q.toString(16)}publishEvent(z){this.eventCallbacks.forEach($=>{try{$(z)}catch(q){console.error(""Error in state manager event callback:"",q)}})}}class AE{sources=new Map;priorities=new Map;lastStates=new Map;syncTimer;options;eventCallbacks=new Set;isDestroyed=!1;constructor(z={}){this.options={syncInterval:1e3,conflictResolution:""latest"",enableBidirectionalSync:!0,...z}}registerSource(z,$=0){if(this.isDestroyed)return;this.sources.set(z.id,z),this.priorities.set(z.id,$);const q=z.getState();q&&this.lastStates.set(z.id,{...q}),this.publishEvent({type:""state.synchronizer.source_registered"",source:""state-synchronizer"",data:{sourceId:z.id,priority:$},timestamp:new Date,time:new Date().toISOString(),id:`register-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}unregisterSource(z){this.isDestroyed||(this.sources.delete(z),this.priorities.delete(z),this.lastStates.delete(z),this.publishEvent({type:""state.synchronizer.source_unregistered"",source:""state-synchronizer"",data:{sourceId:z},timestamp:new Date,time:new Date().toISOString(),id:`unregister-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}))}startSync(){this.isDestroyed||this.syncTimer||(this.syncTimer=setInterval(()=>{this.performSync()},this.options.syncInterval),this.publishEvent({type:""state.synchronizer.started"",source:""state-synchronizer"",data:{interval:this.options.syncInterval},timestamp:new Date,time:new Date().toISOString(),id:`sync-start-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}))}stopSync(){this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=void 0,this.publishEvent({type:""state.synchronizer.stopped"",source:""state-synchronizer"",data:{},timestamp:new Date,time:new Date().toISOString(),id:`sync-stop-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""}))}sync(){this.isDestroyed||this.performSync()}forceState(z,$){if(!this.isDestroyed){for(const[q,et]of this.sources)if(q!==$)try{et.setState(z),this.lastStates.set(q,{...z})}catch(ht){console.error(`Failed to set state for source ${q}:`,ht)}this.publishEvent({type:""state.synchronizer.forced"",source:""state-synchronizer"",data:{state:z,excludeSourceId:$},timestamp:new Date,time:new Date().toISOString(),id:`force-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}}getMergedState(){if(this.isDestroyed||this.sources.size===0)return null;const z=[];for(const[$,q]of this.sources){const et=q.getState();et&&z.push({sourceId:$,state:et,priority:this.priorities.get($)||0})}if(z.length===0)return null;if(z.length===1)return{...z[0].state};switch(this.options.conflictResolution){case""priority"":return this.mergeByPriority(z);case""latest"":return this.mergeByTimestamp(z);case""merge"":return this.mergeFields(z);default:return z[0].state}}onEvent(z){this.eventCallbacks.add(z)}offEvent(z){this.eventCallbacks.delete(z)}destroy(){this.isDestroyed=!0,this.stopSync(),this.sources.clear(),this.priorities.clear(),this.lastStates.clear(),this.eventCallbacks.clear()}performSync(){if(this.isDestroyed||this.sources.size===0)return;const z=[],$=new Map;for(const[q,et]of this.sources){const ht=et.getState();if(ht){$.set(q,ht);const g=this.lastStates.get(q);(!g||this.hasStateChanged(g,ht))&&(z.push(q),this.lastStates.set(q,{...ht}))}}z.length>0&&this.synchronizeStates(z,$)}synchronizeStates(z,$){const q=this.determineAuthoritativeState(z,$);if(!q)return;const{sourceId:et,state:ht}=q;let g=0;for(const[A,t]of this.sources)if(A!==et&&this.options.enableBidirectionalSync)try{t.setState(ht),this.lastStates.set(A,{...ht}),g++}catch(c){console.error(`Failed to sync state to source ${A}:`,c)}g>0&&this.publishEvent({type:""state.synchronizer.synced"",source:""state-synchronizer"",data:{authoritativeSource:et,syncedSources:Array.from(this.sources.keys()).filter(A=>A!==et),state:ht},timestamp:new Date,time:new Date().toISOString(),id:`sync-${Date.now()}`,specversion:""1.0"",datacontenttype:""application/json""})}determineAuthoritativeState(z,$){const q=z.map(et=>({sourceId:et,state:$.get(et),priority:this.priorities.get(et)||0}));switch(this.options.conflictResolution){case""priority"":return q.reduce((ht,g)=>g.priority>ht.priority?g:ht);case""latest"":return q.reduce((ht,g)=>g.state.timestamp>ht.state.timestamp?g:ht);case""merge"":return q.reduce((ht,g)=>g.priority>ht.priority?g:ht);default:return q[0]||null}}mergeByPriority(z){return z.sort(($,q)=>q.priority-$.priority)[0].state}mergeByTimestamp(z){return z.sort(($,q)=>q.state.timestamp.getTime()-$.state.timestamp.getTime())[0].state}mergeFields(z){const q={...z[0].state};for(const{state:et}of z)Object.keys(et).forEach(ht=>{const g=ht;et.timestamp>q.timestamp&&(q[g]=et[g])});return q}hasStateChanged(z,$){return JSON.stringify(z)!==JSON.stringify($)}publishEvent(z){this.eventCallbacks.forEach($=>{try{$(z)}catch(q){console.error(""Error in synchronizer event callback:"",q)}})}}var Pi=(st=>(st[st.LOW=0]=""LOW"",st[st.NORMAL=1]=""NORMAL"",st[st.HIGH=2]=""HIGH"",st[st.CRITICAL=3]=""CRITICAL"",st))(Pi||{});class RE{listeners=new Map;eventQueue=[];isProcessing=!1;subscriptionIdCounter=0;options;metrics={eventsPublished:0,eventsProcessed:0,averageProcessingTime:0,lastEventTime:0};constructor(z={}){this.options={maxListeners:z.maxListeners??100,enableLogging:z.enableLogging??!0,enableMetrics:z.enableMetrics??!0,queueSize:z.queueSize??1e3}}subscribe(z,$,q={}){const et=`sub_${++this.subscriptionIdCounter}`;this.listeners.has(z)||this.listeners.set(z,[]);const ht=this.listeners.get(z);if(ht.length>=this.options.maxListeners)throw new Error(`Maximum listeners (${this.options.maxListeners}) exceeded for event: ${z}`);const g={id:et,handler:$,priority:q.priority??Pi.NORMAL,once:q.once??!1,context:q.context};return ht.push(g),ht.sort((A,t)=>t.priority-A.priority),this.options.enableLogging&&console.log(`[EventBus] Subscribed to ${z} (ID: ${et}, Context: ${q.context||""unknown""})`),et}unsubscribe(z){for(const[$,q]of this.listeners.entries()){const et=q.findIndex(ht=>ht.id===z);if(et!==-1)return q.splice(et,1),q.length===0&&this.listeners.delete($),this.options.enableLogging&&console.log(`[EventBus] Unsubscribed from ${$} (ID: ${z})`),!0}return!1}unsubscribeAll(z){const $=this.listeners.get(z);if($){const q=$.length;return this.listeners.delete(z),this.options.enableLogging&&console.log(`[EventBus] Unsubscribed all (${q}) listeners from ${z}`),q}return 0}publish(z,$){const q={...z,metadata:{id:`evt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,source:$?.source||""unknown"",priority:$?.priority||Pi.NORMAL,persistent:$?.persistent||!1,broadcast:$?.broadcast||!0,...$}};this.metrics.eventsPublished++,this.options.enableLogging&&console.log(`[EventBus] Publishing event: ${z.type}`,q),this.processEvent(q)}async publishAsync(z,$){const q={...z,metadata:{id:`evt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,source:$?.source||""unknown"",priority:$?.priority||Pi.NORMAL,persistent:$?.persistent||!1,broadcast:$?.broadcast||!0,...$}};this.eventQueue.length>=this.options.queueSize&&(console.warn(`[EventBus] Event queue full (${this.options.queueSize}), dropping oldest event`),this.eventQueue.shift()),this.eventQueue.push(q),this.metrics.eventsPublished++,this.isProcessing||await this.processEventQueue()}processEvent(z){const $=performance.now(),q=this.listeners.get(z.type)||[];if(q.length===0){this.options.enableLogging&&console.warn(`[EventBus] No listeners for event: ${z.type}`);return}const et=[];for(const ht of q)try{const g=ht.handler(z);g instanceof Promise&&g.catch(A=>{console.error(`[EventBus] Async handler error for ${z.type}:`,A)}),ht.once&&et.push(ht.id)}catch(g){console.error(`[EventBus] Handler error for ${z.type}:`,g)}if(et.forEach(ht=>this.unsubscribe(ht)),this.options.enableMetrics){const ht=performance.now()-$;this.metrics.eventsProcessed++,this.metrics.averageProcessingTime=(this.metrics.averageProcessingTime*(this.metrics.eventsProcessed-1)+ht)/this.metrics.eventsProcessed,this.metrics.lastEventTime=Date.now()}}async processEventQueue(){if(!this.isProcessing){this.isProcessing=!0;try{for(;this.eventQueue.length>0;){const z=this.eventQueue.shift();z.metadata.priority>=Pi.HIGH?this.processEvent(z):(await new Promise($=>setTimeout($,0)),this.processEvent(z))}}finally{this.isProcessing=!1}}}getListenerStats(){const z={};for(const[$,q]of this.listeners.entries())z[$]=q.length;return z}getMetrics(){return{...this.metrics}}destroy(){this.listeners.clear(),this.eventQueue.length=0,this.isProcessing=!1,this.options.enableLogging&&console.log(""[EventBus] EventBus destroyed"")}hasListeners(z){const $=this.listeners.get(z);return $?$.length>0:!1}getListenerCount(z){const $=this.listeners.get(z);return $?$.length:0}}const Wn=new RE({maxListeners:200,enableLogging:!0,enableMetrics:!0,queueSize:2e3});function Sy(st={}){const{context:z=""react-component"",priority:$=Pi.NORMAL,enableAutoCleanup:q=!0}=st,et=zt.useRef([]),ht=zt.useRef(Wn),g=zt.useCallback((i,l,f={})=>{const d=ht.current.subscribe(i,l,{priority:f.priority||$,once:f.once||!1,context:z});return et.current.push({eventType:i,subscriptionId:d}),d},[z,$]),A=zt.useCallback(i=>{const l=ht.current.unsubscribe(i);return l&&(et.current=et.current.filter(f=>f.subscriptionId!==i)),l},[]),t=zt.useCallback(i=>{ht.current.publish(i,{source:z,priority:$})},[z,$]),c=zt.useCallback(async i=>{await ht.current.publishAsync(i,{source:z,priority:$})},[z,$]),m=zt.useCallback((i,l)=>{const d={pause:{type:""react.command.pause"",data:{timestamp:new Date}},resume:{type:""react.command.resume"",data:{timestamp:new Date}},save:{type:""react.command.save"",data:{saveId:l?.saveId,timestamp:new Date}},load:{type:""react.command.load"",data:{saveId:l?.saveId,timestamp:new Date}},restart:{type:""react.command.restart"",data:{timestamp:new Date}}}[i];d&&t(d)},[t]),h=zt.useCallback((i,l=!1)=>{const f=g(""phaser.response.ready"",i,{once:l}),d=g(""phaser.response.completed"",i,{once:l});return[f,d]},[g]),s=zt.useCallback(i=>{const l=g(""game.state.updated"",i),f=g(""game.state.changed"",i);return[l,f]},[g]),r=zt.useCallback(i=>{const l=g(""game.error"",i),f=g(""game.warning"",i);return[l,f]},[g]),e=zt.useCallback(()=>({listenerStats:ht.current.getListenerStats(),metrics:ht.current.getMetrics(),activeSubscriptions:et.current.length}),[]),n=zt.useCallback(i=>ht.current.hasListeners(i),[]),o=zt.useCallback(()=>{et.current.forEach(({subscriptionId:i})=>{ht.current.unsubscribe(i)}),et.current=[]},[]);return zt.useEffect(()=>{if(q)return o},[o,q]),zt.useMemo(()=>({subscribe:g,unsubscribe:A,publish:t,publishAsync:c,sendCommandToPhaser:m,onPhaserResponse:h,onGameStateChange:s,onGameError:r,getStats:e,hasListeners:n,cleanup:o,eventBus:ht.current}),[g,A,t,c,m,h,s,r,e,n,o])}class ME{running=!1;last=0;rafId=null;update;onError;constructor(z,$){this.update=z,this.onError=$}start(){if(this.running)return;this.running=!0,this.last=performance.now();const z=async $=>{if(!this.running)return;const q=$-this.last;this.last=$;try{await this.update(q)}catch(et){this.onError?.(et)}this.rafId=setTimeout(()=>z(performance.now()),16)};z(this.last)}stop(){this.running=!1,this.rafId&&clearTimeout(this.rafId)}}class PE{state=""boot"";get current(){return this.state}transition(z){if(!{boot:[""loading"",""error""],loading:[""running"",""error""],running:[""paused"",""error""],paused:[""running"",""error""],error:[""boot""]}[this.state].includes(z))throw new Error(`Invalid transition ${this.state} -> ${z}`);this.state=z}}class Ey{sceneManager;gameLoop;stateMachine;stateManager;stateSynchronizer;eventCallbacks=new Set;eventBusSubscriptions=[];currentConfig;currentState;container;gameStartTime=0;gameStatistics={totalMoves:0,itemsCollected:0,enemiesDefeated:0,distanceTraveled:0,averageReactionTime:0};constructor(){this.stateMachine=new PE,this.stateManager=new CE({storageKey:""guild-manager-game"",maxSaves:10,autoSaveInterval:3e4,enableCompression:!0}),this.stateSynchronizer=new AE({syncInterval:1e3,conflictResolution:""priority"",enableBidirectionalSync:!0}),this.sceneManager=new EE({onEvent:z=>{this.handleDomainEvent(z)},onError:(z,$)=>{console.error(""Game engine error:"",z,$),this.stateMachine.transition(""error"")}}),this.gameLoop=new ME(z=>this.updateGame(z),z=>{console.error(""Game loop error:"",z),this.stateMachine.transition(""error"")}),this.currentState={id:`game-${Date.now()}`,level:1,score:0,health:100,inventory:[],position:{x:400,y:300},timestamp:new Date},this.stateManager.onEvent(z=>this.handleDomainEvent(z)),this.stateSynchronizer.onEvent(z=>this.handleDomainEvent(z)),this.setupEventBusListeners(),this.stateSynchronizer.registerSource({id:""game-engine"",getState:()=>this.currentState,setState:z=>{this.currentState={...z},this.stateManager.setState(z,this.currentConfig)}},10),this.stateSynchronizer.startSync()}async initializeGame(z){try{return this.stateMachine.transition(""loading""),this.currentConfig=z,this.currentState={id:`game-${Date.now()}`,level:1,score:0,health:z.initialHealth,inventory:[],position:{x:400,y:300},timestamp:new Date},this.gameStatistics={totalMoves:0,itemsCollected:0,enemiesDefeated:0,distanceTraveled:0,averageReactionTime:0},this.publishEvent(Re.createEvent({type:""game.engine.initialized"",source:""/vitegame/game-engine"",data:{config:z}})),this.stateMachine.transition(""running""),this.currentState}catch($){throw this.stateMachine.transition(""error""),$}}async startGame(z){if(!this.container)throw new Error(""Game container not set. Call setContainer() first."");try{return z&&await this.loadGame(z),this.sceneManager.isInitialized()||await this.sceneManager.initialize(this.container,800,600),this.gameLoop.start(),this.gameStartTime=Date.now(),this.stateMachine.current!==""running""&&this.stateMachine.transition(""running""),this.publishEvent(Re.createEvent({type:""game.engine.started"",source:""/vitegame/game-engine"",data:{saveId:z,state:this.currentState,timestamp:this.gameStartTime},id:`start-${Date.now()}`})),this.currentState}catch($){throw this.stateMachine.transition(""error""),$}}async pauseGame(){this.gameLoop.stop(),this.sceneManager.pauseGame(),this.stateMachine.current===""running""&&this.stateMachine.transition(""paused""),this.publishEvent(Re.createEvent({type:""game.engine.paused"",source:""/vitegame/game-engine"",data:{state:this.currentState},id:`pause-${Date.now()}`}))}async resumeGame(){this.gameLoop.start(),this.sceneManager.resumeGame(),this.stateMachine.current===""paused""&&this.stateMachine.transition(""running""),this.publishEvent(Re.createEvent({type:""game.engine.resumed"",source:""/vitegame/game-engine"",data:{state:this.currentState},id:`resume-${Date.now()}`}))}async saveGame(){if(!this.currentState||!this.currentConfig)throw new Error(""No game state to save"");this.stateManager.setState(this.currentState,this.currentConfig);const z=await this.stateManager.saveGame();return this.publishEvent(Re.createEvent({type:""game.save.completed"",source:""game-engine-adapter"",data:{saveId:z},id:`save-${Date.now()}`})),z}async loadGame(z){try{const{state:$,config:q}=await this.stateManager.loadGame(z);return this.currentState=$,this.currentConfig=q,this.stateSynchronizer.forceState($),this.sceneManager.setGameState(this.currentState),this.publishEvent(Re.createEvent({type:""game.save.loaded"",source:""game-engine-adapter"",data:{saveId:z,state:this.currentState},id:`load-${Date.now()}`})),this.currentState}catch($){throw this.publishEvent(Re.createEvent({type:""game.save.load_failed"",source:""game-engine-adapter"",data:{saveId:z,error:$.message},id:`load-error-${Date.now()}`})),$}}async handleInput(z){this.gameStatistics.totalMoves++;const $=Date.now()-z.timestamp.getTime();this.gameStatistics.averageReactionTime=(this.gameStatistics.averageReactionTime+$)/2;const q=this.sceneManager.getCurrentScene();q&&""handleInput""in q&&q.handleInput(z),this.publishEvent(Re.createEvent({type:""game.input.received"",source:""game-engine-adapter"",data:{input:z},id:`input-${Date.now()}`}))}getCurrentState(){const z=this.sceneManager.getGameState();return z&&(this.currentState={...this.currentState,...z}),{...this.currentState}}onGameEvent(z){this.eventCallbacks.add(z)}offGameEvent(z){this.eventCallbacks.delete(z)}async endGame(){this.gameLoop.stop();const z=this.gameStartTime>0?Date.now()-this.gameStartTime:0,$={finalScore:this.currentState.score,levelReached:this.currentState.level,playTime:z,achievements:[],statistics:this.gameStatistics};return this.publishEvent(Re.createEvent({type:""game.session.ended"",source:""game-engine-adapter"",data:{result:$},id:`end-${Date.now()}`})),$}setContainer(z){this.container=z}getStateMachineState(){return this.stateMachine.current}async updateGame(z){try{if(this.currentState={...this.currentState,timestamp:new Date},this.sceneManager.isInitialized()){const $=this.sceneManager.getGameState();if($){const q=this.currentState.position,et=$.position;if(q&&et){const ht=Math.sqrt(Math.pow(et.x-q.x,2)+Math.pow(et.y-q.y,2));this.gameStatistics.distanceTraveled+=ht}this.currentState={...this.currentState,...$}}}}catch($){console.warn(""Error in updateGame:"",$)}}handleDomainEvent(z){this.eventCallbacks.forEach($=>{try{$(z)}catch(q){console.error(""Error in event callback:"",q)}})}publishEvent(z){this.handleDomainEvent(z)}publishGameEvent(z){Wn.publish(z,{source:""phaser-engine"",priority:Pi.NORMAL})}setupEventBusListeners(){const z=Wn.subscribe(""react.command.pause"",async g=>{console.log(""Received pause command from React:"",g),await this.pauseGame(),this.publishGameEvent({type:""phaser.response.completed"",data:{command:""pause"",timestamp:new Date}})},{context:""phaser-adapter"",priority:Pi.HIGH}),$=Wn.subscribe(""react.command.resume"",async g=>{console.log(""Received resume command from React:"",g),await this.resumeGame(),this.publishGameEvent({type:""phaser.response.completed"",data:{command:""resume"",timestamp:new Date}})},{context:""phaser-adapter"",priority:Pi.HIGH}),q=Wn.subscribe(""react.command.save"",async g=>{console.log(""Received save command from React:"",g);try{const A=await this.saveGame();this.publishGameEvent({type:""phaser.response.completed"",data:{command:""save"",result:{saveId:A},timestamp:new Date}})}catch(A){this.publishGameEvent({type:""game.error"",data:{error:A.message,context:""save-command"",timestamp:new Date}})}},{context:""phaser-adapter"",priority:Pi.HIGH}),et=Wn.subscribe(""react.command.load"",async g=>{console.log(""Received load command from React:"",g);try{if(!g.data||typeof g.data!=""object""||!(""saveId""in g.data))throw new Error(""Invalid load command: missing saveId"");const A=g.data.saveId,t=await this.loadGame(A);this.publishGameEvent({type:""phaser.response.completed"",data:{command:""load"",result:{gameState:t},timestamp:new Date}})}catch(A){this.publishGameEvent({type:""game.error"",data:{error:A.message,context:""load-command"",timestamp:new Date}})}},{context:""phaser-adapter"",priority:Pi.HIGH}),ht=Wn.subscribe(""react.command.restart"",async g=>{console.log(""Received restart command from React:"",g);try{if(await this.endGame(),this.currentConfig){const A=await this.initializeGame(this.currentConfig);await this.startGame(),this.publishGameEvent({type:""phaser.response.completed"",data:{command:""restart"",result:{gameState:A},timestamp:new Date}})}}catch(A){this.publishGameEvent({type:""game.error"",data:{error:A.message,context:""restart-command"",timestamp:new Date}})}},{context:""phaser-adapter"",priority:Pi.HIGH});this.eventBusSubscriptions.push(z,$,q,et,ht),this.publishGameEvent({type:""phaser.response.ready"",data:{timestamp:new Date}})}publishDomainEventToEventBus(z){let $=null;switch(z.type){case""game.state.manager.updated"":$={type:""game.state.updated"",data:{gameState:z.data&&typeof z.data==""object""&&""state""in z.data?z.data.state:{},timestamp:new Date}};break;case""game.save.created"":$={type:""game.save.created"",data:{saveId:z.data&&typeof z.data==""object""&&""saveId""in z.data?z.data.saveId:"""",gameState:z.data&&typeof z.data==""object""&&""state""in z.data?z.data.state:{}}};break;case""game.save.loaded"":$={type:""game.save.loaded"",data:{saveId:z.data&&typeof z.data==""object""&&""saveId""in z.data?z.data.saveId:"""",gameState:z.data&&typeof z.data==""object""&&""state""in z.data?z.data.state:{}}};break;case""game.autosave.completed"":$={type:""game.autosave.completed"",data:{saveId:z.data&&typeof z.data==""object""&&""saveId""in z.data?z.data.saveId:"""",timestamp:new Date}};break}$&&Wn.publish($,{source:""phaser-adapter"",priority:Pi.NORMAL})}destroy(){this.eventBusSubscriptions.forEach(z=>{Wn.unsubscribe(z)}),this.eventBusSubscriptions=[],this.gameLoop.stop(),this.sceneManager.destroy(),this.stateManager.destroy(),this.stateSynchronizer.destroy(),this.eventCallbacks.clear()}}function LE({width:st=800,height:z=600,className:$="""",onGameEvent:q,onGameStateChange:et,autoStart:ht=!0}){const g=zt.useRef(null),A=zt.useRef(null),[t,c]=zt.useState(null),[m,h]=zt.useState(!1),[s,r]=zt.useState(null),e=Sy({context:""game-canvas"",enableAutoCleanup:!0}),n=zt.useCallback(d=>{if(console.log(""Game Event:"",d),!d.type.startsWith(""game."")&&!d.type.startsWith(""phaser."")&&!d.type.startsWith(""react.""))return;const u=d;if(u.type===""game.state.updated""||u.type===""game.state.changed""){const{gameState:p}=u.data.gameState?{gameState:u.data.gameState}:u.data;c(p),et?.(p)}u.type===""game.error""&&u.data&&""error""in u.data?r(u.data.error):u.type===""game.warning""&&u.data&&""warning""in u.data&&console.warn(""Game warning:"",u.data.warning),q?.(d)},[q,et]);zt.useEffect(()=>A.current?((async()=>{try{h(!0),r(null);const u=new Ey;g.current=u,u.setContainer(A.current),u.onGameEvent(n);const p={maxLevel:50,initialHealth:100,scoreMultiplier:1,autoSave:!0,difficulty:""medium""},x=await u.initializeGame(p);c(x),ht&&await u.startGame(),h(!1)}catch(u){console.error(""Failed to initialize game:"",u),r(u.message),h(!1)}})(),()=>{g.current&&(g.current.destroy(),g.current=null)}):void 0,[st,z,ht,n]),zt.useEffect(()=>{const d=e.onGameStateChange(u=>{console.log(""Game state changed via EventBus:"",u),c(u.data.gameState),et?.(u.data.gameState)});return()=>{d.forEach(u=>e.unsubscribe(u))}},[e,et]),zt.useEffect(()=>{const d=e.onGameError(u=>{console.error(""Game error via EventBus:"",u),u.type===""game.error""&&""error""in u.data?r(u.data.error):u.type===""game.warning""&&""warning""in u.data&&r(u.data.warning)});return()=>{d.forEach(u=>e.unsubscribe(u))}},[e]),zt.useEffect(()=>{const d=e.onPhaserResponse(u=>{console.log(""Phaser response:"",u),u.type===""phaser.response.ready""&&console.log(""Phaser engine is ready"")});return()=>{d.forEach(u=>e.unsubscribe(u))}},[e]);const o=zt.useCallback(()=>{e.sendCommandToPhaser(""pause"")},[e]),i=zt.useCallback(()=>{e.sendCommandToPhaser(""resume"")},[e]),l=zt.useCallback(()=>{e.sendCommandToPhaser(""save"")},[e]);zt.useCallback(d=>{e.sendCommandToPhaser(""load"",{saveId:d})},[e]);const f=zt.useCallback(()=>{e.sendCommandToPhaser(""restart"")},[e]);return m?Ft.jsxDEV(""div"",{className:`game-canvas loading ${$}`,style:{width:st,height:z,display:""flex"",justifyContent:""center"",alignItems:""center"",border:""2px solid #3182ce"",borderRadius:""8px"",backgroundColor:""#1a202c""},children:Ft.jsxDEV(""div"",{style:{color:""#ffffff"",fontSize:""18px""},children:""正在加载游戏引擎...""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:230,columnNumber:9},this)},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:217,columnNumber:7},this):s?Ft.jsxDEV(""div"",{className:`game-canvas error ${$}`,style:{width:st,height:z,display:""flex"",flexDirection:""column"",justifyContent:""center"",alignItems:""center"",border:""2px solid #ef4444"",borderRadius:""8px"",backgroundColor:""#1a202c"",padding:""20px""},children:[Ft.jsxDEV(""div"",{style:{color:""#ef4444"",fontSize:""18px"",marginBottom:""10px""},children:""游戏引擎初始化失败""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:255,columnNumber:9},this),Ft.jsxDEV(""div"",{style:{color:""#94a3b8"",fontSize:""14px"",textAlign:""center""},children:s},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:260,columnNumber:9},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:240,columnNumber:7},this):Ft.jsxDEV(""div"",{className:`game-canvas ${$}`,style:{position:""relative"",border:""2px solid #3182ce"",borderRadius:""8px"",padding:""10px"",backgroundColor:""#1a202c""},children:[Ft.jsxDEV(""div"",{ref:A,style:{width:st,height:z,display:""flex"",justifyContent:""center"",alignItems:""center""}},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:280,columnNumber:7},this),t&&Ft.jsxDEV(""div"",{style:{position:""absolute"",top:""20px"",right:""20px"",backgroundColor:""rgba(0, 0, 0, 0.8)"",color:""#ffffff"",padding:""10px"",borderRadius:""5px"",fontSize:""12px"",minWidth:""150px""},children:[Ft.jsxDEV(""div"",{children:[""分数: "",t.score]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:306,columnNumber:11},this),Ft.jsxDEV(""div"",{children:[""等级: "",t.level]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:307,columnNumber:11},this),Ft.jsxDEV(""div"",{children:[""生命值: "",t.health]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:308,columnNumber:11},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:293,columnNumber:9},this),Ft.jsxDEV(""div"",{style:{position:""absolute"",bottom:""20px"",left:""20px"",display:""flex"",gap:""10px""},children:[Ft.jsxDEV(""button"",{onClick:o,style:{padding:""5px 10px"",backgroundColor:""#3182ce"",color:""#ffffff"",border:""none"",borderRadius:""3px"",cursor:""pointer"",fontSize:""12px""},children:""暂停""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:322,columnNumber:9},this),Ft.jsxDEV(""button"",{onClick:i,style:{padding:""5px 10px"",backgroundColor:""#059669"",color:""#ffffff"",border:""none"",borderRadius:""3px"",cursor:""pointer"",fontSize:""12px""},children:""继续""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:336,columnNumber:9},this),Ft.jsxDEV(""button"",{onClick:l,style:{padding:""5px 10px"",backgroundColor:""#dc2626"",color:""#ffffff"",border:""none"",borderRadius:""3px"",cursor:""pointer"",fontSize:""12px""},children:""保存""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:350,columnNumber:9},this),Ft.jsxDEV(""button"",{onClick:f,style:{padding:""5px 10px"",backgroundColor:""#f59e0b"",color:""#ffffff"",border:""none"",borderRadius:""3px"",cursor:""pointer"",fontSize:""12px""},children:""重启""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:364,columnNumber:9},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:313,columnNumber:7},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameCanvas.tsx"",lineNumber:270,columnNumber:5},this)}const OE=""modulepreload"",DE=function(st,z){return new URL(st,z).href},sy={},wE=function(z,$,q){let et=Promise.resolve();if($&&$.length>0){let c=function(m){return Promise.all(m.map(h=>Promise.resolve(h).then(s=>({status:""fulfilled"",value:s}),s=>({status:""rejected"",reason:s}))))};const g=document.getElementsByTagName(""link""),A=document.querySelector(""meta[property=csp-nonce]""),t=A?.nonce||A?.getAttribute(""nonce"");et=c($.map(m=>{if(m=DE(m,q),m in sy)return;sy[m]=!0;const h=m.endsWith("".css""),s=h?'[rel=""stylesheet""]':"""";if(!!q)for(let n=g.length-1;n>=0;n--){const o=g[n];if(o.href===m&&(!h||o.rel===""stylesheet""))return}else if(document.querySelector(`link[href=""${m}""]${s}`))return;const e=document.createElement(""link"");if(e.rel=h?""stylesheet"":OE,h||(e.as=""script""),e.crossOrigin="""",e.href=m,t&&e.setAttribute(""nonce"",t),document.head.appendChild(e),h)return new Promise((n,o)=>{e.addEventListener(""load"",n),e.addEventListener(""error"",()=>o(new Error(`Unable to preload CSS for ${m}`)))})}))}function ht(g){const A=new Event(""vite:preloadError"",{cancelable:!0});if(A.payload=g,window.dispatchEvent(A),!A.defaultPrevented)throw g}return et.then(g=>{for(const A of g||[])A.status===""rejected""&&ht(A.reason);return z().catch(ht)})};let Cy=-1;const la=st=>{addEventListener(""pageshow"",z=>{z.persisted&&(Cy=z.timeStamp,st(z))},!0)},gn=(st,z,$,q)=>{let et,ht;return g=>{z.value>=0&&(g||q)&&(ht=z.value-(et??0),(ht||et===void 0)&&(et=z.value,z.delta=ht,z.rating=((A,t)=>A>t[1]?""poor"":A>t[0]?""needs-improvement"":""good"")(z.value,$),st(z)))}},Mc=st=>{requestAnimationFrame(()=>requestAnimationFrame(()=>st()))},Pc=()=>{const st=performance.getEntriesByType(""navigation"")[0];if(st&&st.responseStart>0&&st.responseStart<performance.now())return st},Go=()=>Pc()?.activationStart??0,xn=(st,z=-1)=>{const $=Pc();let q=""navigate"";return Cy>=0?q=""back-forward-cache"":$&&(document.prerendering||Go()>0?q=""prerender"":document.wasDiscarded?q=""restore"":$.type&&(q=$.type.replace(/_/g,""-""))),{name:st,value:z,rating:""good"",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:q}},gc=new WeakMap;function Lc(st,z){return gc.get(st)||gc.set(st,new z),gc.get(st)}class FE{t;i=0;o=[];h(z){if(z.hadRecentInput)return;const $=this.o[0],q=this.o.at(-1);this.i&&$&&q&&z.startTime-q.startTime<1e3&&z.startTime-$.startTime<5e3?(this.i+=z.value,this.o.push(z)):(this.i=z.value,this.o=[z]),this.t?.(z)}}const Io=(st,z,$={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(st)){const q=new PerformanceObserver(et=>{Promise.resolve().then(()=>{z(et.getEntries())})});return q.observe({type:st,buffered:!0,...$}),q}}catch{}},Oc=st=>{let z=!1;return()=>{z||(st(),z=!0)}};let ra=-1;const Ay=new Set,ry=()=>document.visibilityState!==""hidden""||document.prerendering?1/0:0,Sc=st=>{if(document.visibilityState===""hidden""){if(st.type===""visibilitychange"")for(const z of Ay)z();isFinite(ra)||(ra=st.type===""visibilitychange""?st.timeStamp:0,removeEventListener(""prerenderingchange"",Sc,!0))}},Ih=()=>{if(ra<0){const st=Go();ra=(document.prerendering?void 0:globalThis.performance.getEntriesByType(""visibility-state"").filter($=>$.name===""hidden""&&$.startTime>st)[0]?.startTime)??ry(),addEventListener(""visibilitychange"",Sc,!0),addEventListener(""prerenderingchange"",Sc,!0),la(()=>{setTimeout(()=>{ra=ry()})})}return{get firstHiddenTime(){return ra},onHidden(st){Ay.add(st)}}},zh=st=>{document.prerendering?addEventListener(""prerenderingchange"",()=>st(),!0):st()},ay=[1800,3e3],Ry=(st,z={})=>{zh(()=>{const $=Ih();let q,et=xn(""FCP"");const ht=Io(""paint"",g=>{for(const A of g)A.name===""first-contentful-paint""&&(ht.disconnect(),A.startTime<$.firstHiddenTime&&(et.value=Math.max(A.startTime-Go(),0),et.entries.push(A),q(!0)))});ht&&(q=gn(st,et,ay,z.reportAllChanges),la(g=>{et=xn(""FCP""),q=gn(st,et,ay,z.reportAllChanges),Mc(()=>{et.value=performance.now()-g.timeStamp,q(!0)})}))})},oy=[.1,.25],bE=(st,z={})=>{const $=Ih();Ry(Oc(()=>{let q,et=xn(""CLS"",0);const ht=Lc(z,FE),g=t=>{for(const c of t)ht.h(c);ht.i>et.value&&(et.value=ht.i,et.entries=ht.o,q())},A=Io(""layout-shift"",g);A&&(q=gn(st,et,oy,z.reportAllChanges),$.onHidden(()=>{g(A.takeRecords()),q(!0)}),la(()=>{ht.i=0,et=xn(""CLS"",0),q=gn(st,et,oy,z.reportAllChanges),Mc(()=>q())}),setTimeout(q))}))};let My=0,xc=1/0,bh=0;const BE=st=>{for(const z of st)z.interactionId&&(xc=Math.min(xc,z.interactionId),bh=Math.max(bh,z.interactionId),My=bh?(bh-xc)/7+1:0)};let Ec;const ly=()=>Ec?My:performance.interactionCount??0,NE=()=>{""interactionCount""in performance||Ec||(Ec=Io(""event"",BE,{type:""event"",buffered:!0,durationThreshold:0}))};let hy=0;class GE{u=[];l=new Map;m;p;v(){hy=ly(),this.u.length=0,this.l.clear()}L(){const z=Math.min(this.u.length-1,Math.floor((ly()-hy)/50));return this.u[z]}h(z){if(this.m?.(z),!z.interactionId&&z.entryType!==""first-input"")return;const $=this.u.at(-1);let q=this.l.get(z.interactionId);if(q||this.u.length<10||z.duration>$.P){if(q?z.duration>q.P?(q.entries=[z],q.P=z.duration):z.duration===q.P&&z.startTime===q.entries[0].startTime&&q.entries.push(z):(q={id:z.interactionId,entries:[z],P:z.duration},this.l.set(q.id,q),this.u.push(q)),this.u.sort((et,ht)=>ht.P-et.P),this.u.length>10){const et=this.u.splice(10);for(const ht of et)this.l.delete(ht.id)}this.p?.(q)}}}const Py=st=>{const z=globalThis.requestIdleCallback||setTimeout;document.visibilityState===""hidden""?st():(st=Oc(st),addEventListener(""visibilitychange"",st,{once:!0,capture:!0}),z(()=>{st(),removeEventListener(""visibilitychange"",st,{capture:!0})}))},uy=[200,500],IE=(st,z={})=>{if(!globalThis.PerformanceEventTiming||!(""interactionId""in PerformanceEventTiming.prototype))return;const $=Ih();zh(()=>{NE();let q,et=xn(""INP"");const ht=Lc(z,GE),g=t=>{Py(()=>{for(const m of t)ht.h(m);const c=ht.L();c&&c.P!==et.value&&(et.value=c.P,et.entries=c.entries,q())})},A=Io(""event"",g,{durationThreshold:z.durationThreshold??40});q=gn(st,et,uy,z.reportAllChanges),A&&(A.observe({type:""first-input"",buffered:!0}),$.onHidden(()=>{g(A.takeRecords()),q(!0)}),la(()=>{ht.v(),et=xn(""INP""),q=gn(st,et,uy,z.reportAllChanges)}))})};class zE{m;h(z){this.m?.(z)}}const fy=[2500,4e3],UE=(st,z={})=>{zh(()=>{const $=Ih();let q,et=xn(""LCP"");const ht=Lc(z,zE),g=t=>{z.reportAllChanges||(t=t.slice(-1));for(const c of t)ht.h(c),c.startTime<$.firstHiddenTime&&(et.value=Math.max(c.startTime-Go(),0),et.entries=[c],q())},A=Io(""largest-contentful-paint"",g);if(A){q=gn(st,et,fy,z.reportAllChanges);const t=Oc(()=>{g(A.takeRecords()),A.disconnect(),q(!0)}),c=m=>{m.isTrusted&&(Py(t),removeEventListener(m.type,c,{capture:!0}))};for(const m of[""keydown"",""click"",""visibilitychange""])addEventListener(m,c,{capture:!0});la(m=>{et=xn(""LCP""),q=gn(st,et,fy,z.reportAllChanges),Mc(()=>{et.value=performance.now()-m.timeStamp,q(!0)})})}})},dy=[800,1800],Cc=st=>{document.prerendering?zh(()=>Cc(st)):document.readyState!==""complete""?addEventListener(""load"",()=>Cc(st),!0):setTimeout(st)},VE=(st,z={})=>{let $=xn(""TTFB""),q=gn(st,$,dy,z.reportAllChanges);Cc(()=>{const et=Pc();et&&($.value=Math.max(et.responseStart-Go(),0),$.entries=[et],q(!0),la(()=>{$=xn(""TTFB"",0),q=gn(st,$,dy,z.reportAllChanges),q(!0)}))})},XE={LCP:{good:2500,needs_improvement:4e3},INP:{good:200,needs_improvement:500},CLS:{good:.1,needs_improvement:.25},FCP:{good:1800,needs_improvement:3e3},TTFB:{good:800,needs_improvement:1800}};class YE{metrics={customTimings:{}};callbacks=[];isInitialized=!1;userTimings=[];PERFORMANCE_TARGETS={interaction_p95:100,event_p95:50,route_change_p95:200,data_fetch_p95:300};constructor(){this.initializeWebVitals(),this.setupCustomPerformanceObserver()}initializeWebVitals(){if(!(this.isInitialized||typeof window>""u""))try{bE(this.onCLS.bind(this),{reportAllChanges:!0}),Ry(this.onFCP.bind(this)),IE(this.onINP.bind(this)),UE(this.onLCP.bind(this),{reportAllChanges:!0}),VE(this.onTTFB.bind(this)),this.initializeINP(),this.isInitialized=!0,console.log(""[WebVitals] 监控系统初始化完成"")}catch(z){console.error(""[WebVitals] 初始化失败:"",z)}}initializeINP(){""PerformanceEventTiming""in window&&new PerformanceObserver($=>{const q=$.getEntries();for(const et of q)if(et.processingStart&&et.processingEnd){const ht=et.processingEnd-et.startTime;if(ht>0){const g=this.getRating(""INP"",ht),A={id:`inp-${Date.now()}`,name:""INP"",value:ht,delta:ht,rating:g,entries:[et],timestamp:Date.now(),navigationType:this.getNavigationType(),connection:this.getConnectionInfo()};this.metrics.inp=A,this.notifyCallbacks()}}}).observe({entryTypes:[""event""]})}setupCustomPerformanceObserver(){""PerformanceObserver""in window&&new PerformanceObserver($=>{const q=$.getEntries();for(const et of q)et.entryType===""mark""?this.userTimings.push({name:et.name,startTime:et.startTime,type:""mark""}):et.entryType===""measure""&&(this.userTimings.push({name:et.name,startTime:et.startTime,duration:et.duration,type:""measure""}),this.metrics.customTimings[et.name]=et.duration)}).observe({entryTypes:[""mark"",""measure""]})}onCLS(z){const $=this.getRating(""CLS"",z.value);this.metrics.cls={...z,rating:$,timestamp:Date.now(),navigationType:this.getNavigationType(),connection:this.getConnectionInfo()},this.notifyCallbacks()}onFCP(z){const $=this.getRating(""FCP"",z.value);this.metrics.fcp={...z,rating:$,timestamp:Date.now(),navigationType:this.getNavigationType(),connection:this.getConnectionInfo()},this.notifyCallbacks()}onLCP(z){const $=this.getRating(""LCP"",z.value);this.metrics.lcp={...z,rating:$,timestamp:Date.now(),navigationType:this.getNavigationType(),connection:this.getConnectionInfo()},this.notifyCallbacks()}onTTFB(z){const $=this.getRating(""TTFB"",z.value);this.metrics.ttfb={...z,rating:$,timestamp:Date.now(),navigationType:this.getNavigationType(),connection:this.getConnectionInfo()},this.notifyCallbacks()}onINP(z){const $=this.getRating(""INP"",z.value);this.metrics.inp={...z,rating:$,timestamp:Date.now(),navigationType:this.getNavigationType(),connection:this.getConnectionInfo()},this.notifyCallbacks()}getRating(z,$){const q=XE[z];return $<=q.good?""good"":$<=q.needs_improvement?""needs-improvement"":""poor""}getNavigationType(){return""navigation""in performance&&""type""in performance.navigation&&[""navigate"",""reload"",""back_forward"",""prerender""][performance.navigation.type]||""unknown""}getConnectionInfo(){if(""connection""in navigator&&navigator.connection){const z=navigator.connection;return{effectiveType:z.effectiveType,downlink:z.downlink,rtt:z.rtt}}}notifyCallbacks(){this.callbacks.forEach(z=>{try{z(this.metrics)}catch($){console.error(""[WebVitals] 回调函数执行错误:"",$)}})}subscribe(z){return this.callbacks.push(z),Object.keys(this.metrics).length>1&&z(this.metrics),()=>{const $=this.callbacks.indexOf(z);$>-1&&this.callbacks.splice($,1)}}getMetrics(){return{...this.metrics}}mark(z){""performance""in window&&""mark""in performance&&performance.mark(z)}measure(z,$,q){""performance""in window&&""measure""in performance&&($&&q?performance.measure(z,$,q):$?performance.measure(z,$):performance.measure(z))}recordInteraction(z,$){this.metrics.customTimings[`interaction_${z}`]=$,$>this.PERFORMANCE_TARGETS.interaction_p95&&console.warn(`[WebVitals] 交互""${z}""耗时${$}ms，超出P95目标${this.PERFORMANCE_TARGETS.interaction_p95}ms`)}recordEvent(z,$){this.metrics.customTimings[`event_${z}`]=$,$>this.PERFORMANCE_TARGETS.event_p95&&console.warn(`[WebVitals] 事件""${z}""处理耗时${$}ms，超出P95目标${this.PERFORMANCE_TARGETS.event_p95}ms`)}recordRouteChange(z,$,q){const et=`route_${z}_to_${$}`;this.metrics.customTimings[et]=q,q>this.PERFORMANCE_TARGETS.route_change_p95&&console.warn(`[WebVitals] 路由切换""${z} → ${$}""耗时${q}ms，超出P95目标${this.PERFORMANCE_TARGETS.route_change_p95}ms`)}recordDataFetch(z,$){this.metrics.customTimings[`fetch_${z}`]=$,$>this.PERFORMANCE_TARGETS.data_fetch_p95&&console.warn(`[WebVitals] 数据获取""${z}""耗时${$}ms，超出P95目标${this.PERFORMANCE_TARGETS.data_fetch_p95}ms`)}getPerformanceSummary(){const{lcp:z,inp:$,cls:q,fcp:et,ttfb:ht}=this.metrics;return{coreVitals:{lcp:z?{value:z.value,rating:z.rating}:null,inp:$?{value:$.value,rating:$.rating}:null,cls:q?{value:q.value,rating:q.rating}:null},otherMetrics:{fcp:et?{value:et.value,rating:et.rating}:null,ttfb:ht?{value:ht.value,rating:ht.rating}:null},customTimings:{...this.metrics.customTimings},userTimings:[...this.userTimings],timestamp:Date.now()}}reset(){this.metrics={customTimings:{}},this.userTimings=[],console.log(""[WebVitals] 性能指标已重置"")}destroy(){this.callbacks=[],this.reset(),console.log(""[WebVitals] 监控器已销毁"")}}let yc=null;const Ly=()=>(yc||(yc=new YE),yc),aa=typeof __SENTRY_DEBUG__>""u""||__SENTRY_DEBUG__,Ss=globalThis,Bo=""10.5.0"";function Dc(){return wc(Ss),Ss}function wc(st){const z=st.__SENTRY__=st.__SENTRY__||{};return z.version=z.version||Bo,z[Bo]=z[Bo]||{}}function Fc(st,z,$=Ss){const q=$.__SENTRY__=$.__SENTRY__||{},et=q[Bo]=q[Bo]||{};return et[st]||(et[st]=z())}const HE=""Sentry Logger "",cy={};function Oy(st){if(!(""console""in Ss))return st();const z=Ss.console,$={},q=Object.keys(cy);q.forEach(et=>{const ht=cy[et];$[et]=z[et],z[et]=ht});try{return st()}finally{q.forEach(et=>{z[et]=$[et]})}}function WE(){Bc().enabled=!0}function ZE(){Bc().enabled=!1}function Dy(){return Bc().enabled}function QE(...st){bc(""log"",...st)}function KE(...st){bc(""warn"",...st)}function $E(...st){bc(""error"",...st)}function bc(st,...z){aa&&Dy()&&Oy(()=>{Ss.console[st](`${HE}[${st}]:`,...z)})}function Bc(){return aa?Fc(""loggerSettings"",()=>({enabled:!1})):{enabled:!1}}const Nh={enable:WE,disable:ZE,isEnabled:Dy,log:QE,warn:KE,error:$E},JE=Object.prototype.toString;function jE(st,z){return JE.call(st)===`[object ${z}]`}function kE(st){return jE(st,""Object"")}function qE(st){return!!(st?.then&&typeof st.then==""function"")}function _E(st,z=0){return typeof st!=""string""||z===0||st.length<=z?st:`${st.slice(0,z)}...`}function tC(st,z,$){try{Object.defineProperty(st,z,{value:$,writable:!0,configurable:!0})}catch{aa&&Nh.log(`Failed to add non-enumerable property ""${z}"" to object`,st)}}function eC(){const st=Ss;return st.crypto||st.msCrypto}function No(st=eC()){let z=()=>Math.random()*16;try{if(st?.randomUUID)return st.randomUUID().replace(/-/g,"""");st?.getRandomValues&&(z=()=>{const $=new Uint8Array(1);return st.getRandomValues($),$[0]})}catch{}return(""10000000100040008000""+1e11).replace(/[018]/g,$=>($^(z()&15)>>$/4).toString(16))}const wy=1e3;function Nc(){return Date.now()/wy}function iC(){const{performance:st}=Ss;if(!st?.now||!st.timeOrigin)return Nc;const z=st.timeOrigin;return()=>(z+st.now())/wy}let vy;function nC(){return(vy??(vy=iC()))()}function sC(st,z={}){if(z.user&&(!st.ipAddress&&z.user.ip_address&&(st.ipAddress=z.user.ip_address),!st.did&&!z.did&&(st.did=z.user.id||z.user.email||z.user.username)),st.timestamp=z.timestamp||nC(),z.abnormal_mechanism&&(st.abnormal_mechanism=z.abnormal_mechanism),z.ignoreDuration&&(st.ignoreDuration=z.ignoreDuration),z.sid&&(st.sid=z.sid.length===32?z.sid:No()),z.init!==void 0&&(st.init=z.init),!st.did&&z.did&&(st.did=`${z.did}`),typeof z.started==""number""&&(st.started=z.started),st.ignoreDuration)st.duration=void 0;else if(typeof z.duration==""number"")st.duration=z.duration;else{const $=st.timestamp-st.started;st.duration=$>=0?$:0}z.release&&(st.release=z.release),z.environment&&(st.environment=z.environment),!st.ipAddress&&z.ipAddress&&(st.ipAddress=z.ipAddress),!st.userAgent&&z.userAgent&&(st.userAgent=z.userAgent),typeof z.errors==""number""&&(st.errors=z.errors),z.status&&(st.status=z.status)}function Fy(st,z,$=2){if(!z||typeof z!=""object""||$<=0)return z;if(st&&Object.keys(z).length===0)return st;const q={...st};for(const et in z)Object.prototype.hasOwnProperty.call(z,et)&&(q[et]=Fy(q[et],z[et],$-1));return q}function py(){return No()}const Ac=""_sentrySpan"";function my(st,z){z?tC(st,Ac,z):delete st[Ac]}function gy(st){return st[Ac]}const rC=100;class sr{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:py(),sampleRand:Math.random()}}clone(){const z=new sr;return z._breadcrumbs=[...this._breadcrumbs],z._tags={...this._tags},z._extra={...this._extra},z._contexts={...this._contexts},this._contexts.flags&&(z._contexts.flags={values:[...this._contexts.flags.values]}),z._user=this._user,z._level=this._level,z._session=this._session,z._transactionName=this._transactionName,z._fingerprint=this._fingerprint,z._eventProcessors=[...this._eventProcessors],z._attachments=[...this._attachments],z._sdkProcessingMetadata={...this._sdkProcessingMetadata},z._propagationContext={...this._propagationContext},z._client=this._client,z._lastEventId=this._lastEventId,my(z,gy(this)),z}setClient(z){this._client=z}setLastEventId(z){this._lastEventId=z}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(z){this._scopeListeners.push(z)}addEventProcessor(z){return this._eventProcessors.push(z),this}setUser(z){return this._user=z||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&sC(this._session,{user:z}),this._notifyScopeListeners(),this}getUser(){return this._user}setTags(z){return this._tags={...this._tags,...z},this._notifyScopeListeners(),this}setTag(z,$){return this._tags={...this._tags,[z]:$},this._notifyScopeListeners(),this}setExtras(z){return this._extra={...this._extra,...z},this._notifyScopeListeners(),this}setExtra(z,$){return this._extra={...this._extra,[z]:$},this._notifyScopeListeners(),this}setFingerprint(z){return this._fingerprint=z,this._notifyScopeListeners(),this}setLevel(z){return this._level=z,this._notifyScopeListeners(),this}setTransactionName(z){return this._transactionName=z,this._notifyScopeListeners(),this}setContext(z,$){return $===null?delete this._contexts[z]:this._contexts[z]=$,this._notifyScopeListeners(),this}setSession(z){return z?this._session=z:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(z){if(!z)return this;const $=typeof z==""function""?z(this):z,q=$ instanceof sr?$.getScopeData():kE($)?z:void 0,{tags:et,extra:ht,user:g,contexts:A,level:t,fingerprint:c=[],propagationContext:m}=q||{};return this._tags={...this._tags,...et},this._extra={...this._extra,...ht},this._contexts={...this._contexts,...A},g&&Object.keys(g).length&&(this._user=g),t&&(this._level=t),c.length&&(this._fingerprint=c),m&&(this._propagationContext=m),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._session=void 0,my(this,void 0),this._attachments=[],this.setPropagationContext({traceId:py(),sampleRand:Math.random()}),this._notifyScopeListeners(),this}addBreadcrumb(z,$){const q=typeof $==""number""?$:rC;if(q<=0)return this;const et={timestamp:Nc(),...z,message:z.message?_E(z.message,2048):z.message};return this._breadcrumbs.push(et),this._breadcrumbs.length>q&&(this._breadcrumbs=this._breadcrumbs.slice(-q),this._client?.recordDroppedEvent(""buffer_overflow"",""log_item"")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(z){return this._attachments.push(z),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:gy(this)}}setSDKProcessingMetadata(z){return this._sdkProcessingMetadata=Fy(this._sdkProcessingMetadata,z,2),this}setPropagationContext(z){return this._propagationContext=z,this}getPropagationContext(){return this._propagationContext}captureException(z,$){const q=$?.event_id||No();if(!this._client)return aa&&Nh.warn(""No client configured on scope - will not capture exception!""),q;const et=new Error(""Sentry syntheticException"");return this._client.captureException(z,{originalException:z,syntheticException:et,...$,event_id:q},this),q}captureMessage(z,$,q){const et=q?.event_id||No();if(!this._client)return aa&&Nh.warn(""No client configured on scope - will not capture message!""),et;const ht=new Error(z);return this._client.captureMessage(z,$,{originalException:z,syntheticException:ht,...q,event_id:et},this),et}captureEvent(z,$){const q=$?.event_id||No();return this._client?(this._client.captureEvent(z,{...$,event_id:q},this),q):(aa&&Nh.warn(""No client configured on scope - will not capture event!""),q)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(z=>{z(this)}),this._notifyingListeners=!1)}}function aC(){return Fc(""defaultCurrentScope"",()=>new sr)}function oC(){return Fc(""defaultIsolationScope"",()=>new sr)}class lC{constructor(z,$){let q;z?q=z:q=new sr;let et;$?et=$:et=new sr,this._stack=[{scope:q}],this._isolationScope=et}withScope(z){const $=this._pushScope();let q;try{q=z($)}catch(et){throw this._popScope(),et}return qE(q)?q.then(et=>(this._popScope(),et),et=>{throw this._popScope(),et}):(this._popScope(),q)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const z=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:z}),z}_popScope(){return this._stack.length<=1?!1:!!this._stack.pop()}}function oa(){const st=Dc(),z=wc(st);return z.stack=z.stack||new lC(aC(),oC())}function hC(st){return oa().withScope(st)}function uC(st,z){const $=oa();return $.withScope(()=>($.getStackTop().scope=st,z(st)))}function xy(st){return oa().withScope(()=>st(oa().getIsolationScope()))}function fC(){return{withIsolationScope:xy,withScope:hC,withSetScope:uC,withSetIsolationScope:(st,z)=>xy(z),getCurrentScope:()=>oa().getScope(),getIsolationScope:()=>oa().getIsolationScope()}}function by(st){const z=wc(st);return z.acs?z.acs:fC()}function By(){const st=Dc();return by(st).getCurrentScope()}function dC(){const st=Dc();return by(st).getIsolationScope()}function cC(){return By().getClient()}function yy(st,z){const $=typeof z==""string""?z:void 0,q=typeof z!=""string""?{captureContext:z}:void 0;return By().captureMessage(st,$,q)}const vC=100;function Ty(st,z){const $=cC(),q=dC();if(!$)return;const{beforeBreadcrumb:et=null,maxBreadcrumbs:ht=vC}=$.getOptions();if(ht<=0)return;const A={timestamp:Nc(),...st},t=et?Oy(()=>et(A,z)):A;t!==null&&($.emit&&$.emit(""beforeAddBreadcrumb"",t,z),q.addBreadcrumb(t,ht))}class pC{config;dataBuffer=[];flushTimer=null;sessionId;isEnabled=!1;monitor=Ly();unsubscribe=null;DEFAULT_CONFIG={enabled:!0,sentryEnabled:!0,batchSize:10,flushInterval:3e4,storageKey:""web-vitals-data"",baselineWindow:7,regressionThreshold:15};constructor(z={}){this.config={...this.DEFAULT_CONFIG,...z},this.sessionId=this.generateSessionId(),this.config.enabled&&typeof window<""u""&&this.initialize()}initialize(){try{this.unsubscribe=this.monitor.subscribe(z=>{this.collectData(z)}),this.setupFlushTimer(),this.setupUnloadHandler(),this.cleanupOldData(),this.isEnabled=!0,console.log(""[WebVitalsCollector] 数据收集器初始化完成"")}catch(z){console.error(""[WebVitalsCollector] 初始化失败:"",z)}}generateSessionId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}collectData(z){if(!this.isEnabled)return;const $={timestamp:Date.now(),sessionId:this.sessionId,userId:this.getUserId(),metrics:z,context:this.collectContext()};this.dataBuffer.push($),this.dataBuffer.length>=this.config.batchSize&&this.flush(),this.checkRegression($)}collectContext(){const z={userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},navigation:{type:""navigate"",redirectCount:0}};if(""connection""in navigator&&navigator.connection){const $=navigator.connection;z.connection={effectiveType:$.effectiveType,downlink:$.downlink,rtt:$.rtt}}if(""navigation""in performance){const $=performance.navigation;z.navigation={type:[""navigate"",""reload"",""back_forward"",""prerender""][$.type]||""navigate"",redirectCount:$.redirectCount}}if(""memory""in performance){const $=performance.memory;z.memory={usedJSHeapSize:$.usedJSHeapSize,totalJSHeapSize:$.totalJSHeapSize}}return z}getUserId(){try{const z=localStorage.getItem(""userId"")||localStorage.getItem(""user_id"")||sessionStorage.getItem(""userId"");if(z)return z;const $=document.cookie.match(/user_id=([^;]+)/);return $?$[1]:void 0}catch{return}}setupFlushTimer(){this.flushTimer&&clearInterval(this.flushTimer),this.flushTimer=setInterval(()=>{this.dataBuffer.length>0&&this.flush()},this.config.flushInterval)}setupUnloadHandler(){const z=()=>{this.dataBuffer.length>0&&this.flushSync()};window.addEventListener(""beforeunload"",z),window.addEventListener(""pagehide"",z)}flush(){if(this.dataBuffer.length===0)return;const z=[...this.dataBuffer];this.dataBuffer=[],Promise.all([this.sendToSentry(z),this.saveToLocalStorage(z),this.sendToCustomEndpoint(z)]).catch($=>{console.error(""[WebVitalsCollector] 数据上报失败:"",$),this.dataBuffer.unshift(...z)})}flushSync(){if(this.dataBuffer.length===0)return;const z=JSON.stringify(this.dataBuffer);try{""sendBeacon""in navigator&&navigator.sendBeacon(""/api/web-vitals"",z),this.saveToLocalStorageSync(this.dataBuffer)}catch($){console.error(""[WebVitalsCollector] 同步上报失败:"",$)}this.dataBuffer=[]}async sendToSentry(z){if(this.config.sentryEnabled)try{z.forEach($=>{$.metrics.lcp&&this.sendMetricToSentry(""LCP"",$.metrics.lcp,$),$.metrics.inp&&this.sendMetricToSentry(""INP"",$.metrics.inp,$),$.metrics.cls&&this.sendMetricToSentry(""CLS"",$.metrics.cls,$),$.metrics.fcp&&this.sendMetricToSentry(""FCP"",$.metrics.fcp,$),$.metrics.ttfb&&this.sendMetricToSentry(""TTFB"",$.metrics.ttfb,$),Object.entries($.metrics.customTimings).forEach(([q,et])=>{Ty({category:""performance"",message:`Custom timing: ${q}`,level:""info"",data:{value:et,sessionId:$.sessionId}})})})}catch($){throw console.error(""[WebVitalsCollector] Sentry上报失败:"",$),$}}sendMetricToSentry(z,$,q){Ty({category:""performance"",message:`Web Vital: ${z}`,level:$.rating===""good""?""info"":$.rating===""needs-improvement""?""warning"":""error"",data:{value:$.value,rating:$.rating,sessionId:q.sessionId,connection:q.context.connection,viewport:q.context.viewport}}),$.rating===""poor""&&yy(`Poor ${z}: ${$.value}`,{level:""warning"",tags:{webVital:z,rating:$.rating},extra:{metric:$,context:q.context}})}async sendToCustomEndpoint(z){try{await fetch(""/api/web-vitals"",{method:""POST"",headers:{""Content-Type"":""application/json""},body:JSON.stringify(z)})}catch($){console.warn(""[WebVitalsCollector] 自定义端点上报失败:"",$)}}saveToLocalStorage(z){try{const et=[...this.getStoredData(),...z].slice(-1e3);localStorage.setItem(this.config.storageKey,JSON.stringify(et))}catch($){console.error(""[WebVitalsCollector] 本地存储失败:"",$)}}saveToLocalStorageSync(z){try{const et=[...this.getStoredData(),...z].slice(-1e3);localStorage.setItem(this.config.storageKey,JSON.stringify(et))}catch($){console.error(""[WebVitalsCollector] 同步本地存储失败:"",$)}}getStoredData(){try{const z=localStorage.getItem(this.config.storageKey);return z?JSON.parse(z):[]}catch{return[]}}cleanupOldData(){try{const z=this.getStoredData(),$=Date.now()-this.config.baselineWindow*24*60*60*1e3,q=z.filter(et=>et.timestamp>$);q.length!==z.length&&(localStorage.setItem(this.config.storageKey,JSON.stringify(q)),console.log(`[WebVitalsCollector] 清理了${z.length-q.length}条旧数据`))}catch(z){console.error(""[WebVitalsCollector] 数据清理失败:"",z)}}checkRegression(z){try{const $=this.getBaseline();if(!$)return;const q=[];if(z.metrics.lcp&&$.lcp_p95){const et=this.calculateRegression(z.metrics.lcp.value,$.lcp_p95);et>this.config.regressionThreshold&&q.push({metric:""LCP"",currentValue:z.metrics.lcp.value,baselineValue:$.lcp_p95,regressionPercentage:et,severity:et>30?""critical"":""warning"",timestamp:Date.now()})}if(z.metrics.inp&&$.inp_p95){const et=this.calculateRegression(z.metrics.inp.value,$.inp_p95);et>this.config.regressionThreshold&&q.push({metric:""INP"",currentValue:z.metrics.inp.value,baselineValue:$.inp_p95,regressionPercentage:et,severity:et>30?""critical"":""warning"",timestamp:Date.now()})}if(z.metrics.cls&&$.cls_p95){const et=this.calculateRegression(z.metrics.cls.value,$.cls_p95);et>this.config.regressionThreshold&&q.push({metric:""CLS"",currentValue:z.metrics.cls.value,baselineValue:$.cls_p95,regressionPercentage:et,severity:et>50?""critical"":""warning"",timestamp:Date.now()})}q.length>0&&this.reportRegressions(q)}catch($){console.error(""[WebVitalsCollector] 回归检测失败:"",$)}}calculateRegression(z,$){return(z-$)/$*100}reportRegressions(z){z.forEach($=>{console.warn(`[WebVitalsCollector] ${$.metric}性能回归检测:`,$),this.config.sentryEnabled&&yy(`Web Vitals回归: ${$.metric}`,{level:$.severity===""critical""?""error"":""warning"",tags:{regression:!0,metric:$.metric,severity:$.severity},extra:$})})}getBaseline(){try{const z=localStorage.getItem(`${this.config.storageKey}-baseline`);return z?JSON.parse(z):null}catch{return null}}updateBaseline(){try{const z=this.getStoredData(),$=Date.now()-this.config.baselineWindow*24*60*60*1e3,q=z.filter(m=>m.timestamp>$);if(q.length<10)return console.warn(""[WebVitalsCollector] 数据量不足，无法计算基线""),null;const et=q.filter(m=>m.metrics.lcp).map(m=>m.metrics.lcp.value),ht=q.filter(m=>m.metrics.inp).map(m=>m.metrics.inp.value),g=q.filter(m=>m.metrics.cls).map(m=>m.metrics.cls.value),A=q.filter(m=>m.metrics.fcp).map(m=>m.metrics.fcp.value),t=q.filter(m=>m.metrics.ttfb).map(m=>m.metrics.ttfb.value),c={lcp_p95:this.calculateP95(et),inp_p95:this.calculateP95(ht),cls_p95:this.calculateP95(g),fcp_p95:this.calculateP95(A),ttfb_p95:this.calculateP95(t),sampleSize:q.length,windowStart:$,windowEnd:Date.now(),lastUpdated:Date.now()};return localStorage.setItem(`${this.config.storageKey}-baseline`,JSON.stringify(c)),console.log(""[WebVitalsCollector] 性能基线已更新:"",c),c}catch(z){return console.error(""[WebVitalsCollector] 基线计算失败:"",z),null}}calculateP95(z){if(z.length===0)return 0;const $=z.sort((et,ht)=>et-ht),q=Math.ceil($.length*.95)-1;return $[Math.max(0,q)]}getPerformanceReport(){const z=this.getStoredData(),$=Date.now()-1440*60*1e3,q=z.filter(t=>t.timestamp>$),et=q.filter(t=>t.metrics.lcp).map(t=>t.metrics.lcp.value),ht=q.filter(t=>t.metrics.inp).map(t=>t.metrics.inp.value),g=q.filter(t=>t.metrics.cls).map(t=>t.metrics.cls.value),A=q.filter(t=>t.metrics.lcp?.rating===""good""&&t.metrics.inp?.rating===""good""&&t.metrics.cls?.rating===""good"").length;return{baseline:this.getBaseline(),recent:q,summary:{totalSessions:new Set(q.map(t=>t.sessionId)).size,avgLCP:et.length?et.reduce((t,c)=>t+c,0)/et.length:0,avgINP:ht.length?ht.reduce((t,c)=>t+c,0)/ht.length:0,avgCLS:g.length?g.reduce((t,c)=>t+c,0)/g.length:0,goodRating:q.length?A/q.length*100:0}}}start(){!this.isEnabled&&this.config.enabled&&this.initialize()}stop(){this.isEnabled=!1,this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.flush(),console.log(""[WebVitalsCollector] 收集器已停止"")}destroy(){this.stop(),this.dataBuffer=[],console.log(""[WebVitalsCollector] 收集器已销毁"")}}let Tc=null;const mC=st=>(Tc||(Tc=new pC(st)),Tc);function Ny(st={}){const{enabled:z=!0,componentName:$=""UnknownComponent"",trackRender:q=!0,trackInteractions:et=!0,collectorConfig:ht}=st,[g,A]=zt.useState(null),[t,c]=zt.useState(!0),m=zt.useRef(0),h=zt.useRef(new Map),s=zt.useRef(z?Ly():null),r=zt.useRef(z?mC(ht):null);zt.useEffect(()=>{if(!z||!s.current)return;const u=s.current.subscribe(p=>{A(p),c(!1)});return A(s.current.getMetrics()),c(!1),u},[z]),zt.useEffect(()=>{if(!(!z||!q||!s.current))return m.current=performance.now(),s.current.mark(`${$}_render_start`),()=>{if(m.current>0){const u=performance.now()-m.current;s.current?.mark(`${$}_render_end`),s.current?.measure(`${$}_render`,`${$}_render_start`,`${$}_render_end`),u>50&&console.log(`[WebVitals] 组件""${$}""渲染耗时: ${u.toFixed(2)}ms`)}}},[z,q,$]);const e=zt.useCallback(u=>{if(!z||!s.current)return;const p=`${$}_${u}_start`,x=performance.now();h.current.set(u,x),s.current.mark(p)},[z,$]),n=zt.useCallback(u=>{if(!z||!s.current)return;const p=h.current.get(u);if(!p){console.warn(`[WebVitals] 找不到计时开始标记: ${u}`);return}const S=performance.now()-p,y=`${$}_${u}_start`,E=`${$}_${u}_end`,C=`${$}_${u}`;return s.current.mark(E),s.current.measure(C,y,E),h.current.delete(u),console.log(`[WebVitals] ${$} - ${u}: ${S.toFixed(2)}ms`),S},[z,$]),o=zt.useCallback((u,p)=>{!z||!s.current||s.current.recordInteraction(`${$}_${u}`,p)},[z,$]),i=zt.useCallback((u,p)=>{!z||!s.current||s.current.recordEvent(`${$}_${u}`,p)},[z,$]),l=zt.useCallback((u,p)=>{if(!(!z||!r.current))try{const x=r.current.getPerformanceReport();console.log(`[WebVitals] Custom event: ${$}_${u}`,p,x)}catch(x){console.warn(""[WebVitals] 记录自定义事件失败:"",x)}},[z,$]),f=zt.useCallback((u,p)=>{z&&(console.error(`[WebVitals] Error in ${$}${p?` (${p})`:""""}:`,u),window.electronAPI?.reportEvent&&window.electronAPI.reportEvent({type:""web_vitals_error"",data:{component:$,error:u.message,stack:u.stack,context:p,timestamp:new Date().toISOString()}}))},[z,$]),d=zt.useCallback(()=>!z||!r.current?null:r.current.getPerformanceReport(),[z]);return{metrics:g,isLoading:t,startTiming:e,endTiming:n,recordInteraction:o,recordEvent:i,recordCustomEvent:l,recordError:f,getPerformanceReport:d}}function gC({onComplete:st,onError:z,className:$="""",autoStart:q=!1}){const et=zt.useRef(null),ht=zt.useRef(null),[g,A]=zt.useState({phase:""ready"",events:[]}),t=Ny({enabled:!0,componentName:""GameVerticalSlice"",trackRender:!0,trackInteractions:!0,collectorConfig:{enabled:!0,sentryEnabled:!0,batchSize:3,flushInterval:5e3}});Sy({context:""vertical-slice"",enableAutoCleanup:!0});const c=zt.useCallback(o=>{if(console.log(""🎮 Vertical Slice Event:"",o),!o.type.startsWith(""game.""))return;const i=o;switch(A(l=>({...l,events:[...l.events,i]})),i.type){case""game.scene.created"":i.data.sceneKey===""TestScene""&&(console.log(""✅ TestScene创建成功""),t.recordCustomEvent(""test_scene_created""));break;case""game.player.moved"":A(l=>({...l,totalMoves:(l.totalMoves||0)+1}));break;case""game.level.completed"":console.log(""🎉 Level Completed!"",i.data),t.recordCustomEvent(""level_completed"",{score:i.data.result?.score,moves:i.data.result?.totalMoves,duration:i.data.result?.duration}),A(l=>({...l,phase:""completed"",testEndTime:new Date,levelResult:i.data.result,score:i.data.result?.score})),m(i.data.result);break;case""game.scene.stopped"":i.data.sceneKey===""TestScene""&&console.log(""🏁 TestScene停止，竖切测试完成"");break;case""game.error"":console.error(""❌ 游戏错误:"",i.data),A(l=>({...l,phase:""error"",error:i.data.error})),z?.(i.data.error);break}window.electronAPI&&window.electronAPI.reportEvent?.({type:""game_event"",data:{eventType:i.type,source:i.source,timestamp:i.timestamp}})},[t,z]),m=zt.useCallback(async o=>{try{console.log(""💾 开始数据持久化...""),t.startTiming(""data_persistence"");const{LevelResultService:i}=await wE(async()=>{const{LevelResultService:u}=await import(""./LevelResultService-DTQld7En.js"");return{LevelResultService:u}},[],import.meta.url),l=new i({enableBackup:!0,backupInterval:1e4,fallbackToLocalStorage:!0}),f={levelId:""test-level-1"",playerId:`player-${Date.now()}`,startTime:g.testStartTime||new Date,endTime:g.testEndTime||new Date,duration:o.duration||0,score:o.score||0,totalMoves:o.totalMoves||0,completionReason:o.completionReason||""goal_reached"",gameEvents:g.events,metadata:{version:""1.0.0"",testType:""vertical-slice"",webVitals:{testDuration:g.testEndTime?g.testEndTime.getTime()-(g.testStartTime?.getTime()||0):0},sessionId:`session-${Date.now()}`}},d=await l.saveLevelResult(f);if(d.success){console.log(""✅ 数据持久化完成, ID:"",d.data);const u=await l.getStats();u.success&&console.log(""📊 持久化统计:"",u.data);const p={testId:d.data,timestamp:new Date().toISOString(),result:f,stats:u.data};t.endTiming(""data_persistence""),st?.(p),l.dispose()}else throw new Error(d.error||""Unknown persistence error"")}catch(i){console.error(""❌ 数据持久化失败:"",i),t.recordError(i,""data_persistence""),A(l=>({...l,error:`数据持久化失败: ${i.message}`}))}},[g,t,st]),h=zt.useCallback(async()=>{if(!(!ht.current||et.current))try{A(l=>({...l,phase:""initializing""})),t.startTiming(""game_engine_init"");const o={maxLevel:50,initialHealth:100,scoreMultiplier:1,autoSave:!0,difficulty:""medium""};et.current=new Ey,et.current.setContainer(ht.current),et.current.onGameEvent(c),await et.current.initializeGame(o),await et.current.startGame();const i=et.current.sceneManager;i&&i.game&&(i.game.scene.start(""TestScene""),i.game.scene.stop(""MenuScene"")),console.log(""✅ 游戏引擎初始化完成，TestScene已启动""),t.endTiming(""game_engine_init""),A(l=>({...l,phase:""playing"",testStartTime:new Date}))}catch(o){console.error(""❌ 游戏引擎初始化失败:"",o),t.recordError(o,""game_engine_init""),A(i=>({...i,phase:""error"",error:o.message})),z?.(o.message)}},[c,t,z]),s=zt.useCallback(()=>{if(et.current)try{et.current.destroy(),et.current=null,console.log(""✅ 游戏引擎已清理"")}catch(o){console.error(""❌ 游戏引擎清理失败:"",o)}},[]),r=zt.useCallback(()=>{s(),A({phase:""ready"",events:[]})},[s]),e=zt.useCallback(()=>{t.recordCustomEvent(""vertical_slice_start""),h()},[h,t]);zt.useEffect(()=>{if(q){const o=setTimeout(e,1e3);return()=>clearTimeout(o)}},[q,e]),zt.useEffect(()=>()=>{s()},[s]);const n=()=>{switch(g.phase){case""ready"":return Ft.jsxDEV(""div"",{className:""text-center p-8"",children:[Ft.jsxDEV(""h2"",{className:""text-2xl font-bold text-white mb-4"",children:""🚀 游戏竖切测试""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:355,columnNumber:13},this),Ft.jsxDEV(""p"",{className:""text-gray-300 mb-6"",children:""端到端验证：React → Phaser → 事件 → 持久化 → 可观测性""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:358,columnNumber:13},this),Ft.jsxDEV(""button"",{onClick:e,className:""px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"",children:""开始测试""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:361,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:354,columnNumber:11},this);case""initializing"":return Ft.jsxDEV(""div"",{className:""text-center p-8"",children:[Ft.jsxDEV(""h2"",{className:""text-xl font-bold text-white mb-4"",children:""⚡ 初始化中...""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:373,columnNumber:13},this),Ft.jsxDEV(""div"",{className:""animate-pulse text-blue-400"",children:""正在启动游戏引擎和TestScene""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:376,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:372,columnNumber:11},this);case""playing"":return Ft.jsxDEV(""div"",{className:""p-4 bg-gray-800 rounded-t-lg"",children:[Ft.jsxDEV(""div"",{className:""flex justify-between items-center"",children:[Ft.jsxDEV(""h3"",{className:""text-lg font-semibold text-white"",children:""🎮 测试进行中""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:386,columnNumber:15},this),Ft.jsxDEV(""div"",{className:""text-sm text-gray-300"",children:[""移动次数: "",g.totalMoves||0]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:389,columnNumber:15},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:385,columnNumber:13},this),Ft.jsxDEV(""div"",{className:""mt-2 text-xs text-gray-400"",children:""提示：使用WASD移动蓝色精灵到右上角绿色区域完成测试""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:393,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:384,columnNumber:11},this);case""completed"":return Ft.jsxDEV(""div"",{className:""p-6 bg-green-800 rounded-t-lg"",children:[Ft.jsxDEV(""h2"",{className:""text-xl font-bold text-white mb-4"",children:""🎉 测试完成！""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:402,columnNumber:13},this),Ft.jsxDEV(""div"",{className:""grid grid-cols-2 gap-4 text-sm"",children:[Ft.jsxDEV(""div"",{className:""text-green-200"",children:[""分数: "",g.score||0]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:404,columnNumber:15},this),Ft.jsxDEV(""div"",{className:""text-green-200"",children:[""移动次数: "",g.levelResult?.totalMoves||0]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:407,columnNumber:15},this),Ft.jsxDEV(""div"",{className:""text-green-200"",children:[""用时:"","" "",g.levelResult?.duration?Math.round(g.levelResult.duration/1e3)+""秒"":""N/A""]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:410,columnNumber:15},this),Ft.jsxDEV(""div"",{className:""text-green-200"",children:[""事件数: "",g.events.length]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:416,columnNumber:15},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:403,columnNumber:13},this),Ft.jsxDEV(""button"",{onClick:r,className:""mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"",children:""重新测试""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:420,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:401,columnNumber:11},this);case""error"":return Ft.jsxDEV(""div"",{className:""p-6 bg-red-800 rounded-t-lg"",children:[Ft.jsxDEV(""h2"",{className:""text-xl font-bold text-white mb-4"",children:""❌ 测试失败""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:432,columnNumber:13},this),Ft.jsxDEV(""div"",{className:""text-red-200 text-sm mb-4"",children:g.error},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:433,columnNumber:13},this),Ft.jsxDEV(""button"",{onClick:r,className:""px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"",children:""重试""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:434,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:431,columnNumber:11},this);default:return null}};return Ft.jsxDEV(""div"",{className:`game-vertical-slice ${$}`,children:[n(),(g.phase===""playing""||g.phase===""completed"")&&Ft.jsxDEV(""div"",{ref:ht,className:""game-canvas-container border border-gray-600"",style:{width:800,height:600}},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:454,columnNumber:9},this),g.events.length>0&&Ft.jsxDEV(""details"",{className:""mt-4 p-4 bg-gray-900 rounded text-xs"",children:[Ft.jsxDEV(""summary"",{className:""text-white cursor-pointer"",children:[""调试信息 ("",g.events.length,"" 个事件)""]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:465,columnNumber:13},this),Ft.jsxDEV(""div"",{className:""mt-2 max-h-40 overflow-y-auto text-gray-300"",children:g.events.slice(-10).map((o,i)=>Ft.jsxDEV(""div"",{className:""mb-1"",children:[Ft.jsxDEV(""span"",{className:""text-blue-400"",children:o.type},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:471,columnNumber:19},this),"" - "",Ft.jsxDEV(""span"",{className:""text-yellow-400"",children:o.source},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:473,columnNumber:19},this),o.data&&Ft.jsxDEV(""span"",{className:""text-gray-500 ml-2"",children:JSON.stringify(o.data).substring(0,100)},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:475,columnNumber:21},this)]},i,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:470,columnNumber:17},this))},void 0,!1,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:468,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:464,columnNumber:11},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/components/GameVerticalSlice.tsx"",lineNumber:449,columnNumber:5},this)}function xC(){const[st,z]=zt.useState(""normal""),[$,q]=zt.useState(!1),et=Ny({enabled:!0,componentName:""App"",trackRender:!0,trackInteractions:!0,collectorConfig:{enabled:!0,sentryEnabled:!0,batchSize:5,flushInterval:15e3}});zt.useEffect(()=>{et.startTiming(""app_initialization"");const A=setTimeout(()=>{et.endTiming(""app_initialization"")},100);return()=>clearTimeout(A)},[et]);const ht=A=>{console.log(""🎉 竖切测试完成:"",A),q(!0),et.recordCustomEvent(""vertical_slice_completed"",{testId:A.testId,score:A.result?.score,duration:A.result?.duration})},g=A=>{console.error(""❌ 竖切测试失败:"",A),et.recordError(new Error(A),""vertical_slice"")};return zt.useEffect(()=>{new URLSearchParams(window.location.search).get(""vertical-slice"")===""auto""&&(console.log(""🚀 自动启动竖切测试""),z(""vertical-slice""))},[]),Ft.jsxDEV(""div"",{className:""app-container p-8 min-h-screen bg-game-ui-background"",""data-testid"":""app-root"",children:[Ft.jsxDEV(""header"",{className:""text-center mb-8"",children:[Ft.jsxDEV(""h1"",{className:""text-game-title font-bold text-game-primary mb-4"",children:""Phaser 3 + React 19 + TypeScript""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:70,columnNumber:9},this),Ft.jsxDEV(""p"",{className:""text-game-subtitle text-game-ui-muted"",children:""符合 CLAUDE.md 技术栈要求的游戏开发环境""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:73,columnNumber:9},this),Ft.jsxDEV(""div"",{className:""flex justify-center gap-4 mt-6"",children:[Ft.jsxDEV(""button"",{onClick:()=>z(""normal""),className:`px-4 py-2 rounded-lg transition-colors ${st===""normal""?""bg-blue-600 text-white"":""bg-gray-600 text-gray-300 hover:bg-gray-500""}`,children:""🎮 常规游戏""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:79,columnNumber:11},this),Ft.jsxDEV(""button"",{onClick:()=>z(""vertical-slice""),className:`px-4 py-2 rounded-lg transition-colors ${st===""vertical-slice""?""bg-green-600 text-white"":""bg-gray-600 text-gray-300 hover:bg-gray-500""}`,children:[""🚀 竖切测试"",$&&Ft.jsxDEV(""span"",{className:""ml-2 text-green-300"",children:""✅""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:99,columnNumber:15},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:89,columnNumber:11},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:78,columnNumber:9},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:69,columnNumber:7},this),Ft.jsxDEV(""main"",{className:""flex justify-center"",children:st===""normal""?Ft.jsxDEV(""div"",{className:""flex flex-col items-center"",children:[Ft.jsxDEV(LE,{width:800,height:600,className:""shadow-lg""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:108,columnNumber:13},this),Ft.jsxDEV(""p"",{className:""text-center mt-4 text-gray-400 text-sm max-w-md"",children:""这是标准的游戏画布，使用现有的 GameEngineAdapter 和 MenuScene/GameScene""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:109,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:107,columnNumber:11},this):Ft.jsxDEV(""div"",{className:""flex flex-col items-center"",children:[Ft.jsxDEV(gC,{onComplete:ht,onError:g,className:""max-w-4xl"",autoStart:!1},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:116,columnNumber:13},this),Ft.jsxDEV(""div"",{className:""mt-6 p-4 bg-gray-800 rounded-lg max-w-2xl"",children:[Ft.jsxDEV(""h3"",{className:""text-white font-semibold mb-2"",children:""🔬 竖切测试说明""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:123,columnNumber:15},this),Ft.jsxDEV(""ul"",{className:""text-gray-300 text-sm space-y-1"",children:[Ft.jsxDEV(""li"",{children:""• 验证 React → Phaser → CloudEvents → SQLite 端到端流程""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:125,columnNumber:17},this),Ft.jsxDEV(""li"",{children:""• 包含数据持久化、可观测性上报、性能监控""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:126,columnNumber:17},this),Ft.jsxDEV(""li"",{children:""• 集成现有的备份系统和 Sentry 监控""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:127,columnNumber:17},this),Ft.jsxDEV(""li"",{children:[""• 支持快速访问: "",Ft.jsxDEV(""code"",{children:""?vertical-slice=auto""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:129,columnNumber:29},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:128,columnNumber:17},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:124,columnNumber:15},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:122,columnNumber:13},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:115,columnNumber:11},this)},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:105,columnNumber:7},this),Ft.jsxDEV(""footer"",{className:""text-center mt-8 text-game-ui-muted"",children:[Ft.jsxDEV(""p"",{children:""🎮 技术栈：Electron + React 19 + Vite + Phaser 3 + Tailwind CSS v4 + TypeScript""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:138,columnNumber:9},this),st===""vertical-slice""&&Ft.jsxDEV(""p"",{className:""mt-2 text-sm text-green-400"",children:""竖切模式: 端到端验证所有组件集成""},void 0,!1,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:143,columnNumber:11},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:137,columnNumber:7},this)]},void 0,!0,{fileName:""C:/buildgame/vitegame/src/App.tsx"",lineNumber:65,columnNumber:5},this)}pE.createRoot(document.getElementById(""root"")).render(Ft.jsxDEV(zt.StrictMode,{children:Ft.jsxDEV(xC,{},void 0,!1,{fileName:""C:/buildgame/vitegame/src/main.tsx"",lineNumber:8,columnNumber:5},void 0)},void 0,!1,{fileName:""C:/buildgame/vitegame/src/main.tsx"",lineNumber:7,columnNumber:3},void 0));","Do not use insertCSS, executeJavaScript, eval, Function, setTimeout, setInterval, setImmediate with user-supplied content",https://github.com/doyensec/electronegativity/wiki/DANGEROUS_FUNCTIONS_JS_CHECK
AUXCLICK_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\electron\main.ts","17:9","return new BrowserWindow({","Limit navigation flows to untrusted origins. Middle-click may cause Electron to open a link within a new window",https://github.com/doyensec/electronegativity/wiki/AUXCLICK_JS_CHECK
PRELOAD_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\electron\main.ts","23:6","preload: join(__dirname, '../preload.js'),","Review the use of preload scripts",https://github.com/doyensec/electronegativity/wiki/PRELOAD_JS_CHECK
AUXCLICK_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\electron\security.ts","39:9","return new BrowserWindow(secureOptions);","Limit navigation flows to untrusted origins. Middle-click may cause Electron to open a link within a new window",https://github.com/doyensec/electronegativity/wiki/AUXCLICK_JS_CHECK
CONTEXT_ISOLATION_JS_CHECK,"HIGH","FIRM","C:\buildgame\vitegame\electron\security.ts","39:9","return new BrowserWindow(secureOptions);","Review the use of the contextIsolation option",https://github.com/doyensec/electronegativity/wiki/CONTEXT_ISOLATION_JS_CHECK
SANDBOX_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\electron\security.ts","39:9","return new BrowserWindow(secureOptions);","Use sandbox for untrusted origins",https://github.com/doyensec/electronegativity/wiki/SANDBOX_JS_CHECK
OPEN_EXTERNAL_JS_CHECK,"MEDIUM","TENTATIVE","C:\buildgame\vitegame\electron\security.ts","63:4","shell.openExternal(url);","Review the use of openExternal",https://github.com/doyensec/electronegativity/wiki/OPEN_EXTERNAL_JS_CHECK
OPEN_EXTERNAL_JS_CHECK,"MEDIUM","TENTATIVE","C:\buildgame\vitegame\electron\security.ts","118:6","shell.openExternal(redirectUrl);","Review the use of openExternal",https://github.com/doyensec/electronegativity/wiki/OPEN_EXTERNAL_JS_CHECK
OPEN_EXTERNAL_JS_CHECK,"MEDIUM","TENTATIVE","C:\buildgame\vitegame\electron\security.ts","222:6","shell.openExternal(url);","Review the use of openExternal",https://github.com/doyensec/electronegativity/wiki/OPEN_EXTERNAL_JS_CHECK
OPEN_EXTERNAL_JS_CHECK,"MEDIUM","TENTATIVE","C:\buildgame\vitegame\electron\security\permissions.ts","282:8","shell.openExternal(url);","Review the use of openExternal",https://github.com/doyensec/electronegativity/wiki/OPEN_EXTERNAL_JS_CHECK
AUXCLICK_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\src\main\window.ts","5:14","const win = new BrowserWindow({","Limit navigation flows to untrusted origins. Middle-click may cause Electron to open a link within a new window",https://github.com/doyensec/electronegativity/wiki/AUXCLICK_JS_CHECK
PRELOAD_JS_CHECK,"MEDIUM","FIRM","C:\buildgame\vitegame\src\main\window.ts","10:6","preload: path.join(__dirname, 'preload', 'bridge.js'),","Review the use of preload scripts",https://github.com/doyensec/electronegativity/wiki/PRELOAD_JS_CHECK

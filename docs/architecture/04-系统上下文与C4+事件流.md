# 04 ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸ C4 / äº‹ä»¶æµ
> é‡‡ç”¨ **C4 æ¨¡å‹**ï¼ˆContextâ†’Containerâ†’Componentï¼‰ç»Ÿä¸€ç³»ç»Ÿè§†å›¾ï¼›ä»¥**ç±»å‹å®‰å…¨äº‹ä»¶æ€»çº¿**ä½œä¸ºè·¨æ¨¡å—é€šä¿¡â€œè¿è¡Œæ—¶éª¨å¹²â€ã€‚

## 4.1 ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸C4+äº‹ä»¶æµ-Context & Container è§†å›¾ï¼ˆMermaidï¼‰
> æœ¬èŠ‚åŸºäº **ultrathink æ·±åº¦åˆ†æ**ï¼Œæä¾›ä¼ä¸šçº§ C4 æ¶æ„è§†å›¾ï¼Œå‡†ç¡®å±•ç° Electron å¤šè¿›ç¨‹æ¶æ„çš„å¤æ‚æ€§ä¸äº‹ä»¶é©±åŠ¨é€šä¿¡æ¨¡å¼ã€‚
> è¯´æ˜ï¼šç”¨æˆ·é€šè¿‡æ¸²æŸ“è¿›ç¨‹ï¼ˆReact UI + Phaser ç”»å¸ƒï¼‰ä¸ç³»ç»Ÿäº¤äº’ï¼›æ¸²æŸ“è¿›ç¨‹ä¸ä¸»è¿›ç¨‹é€šè¿‡ **IPC** åä½œï¼›æ¸¸æˆåŸŸå†…éƒ¨é€šè¿‡ **äº‹ä»¶æ€»çº¿** è§£è€¦ã€‚

### 4.1.1 C4 Context è§†å›¾ - ç³»ç»Ÿè¾¹ç•Œä¸å¤–éƒ¨äº¤äº’

```mermaid
C4Context
    title C4 Context - Guild Manager ç³»ç»Ÿä¸Šä¸‹æ–‡å›¾

    Person(player, "æ¸¸æˆç©å®¶", "æ¡Œé¢ç«¯ç”¨æˆ·ï¼Œè¿›è¡Œå…¬ä¼šç®¡ç†ä¸ç­–ç•¥å†³ç­–")
    
    System_Boundary(desktop, "æ¡Œé¢ç¯å¢ƒè¾¹ç•Œ") {
        System(guildmgr, "Guild Manager", "å…¬ä¼šç»ç†æ¡Œé¢æ¸¸æˆ\nElectron + React 19 + Phaser 3")
    }
    
    System_Ext(os, "æ“ä½œç³»ç»Ÿ", "Windows/macOS/Linux\næ–‡ä»¶ç³»ç»Ÿã€çª—å£ç®¡ç†ã€ç¡¬ä»¶è®¿é—®")
    System_Ext(filesystem, "æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ", "æ¸¸æˆå­˜æ¡£ã€é…ç½®æ–‡ä»¶\nç”¨æˆ·æ•°æ®æŒä¹…åŒ–")
    System_Ext(sentry, "Sentry ç›‘æ§", "é”™è¯¯è¿½è¸ªã€æ€§èƒ½ç›‘æ§\nRelease Health åˆ†æ")
    System_Ext(ai_models, "æœ¬åœ°AIæ¨¡å‹", "æ¸¸æˆç­–ç•¥è®¡ç®—\nå†³ç­–æ”¯æŒç³»ç»Ÿ")

    Rel(player, guildmgr, "æ“ä½œäº¤äº’", "é¼ æ ‡ã€é”®ç›˜ã€UIæ“ä½œ")
    Rel(guildmgr, os, "ç³»ç»ŸAPIè°ƒç”¨", "çª—å£ç®¡ç†ã€é€šçŸ¥ã€ç¡¬ä»¶")
    Rel(guildmgr, filesystem, "æ•°æ®è¯»å†™", "SQLite DBã€é…ç½®æ–‡ä»¶")
    Rel(guildmgr, sentry, "ç›‘æ§æ•°æ®", "HTTPS/å¼‚æ­¥ä¸ŠæŠ¥")
    Rel(guildmgr, ai_models, "AIæ¨ç†", "Web Workersè®¡ç®—")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="2")
```

### 4.1.2 C4 Container è§†å›¾ - Electron å¤šè¿›ç¨‹æ¶æ„

```mermaid
C4Container
    title C4 Container - Guild Manager å®¹å™¨æ¶æ„å›¾

    Person(player, "æ¸¸æˆç©å®¶")
    
    Container_Boundary(electron_app, "Electron åº”ç”¨è¾¹ç•Œ") {
        Container(main_process, "Main Process", "Electron/Node.js", "ç³»ç»ŸAPIè®¿é—®ã€çª—å£ç®¡ç†\næ•°æ®åº“è¿æ¥ã€å®‰å…¨ç­–ç•¥")
        
        Container_Boundary(renderer_boundary, "æ¸²æŸ“è¿›ç¨‹è¾¹ç•Œ") {
            Container(react_ui, "React UI Layer", "React 19/TypeScript", "ç”¨æˆ·ç•Œé¢ç»„ä»¶\nè¡¨å•å¤„ç†ã€å¯¼èˆªç®¡ç†")
            Container(phaser_game, "Phaser Game Engine", "Phaser 3/WebGL", "æ¸¸æˆåœºæ™¯æ¸²æŸ“\nåŠ¨ç”»ã€æ¸¸æˆå¾ªç¯")
            Container(event_bus, "Event Bus", "TypeScript", "äº‹ä»¶é©±åŠ¨é€šä¿¡ä¸­æ¢\nç±»å‹å®‰å…¨æ¶ˆæ¯ä¼ é€’")
        }
        
        Container(ai_workers, "AI Web Workers", "Web Workers/WASM", "AIç­–ç•¥è®¡ç®—éš”ç¦»\nå¹¶å‘å†³ç­–å¤„ç†")
        Container(ipc_bridge, "IPC å®‰å…¨æ¡¥", "Electron IPC", "è¿›ç¨‹é—´å®‰å…¨é€šä¿¡\næƒé™éªŒè¯ã€é™æµ")
    }
    
    ContainerDb(sqlite_db, "SQLite Database", "SQLite", "æ¸¸æˆæ•°æ®æŒä¹…åŒ–\nç”¨æˆ·é…ç½®å­˜å‚¨")
    Container_Ext(sentry, "Sentry SDK", "ç›‘æ§æœåŠ¡", "é”™è¯¯æ”¶é›†ã€æ€§èƒ½è¿½è¸ª")

    Rel(player, react_ui, "ç”¨æˆ·äº¤äº’", "ç‚¹å‡»ã€è¾“å…¥ã€æ‹–æ‹½")
    Rel(react_ui, event_bus, "UIäº‹ä»¶", "guild.*, ui.*, form.*")
    Rel(phaser_game, event_bus, "æ¸¸æˆäº‹ä»¶", "game.*, scene.*, entity.*")
    Rel(event_bus, ipc_bridge, "è·¨è¿›ç¨‹äº‹ä»¶", "å®‰å…¨ä¸Šä¸‹æ–‡éš”ç¦»")
    Rel(ipc_bridge, main_process, "IPCé€šä¿¡", "contextIsolation=true")
    Rel(main_process, sqlite_db, "æ•°æ®æ“ä½œ", "SQLite queries")
    Rel(event_bus, ai_workers, "AIè®¡ç®—è¯·æ±‚", "postMessage/onMessage")
    Rel_Back(ai_workers, event_bus, "AIå†³ç­–ç»“æœ", "ç­–ç•¥å»ºè®®ã€è®¡ç®—ç»“æœ")
    
    Rel(main_process, sentry, "ç›‘æ§ä¸ŠæŠ¥", "crash-free sessions")
    Rel(react_ui, sentry, "å‰ç«¯ç›‘æ§", "ç”¨æˆ·è¡Œä¸ºã€é”™è¯¯è¾¹ç•Œ")

    UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")
```

### 4.1.3 äº‹ä»¶æµé›†æˆè§†å›¾ - EventBus é€šä¿¡åè®®

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant R as React UI
    participant E as EventBus
    participant P as Phaser Game
    participant I as IPC Bridge
    participant M as Main Process
    participant W as AI Workers
    participant D as SQLite DB

    Note over E: ğŸ¯ äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­æ¢
    
    U->>R: ç”¨æˆ·æ“ä½œ (åˆ›å»ºå…¬ä¼š)
    R->>E: å‘å¸ƒäº‹ä»¶ guild.create
    
    par å¹¶è¡Œå¤„ç†
        E->>P: é€šçŸ¥æ¸¸æˆå¼•æ“
        P->>E: æ›´æ–°æ¸¸æˆçŠ¶æ€ game.update
    and
        E->>I: è·¨è¿›ç¨‹äº‹ä»¶ä¼ é€’
        I->>M: IPCå®‰å…¨é€šä¿¡
        M->>D: æ•°æ®æŒä¹…åŒ–
        D-->>M: æ“ä½œç»“æœ
        M->>I: ç»“æœå›ä¼ 
        I->>E: å‘å¸ƒæ•°æ®äº‹ä»¶ data.saved
    and
        E->>W: AIåˆ†æè¯·æ±‚ ai.analyze
        W->>W: ç­–ç•¥è®¡ç®—å¤„ç†
        W->>E: AIå»ºè®® ai.suggestion
    end
    
    E->>R: çŠ¶æ€åŒæ­¥ state.updated
    R->>U: UIæ›´æ–°åé¦ˆ
    
    Note over E,W: ğŸ”’ å®‰å…¨éš”ç¦»ï¼šcontextIsolation + nodeIntegration=false
```

### 4.1.4 æ¶æ„è´¨é‡å±æ€§æ˜ å°„

| è´¨é‡å±æ€§ | æ¶æ„å®ç°æœºåˆ¶ | å…·ä½“å®¹å™¨/ç»„ä»¶ |
|----------|-------------|---------------|
| **å®‰å…¨æ€§** | è¿›ç¨‹éš”ç¦» + ä¸Šä¸‹æ–‡éš”ç¦» | Main Process â†” Renderer è¾¹ç•Œ |
| **æ€§èƒ½** | äº‹ä»¶é©±åŠ¨ + AIè®¡ç®—åˆ†ç¦» | EventBus + Web Workers |
| **å¯è§‚æµ‹æ€§** | å…¨æ ˆç›‘æ§ + é“¾è·¯è¿½è¸ª | Sentry SDK è·¨æ‰€æœ‰å®¹å™¨ |
| **å¯ç»´æŠ¤æ€§** | ç±»å‹å®‰å…¨ + å¥‘çº¦å›ºåŒ– | TypeScript + EventBuså¥‘çº¦ |
| **å¯æ‰©å±•æ€§** | æ¨¡å—åŒ– + æ’ä»¶åŒ– | ç»„ä»¶è¾¹ç•Œæ¸…æ™° + äº‹ä»¶è§£è€¦ |

### 4.1.5 å…³é”®æ¶æ„å†³ç­– (ADR å…³è”)

**ADR-004: Electron å¤šè¿›ç¨‹å®‰å…¨éš”ç¦»**
- **å†³ç­–**: å¼ºåˆ¶å¯ç”¨ `contextIsolation`ï¼Œç¦ç”¨ `nodeIntegration`
- **æ¶æ„ä½“ç°**: Main Process ä¸ Renderer Process ä¸¥æ ¼è¾¹ç•Œåˆ†ç¦»
- **è´¨é‡ä¿è¯**: é˜²æ­¢æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—® Node.js API

**ADR-005: äº‹ä»¶é©±åŠ¨æ¶æ„ä½œä¸ºé€šä¿¡éª¨å¹²**
- **å†³ç­–**: EventBus ä½œä¸º React â†” Phaser é€šä¿¡ä¸­æ¢
- **æ¶æ„ä½“ç°**: æ‰€æœ‰è·¨ç»„ä»¶é€šä¿¡é€šè¿‡ç±»å‹å®‰å…¨äº‹ä»¶æ€»çº¿
- **è´¨é‡ä¿è¯**: é™ä½è€¦åˆåº¦ï¼Œæé«˜ç³»ç»Ÿå¯æµ‹è¯•æ€§

**ADR-006: AI è®¡ç®—è¿›ç¨‹éš”ç¦»**
- **å†³ç­–**: Web Workers ä¸“é—¨å¤„ç† AI ç­–ç•¥è®¡ç®—
- **æ¶æ„ä½“ç°**: AI Workers ä¸ä¸»æ¸²æŸ“è¿›ç¨‹å®Œå…¨éš”ç¦»
- **è´¨é‡ä¿è¯**: é¿å… AI è®¡ç®—é˜»å¡æ¸¸æˆä¸»å¾ªç¯

### 4.1.6 ä¸ç°æœ‰ç« èŠ‚æ•´åˆ

- **4.1-4.3 åŸºç¡€è§†å›¾**: æœ¬èŠ‚æä¾›çš„ä¼ä¸šçº§ C4 è§†å›¾æ˜¯å¯¹åŸæœ‰ç®€åŒ–å›¾çš„å…¨é¢å‡çº§
- **4.4-4.5 äº‹ä»¶å¥‘çº¦**: æœ¬èŠ‚çš„äº‹ä»¶æµå›¾è¯¦ç»†å±•ç°äº†å¥‘çº¦åœ¨å®é™…æ¶æ„ä¸­çš„åº”ç”¨
- **ç¬¬ 6 ç«  SLO é—¨ç¦**: C4 å®¹å™¨è¾¹ç•Œç›´æ¥æ˜ å°„åˆ°æ€§èƒ½ç›‘æ§ç‚¹å’Œè´¨é‡é—¨ç¦
- **ç¬¬ 8 ç«  éªŒæ”¶æµ‹è¯•**: æ¯ä¸ªå®¹å™¨éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•è¾¹ç•Œå’ŒéªŒæ”¶æ ‡å‡†

### 4.1.7 æ¶æ„æ¼”è¿›è·¯å¾„

**Phase 1 (å½“å‰)**: åŸºç¡€å¤šè¿›ç¨‹æ¶æ„ + äº‹ä»¶é©±åŠ¨é€šä¿¡
**Phase 2 (è§„åˆ’)**: å¾®å‰ç«¯æ¶æ„ + æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ  
**Phase 3 (è¿œæ™¯)**: äº‘ç«¯è®¡ç®—æ•´åˆ + è·¨å¹³å°åŒæ­¥

> ğŸ’¡ **æ¶æ„æ´å¯Ÿ**: æ­¤ C4 æ¶æ„è®¾è®¡åŸºäºç°ä»£æ¡Œé¢åº”ç”¨æœ€ä½³å®è·µï¼Œå……åˆ†åˆ©ç”¨ Electron çš„å®‰å…¨ç‰¹æ€§å’Œ Web Workers çš„è®¡ç®—èƒ½åŠ›ï¼Œä¸ºã€Šå…¬ä¼šç»ç†ã€‹æä¾›äº†æ—¢å®‰å…¨åˆé«˜æ€§èƒ½çš„æŠ€æœ¯æ¶æ„åŸºç¡€ã€‚

---

## 4.2 ç»„ä»¶å…³ç³»ï¼ˆComponent è§†å›¾è¦ç‚¹ï¼‰
> æœ¬èŠ‚åŸºäº **ultrathink æ·±åº¦åˆ†æ**ï¼Œæä¾› C4 Component å±‚è¯¦ç»†è§†å›¾ï¼Œå±•ç° Electron å¤šè¿›ç¨‹æ¶æ„ä¸­æ¯ä¸ª Container å†…éƒ¨çš„å…·ä½“æŠ€æœ¯ç»„ä»¶ç»“æ„ä¸ä¾èµ–å…³ç³»ã€‚

### 4.2.1 ä¸»è¿›ç¨‹ï¼ˆMain Processï¼‰ç»„ä»¶æ¶æ„

```mermaid
C4Component
    title C4 Component - Electron Main Process å†…éƒ¨ç»„ä»¶

    Container_Boundary(main_process, "Main Process") {
        Component(system_api, "System API Manager", "Node.js", "æ“ä½œç³»ç»ŸAPIå°è£…\nçª—å£ç®¡ç†ã€æ–‡ä»¶ç³»ç»Ÿ")
        Component(ipc_server, "IPC Server", "Electron IPC", "è¿›ç¨‹é—´é€šä¿¡æœåŠ¡\nå®‰å…¨éªŒè¯ã€æ¶ˆæ¯è·¯ç”±")
        Component(db_manager, "Database Manager", "SQLite", "æ•°æ®åº“è¿æ¥æ± \näº‹åŠ¡ç®¡ç†ã€æŸ¥è¯¢ä¼˜åŒ–")
        Component(security_guard, "Security Guard", "Node.js", "å®‰å…¨ç­–ç•¥æ‰§è¡Œ\næƒé™éªŒè¯ã€CSPç®¡ç†")
        Component(app_lifecycle, "App Lifecycle", "Electron", "åº”ç”¨ç”Ÿå‘½å‘¨æœŸ\nå¯åŠ¨ã€é€€å‡ºã€æ›´æ–°")
    }
    
    ComponentDb(sqlite_db, "SQLite Database", "SQLite", "æœ¬åœ°æ•°æ®æŒä¹…åŒ–")
    System_Ext(os_apis, "æ“ä½œç³»ç»Ÿ APIs")
    
    Rel(system_api, os_apis, "ç³»ç»Ÿè°ƒç”¨", "æ–‡ä»¶ã€ç½‘ç»œã€ç¡¬ä»¶")
    Rel(ipc_server, security_guard, "å®‰å…¨éªŒè¯", "æƒé™æ£€æŸ¥")
    Rel(db_manager, sqlite_db, "æ•°æ®æ“ä½œ", "CRUDæ“ä½œ")
    Rel(app_lifecycle, system_api, "ç”Ÿå‘½å‘¨æœŸäº‹ä»¶", "å¯åŠ¨/å…³é—­")
    
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 4.2.2 æ¸²æŸ“è¿›ç¨‹ï¼ˆRenderer Processï¼‰ç»„ä»¶æ¶æ„

```mermaid
C4Component
    title C4 Component - Renderer Process å†…éƒ¨ç»„ä»¶æ¶æ„

    Container_Boundary(renderer_process, "Renderer Process") {
        Container_Boundary(react_layer, "React UI Layer") {
            Component(router, "UI Router", "React Router", "è·¯ç”±ç®¡ç†\né¡µé¢å¯¼èˆª")
            Component(state_mgr, "State Manager", "Zustand/Redux", "å…¨å±€çŠ¶æ€ç®¡ç†\næ•°æ®æµæ§åˆ¶")
            Component(ui_components, "UI Components", "React 19", "ç”¨æˆ·ç•Œé¢ç»„ä»¶\nè¡¨å•ã€å¸ƒå±€ã€äº¤äº’")
            Component(form_handler, "Form Handler", "React Hook Form", "è¡¨å•å¤„ç†\néªŒè¯ã€æäº¤")
        }
        
        Container_Boundary(phaser_layer, "Phaser Game Layer") {
            Component(scene_manager, "Scene Manager", "Phaser 3", "æ¸¸æˆåœºæ™¯ç®¡ç†\nåœºæ™¯åˆ‡æ¢ã€ç”Ÿå‘½å‘¨æœŸ")
            Component(render_pipeline, "Render Pipeline", "WebGL/Canvas", "æ¸²æŸ“ç®¡é“\nå›¾å½¢ç»˜åˆ¶ã€ä¼˜åŒ–")
            Component(input_handler, "Input Handler", "Phaser Input", "è¾“å…¥å¤„ç†\né”®ç›˜ã€é¼ æ ‡ã€è§¦æ‘¸")
            Component(animation_sys, "Animation System", "Phaser Tweens", "åŠ¨ç”»ç³»ç»Ÿ\nè¡¥é—´åŠ¨ç”»ã€æ—¶é—´è½´")
            Component(asset_loader, "Asset Loader", "Phaser Loader", "èµ„æºåŠ è½½\nå›¾ç‰‡ã€éŸ³é¢‘ã€æ•°æ®")
        }
        
        Component(event_bus_core, "EventBus Core", "TypeScript", "äº‹ä»¶æ€»çº¿ä¸­æ¢\nç±»å‹å®‰å…¨é€šä¿¡")
        Component(ipc_client, "IPC Client", "Electron IPC", "IPCå®¢æˆ·ç«¯\nä¸ä¸»è¿›ç¨‹é€šä¿¡")
        Component(cache_l1, "L1 Cache", "Map/WeakMap", "ç»„ä»¶çº§ç¼“å­˜\nå†…å­˜ä¼˜åŒ–")
    }
    
    Rel(ui_components, state_mgr, "çŠ¶æ€è®¢é˜…", "æ•°æ®ç»‘å®š")
    Rel(router, ui_components, "è·¯ç”±æ›´æ–°", "ç»„ä»¶æ¸²æŸ“")
    Rel(form_handler, state_mgr, "è¡¨å•æ•°æ®", "çŠ¶æ€æ›´æ–°")
    
    Rel(scene_manager, render_pipeline, "æ¸²æŸ“æŒ‡ä»¤", "ç»˜åˆ¶å‘½ä»¤")
    Rel(input_handler, scene_manager, "è¾“å…¥äº‹ä»¶", "ç”¨æˆ·äº¤äº’")
    Rel(animation_sys, render_pipeline, "åŠ¨ç”»å¸§", "è§†è§‰æ•ˆæœ")
    Rel(asset_loader, scene_manager, "èµ„æºæ•°æ®", "åœºæ™¯èµ„æº")
    
    Rel(state_mgr, event_bus_core, "çŠ¶æ€äº‹ä»¶", "å…¨å±€é€šçŸ¥")
    Rel(scene_manager, event_bus_core, "æ¸¸æˆäº‹ä»¶", "çŠ¶æ€åŒæ­¥")
    Rel(event_bus_core, ipc_client, "è·¨è¿›ç¨‹äº‹ä»¶", "IPCæ¶ˆæ¯")
    
    Rel(ui_components, cache_l1, "ç¼“å­˜è¯»å†™", "æ€§èƒ½ä¼˜åŒ–")
    Rel(scene_manager, cache_l1, "èµ„æºç¼“å­˜", "å‡å°‘åŠ è½½")
    
    UpdateLayoutConfig($c4ShapeInRow="4", $c4BoundaryInRow="2")
```

### 4.2.3 EventBus æ ¸å¿ƒç»„ä»¶è¯¦ç»†ç»“æ„

```mermaid
C4Component
    title C4 Component - EventBus å†…éƒ¨ç»„ä»¶ç»“æ„

    Container_Boundary(eventbus_system, "EventBus System") {
        Component(event_pool, "Event Pool", "TypeScript", "äº‹ä»¶å¯¹è±¡æ± \nå†…å­˜å¤ç”¨ã€æ€§èƒ½ä¼˜åŒ–")
        Component(event_dispatcher, "Event Dispatcher", "TypeScript", "äº‹ä»¶åˆ†å‘å™¨\nè·¯ç”±ã€è¿‡æ»¤ã€æ‰¹å¤„ç†")
        Component(contract_manager, "Contract Manager", "TypeScript", "å¥‘çº¦ç®¡ç†å™¨\nv1.0è§„èŒƒã€ç±»å‹æ£€æŸ¥")
        Component(subscription_mgr, "Subscription Manager", "TypeScript", "è®¢é˜…ç®¡ç†å™¨\nç›‘å¬å™¨æ³¨å†Œã€æ¸…ç†")
        Component(event_history, "Event History", "TypeScript", "äº‹ä»¶å†å²\nè°ƒè¯•ã€é‡æ”¾ã€å®¡è®¡")
        Component(performance_monitor, "Performance Monitor", "TypeScript", "æ€§èƒ½ç›‘æ§\nå»¶è¿Ÿç»Ÿè®¡ã€ç“¶é¢ˆåˆ†æ")
    }
    
    Component_Ext(react_components, "React Components")
    Component_Ext(phaser_scenes, "Phaser Scenes")
    Component_Ext(ai_workers, "AI Workers")
    Component_Ext(main_process, "Main Process")
    
    Rel(react_components, event_dispatcher, "å‘å¸ƒäº‹ä»¶", "UIäº‹ä»¶")
    Rel(phaser_scenes, event_dispatcher, "å‘å¸ƒäº‹ä»¶", "æ¸¸æˆäº‹ä»¶")
    Rel(event_dispatcher, contract_manager, "å¥‘çº¦éªŒè¯", "ç±»å‹æ£€æŸ¥")
    Rel(contract_manager, subscription_mgr, "è®¢é˜…è·¯ç”±", "ç±»å‹åŒ¹é…")
    Rel(subscription_mgr, react_components, "äº‹ä»¶é€šçŸ¥", "çŠ¶æ€æ›´æ–°")
    Rel(subscription_mgr, phaser_scenes, "äº‹ä»¶é€šçŸ¥", "åœºæ™¯æ›´æ–°")
    
    Rel(event_dispatcher, event_pool, "å¯¹è±¡å¤ç”¨", "å†…å­˜ä¼˜åŒ–")
    Rel(event_dispatcher, event_history, "äº‹ä»¶è®°å½•", "å†å²è¿½è¸ª")
    Rel(event_dispatcher, performance_monitor, "æ€§èƒ½ç»Ÿè®¡", "ç›‘æ§æ•°æ®")
    
    Rel(event_dispatcher, ai_workers, "AIäº‹ä»¶", "è®¡ç®—è¯·æ±‚")
    Rel(event_dispatcher, main_process, "IPCäº‹ä»¶", "è·¨è¿›ç¨‹é€šä¿¡")
    
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 4.2.4 AI Worker ç»„ä»¶æ¶æ„

```mermaid
C4Component
    title C4 Component - AI Worker å†…éƒ¨ç»„ä»¶ç»“æ„

    Container_Boundary(ai_worker_system, "AI Worker System") {
        Component(strategy_engine, "Strategy Engine", "Web Worker", "AIç­–ç•¥å¼•æ“\nå†³ç­–ç®—æ³•ã€è§„åˆ™å¤„ç†")
        Component(decision_algorithm, "Decision Algorithm", "JavaScript", "å†³ç­–ç®—æ³•\næœºå™¨å­¦ä¹ ã€å¯å‘å¼")
        Component(data_processor, "Data Processor", "Web Worker", "æ•°æ®å¤„ç†å™¨\nè¾“å…¥é¢„å¤„ç†ã€ç»“æœåå¤„ç†")
        Component(communication_interface, "Communication Interface", "Worker API", "é€šä¿¡æ¥å£\npostMessage/onMessage")
        Component(performance_tracker, "Performance Tracker", "Web Worker", "æ€§èƒ½è¿½è¸ª\nè®¡ç®—æ—¶é—´ã€å†…å­˜ä½¿ç”¨")
        Component(ai_cache, "AI Cache", "Web Worker", "AIç¼“å­˜\nå†³ç­–ç»“æœã€è®¡ç®—çŠ¶æ€")
    }
    
    Component_Ext(event_bus, "EventBus")
    Component_Ext(game_data, "Game Data")
    
    Rel(communication_interface, event_bus, "AIäº‹ä»¶", "å†³ç­–è¯·æ±‚/ç»“æœ")
    Rel(strategy_engine, decision_algorithm, "ç­–ç•¥è®¡ç®—", "ç®—æ³•è°ƒç”¨")
    Rel(data_processor, strategy_engine, "æ•°æ®è¾“å…¥", "é¢„å¤„ç†æ•°æ®")
    Rel(strategy_engine, data_processor, "è®¡ç®—ç»“æœ", "åå¤„ç†è¾“å‡º")
    Rel(communication_interface, data_processor, "æ¶ˆæ¯å¤„ç†", "æ•°æ®è½¬æ¢")
    
    Rel(strategy_engine, performance_tracker, "æ€§èƒ½ç»Ÿè®¡", "è®¡ç®—ç›‘æ§")
    Rel(decision_algorithm, ai_cache, "ç¼“å­˜è®¿é—®", "ç»“æœå¤ç”¨")
    Rel(data_processor, game_data, "æ•°æ®è·å–", "æ¸¸æˆçŠ¶æ€")
    
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 4.2.5 è·¨è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰æ¡¥æ¢ç»„ä»¶

```mermaid
C4Component
    title C4 Component - IPC Bridge å†…éƒ¨ç»„ä»¶ç»“æ„

    Container_Boundary(ipc_bridge_system, "IPC Bridge System") {
        Component(security_validator, "Security Validator", "Electron", "å®‰å…¨éªŒè¯å™¨\næƒé™æ£€æŸ¥ã€æ¶ˆæ¯éªŒè¯")
        Component(message_serializer, "Message Serializer", "JSON", "æ¶ˆæ¯åºåˆ—åŒ–\næ•°æ®è½¬æ¢ã€å‹ç¼©")
        Component(error_handler, "Error Handler", "TypeScript", "é”™è¯¯å¤„ç†å™¨\nå¼‚å¸¸æ•è·ã€æ¢å¤æœºåˆ¶")
        Component(rate_limiter, "Rate Limiter", "TypeScript", "é€Ÿç‡é™åˆ¶å™¨\né˜²æ­¢æ¶ˆæ¯é£æš´")
        Component(channel_manager, "Channel Manager", "Electron IPC", "é€šé“ç®¡ç†å™¨\nå¤šé€šé“å¤ç”¨ã€è·¯ç”±")
        Component(heartbeat_monitor, "Heartbeat Monitor", "TypeScript", "å¿ƒè·³ç›‘æ§\nè¿æ¥çŠ¶æ€ã€å¥åº·æ£€æŸ¥")
    }
    
    Component_Ext(main_process, "Main Process")
    Component_Ext(renderer_process, "Renderer Process")
    Component_Ext(event_bus, "EventBus")
    
    Rel(renderer_process, channel_manager, "IPCè¯·æ±‚", "è·¨è¿›ç¨‹è°ƒç”¨")
    Rel(channel_manager, security_validator, "å®‰å…¨æ£€æŸ¥", "æƒé™éªŒè¯")
    Rel(security_validator, message_serializer, "æ¶ˆæ¯å¤„ç†", "æ•°æ®åºåˆ—åŒ–")
    Rel(message_serializer, main_process, "å®‰å…¨æ¶ˆæ¯", "è¿›ç¨‹é€šä¿¡")
    
    Rel(channel_manager, rate_limiter, "é€Ÿç‡æ§åˆ¶", "æµé‡ç®¡ç†")
    Rel(channel_manager, error_handler, "é”™è¯¯å¤„ç†", "å¼‚å¸¸æ¢å¤")
    Rel(channel_manager, heartbeat_monitor, "å¥åº·ç›‘æ§", "è¿æ¥çŠ¶æ€")
    
    Rel(event_bus, channel_manager, "äº‹ä»¶æ¡¥æ¥", "è·¨è¿›ç¨‹äº‹ä»¶")
    
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 4.2.6 å¤šçº§ç¼“å­˜ç³»ç»Ÿç»„ä»¶

```mermaid
C4Component
    title C4 Component - å¤šçº§ç¼“å­˜ç³»ç»Ÿå†…éƒ¨ç»“æ„

    Container_Boundary(cache_system, "Multi-Level Cache System") {
        Component(l1_component_cache, "L1 Component Cache", "Map/WeakMap", "ç»„ä»¶çº§ç¼“å­˜\nå†…å­˜ç›´æ¥è®¿é—®")
        Component(l2_app_cache, "L2 App Cache", "Redux/Zustand", "åº”ç”¨çº§ç¼“å­˜\nçŠ¶æ€æŒä¹…åŒ–")
        Component(l3_memory_db, "L3 Memory DB", "SQLite :memory:", "å†…å­˜æ•°æ®åº“\n SQLæŸ¥è¯¢ç¼“å­˜")
        Component(cache_coordinator, "Cache Coordinator", "TypeScript", "ç¼“å­˜åè°ƒå™¨\nä¸€è‡´æ€§ç®¡ç†ã€å¤±æ•ˆç­–ç•¥")
        Component(cache_metrics, "Cache Metrics", "TypeScript", "ç¼“å­˜æŒ‡æ ‡\nå‘½ä¸­ç‡ã€æ€§èƒ½ç»Ÿè®¡")
        Component(eviction_manager, "Eviction Manager", "TypeScript", "æ·˜æ±°ç®¡ç†å™¨\nLRU/LFUç­–ç•¥")
    }
    
    Component_Ext(ui_components, "UI Components")
    Component_Ext(phaser_scenes, "Phaser Scenes")
    Component_Ext(event_bus, "EventBus")
    Component_Ext(sqlite_db, "SQLite DB")
    
    Rel(ui_components, l1_component_cache, "å¿«é€Ÿè®¿é—®", "ç»„ä»¶çŠ¶æ€")
    Rel(phaser_scenes, l1_component_cache, "èµ„æºç¼“å­˜", "æ¸¸æˆèµ„æº")
    Rel(l1_component_cache, l2_app_cache, "ç¼“å­˜ç©¿é€", "çŠ¶æ€åŒæ­¥")
    Rel(l2_app_cache, l3_memory_db, "æ•°æ®ç¼“å­˜", "æŸ¥è¯¢ç»“æœ")
    Rel(l3_memory_db, sqlite_db, "æ•°æ®åŒæ­¥", "æŒä¹…åŒ–")
    
    Rel(cache_coordinator, l1_component_cache, "ä¸€è‡´æ€§æ§åˆ¶", "ç¼“å­˜å¤±æ•ˆ")
    Rel(cache_coordinator, l2_app_cache, "çŠ¶æ€åŒæ­¥", "æ•°æ®ä¸€è‡´æ€§")
    Rel(cache_coordinator, l3_memory_db, "æ•°æ®åŒæ­¥", "ç¼“å­˜æ›´æ–°")
    
    Rel(eviction_manager, cache_metrics, "æ€§èƒ½æ•°æ®", "æ·˜æ±°å†³ç­–")
    Rel(cache_coordinator, event_bus, "ç¼“å­˜äº‹ä»¶", "å¤±æ•ˆé€šçŸ¥")
    
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 4.2.7 ç»„ä»¶ä¾èµ–å…³ç³»çŸ©é˜µ

| ç»„ä»¶ç±»åˆ« | æ ¸å¿ƒä¾èµ– | é€šä¿¡åè®® | æ•°æ®æµå‘ | æ€§èƒ½å½±å“ |
|----------|----------|----------|----------|----------|
| **React UI Components** | State Manager + EventBus | Props/Hooks + Events | UI â†’ State â†’ Event | è½»é‡çº§ï¼Œå“åº”å¼ |
| **Phaser Game Components** | Scene Manager + Render Pipeline | Phaser API + EventBus | Input â†’ Scene â†’ Render | é«˜æ€§èƒ½ï¼Œ60FPS |
| **EventBus Components** | Contract Manager + Dispatcher | Type-safe Events | Pub/Subæ¨¡å¼ | ä½å»¶è¿Ÿï¼Œ<1ms |
| **AI Worker Components** | Strategy Engine + Communication | postMessage/onMessage | Request â†’ Compute â†’ Response | å¼‚æ­¥éš”ç¦»ï¼Œ<100ms |
| **IPC Bridge Components** | Security Validator + Serializer | Electron IPC | Renderer â†” Main | å®‰å…¨ä¼˜å…ˆï¼Œ<5ms |
| **Cache Components** | Coordinator + Metrics | Internal APIs | Read/Write/Evict | å†…å­˜ä¼˜åŒ–ï¼Œé«˜å‘½ä¸­ç‡ |

### 4.2.8 ç»„ä»¶å®ç°æ–‡ä»¶æ˜ å°„

**React UI Layer ç»„ä»¶æ˜ å°„**:
- `src/renderer/components/` - UIç»„ä»¶å®ç°
- `src/renderer/store/` - çŠ¶æ€ç®¡ç†å™¨  
- `src/renderer/routes/` - è·¯ç”±é…ç½®
- `src/renderer/hooks/` - è‡ªå®šä¹‰Hook

**Phaser Game Layer ç»„ä»¶æ˜ å°„**:
- `src/renderer/game/scenes/` - æ¸¸æˆåœºæ™¯
- `src/renderer/game/systems/` - æ¸¸æˆç³»ç»Ÿ
- `src/renderer/game/entities/` - æ¸¸æˆå®ä½“
- `src/renderer/game/input/` - è¾“å…¥å¤„ç†

**EventBus System ç»„ä»¶æ˜ å°„**:
- `src/core/events/EventBus.ts` - äº‹ä»¶æ€»çº¿æ ¸å¿ƒ
- `src/core/events/types.ts` - äº‹ä»¶ç±»å‹å®šä¹‰
- `src/core/events/contracts/` - å¥‘çº¦ç®¡ç†
- `src/core/events/performance/` - æ€§èƒ½ç›‘æ§

**AI Worker System ç»„ä»¶æ˜ å°„**:
- `src/workers/ai/` - AIè®¡ç®—Worker
- `src/workers/ai/strategies/` - ç­–ç•¥ç®—æ³•
- `src/workers/ai/communication/` - é€šä¿¡æ¥å£
- `src/workers/ai/cache/` - AIç¼“å­˜

### 4.2.9 æ¶æ„çº¦æŸéªŒè¯

**KISSåŸåˆ™éªŒè¯**:
- âœ… æ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€ï¼ŒåŠŸèƒ½æ˜ç¡®
- âœ… ç»„ä»¶é—´ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œé¿å…å¾ªç¯ä¾èµ–
- âœ… æ¥å£è®¾è®¡ç®€æ´ï¼Œæ˜“äºç†è§£å’Œä½¿ç”¨

**YAGNIåŸåˆ™éªŒè¯**:
- âœ… æ‰€æœ‰ç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡éœ€æ±‚æ”¯æ’‘
- âœ… é¿å…è¿‡åº¦è®¾è®¡å’Œé¢„ç•™æ¥å£
- âœ… åŸºäºMVPéœ€æ±‚å®ç°æ ¸å¿ƒåŠŸèƒ½

**æŠ€æœ¯æ ˆçº¦æŸç¬¦åˆæ€§**:
- âœ… React 19 å‡½æ•°ç»„ä»¶ + Hookæ¨¡å¼
- âœ… Phaser 3 Sceneæ¶æ„ + WebGLæ¸²æŸ“
- âœ… TypeScript å¼ºç±»å‹çº¦æŸ
- âœ… EventBus å¥‘çº¦å›ºåŒ–v1.0

### 4.2.10 ä¸å…¶ä»–C4å±‚çº§æ•´åˆ

- **Contextå±‚å…³è”**: Componentå±‚å®ç°äº†Contextå±‚å®šä¹‰çš„ç³»ç»Ÿè¾¹ç•Œå’Œå¤–éƒ¨äº¤äº’
- **Containerå±‚å…³è”**: æ¯ä¸ªContainerçš„å†…éƒ¨å®ç°éƒ½é€šè¿‡Componentå±‚è¯¦ç»†å±•ç°
- **è¿è¡Œæ—¶å…³è”**: Componenté—´çš„äº¤äº’æ¨¡å¼ç›´æ¥æ˜ å°„åˆ°è¿è¡Œæ—¶çš„æ‰§è¡Œæµç¨‹
- **æµ‹è¯•å…³è”**: æ¯ä¸ªComponentéƒ½æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è¦†ç›–

> ğŸ’¡ **ç»„ä»¶è®¾è®¡æ´å¯Ÿ**: åŸºäº ultrathink æ·±åº¦åˆ†æï¼Œæ­¤Componentå±‚è®¾è®¡å……åˆ†ä½“ç°äº†Electronå¤šè¿›ç¨‹æ¶æ„çš„æŠ€æœ¯å¤æ‚æ€§ï¼ŒåŒæ—¶ä¿æŒäº†é«˜åº¦çš„æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤æ€§ã€‚EventBusä½œä¸ºé€šä¿¡ä¸­æ¢ï¼Œæœ‰æ•ˆè§£è€¦äº†React UIå±‚å’ŒPhaseræ¸¸æˆå±‚ï¼ŒAI Workerçš„éš”ç¦»è®¾è®¡ç¡®ä¿äº†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸ä¼šé˜»å¡ä¸»æ¸²æŸ“æµç¨‹ã€‚

---

## 4.3 äº‹ä»¶å‘½åä¸å¥‘çº¦ï¼ˆContractï¼‰
> æœ¬èŠ‚åŸºäº **ultrathink æ·±åº¦åˆ†æ** å’Œ **CloudEvents è§„èŒƒ**ï¼Œæä¾›ä¼ä¸šçº§äº‹ä»¶å¥‘çº¦ä½“ç³»ï¼Œå®ç°æ ‡å‡†å…¼å®¹æ€§ä¸æ¸¸æˆå¼€å‘æ•ˆç‡çš„å®Œç¾å¹³è¡¡ã€‚

### 4.3.1 ä¸‰å±‚äº‹ä»¶å¥‘çº¦æ¶æ„è®¾è®¡

```mermaid
graph TB
    subgraph "Developer API Layer"
        DevAPI["ç®€åŒ–å¼€å‘API<br/>guild.create(), combat.start()"]
        TypeHelper["TypeScriptç±»å‹åŠ©æ‰‹<br/>ç¼–è¯‘æ—¶éªŒè¯"]
    end
    
    subgraph "Game Event Layer"
        GameEvent["æ¸¸æˆäº‹ä»¶æ ¼å¼<br/>StandardGameEvent<T>"]
        EventTypes["äº‹ä»¶ç±»å‹æ³¨å†Œ<br/>GUILD, COMBAT, ECONOMY"]
        Priority["ä¼˜å…ˆçº§ç®¡ç†<br/>CRITICAL/HIGH/MEDIUM/LOW"]
    end
    
    subgraph "CloudEvents Core Layer"
        CloudEvent["CloudEventsæ ¼å¼<br/>æ ‡å‡†å…¼å®¹æ€§"]
        Metadata["æ ‡å‡†å…ƒæ•°æ®<br/>id, source, time, type"]
        Schema["JSON SchemaéªŒè¯<br/>è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥"]
    end
    
    DevAPI --> GameEvent
    TypeHelper --> GameEvent
    GameEvent --> CloudEvent
    EventTypes --> CloudEvent
    Priority --> CloudEvent
    CloudEvent --> Metadata
    CloudEvent --> Schema
    
    style DevAPI fill:#e1f5fe
    style GameEvent fill:#f3e5f5
    style CloudEvent fill:#e8f5e8
```

### 4.3.2 CloudEvents å…¼å®¹çš„äº‹ä»¶å¥‘çº¦è§„èŒƒ

**CloudEvents v1.0 æ ¸å¿ƒå±æ€§æ˜ å°„**:
```typescript
// CloudEvents è§„èŒƒå…¼å®¹çš„äº‹ä»¶æ¥å£
interface CloudEventsCompatibleEvent {
  // === CloudEvents å¿…éœ€å±æ€§ ===
  readonly specversion: "1.0";           // CloudEvents è§„èŒƒç‰ˆæœ¬
  readonly type: string;                 // äº‹ä»¶ç±»å‹ (com.guildmanager.guild.created)
  readonly source: string;               // äº‹ä»¶æº (/guild-manager/renderer/ui)
  readonly id: string;                   // äº‹ä»¶å”¯ä¸€æ ‡è¯†ç¬¦
  readonly time?: string;                // ISO 8601 æ—¶é—´æˆ³
  readonly datacontenttype?: string;     // æ•°æ®å†…å®¹ç±»å‹ (application/json)
  readonly dataschema?: string;          // æ•°æ®æ¨¡å¼URI
  readonly subject?: string;             // äº‹ä»¶ä¸»é¢˜ (guild/12345)
  
  // === CloudEvents å¯é€‰å±æ€§ ===
  readonly data?: any;                   // äº‹ä»¶è´Ÿè½½æ•°æ®
  
  // === æ¸¸æˆæ‰©å±•å±æ€§ ===
  readonly priority: EventPriority;     // æ¸¸æˆä¼˜å…ˆçº§
  readonly ttl?: number;                 // ç”Ÿå­˜æ—¶é—´ (ms)
  readonly sessionid?: string;           // æ¸¸æˆä¼šè¯ID
  readonly traceid?: string;             // åˆ†å¸ƒå¼è¿½è¸ªID
  readonly userid?: string;              // ç”¨æˆ·æ ‡è¯†ç¬¦
}

// æ¸¸æˆä¼˜å…ˆçº§æšä¸¾ï¼ˆä¸CloudEventså…¼å®¹ï¼‰
enum EventPriority {
  CRITICAL = 0,    // ç«‹å³å¤„ç† (<1ms)
  HIGH = 1,        // ä¸‹ä¸€å¸§å¤„ç† (<16ms)
  MEDIUM = 2,      // æ‰¹é‡å¤„ç† (<100ms)
  LOW = 3          // ç©ºé—²æ—¶å¤„ç† (<1s)
}
```

### 4.3.3 äº‹ä»¶å‘½åçº¦å®šä¸æœ€ä½³å®è·µ

**æ ‡å‡†åŒ–å‘½åè§„èŒƒ**:
```typescript
// äº‹ä»¶ç±»å‹å‘½åæ ‡å‡† (CloudEvents + æ¸¸æˆç®€åŒ–)
namespace EventNaming {
  // === CloudEvents æ ‡å‡†æ ¼å¼ ===
  export const CLOUDEVENTS_FORMAT = {
    // å®Œæ•´æ ¼å¼ï¼šcom.{organization}.{system}.{domain}.{action}
    FULL: "com.guildmanager.game.guild.created",
    // æºæ ‡è¯†ï¼š/{system}/{process}/{component}
    SOURCE: "/guild-manager/renderer/ui",
    // ä¸»é¢˜æ ‡è¯†ï¼š{entity-type}/{entity-id}
    SUBJECT: "guild/12345"
  };
  
  // === ç®€åŒ–æ¸¸æˆæ ¼å¼ (å‘åå…¼å®¹) ===
  export const GAME_FORMAT = {
    // ç®€åŒ–æ ¼å¼ï¼š{domain}.{action}
    SIMPLE: "guild.created",
    // æºæ ‡è¯†ï¼š{component}
    SOURCE: "ui",
    // ä¸»é¢˜æ ‡è¯†ï¼š{id}
    SUBJECT: "12345"
  };
  
  // === è‡ªåŠ¨è½¬æ¢è§„åˆ™ ===
  export const CONVERSION_RULES = {
    // æ¸¸æˆæ ¼å¼ â†’ CloudEventsæ ¼å¼
    toCloudEvents: (gameType: string, source: string) => 
      `com.guildmanager.game.${gameType}`,
    // CloudEventsæ ¼å¼ â†’ æ¸¸æˆæ ¼å¼  
    toGameFormat: (cloudType: string) => 
      cloudType.replace("com.guildmanager.game.", "")
  };
}

// åŸŸç‰¹å®šäº‹ä»¶ç±»å‹å®šä¹‰
export const GUILD_EVENTS = {
  // å…¬ä¼šç”Ÿå‘½å‘¨æœŸ
  CREATED: "guild.created",              // å…¬ä¼šåˆ›å»º
  DISBANDED: "guild.disbanded",          // å…¬ä¼šè§£æ•£
  RENAMED: "guild.renamed",              // å…¬ä¼šé‡å‘½å
  
  // æˆå‘˜ç®¡ç†
  MEMBER_JOINED: "guild.member.joined",  // æˆå‘˜åŠ å…¥
  MEMBER_LEFT: "guild.member.left",      // æˆå‘˜ç¦»å¼€
  MEMBER_PROMOTED: "guild.member.promoted", // æˆå‘˜æ™‹å‡
  MEMBER_DEMOTED: "guild.member.demoted",   // æˆå‘˜é™çº§
  
  // å…¬ä¼šæ´»åŠ¨
  ACTIVITY_STARTED: "guild.activity.started", // æ´»åŠ¨å¼€å§‹
  ACTIVITY_COMPLETED: "guild.activity.completed", // æ´»åŠ¨å®Œæˆ
  RAID_SCHEDULED: "guild.raid.scheduled",     // å›¢é˜Ÿå‰¯æœ¬å®‰æ’
} as const;

export const COMBAT_EVENTS = {
  // æˆ˜æ–—æµç¨‹
  BATTLE_STARTED: "combat.battle.started",
  BATTLE_ENDED: "combat.battle.ended",
  ROUND_STARTED: "combat.round.started",
  ROUND_ENDED: "combat.round.ended",
  
  // æˆ˜æ–—åŠ¨ä½œ
  ATTACK_EXECUTED: "combat.attack.executed",
  SKILL_CAST: "combat.skill.cast",
  ITEM_USED: "combat.item.used",
  
  // çŠ¶æ€å˜åŒ–
  HP_CHANGED: "combat.hp.changed",
  BUFF_APPLIED: "combat.buff.applied",
  DEBUFF_APPLIED: "combat.debuff.applied",
} as const;

export const ECONOMY_EVENTS = {
  // äº¤æ˜“ç³»ç»Ÿ
  TRADE_INITIATED: "economy.trade.initiated",
  TRADE_COMPLETED: "economy.trade.completed",
  TRADE_CANCELLED: "economy.trade.cancelled",
  
  // æ‹å–ç³»ç»Ÿ
  AUCTION_CREATED: "economy.auction.created",
  BID_PLACED: "economy.bid.placed",
  AUCTION_ENDED: "economy.auction.ended",
  
  // å¸‚åœºåŠ¨æ€
  PRICE_CHANGED: "economy.price.changed",
  INFLATION_DETECTED: "economy.inflation.detected",
} as const;
```

### 4.3.4 TypeScript ç±»å‹å®‰å…¨çš„äº‹ä»¶å¥‘çº¦

**ç¼–è¯‘æ—¶ç±»å‹éªŒè¯**:
```typescript
// æ¡ä»¶ç±»å‹å®ç°ç¼–è¯‘æ—¶éªŒè¯
type EventTypeValidator<T extends string> = 
  T extends `${string}.${string}` ? T : never;

type ValidEventType = EventTypeValidator<"guild.created">; // âœ… é€šè¿‡
type InvalidEventType = EventTypeValidator<"invalid">;     // âŒ ç¼–è¯‘é”™è¯¯

// äº‹ä»¶è´Ÿè½½ç±»å‹å®‰å…¨
interface EventPayloadMap {
  "guild.created": {
    guildId: string;
    guildName: string;
    creatorId: string;
    createdAt: number;
    maxMembers: number;
  };
  
  "combat.battle.started": {
    battleId: string;
    participants: string[];
    battleType: "PVP" | "PVE" | "RAID";
    location: string;
  };
  
  "economy.trade.completed": {
    tradeId: string;
    sellerId: string;
    buyerId: string;
    itemId: string;
    price: number;
    currency: "GOLD" | "SILVER" | "CRYSTAL";
  };
}

// ç±»å‹å®‰å…¨çš„äº‹ä»¶åˆ›å»ºå™¨
function createTypedEvent<T extends keyof EventPayloadMap>(
  type: T,
  payload: EventPayloadMap[T],
  options?: Partial<CloudEventsCompatibleEvent>
): CloudEventsCompatibleEvent & { data: EventPayloadMap[T] } {
  return {
    specversion: "1.0",
    type: EventNaming.CONVERSION_RULES.toCloudEvents(type, "renderer"),
    source: "/guild-manager/renderer/game",
    id: crypto.randomUUID(),
    time: new Date().toISOString(),
    datacontenttype: "application/json",
    subject: payload.id || payload.guildId || payload.battleId || payload.tradeId,
    data: payload,
    priority: EventPriority.MEDIUM,
    sessionid: globalThis.sessionStorage?.getItem("session-id") || undefined,
    ...options
  };
}

// ä½¿ç”¨ç¤ºä¾‹ - å®Œå…¨ç±»å‹å®‰å…¨
const guildCreatedEvent = createTypedEvent("guild.created", {
  guildId: "guild-12345",
  guildName: "é¾™ä¹‹å…¬ä¼š",
  creatorId: "user-67890",
  createdAt: Date.now(),
  maxMembers: 50
});
```

### 4.3.5 äº‹ä»¶éªŒè¯ä¸è¿è¡Œæ—¶æ£€æŸ¥

**JSON Schema è¿è¡Œæ—¶éªŒè¯**:
```typescript
// äº‹ä»¶ Schema å®šä¹‰
const EVENT_SCHEMAS = {
  "guild.created": {
    type: "object",
    required: ["guildId", "guildName", "creatorId", "createdAt", "maxMembers"],
    properties: {
      guildId: { type: "string", pattern: "^guild-[a-zA-Z0-9]+$" },
      guildName: { type: "string", minLength: 1, maxLength: 50 },
      creatorId: { type: "string", pattern: "^user-[a-zA-Z0-9]+$" },
      createdAt: { type: "number", minimum: 0 },
      maxMembers: { type: "number", minimum: 1, maximum: 200 }
    },
    additionalProperties: false
  }
} as const;

// è¿è¡Œæ—¶éªŒè¯å™¨
class EventValidator {
  private ajv = new Ajv({ allErrors: true });
  
  constructor() {
    // æ³¨å†Œæ‰€æœ‰äº‹ä»¶ Schema
    Object.entries(EVENT_SCHEMAS).forEach(([eventType, schema]) => {
      this.ajv.addSchema(schema, eventType);
    });
  }
  
  validate<T extends keyof EventPayloadMap>(
    eventType: T, 
    payload: unknown
  ): payload is EventPayloadMap[T] {
    const isValid = this.ajv.validate(eventType, payload);
    if (!isValid) {
      console.error(`Event validation failed for ${eventType}:`, this.ajv.errors);
      return false;
    }
    return true;
  }
  
  validateCloudEvent(event: CloudEventsCompatibleEvent): boolean {
    // CloudEvents è§„èŒƒéªŒè¯
    const requiredFields = ["specversion", "type", "source", "id"];
    const missingFields = requiredFields.filter(field => !event[field]);
    
    if (missingFields.length > 0) {
      console.error("Missing required CloudEvents fields:", missingFields);
      return false;
    }
    
    // äº‹ä»¶ç±»å‹æ ¼å¼éªŒè¯
    if (!event.type.includes(".")) {
      console.error("Invalid event type format:", event.type);
      return false;
    }
    
    // æ—¶é—´æˆ³æ ¼å¼éªŒè¯
    if (event.time && !isValidISO8601(event.time)) {
      console.error("Invalid time format:", event.time);
      return false;
    }
    
    return true;
  }
}

function isValidISO8601(dateString: string): boolean {
  const iso8601Regex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z$/;
  return iso8601Regex.test(dateString);
}
```

### 4.3.6 äº‹ä»¶ç‰ˆæœ¬åŒ–ä¸å‘åå…¼å®¹æ€§

**è¯­ä¹‰åŒ–ç‰ˆæœ¬ç®¡ç†**:
```typescript
// äº‹ä»¶ç‰ˆæœ¬åŒ–ç­–ç•¥
namespace EventVersioning {
  // ç‰ˆæœ¬ä¿¡æ¯æ¥å£
  interface EventVersion {
    readonly major: number;    // é‡å¤§å˜æ›´ï¼ˆä¸å…¼å®¹ï¼‰
    readonly minor: number;    // åŠŸèƒ½å¢åŠ ï¼ˆå‘åå…¼å®¹ï¼‰  
    readonly patch: number;    // é”™è¯¯ä¿®å¤ï¼ˆå‘åå…¼å®¹ï¼‰
  }
  
  // ç‰ˆæœ¬åŒ–äº‹ä»¶æ¥å£
  interface VersionedEvent extends CloudEventsCompatibleEvent {
    readonly dataschema: string; // Schemaç‰ˆæœ¬URI
    readonly eventversion: string; // äº‹ä»¶ç‰ˆæœ¬ (1.2.3)
  }
  
  // ç‰ˆæœ¬è¿ç§»å™¨
  class EventMigrator {
    private migrations = new Map<string, Migration[]>();
    
    // æ³¨å†Œè¿ç§»è§„åˆ™
    registerMigration(eventType: string, migration: Migration): void {
      const existing = this.migrations.get(eventType) || [];
      existing.push(migration);
      this.migrations.set(eventType, existing.sort((a, b) => 
        compareVersions(a.fromVersion, b.fromVersion)
      ));
    }
    
    // è¿ç§»äº‹ä»¶åˆ°æœ€æ–°ç‰ˆæœ¬
    migrate(event: VersionedEvent): VersionedEvent {
      const migrations = this.migrations.get(event.type) || [];
      let currentEvent = event;
      
      for (const migration of migrations) {
        if (compareVersions(currentEvent.eventversion, migration.fromVersion) === 0) {
          currentEvent = migration.transform(currentEvent);
        }
      }
      
      return currentEvent;
    }
  }
  
  interface Migration {
    readonly fromVersion: string;
    readonly toVersion: string;
    readonly description: string;
    transform(event: VersionedEvent): VersionedEvent;
  }
  
  // ç‰ˆæœ¬æ¯”è¾ƒå·¥å…·
  function compareVersions(a: string, b: string): number {
    const aParts = a.split('.').map(Number);
    const bParts = b.split('.').map(Number);
    
    for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
      const aPart = aParts[i] || 0;
      const bPart = bParts[i] || 0;
      
      if (aPart !== bPart) {
        return aPart - bPart;
      }
    }
    
    return 0;
  }
}

// å‘åå…¼å®¹æ€§ç¤ºä¾‹
const guildEventMigrator = new EventVersioning.EventMigrator();

// æ³¨å†Œ guild.created äº‹ä»¶çš„ç‰ˆæœ¬è¿ç§»
guildEventMigrator.registerMigration("guild.created", {
  fromVersion: "1.0.0",
  toVersion: "1.1.0", 
  description: "æ·»åŠ  maxMembers å­—æ®µ",
  transform: (event) => ({
    ...event,
    eventversion: "1.1.0",
    data: {
      ...event.data,
      maxMembers: event.data.maxMembers || 50 // é»˜è®¤å€¼
    }
  })
});
```

### 4.3.7 å¯è§‚æµ‹æ€§ä¸è°ƒè¯•æ”¯æŒ

**OpenTelemetry å…¼å®¹çš„äº‹ä»¶è¿½è¸ª**:
```typescript
// äº‹ä»¶è¿½è¸ªé›†æˆ
import { trace, context, SpanKind, SpanStatusCode } from '@opentelemetry/api';

class ObservableEventBus {
  private tracer = trace.getTracer('guild-manager-events', '1.0.0');
  
  async publish<T>(event: CloudEventsCompatibleEvent & { data: T }): Promise<void> {
    // åˆ›å»ºåˆ†å¸ƒå¼è¿½è¸ª span
    const span = this.tracer.startSpan(`event.publish.${event.type}`, {
      kind: SpanKind.PRODUCER,
      attributes: {
        'event.type': event.type,
        'event.source': event.source,
        'event.id': event.id,
        'event.priority': event.priority,
        'event.size_bytes': JSON.stringify(event.data).length
      }
    });
    
    try {
      // æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡
      const enhancedEvent = {
        ...event,
        traceid: span.spanContext().traceId,
        spanid: span.spanContext().spanId
      };
      
      // è®°å½•äº‹ä»¶å‘å¸ƒæŒ‡æ ‡
      this.recordEventMetrics(enhancedEvent);
      
      // å®é™…å‘å¸ƒäº‹ä»¶
      await this.doPublish(enhancedEvent);
      
      span.setStatus({ code: SpanStatusCode.OK });
      
    } catch (error) {
      span.setStatus({ 
        code: SpanStatusCode.ERROR, 
        message: error.message 
      });
      span.recordException(error);
      throw error;
      
    } finally {
      span.end();
    }
  }
  
  private recordEventMetrics(event: CloudEventsCompatibleEvent): void {
    // å‘å¸ƒå»¶è¿ŸæŒ‡æ ‡
    const publishLatency = performance.now() - event.timestamp;
    metrics.histogram('event.publish.latency', publishLatency, {
      event_type: event.type,
      priority: event.priority.toString()
    });
    
    // äº‹ä»¶è®¡æ•°æŒ‡æ ‡
    metrics.counter('event.published.total', 1, {
      event_type: event.type,
      source: event.source
    });
    
    // äº‹ä»¶å¤§å°æŒ‡æ ‡
    const eventSize = JSON.stringify(event.data).length;
    metrics.histogram('event.payload.size', eventSize, {
      event_type: event.type
    });
  }
}

// äº‹ä»¶è°ƒè¯•å·¥å…·
class EventDebugger {
  private eventHistory: CloudEventsCompatibleEvent[] = [];
  private maxHistorySize = 1000;
  
  recordEvent(event: CloudEventsCompatibleEvent): void {
    this.eventHistory.unshift(event);
    if (this.eventHistory.length > this.maxHistorySize) {
      this.eventHistory.pop();
    }
  }
  
  // äº‹ä»¶é‡æ”¾åŠŸèƒ½
  replayEvents(filter?: EventFilter): CloudEventsCompatibleEvent[] {
    return this.eventHistory.filter(event => {
      if (!filter) return true;
      
      return (!filter.type || event.type === filter.type) &&
             (!filter.source || event.source === filter.source) &&
             (!filter.timeRange || this.isInTimeRange(event, filter.timeRange));
    });
  }
  
  // äº‹ä»¶æµåˆ†æ
  analyzeEventFlow(timeWindow: number = 5000): EventFlowAnalysis {
    const recentEvents = this.eventHistory.filter(event => 
      Date.now() - new Date(event.time).getTime() < timeWindow
    );
    
    return {
      totalEvents: recentEvents.length,
      eventsPerSecond: recentEvents.length / (timeWindow / 1000),
      typeDistribution: this.getTypeDistribution(recentEvents),
      averageLatency: this.calculateAverageLatency(recentEvents)
    };
  }
}

interface EventFilter {
  type?: string;
  source?: string;
  timeRange?: { start: Date; end: Date };
}

interface EventFlowAnalysis {
  totalEvents: number;
  eventsPerSecond: number;
  typeDistribution: Record<string, number>;
  averageLatency: number;
}
```

### 4.3.8 æ€§èƒ½ä¼˜åŒ–çš„äº‹ä»¶å¤„ç†

**äº‹ä»¶æ± ä¸æ‰¹å¤„ç†ç­–ç•¥**:
```typescript
// é«˜æ€§èƒ½äº‹ä»¶æ± 
class EventPool {
  private pool: CloudEventsCompatibleEvent[] = [];
  private maxPoolSize = 100;
  
  acquire(): CloudEventsCompatibleEvent {
    if (this.pool.length > 0) {
      return this.pool.pop()!;
    }
    
    return this.createEmptyEvent();
  }
  
  release(event: CloudEventsCompatibleEvent): void {
    if (this.pool.length < this.maxPoolSize) {
      // é‡ç½®äº‹ä»¶å¯¹è±¡
      this.resetEvent(event);
      this.pool.push(event);
    }
  }
  
  private createEmptyEvent(): CloudEventsCompatibleEvent {
    return {
      specversion: "1.0",
      type: "",
      source: "",
      id: "",
      time: "",
      data: null,
      priority: EventPriority.MEDIUM
    };
  }
  
  private resetEvent(event: CloudEventsCompatibleEvent): void {
    Object.keys(event).forEach(key => {
      event[key] = undefined;
    });
  }
}

// æ‰¹å¤„ç†äº‹ä»¶å‘å¸ƒå™¨
class BatchEventPublisher {
  private batch: CloudEventsCompatibleEvent[] = [];
  private batchSize = 50;
  private flushInterval = 16; // 16ms (60FPS)
  private timer: number | null = null;
  
  addToBatch(event: CloudEventsCompatibleEvent): void {
    this.batch.push(event);
    
    if (this.batch.length >= this.batchSize) {
      this.flush();
    } else if (this.timer === null) {
      this.timer = setTimeout(() => this.flush(), this.flushInterval);
    }
  }
  
  private flush(): void {
    if (this.batch.length === 0) return;
    
    const eventsToProcess = [...this.batch];
    this.batch.length = 0;
    
    if (this.timer !== null) {
      clearTimeout(this.timer);
      this.timer = null;
    }
    
    // æŒ‰ä¼˜å…ˆçº§æ’åºæ‰¹å¤„ç†
    eventsToProcess.sort((a, b) => a.priority - b.priority);
    
    // åˆ†æ‰¹å¤„ç†ä¸åŒä¼˜å…ˆçº§çš„äº‹ä»¶
    this.processBatchByPriority(eventsToProcess);
  }
  
  private processBatchByPriority(events: CloudEventsCompatibleEvent[]): void {
    const priorityGroups = new Map<EventPriority, CloudEventsCompatibleEvent[]>();
    
    events.forEach(event => {
      const group = priorityGroups.get(event.priority) || [];
      group.push(event);
      priorityGroups.set(event.priority, group);
    });
    
    // ç«‹å³å¤„ç†å…³é”®äº‹ä»¶
    const criticalEvents = priorityGroups.get(EventPriority.CRITICAL) || [];
    if (criticalEvents.length > 0) {
      this.processEventGroup(criticalEvents);
    }
    
    // ä¸‹ä¸€å¸§å¤„ç†é«˜ä¼˜å…ˆçº§äº‹ä»¶
    const highEvents = priorityGroups.get(EventPriority.HIGH) || [];
    if (highEvents.length > 0) {
      requestAnimationFrame(() => this.processEventGroup(highEvents));
    }
    
    // æ‰¹é‡å¤„ç†ä¸­ä½ä¼˜å…ˆçº§äº‹ä»¶
    const mediumEvents = priorityGroups.get(EventPriority.MEDIUM) || [];
    const lowEvents = priorityGroups.get(EventPriority.LOW) || [];
    if (mediumEvents.length > 0 || lowEvents.length > 0) {
      requestIdleCallback(() => {
        this.processEventGroup([...mediumEvents, ...lowEvents]);
      });
    }
  }
  
  private processEventGroup(events: CloudEventsCompatibleEvent[]): void {
    events.forEach(event => {
      // å®é™…çš„äº‹ä»¶å¤„ç†é€»è¾‘
      this.processEvent(event);
    });
  }
}
```

### 4.3.9 äº‹ä»¶å¥‘çº¦æœ€ä½³å®è·µæ€»ç»“

**å¼€å‘æŒ‡å—**:
```typescript
// âœ… æ¨èçš„äº‹ä»¶ä½¿ç”¨æ¨¡å¼
class GuildService {
  // 1. ä½¿ç”¨ç±»å‹å®‰å…¨çš„äº‹ä»¶åˆ›å»º
  async createGuild(name: string, creatorId: string): Promise<Guild> {
    const guild = await this.repository.create({ name, creatorId });
    
    // å‘å¸ƒç±»å‹å®‰å…¨çš„äº‹ä»¶
    const event = createTypedEvent("guild.created", {
      guildId: guild.id,
      guildName: guild.name,
      creatorId: guild.creatorId,
      createdAt: guild.createdAt,
      maxMembers: guild.maxMembers
    });
    
    await eventBus.publish(event);
    return guild;
  }
  
  // 2. ä½¿ç”¨å¼ºç±»å‹çš„äº‹ä»¶ç›‘å¬
  setupEventListeners(): void {
    eventBus.subscribe("guild.member.joined", async (event) => {
      // event.data æ˜¯å®Œå…¨ç±»å‹å®‰å…¨çš„
      await this.handleMemberJoined(event.data);
    });
  }
}

// âŒ é¿å…çš„åæ¨¡å¼
class BadEventUsage {
  // ä¸è¦ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹
  publishEvent(type: string, data: any): void {
    // ç¼ºä¹ç±»å‹å®‰å…¨
  }
  
  // ä¸è¦åœ¨äº‹ä»¶ä¸­åŒ…å«UIçŠ¶æ€
  publishUIEvent(): void {
    eventBus.publish("guild.created", {
      guild: guildData,
      selectedTab: "members", // âŒ UIçŠ¶æ€ä¸åº”åœ¨äº‹ä»¶ä¸­
      uiState: {} // âŒ UIçŠ¶æ€ä¸åº”åœ¨äº‹ä»¶ä¸­  
    });
  }
}
```

### 4.3.10 ä¸æ¶æ„ä½“ç³»çš„æ•´åˆ

- **4.1 Contextå±‚å…³è”**: äº‹ä»¶å¥‘çº¦å®šä¹‰äº†ç³»ç»Ÿè¾¹ç•Œå†…çš„æ ‡å‡†é€šä¿¡åè®®
- **4.8 Componentå±‚å…³è”**: æ¯ä¸ªç»„ä»¶éƒ½éµå¾ªç»Ÿä¸€çš„äº‹ä»¶å¥‘çº¦è§„èŒƒ
- **ç¬¬ 6 ç«  SLO é—¨ç¦**: äº‹ä»¶å»¶è¿Ÿå’Œå¤„ç†æ€§èƒ½ç›´æ¥æ˜ å°„åˆ°è´¨é‡é—¨ç¦æŒ‡æ ‡  
- **ç¬¬ 8 ç«  éªŒæ”¶æµ‹è¯•**: æ¯ä¸ªäº‹ä»¶å¥‘çº¦éƒ½æœ‰å¯¹åº”çš„BDDéªŒæ”¶æµ‹è¯•

> ğŸ’¡ **å¥‘çº¦è®¾è®¡æ´å¯Ÿ**: åŸºäº ultrathink æ·±åº¦åˆ†æï¼Œæ­¤ä¸‰å±‚äº‹ä»¶å¥‘çº¦æ¶æ„åœ¨ä¿æŒ CloudEvents æ ‡å‡†å…¼å®¹æ€§çš„åŒæ—¶ï¼Œä¸ºæ¸¸æˆå¼€å‘æä¾›äº†æœ€ä½³çš„å¼€å‘è€…ä½“éªŒã€‚TypeScript ç±»å‹ç³»ç»Ÿä¸é€‚é…å™¨æ¨¡å¼å®ç°äº†é›¶è¿è¡Œæ—¶å¼€é”€çš„ç±»å‹å®‰å…¨ï¼Œäº‹ä»¶æ± å’Œæ‰¹å¤„ç†ç­–ç•¥ç¡®ä¿äº†é«˜é¢‘æ¸¸æˆäº‹ä»¶çš„å¤„ç†æ€§èƒ½ã€‚

---

## 4.4 TypeScript ç±»å‹ä¸äº‹ä»¶æ€»çº¿æ¥å£

åŸºäºå‰è¿°çš„CloudEventså…¼å®¹æ¶æ„å’ŒComponentå±‚è®¾è®¡ï¼Œæœ¬èŠ‚è¯¦ç»†å±•ç°ã€Šå…¬ä¼šç»ç†ã€‹äº‹ä»¶ç³»ç»Ÿçš„TypeScriptç±»å‹è®¾è®¡ä¸RxJS Subject pub-subæ¨¡å¼å®ç°ã€‚

### 4.4.1 ç±»å‹å®‰å…¨äº‹ä»¶ç³»ç»Ÿè®¾è®¡

#### 4.4.1.1 åŸºç¡€äº‹ä»¶ç±»å‹æŠ½è±¡

```typescript
/**
 * æ¸¸æˆäº‹ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯
 * ä¸ºæ¯ä¸ªäº‹ä»¶æä¾›æ¸¸æˆç‰¹å®šçš„è¿è¡Œæ—¶ä¸Šä¸‹æ–‡
 */
interface GameEventContext {
  readonly sessionId: string;        // æ¸¸æˆä¼šè¯æ ‡è¯†
  readonly playerId?: string;        // ç©å®¶IDï¼ˆå¯é€‰ï¼‰
  readonly sceneId?: string;         // å½“å‰åœºæ™¯IDï¼ˆå¯é€‰ï¼‰
  readonly timestamp: number;        // é«˜ç²¾åº¦æ—¶é—´æˆ³
  readonly frameId?: number;         // æ¸¸æˆå¸§IDï¼ˆç”¨äºåŒæ­¥ï¼‰
  readonly traceId?: string;         // é“¾è·¯è¿½è¸ªIDï¼ˆç”¨äºè°ƒè¯•ï¼‰
}

/**
 * åŸºç¡€æ¸¸æˆäº‹ä»¶æ¥å£ - Discriminated Union æ ¸å¿ƒæŠ½è±¡
 * ç»§æ‰¿CloudEventsæ ‡å‡†ï¼Œå¢åŠ æ¸¸æˆç‰¹å®šå­—æ®µ
 */
interface BaseGameEvent<T extends string, D = unknown> extends CloudEventsCompatibleEvent {
  readonly type: T;                  // äº‹ä»¶ç±»å‹ï¼ˆdiscriminatorï¼‰
  readonly data: D;                  // å¼ºç±»å‹äº‹ä»¶æ•°æ®
  readonly gameContext: GameEventContext;  // æ¸¸æˆä¸Šä¸‹æ–‡
  readonly priority: EventPriority;  // äº‹ä»¶ä¼˜å…ˆçº§
  readonly version: string;          // äº‹ä»¶å¥‘çº¦ç‰ˆæœ¬
}

/**
 * äº‹ä»¶ä¼˜å…ˆçº§æšä¸¾ - å½±å“å¤„ç†é¡ºåºå’Œæ‰¹å¤„ç†ç­–ç•¥
 */
enum EventPriority {
  CRITICAL = 0,    // å…³é”®äº‹ä»¶ï¼šç«‹å³å¤„ç†ï¼ˆå®‰å…¨ã€é”™è¯¯ï¼‰
  HIGH = 1,        // é«˜ä¼˜å…ˆçº§ï¼šä¸‹ä¸€å¸§å¤„ç†ï¼ˆç”¨æˆ·äº¤äº’ï¼‰
  MEDIUM = 2,      // ä¸­ä¼˜å…ˆçº§ï¼šæ‰¹é‡å¤„ç†ï¼ˆæ¸¸æˆé€»è¾‘ï¼‰
  LOW = 3          // ä½ä¼˜å…ˆçº§ï¼šç©ºé—²æ—¶å¤„ç†ï¼ˆç»Ÿè®¡ã€æ—¥å¿—ï¼‰
}
```

#### 4.4.1.2 Discriminated Union äº‹ä»¶åˆ†ç±»ç³»ç»Ÿ

```typescript
/**
 * æ¸¸æˆé€»è¾‘äº‹ä»¶æ•°æ®ç±»å‹
 */
interface BattleStartData {
  readonly battleId: string;
  readonly players: string[];
  readonly mapId: string;
  readonly rules: BattleRules;
}

interface ResourceUpdateData {
  readonly resourceType: 'gold' | 'exp' | 'energy';
  readonly amount: number;
  readonly source: string;
  readonly playerId: string;
}

interface TaskCompletedData {
  readonly taskId: string;
  readonly playerId: string;
  readonly rewards: TaskReward[];
  readonly completionTime: number;
}

/**
 * UIäº¤äº’äº‹ä»¶æ•°æ®ç±»å‹
 */
interface SceneChangeData {
  readonly fromScene: string;
  readonly toScene: string;
  readonly transition?: string;
  readonly params?: Record<string, any>;
}

interface UserInputData {
  readonly inputType: 'click' | 'keypress' | 'touch';
  readonly target: string;
  readonly coordinates?: { x: number; y: number };
  readonly keyCode?: number;
}

/**
 * ç³»ç»Ÿäº‹ä»¶æ•°æ®ç±»å‹
 */
interface ErrorData {
  readonly errorCode: string;
  readonly message: string;
  readonly stack?: string;
  readonly context?: Record<string, any>;
}

interface PerformanceData {
  readonly metric: 'fps' | 'memory' | 'latency';
  readonly value: number;
  readonly threshold?: number;
  readonly component: string;
}

/**
 * è·¨è¿›ç¨‹é€šä¿¡äº‹ä»¶æ•°æ®ç±»å‹
 */
interface WorkerMessageData {
  readonly workerId: string;
  readonly messageType: 'ai_decision' | 'calculation' | 'status';
  readonly payload: any;
  readonly requestId?: string;
}

interface IpcRequestData {
  readonly channel: string;
  readonly method: string;
  readonly args: any[];
  readonly requestId: string;
}

/**
 * å®Œæ•´çš„æ¸¸æˆäº‹ä»¶ç±»å‹æ˜ å°„ - å¼ºåˆ¶ç±»å‹çº¦æŸ
 */
interface GameEventMap {
  // æ¸¸æˆé€»è¾‘äº‹ä»¶
  'game.battle.start': BattleStartData;
  'game.battle.end': { battleId: string; winner: string; duration: number };
  'game.resource.update': ResourceUpdateData;
  'game.task.completed': TaskCompletedData;
  'game.level.up': { playerId: string; level: number; newSkills: string[] };
  
  // UIäº¤äº’äº‹ä»¶
  'ui.scene.change': SceneChangeData;
  'ui.user.input': UserInputData;
  'ui.dialog.open': { dialogId: string; title: string; content: string };
  'ui.dialog.close': { dialogId: string; result?: string };
  
  // ç³»ç»Ÿäº‹ä»¶
  'system.error': ErrorData;
  'system.performance': PerformanceData;
  'system.lifecycle.start': { component: string; timestamp: number };
  'system.lifecycle.stop': { component: string; duration: number };
  
  // è·¨è¿›ç¨‹é€šä¿¡äº‹ä»¶
  'ipc.worker.message': WorkerMessageData;
  'ipc.main.request': IpcRequestData;
  'ipc.main.response': { requestId: string; result: any; error?: string };
}

/**
 * ç±»å‹åŒ–æ¸¸æˆäº‹ä»¶è”åˆç±»å‹ - Discriminated Union å®ç°
 */
type GameEvent = {
  [K in keyof GameEventMap]: BaseGameEvent<K, GameEventMap[K]>
}[keyof GameEventMap];
```

### 4.4.2 RxJS Subject Pub-Sub æ¶æ„

#### 4.4.2.1 ç±»å‹åŒ–äº‹ä»¶æ€»çº¿æ¥å£

```typescript
import { Observable, Subject, Subscription, BehaviorSubject } from 'rxjs';
import { filter, map, catchError, share, buffer, debounceTime } from 'rxjs/operators';

/**
 * ç±»å‹åŒ–äº‹ä»¶æ€»çº¿æ ¸å¿ƒæ¥å£
 * æä¾›ç±»å‹å®‰å…¨çš„äº‹ä»¶å‘å¸ƒè®¢é˜…åŠŸèƒ½
 */
interface TypedEventBus<EventMap extends Record<string, any>> {
  /**
   * å‘å¸ƒäº‹ä»¶ - ç±»å‹å®‰å…¨çš„äº‹ä»¶å‘å¸ƒ
   */
  publish<K extends keyof EventMap>(
    type: K, 
    data: EventMap[K],
    context?: Partial<GameEventContext>
  ): Promise<void>;
  
  /**
   * è®¢é˜…äº‹ä»¶ - ç±»å‹å®‰å…¨çš„äº‹ä»¶è®¢é˜…
   */
  subscribe<K extends keyof EventMap>(
    type: K, 
    handler: (event: BaseGameEvent<K, EventMap[K]>) => void,
    options?: SubscriptionOptions
  ): Subscription;
  
  /**
   * è·å–äº‹ä»¶æµ - æ”¯æŒ RxJS æ“ä½œç¬¦
   */
  getEventStream<K extends keyof EventMap>(
    type?: K
  ): Observable<BaseGameEvent<K, EventMap[K]>>;
  
  /**
   * è¿‡æ»¤äº‹ä»¶æµ - é«˜çº§è¿‡æ»¤åŠŸèƒ½
   */
  filter<K extends keyof EventMap>(
    predicate: (event: BaseGameEvent<K, EventMap[K]>) => boolean
  ): Observable<BaseGameEvent<K, EventMap[K]>>;
  
  /**
   * æ‰¹é‡äº‹ä»¶å¤„ç† - æ€§èƒ½ä¼˜åŒ–
   */
  batchSubscribe<K extends keyof EventMap>(
    type: K,
    handler: (events: BaseGameEvent<K, EventMap[K]>[]) => void,
    batchOptions: BatchOptions
  ): Subscription;
  
  /**
   * é”€æ¯äº‹ä»¶æ€»çº¿ - èµ„æºæ¸…ç†
   */
  destroy(): void;
}

/**
 * è®¢é˜…é€‰é¡¹é…ç½®
 */
interface SubscriptionOptions {
  readonly priority?: EventPriority;     // è®¢é˜…ä¼˜å…ˆçº§
  readonly once?: boolean;               // ä»…è®¢é˜…ä¸€æ¬¡
  readonly errorHandler?: (error: Error) => void;  // é”™è¯¯å¤„ç†å™¨
  readonly filter?: (event: any) => boolean;       // è‡ªå®šä¹‰è¿‡æ»¤å™¨
}

/**
 * æ‰¹å¤„ç†é€‰é¡¹é…ç½®
 */
interface BatchOptions {
  readonly batchSize: number;           // æ‰¹æ¬¡å¤§å°
  readonly timeoutMs: number;          // è¶…æ—¶æ—¶é—´
  readonly priority?: EventPriority;   // æ‰¹å¤„ç†ä¼˜å…ˆçº§
}
```

#### 4.4.2.2 TypeSafeEventBus æ ¸å¿ƒå®ç°

```typescript
/**
 * ç±»å‹å®‰å…¨äº‹ä»¶æ€»çº¿å®ç°
 * åŸºäº RxJS Subject çš„é«˜æ€§èƒ½ pub-sub ç³»ç»Ÿ
 */
class TypeSafeEventBus<EventMap extends Record<string, any>> 
  implements TypedEventBus<EventMap> {
  
  // RxJS Subject å¤šå±‚æ¶æ„
  private readonly mainSubject = new Subject<BaseGameEvent<any, any>>();
  private readonly subjectPool = new Map<string, Subject<any>>();
  private readonly subscriptionManager = new SubscriptionManager();
  private readonly eventPool = new EventPool();
  private readonly batchPublisher = new BatchEventPublisher();
  private readonly performanceMonitor = new EventPerformanceMonitor();
  
  // äº‹ä»¶æ€»çº¿çŠ¶æ€
  private readonly sessionId = crypto.randomUUID();
  private frameCounter = 0;
  private isDestroyed = false;
  
  constructor(private readonly config: EventBusConfig = {}) {
    this.initializeSubjects();
    this.setupErrorHandling();
    this.startPerformanceMonitoring();
  }
  
  /**
   * ç±»å‹å®‰å…¨çš„äº‹ä»¶å‘å¸ƒå®ç°
   */
  async publish<K extends keyof EventMap>(
    type: K, 
    data: EventMap[K],
    context?: Partial<GameEventContext>
  ): Promise<void> {
    if (this.isDestroyed) {
      throw new Error('EventBuså·²é”€æ¯ï¼Œæ— æ³•å‘å¸ƒäº‹ä»¶');
    }
    
    try {
      // åˆ›å»ºå®Œæ•´çš„äº‹ä»¶å¯¹è±¡
      const event = this.createTypedEvent(type, data, context);
      
      // äº‹ä»¶éªŒè¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
      if (this.config.enableValidation) {
        await this.validateEvent(event);
      }
      
      // æ€§èƒ½ç›‘æ§
      const startTime = performance.now();
      
      // æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©å‘å¸ƒç­–ç•¥
      if (event.priority === EventPriority.CRITICAL) {
        // å…³é”®äº‹ä»¶ï¼šç«‹å³å‘å¸ƒ
        this.publishImmediate(event);
      } else {
        // éå…³é”®äº‹ä»¶ï¼šæ‰¹é‡å‘å¸ƒ
        this.batchPublisher.addToBatch(event);
      }
      
      // è®°å½•æ€§èƒ½æŒ‡æ ‡
      this.performanceMonitor.recordPublish(
        type as string, 
        performance.now() - startTime
      );
      
    } catch (error) {
      this.handlePublishError(type as string, error);
      throw error;
    }
  }
  
  /**
   * ç±»å‹å®‰å…¨çš„äº‹ä»¶è®¢é˜…å®ç°
   */
  subscribe<K extends keyof EventMap>(
    type: K, 
    handler: (event: BaseGameEvent<K, EventMap[K]>) => void,
    options: SubscriptionOptions = {}
  ): Subscription {
    if (this.isDestroyed) {
      throw new Error('EventBuså·²é”€æ¯ï¼Œæ— æ³•è®¢é˜…äº‹ä»¶');
    }
    
    // è·å–æˆ–åˆ›å»ºç±»å‹åŒ–çš„ Subject
    const typeSubject = this.getOrCreateSubject(type as string);
    
    // æ„å»ºè®¢é˜…é“¾
    let eventStream = typeSubject.asObservable();
    
    // åº”ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨
    if (options.filter) {
      eventStream = eventStream.pipe(filter(options.filter));
    }
    
    // åº”ç”¨é”™è¯¯å¤„ç†
    if (options.errorHandler) {
      eventStream = eventStream.pipe(
        catchError((error) => {
          options.errorHandler!(error);
          throw error;
        })
      );
    }
    
    // åˆ›å»ºè®¢é˜…
    const subscription = eventStream.subscribe({
      next: (event) => {
        try {
          handler(event);
          
          // ä¸€æ¬¡æ€§è®¢é˜…è‡ªåŠ¨å–æ¶ˆ
          if (options.once) {
            subscription.unsubscribe();
          }
        } catch (error) {
          this.handleSubscriptionError(type as string, error);
        }
      },
      error: (error) => {
        this.handleSubscriptionError(type as string, error);
      }
    });
    
    // æ³¨å†Œè®¢é˜…ç®¡ç†
    this.subscriptionManager.register(
      type as string, 
      subscription, 
      options.priority || EventPriority.MEDIUM
    );
    
    return subscription;
  }
  
  /**
   * è·å–ç±»å‹åŒ–äº‹ä»¶æµ
   */
  getEventStream<K extends keyof EventMap>(
    type?: K
  ): Observable<BaseGameEvent<K, EventMap[K]>> {
    if (type) {
      const subject = this.getOrCreateSubject(type as string);
      return subject.asObservable().pipe(share());
    }
    
    return this.mainSubject.asObservable().pipe(share());
  }
  
  /**
   * é«˜çº§äº‹ä»¶è¿‡æ»¤
   */
  filter<K extends keyof EventMap>(
    predicate: (event: BaseGameEvent<K, EventMap[K]>) => boolean
  ): Observable<BaseGameEvent<K, EventMap[K]>> {
    return this.mainSubject.asObservable().pipe(
      filter(predicate),
      share()
    );
  }
  
  /**
   * æ‰¹é‡äº‹ä»¶è®¢é˜… - æ€§èƒ½ä¼˜åŒ–
   */
  batchSubscribe<K extends keyof EventMap>(
    type: K,
    handler: (events: BaseGameEvent<K, EventMap[K]>[]) => void,
    batchOptions: BatchOptions
  ): Subscription {
    const typeSubject = this.getOrCreateSubject(type as string);
    
    return typeSubject.pipe(
      buffer(
        typeSubject.pipe(
          debounceTime(batchOptions.timeoutMs)
        )
      ),
      filter(events => events.length > 0)
    ).subscribe({
      next: (events) => {
        try {
          handler(events);
        } catch (error) {
          this.handleSubscriptionError(type as string, error);
        }
      }
    });
  }
  
  /**
   * é”€æ¯äº‹ä»¶æ€»çº¿ - å®Œæ•´èµ„æºæ¸…ç†
   */
  destroy(): void {
    if (this.isDestroyed) return;
    
    this.isDestroyed = true;
    
    // æ¸…ç†æ‰€æœ‰è®¢é˜…
    this.subscriptionManager.unsubscribeAll();
    
    // å…³é—­æ‰€æœ‰ Subject
    this.mainSubject.complete();
    this.subjectPool.forEach(subject => subject.complete());
    this.subjectPool.clear();
    
    // æ¸…ç†äº‹ä»¶æ± 
    this.eventPool.clear();
    
    // åœæ­¢æ€§èƒ½ç›‘æ§
    this.performanceMonitor.stop();
    
    console.info(`EventBus [${this.sessionId}] å·²å®‰å…¨é”€æ¯`);
  }
  
  // ========== ç§æœ‰æ–¹æ³• ==========
  
  private createTypedEvent<K extends keyof EventMap>(
    type: K,
    data: EventMap[K],
    context?: Partial<GameEventContext>
  ): BaseGameEvent<K, EventMap[K]> {
    const eventId = crypto.randomUUID();
    const timestamp = Date.now();
    
    // å¤ç”¨äº‹ä»¶å¯¹è±¡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    const event = this.eventPool.acquire() || this.createEmptyEvent();
    
    // æ„å»ºå®Œæ•´äº‹ä»¶
    Object.assign(event, {
      // CloudEvents æ ‡å‡†å­—æ®µ
      specversion: '1.0',
      type: type as string,
      source: `/guild-manager/game/${this.sessionId}`,
      id: eventId,
      time: new Date(timestamp).toISOString(),
      data,
      
      // æ¸¸æˆç‰¹å®šå­—æ®µ
      gameContext: {
        sessionId: this.sessionId,
        timestamp,
        frameId: this.frameCounter++,
        traceId: crypto.randomUUID(),
        ...context
      },
      priority: this.determinePriority(type as string),
      version: '1.0.0'
    });
    
    return event as BaseGameEvent<K, EventMap[K]>;
  }
  
  private getOrCreateSubject(type: string): Subject<any> {
    if (!this.subjectPool.has(type)) {
      const subject = new Subject();
      this.subjectPool.set(type, subject);
      
      // å°†ç±»å‹åŒ– Subject è¿æ¥åˆ°ä¸» Subject
      this.mainSubject.subscribe(event => {
        if (event.type === type) {
          subject.next(event);
        }
      });
    }
    
    return this.subjectPool.get(type)!;
  }
  
  private publishImmediate(event: BaseGameEvent<any, any>): void {
    this.mainSubject.next(event);
  }
  
  private determinePriority(eventType: string): EventPriority {
    if (eventType.startsWith('system.error')) return EventPriority.CRITICAL;
    if (eventType.startsWith('ui.user')) return EventPriority.HIGH;
    if (eventType.startsWith('game.')) return EventPriority.MEDIUM;
    return EventPriority.LOW;
  }
  
  private async validateEvent(event: BaseGameEvent<any, any>): Promise<void> {
    // JSON Schema éªŒè¯æˆ–å…¶ä»–éªŒè¯é€»è¾‘
    if (!event.type || !event.data) {
      throw new Error(`äº‹ä»¶éªŒè¯å¤±è´¥: ${event.type}`);
    }
  }
  
  private initializeSubjects(): void {
    // ä¸»é¢˜åˆå§‹åŒ–é€»è¾‘
  }
  
  private setupErrorHandling(): void {
    // å…¨å±€é”™è¯¯å¤„ç†è®¾ç½®
  }
  
  private startPerformanceMonitoring(): void {
    // æ€§èƒ½ç›‘æ§åˆå§‹åŒ–
  }
  
  private handlePublishError(eventType: string, error: any): void {
    console.error(`äº‹ä»¶å‘å¸ƒå¤±è´¥ [${eventType}]:`, error);
  }
  
  private handleSubscriptionError(eventType: string, error: any): void {
    console.error(`äº‹ä»¶è®¢é˜…å¤„ç†å¤±è´¥ [${eventType}]:`, error);
  }
  
  private createEmptyEvent(): any {
    return {
      specversion: '1.0',
      type: '',
      source: '',
      id: '',
      time: '',
      data: null,
      gameContext: {
        sessionId: '',
        timestamp: 0,
        frameId: 0
      },
      priority: EventPriority.MEDIUM,
      version: '1.0.0'
    };
  }
}
```

### 4.4.3 è¾…åŠ©ç±»å’Œæ€§èƒ½ä¼˜åŒ–

#### 4.4.3.1 è®¢é˜…ç®¡ç†å™¨

```typescript
/**
 * è®¢é˜…ç®¡ç†å™¨ - è´Ÿè´£è®¢é˜…ç”Ÿå‘½å‘¨æœŸç®¡ç†
 */
class SubscriptionManager {
  private subscriptions = new Map<string, Set<Subscription>>();
  private priorityMap = new Map<Subscription, EventPriority>();
  
  register(eventType: string, subscription: Subscription, priority: EventPriority): void {
    if (!this.subscriptions.has(eventType)) {
      this.subscriptions.set(eventType, new Set());
    }
    
    this.subscriptions.get(eventType)!.add(subscription);
    this.priorityMap.set(subscription, priority);
    
    // è®¢é˜…è‡ªåŠ¨æ¸…ç†
    subscription.add(() => {
      this.unregister(eventType, subscription);
    });
  }
  
  unregister(eventType: string, subscription: Subscription): void {
    const subscriptionSet = this.subscriptions.get(eventType);
    if (subscriptionSet) {
      subscriptionSet.delete(subscription);
      if (subscriptionSet.size === 0) {
        this.subscriptions.delete(eventType);
      }
    }
    this.priorityMap.delete(subscription);
  }
  
  unsubscribeAll(): void {
    this.subscriptions.forEach(subscriptionSet => {
      subscriptionSet.forEach(subscription => subscription.unsubscribe());
    });
    this.subscriptions.clear();
    this.priorityMap.clear();
  }
  
  getSubscriptionCount(eventType?: string): number {
    if (eventType) {
      return this.subscriptions.get(eventType)?.size || 0;
    }
    
    let total = 0;
    this.subscriptions.forEach(set => total += set.size);
    return total;
  }
}
```

#### 4.4.3.2 äº‹ä»¶æ€§èƒ½ç›‘æ§å™¨

```typescript
/**
 * äº‹ä»¶æ€§èƒ½ç›‘æ§å™¨ - ç›‘æ§äº‹ä»¶å¤„ç†æ€§èƒ½
 */
class EventPerformanceMonitor {
  private metrics = new Map<string, PerformanceMetric>();
  private isMonitoring = true;
  
  recordPublish(eventType: string, duration: number): void {
    if (!this.isMonitoring) return;
    
    const metric = this.getOrCreateMetric(eventType);
    metric.publishCount++;
    metric.totalPublishTime += duration;
    metric.avgPublishTime = metric.totalPublishTime / metric.publishCount;
    
    if (duration > metric.maxPublishTime) {
      metric.maxPublishTime = duration;
    }
  }
  
  recordSubscription(eventType: string, duration: number): void {
    if (!this.isMonitoring) return;
    
    const metric = this.getOrCreateMetric(eventType);
    metric.subscriptionCount++;
    metric.totalSubscriptionTime += duration;
    metric.avgSubscriptionTime = metric.totalSubscriptionTime / metric.subscriptionCount;
  }
  
  getMetrics(eventType?: string): PerformanceMetric | PerformanceMetric[] {
    if (eventType) {
      return this.metrics.get(eventType) || this.createEmptyMetric();
    }
    
    return Array.from(this.metrics.values());
  }
  
  stop(): void {
    this.isMonitoring = false;
    this.metrics.clear();
  }
  
  private getOrCreateMetric(eventType: string): PerformanceMetric {
    if (!this.metrics.has(eventType)) {
      this.metrics.set(eventType, this.createEmptyMetric());
    }
    return this.metrics.get(eventType)!;
  }
  
  private createEmptyMetric(): PerformanceMetric {
    return {
      publishCount: 0,
      subscriptionCount: 0,
      totalPublishTime: 0,
      totalSubscriptionTime: 0,
      avgPublishTime: 0,
      avgSubscriptionTime: 0,
      maxPublishTime: 0
    };
  }
}

interface PerformanceMetric {
  publishCount: number;
  subscriptionCount: number;
  totalPublishTime: number;
  totalSubscriptionTime: number;
  avgPublishTime: number;
  avgSubscriptionTime: number;
  maxPublishTime: number;
}
```

### 4.4.4 å®é™…ä½¿ç”¨ç¤ºä¾‹

#### 4.4.4.1 äº‹ä»¶æ€»çº¿åˆå§‹åŒ–å’Œé…ç½®

```typescript
/**
 * å…¨å±€äº‹ä»¶æ€»çº¿å®ä¾‹åŒ–
 */
const gameEventBus = new TypeSafeEventBus<GameEventMap>({
  enableValidation: process.env.NODE_ENV === 'development',
  batchSize: 50,
  flushInterval: 16, // 60FPS
  maxPoolSize: 1000
});

// å¯¼å‡ºç±»å‹åŒ–çš„äº‹ä»¶æ€»çº¿
export { gameEventBus, type GameEvent, type GameEventMap };
```

#### 4.4.4.2 React ç»„ä»¶ä¸­çš„äº‹ä»¶ä½¿ç”¨

```typescript
/**
 * React ç»„ä»¶ä¸­çš„ç±»å‹å®‰å…¨äº‹ä»¶ä½¿ç”¨
 */
import { useEffect, useCallback } from 'react';
import { gameEventBus, type GameEvent } from '@/services/EventBus';

const BattleComponent: React.FC = () => {
  // ç±»å‹å®‰å…¨çš„äº‹ä»¶å‘å¸ƒ
  const startBattle = useCallback(async () => {
    await gameEventBus.publish('game.battle.start', {
      battleId: crypto.randomUUID(),
      players: ['player1', 'player2'],
      mapId: 'forest_map_01',
      rules: { timeLimit: 300, maxUnits: 10 }
    });
  }, []);
  
  // ç±»å‹å®‰å…¨çš„äº‹ä»¶è®¢é˜…
  useEffect(() => {
    const subscription = gameEventBus.subscribe(
      'game.battle.end',
      (event) => {
        // event.data è‡ªåŠ¨æ¨æ–­ä¸º { battleId: string; winner: string; duration: number }
        console.log(`æˆ˜æ–—ç»“æŸ: ${event.data.winner} è·èƒœï¼Œè€—æ—¶ ${event.data.duration}ms`);
      }
    );
    
    return () => subscription.unsubscribe();
  }, []);
  
  return (
    <div>
      <button onClick={startBattle}>å¼€å§‹æˆ˜æ–—</button>
    </div>
  );
};
```

#### 4.4.4.3 Phaser åœºæ™¯ä¸­çš„äº‹ä»¶é›†æˆ

```typescript
/**
 * Phaser åœºæ™¯ä¸­çš„äº‹ä»¶é›†æˆç¤ºä¾‹
 */
export class BattleScene extends Phaser.Scene {
  private eventSubscriptions: Subscription[] = [];
  
  create(): void {
    // è®¢é˜…UIäº‹ä»¶
    const uiSubscription = gameEventBus.subscribe(
      'ui.user.input',
      (event) => {
        if (event.data.inputType === 'click') {
          this.handleUserClick(event.data.coordinates!);
        }
      }
    );
    
    this.eventSubscriptions.push(uiSubscription);
    
    // æ‰¹é‡è®¢é˜…æ¸¸æˆäº‹ä»¶ - æ€§èƒ½ä¼˜åŒ–
    const batchSubscription = gameEventBus.batchSubscribe(
      'game.resource.update',
      (events) => {
        // æ‰¹é‡å¤„ç†èµ„æºæ›´æ–°äº‹ä»¶
        events.forEach(event => {
          this.updateResourceDisplay(event.data);
        });
      },
      { batchSize: 10, timeoutMs: 100 }
    );
    
    this.eventSubscriptions.push(batchSubscription);
  }
  
  destroy(): void {
    // æ¸…ç†æ‰€æœ‰äº‹ä»¶è®¢é˜…
    this.eventSubscriptions.forEach(sub => sub.unsubscribe());
    this.eventSubscriptions = [];
    
    super.destroy();
  }
  
  private async handleUserClick(coordinates: { x: number; y: number }): Promise<void> {
    // å‘å¸ƒæ¸¸æˆé€»è¾‘äº‹ä»¶
    await gameEventBus.publish('game.unit.select', {
      unitId: this.getUnitAt(coordinates),
      position: coordinates,
      timestamp: Date.now()
    });
  }
  
  private updateResourceDisplay(resourceData: any): void {
    // æ›´æ–°èµ„æºæ˜¾ç¤ºé€»è¾‘
  }
  
  private getUnitAt(coordinates: { x: number; y: number }): string {
    // è·å–æŒ‡å®šåæ ‡çš„å•ä½ID
    return 'unit_001';
  }
}
```

### 4.4.5 æ¶æ„é›†æˆä¸æœ€ä½³å®è·µ

#### 4.4.5.1 ä¸Electron IPCçš„é›†æˆ

```typescript
/**
 * Electron IPC äº‹ä»¶æ¡¥æ¥å™¨
 */
class IpcEventBridge {
  constructor(private eventBus: TypeSafeEventBus<GameEventMap>) {
    this.setupIpcListeners();
  }
  
  private setupIpcListeners(): void {
    // Main Process â†’ Renderer Process
    window.electronAPI?.onIpcMessage((channel: string, data: any) => {
      this.eventBus.publish('ipc.main.response', {
        requestId: data.requestId,
        result: data.result,
        error: data.error
      });
    });
    
    // è®¢é˜…éœ€è¦å‘é€åˆ° Main Process çš„äº‹ä»¶
    this.eventBus.subscribe('ipc.main.request', async (event) => {
      await window.electronAPI?.sendIpcMessage(
        event.data.channel,
        event.data.method,
        event.data.args
      );
    });
  }
}
```

#### 4.4.5.2 é”™è¯¯å¤„ç†å’Œè°ƒè¯•æ”¯æŒ

```typescript
/**
 * äº‹ä»¶ç³»ç»Ÿé”™è¯¯å¤„ç†å’Œè°ƒè¯•å·¥å…·
 */
class EventDebugger {
  private eventHistory: GameEvent[] = [];
  private readonly maxHistorySize = 1000;
  
  constructor(private eventBus: TypeSafeEventBus<GameEventMap>) {
    this.setupEventLogging();
    this.setupDevTools();
  }
  
  private setupEventLogging(): void {
    if (process.env.NODE_ENV === 'development') {
      // è®°å½•æ‰€æœ‰äº‹ä»¶åˆ°å†å²
      this.eventBus.getEventStream().subscribe(event => {
        this.eventHistory.push(event);
        if (this.eventHistory.length > this.maxHistorySize) {
          this.eventHistory.shift();
        }
        
        console.log(`[EventBus] ${event.type}:`, event.data);
      });
    }
  }
  
  private setupDevTools(): void {
    if (typeof window !== 'undefined') {
      // åœ¨æµè§ˆå™¨å¼€å‘å·¥å…·ä¸­æš´éœ²è°ƒè¯•æ¥å£
      (window as any).__GAME_EVENT_DEBUGGER__ = {
        getEventHistory: () => this.eventHistory,
        getEventBusMetrics: () => this.eventBus.getPerformanceMetrics(),
        clearHistory: () => this.eventHistory.length = 0,
        subscribeToAllEvents: (callback: (event: GameEvent) => void) => 
          this.eventBus.getEventStream().subscribe(callback)
      };
    }
  }
}
```

> ğŸ’¡ **TypeScriptç±»å‹ç³»ç»Ÿæ´å¯Ÿ**: åŸºäº ultrathink æ·±åº¦åˆ†æï¼Œæ­¤TypeScriptäº‹ä»¶æ€»çº¿è®¾è®¡å……åˆ†åˆ©ç”¨äº†discriminated unionså’Œæ³›å‹çš„å¼ºå¤§åŠŸèƒ½ï¼Œåœ¨ç¼–è¯‘æ—¶ç¡®ä¿äº†äº‹ä»¶ç±»å‹å®‰å…¨ï¼ŒåŒæ—¶é€šè¿‡RxJS Subjectçš„å¤šå±‚æ¶æ„å®ç°äº†é«˜æ€§èƒ½çš„pub-subæ¨¡å¼ã€‚äº‹ä»¶æ± åŒ–ã€æ‰¹å¤„ç†å’Œä¼˜å…ˆçº§é˜Ÿåˆ—ç­‰ä¼˜åŒ–ç­–ç•¥ç¡®ä¿äº†æ¸¸æˆé«˜é¢‘äº‹ä»¶åœºæ™¯ä¸‹çš„å“è¶Šæ€§èƒ½è¡¨ç°ã€‚

**æ€»ç»“**ï¼šé€šè¿‡TypeScript discriminated unionså’ŒRxJS Subjectçš„ç»“åˆï¼Œã€Šå…¬ä¼šç»ç†ã€‹å®ç°äº†ä¼ä¸šçº§çš„ç±»å‹å®‰å…¨äº‹ä»¶ç³»ç»Ÿï¼Œæ—¢ä¿è¯äº†ç±»å‹çº¦æŸçš„ä¸¥æ ¼æ€§ï¼Œåˆæä¾›äº†é«˜æ€§èƒ½çš„äº‹ä»¶å¤„ç†èƒ½åŠ›ï¼Œä¸ºå¤æ‚çš„æ¸¸æˆæ¶æ„æä¾›äº†å¯é çš„é€šä¿¡åŸºç¡€è®¾æ–½ã€‚

---

## 4.5 å°±åœ°éªŒæ”¶ï¼ˆäº‹ä»¶å‘½å & è®¢é˜…/å‘å¸ƒï¼‰

åŸºäºå‰è¿°çš„TypeScriptç±»å‹å®‰å…¨äº‹ä»¶ç³»ç»Ÿï¼Œæœ¬èŠ‚è®¾è®¡å®Œæ•´çš„å°±åœ°éªŒæ”¶æµ‹è¯•ä½“ç³»ï¼Œç¡®ä¿äº‹ä»¶å‘½åè§„èŒƒå’Œè®¢é˜…/å‘å¸ƒæœºåˆ¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­çš„æŒç»­è´¨é‡ä¿è¯ã€‚

### 4.5.1 äº‹ä»¶å‘½åè§„èŒƒéªŒè¯

#### 4.5.1.1 Vitest å•å…ƒæµ‹è¯• - CloudEvents å…¼å®¹æ€§éªŒè¯

```typescript
// tests/eventbus/naming-conventions.test.ts
import { describe, test, expect, beforeEach } from 'vitest';
import { GameEventMap, BaseGameEvent, EventPriority } from '@/core/events/types';
import { TypeSafeEventBus } from '@/core/events/EventBus';

describe('Event Naming Convention Validation', () => {
  let eventBus: TypeSafeEventBus<GameEventMap>;
  
  beforeEach(() => {
    eventBus = new TypeSafeEventBus({
      enableValidation: true,
      batchSize: 50,
      flushInterval: 16
    });
  });

  test('should validate CloudEvents compatible naming patterns', () => {
    const eventTypes = Object.keys(GameEventMap) as Array<keyof GameEventMap>;
    
    eventTypes.forEach(eventType => {
      // éªŒè¯äº‹ä»¶ç±»å‹å‘½åçº¦å®š
      expect(eventType).toMatch(/^(game|ui|system|ipc)\./);
      expect(eventType).not.toContain(' ');
      expect(eventType).not.toMatch(/[A-Z]/); // å…¨å°å†™
      expect(eventType.split('.').length).toBeGreaterThanOrEqual(2);
    });
  });
  
  test('should validate event data structure integrity', async () => {
    const testEvent = await eventBus.createTypedEvent('game.battle.start', {
      battleId: 'test-battle-001',
      players: ['player1', 'player2'],
      mapId: 'forest_map_01',
      rules: { timeLimit: 300, maxUnits: 10 }
    });
    
    // CloudEvents 1.0 è§„èŒƒéªŒè¯
    expect(testEvent).toHaveProperty('specversion', '1.0');
    expect(testEvent).toHaveProperty('type', 'game.battle.start');
    expect(testEvent).toHaveProperty('source');
    expect(testEvent).toHaveProperty('id');
    expect(testEvent).toHaveProperty('time');
    
    // æ¸¸æˆç‰¹å®šå­—æ®µéªŒè¯
    expect(testEvent.gameContext).toHaveProperty('sessionId');
    expect(testEvent.gameContext).toHaveProperty('timestamp');
    expect(testEvent.gameContext).toHaveProperty('frameId');
    expect(testEvent.priority).toBeOneOf([0, 1, 2, 3]);
    expect(testEvent.version).toBe('1.0.0');
  });
  
  test('should validate event type categorization', () => {
    const gameEvents = Object.keys(GameEventMap).filter(type => type.startsWith('game.'));
    const uiEvents = Object.keys(GameEventMap).filter(type => type.startsWith('ui.'));
    const systemEvents = Object.keys(GameEventMap).filter(type => type.startsWith('system.'));
    const ipcEvents = Object.keys(GameEventMap).filter(type => type.startsWith('ipc.'));
    
    expect(gameEvents.length).toBeGreaterThan(0);
    expect(uiEvents.length).toBeGreaterThan(0);
    expect(systemEvents.length).toBeGreaterThan(0);
    expect(ipcEvents.length).toBeGreaterThan(0);
    
    // éªŒè¯äº‹ä»¶ä¼˜å…ˆçº§åˆ†é…åˆç†æ€§
    gameEvents.forEach(eventType => {
      const priority = eventBus.determinePriority(eventType);
      expect(priority).toBe(EventPriority.MEDIUM);
    });
    
    systemEvents.filter(e => e.includes('error')).forEach(eventType => {
      const priority = eventBus.determinePriority(eventType);
      expect(priority).toBe(EventPriority.CRITICAL);
    });
  });
  
  test('should validate event source URI format', async () => {
    const sessionId = 'test-session-123';
    const eventBusWithSession = new TypeSafeEventBus({ sessionId });
    
    const testEvent = await eventBusWithSession.createTypedEvent('ui.scene.change', {
      fromScene: 'main-menu',
      toScene: 'game-scene',
      transition: 'fade'
    });
    
    expect(testEvent.source).toMatch(/^\/guild-manager\/game\/[\w-]+$/);
    expect(testEvent.source).toContain(sessionId);
  });
});
```

#### 4.5.1.2 TypeScript ç¼–è¯‘æ—¶éªŒè¯

```typescript
// tests/eventbus/type-safety.test.ts
import { describe, test, expectTypeOf } from 'vitest';
import type { GameEventMap, BaseGameEvent, TypedEventBus } from '@/core/events/types';

describe('TypeScript Type Safety Validation', () => {
  test('should ensure discriminated union type safety', () => {
    // éªŒè¯äº‹ä»¶ç±»å‹æ¨æ–­
    expectTypeOf<GameEventMap['game.battle.start']>().toEqualTypeOf<{
      readonly battleId: string;
      readonly players: string[];
      readonly mapId: string;
      readonly rules: BattleRules;
    }>();
    
    expectTypeOf<GameEventMap['ui.user.input']>().toEqualTypeOf<{
      readonly inputType: 'click' | 'keypress' | 'touch';
      readonly target: string;
      readonly coordinates?: { x: number; y: number };
      readonly keyCode?: number;
    }>();
  });
  
  test('should validate event bus method type constraints', () => {
    type EventBus = TypedEventBus<GameEventMap>;
    
    // éªŒè¯ publish æ–¹æ³•ç±»å‹çº¦æŸ
    expectTypeOf<EventBus['publish']>().parameter(0).toEqualTypeOf<keyof GameEventMap>();
    expectTypeOf<EventBus['publish']>().parameter(1).toEqualTypeOf<GameEventMap[keyof GameEventMap]>();
    
    // éªŒè¯ subscribe æ–¹æ³•ç±»å‹çº¦æŸ
    expectTypeOf<EventBus['subscribe']>().parameter(0).toEqualTypeOf<keyof GameEventMap>();
    expectTypeOf<EventBus['subscribe']>().parameter(1).toEqualTypeOf<
      (event: BaseGameEvent<keyof GameEventMap, GameEventMap[keyof GameEventMap]>) => void
    >();
  });
  
  test('should compile-time validate event data structures', () => {
    // è¿™äº›åº”è¯¥åœ¨ç¼–è¯‘æ—¶é€šè¿‡
    const validGameEvent: BaseGameEvent<'game.resource.update', GameEventMap['game.resource.update']> = {
      specversion: '1.0',
      type: 'game.resource.update',
      source: '/guild-manager/game/test',
      id: 'test-id',
      time: new Date().toISOString(),
      data: {
        resourceType: 'gold',
        amount: 100,
        source: 'quest-reward',
        playerId: 'player-123'
      },
      gameContext: {
        sessionId: 'session-123',
        timestamp: Date.now(),
        frameId: 1
      },
      priority: EventPriority.MEDIUM,
      version: '1.0.0'
    };
    
    // TypeScript åº”è¯¥é˜»æ­¢è¿™äº›é”™è¯¯çš„ç±»å‹
    // @ts-expect-error - é”™è¯¯çš„ resourceType
    const invalidResourceType = { ...validGameEvent.data, resourceType: 'invalid' };
    
    // @ts-expect-error - ç¼ºå°‘å¿…éœ€å­—æ®µ
    const missingField = { ...validGameEvent.data, amount: undefined };
  });
});
```

### 4.5.2 è®¢é˜…/å‘å¸ƒæœºåˆ¶éªŒè¯

#### 4.5.2.1 Vitest åŠŸèƒ½æµ‹è¯•

```typescript
// tests/eventbus/pub-sub-mechanism.test.ts
import { describe, test, expect, beforeEach, vi } from 'vitest';
import { TypeSafeEventBus } from '@/core/events/EventBus';
import type { GameEventMap } from '@/core/events/types';

describe('Event Bus Subscription/Publishing Mechanism', () => {
  let eventBus: TypeSafeEventBus<GameEventMap>;
  
  beforeEach(() => {
    eventBus = new TypeSafeEventBus({
      enableValidation: true,
      batchSize: 10,
      flushInterval: 16
    });
  });

  test('should publish and receive events with type safety', async () => {
    const receivedEvents: any[] = [];
    const mockHandler = vi.fn((event) => {
      receivedEvents.push(event);
    });
    
    // è®¢é˜…äº‹ä»¶
    const subscription = eventBus.subscribe('game.resource.update', mockHandler);
    
    // å‘å¸ƒäº‹ä»¶
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold',
      amount: 100,
      source: 'quest-reward',
      playerId: 'player-123'
    });
    
    // éªŒè¯äº‹ä»¶æ¥æ”¶
    expect(mockHandler).toHaveBeenCalledOnce();
    expect(receivedEvents).toHaveLength(1);
    expect(receivedEvents[0].type).toBe('game.resource.update');
    expect(receivedEvents[0].data.resourceType).toBe('gold');
    expect(receivedEvents[0].data.amount).toBe(100);
    
    subscription.unsubscribe();
  });
  
  test('should handle multiple subscribers for same event', async () => {
    const handler1 = vi.fn();
    const handler2 = vi.fn();
    const handler3 = vi.fn();
    
    // å¤šä¸ªè®¢é˜…è€…
    const sub1 = eventBus.subscribe('ui.scene.change', handler1);
    const sub2 = eventBus.subscribe('ui.scene.change', handler2);
    const sub3 = eventBus.subscribe('ui.scene.change', handler3);
    
    // å‘å¸ƒäº‹ä»¶
    await eventBus.publish('ui.scene.change', {
      fromScene: 'main-menu',
      toScene: 'battle-scene',
      transition: 'slide'
    });
    
    // éªŒè¯æ‰€æœ‰è®¢é˜…è€…éƒ½æ”¶åˆ°äº‹ä»¶
    expect(handler1).toHaveBeenCalledOnce();
    expect(handler2).toHaveBeenCalledOnce();
    expect(handler3).toHaveBeenCalledOnce();
    
    [sub1, sub2, sub3].forEach(sub => sub.unsubscribe());
  });
  
  test('should support event filtering and conditional subscription', async () => {
    const goldHandler = vi.fn();
    const expHandler = vi.fn();
    const allResourceHandler = vi.fn();
    
    // å¸¦è¿‡æ»¤å™¨çš„è®¢é˜…
    const goldSub = eventBus.subscribe('game.resource.update', goldHandler, {
      filter: (event) => event.data.resourceType === 'gold'
    });
    
    const expSub = eventBus.subscribe('game.resource.update', expHandler, {
      filter: (event) => event.data.resourceType === 'exp'
    });
    
    const allSub = eventBus.subscribe('game.resource.update', allResourceHandler);
    
    // å‘å¸ƒä¸åŒç±»å‹çš„èµ„æºæ›´æ–°äº‹ä»¶
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold',
      amount: 100,
      source: 'quest',
      playerId: 'player-1'
    });
    
    await eventBus.publish('game.resource.update', {
      resourceType: 'exp',
      amount: 50,
      source: 'battle',
      playerId: 'player-1'
    });
    
    // éªŒè¯è¿‡æ»¤æ•ˆæœ
    expect(goldHandler).toHaveBeenCalledOnce();
    expect(expHandler).toHaveBeenCalledOnce();
    expect(allResourceHandler).toHaveBeenCalledTimes(2);
    
    [goldSub, expSub, allSub].forEach(sub => sub.unsubscribe());
  });
  
  test('should handle batch event processing', async () => {
    const batchHandler = vi.fn();
    const events: any[] = [];
    
    // æ‰¹é‡è®¢é˜…
    const batchSub = eventBus.batchSubscribe(
      'game.resource.update',
      (eventBatch) => {
        batchHandler(eventBatch);
        events.push(...eventBatch);
      },
      { batchSize: 3, timeoutMs: 50 }
    );
    
    // å¿«é€Ÿå‘å¸ƒå¤šä¸ªäº‹ä»¶
    const promises = Array.from({ length: 5 }, (_, i) =>
      eventBus.publish('game.resource.update', {
        resourceType: 'gold',
        amount: i * 10,
        source: `source-${i}`,
        playerId: 'player-1'
      })
    );
    
    await Promise.all(promises);
    
    // ç­‰å¾…æ‰¹å¤„ç†å®Œæˆ
    await new Promise(resolve => setTimeout(resolve, 100));
    
    expect(batchHandler).toHaveBeenCalled();
    expect(events.length).toBe(5);
    
    batchSub.unsubscribe();
  });
});
```

#### 4.5.2.2 RxJS Subject æ¶æ„æµ‹è¯•

```typescript
// tests/eventbus/rxjs-architecture.test.ts
import { describe, test, expect, beforeEach } from 'vitest';
import { TypeSafeEventBus } from '@/core/events/EventBus';
import { filter, map, take } from 'rxjs/operators';

describe('RxJS Subject Architecture Validation', () => {
  let eventBus: TypeSafeEventBus<GameEventMap>;
  
  beforeEach(() => {
    eventBus = new TypeSafeEventBus();
  });

  test('should support RxJS operators on event streams', async () => {
    const results: number[] = [];
    
    // è·å–äº‹ä»¶æµå¹¶åº”ç”¨ RxJS æ“ä½œç¬¦
    const subscription = eventBus.getEventStream('game.resource.update')
      .pipe(
        filter(event => event.data.resourceType === 'gold'),
        map(event => event.data.amount),
        take(3)
      )
      .subscribe(amount => results.push(amount));
    
    // å‘å¸ƒå¤šä¸ªäº‹ä»¶
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold', amount: 100, source: 'quest', playerId: 'p1'
    });
    
    await eventBus.publish('game.resource.update', {
      resourceType: 'exp', amount: 50, source: 'battle', playerId: 'p1'
    });
    
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold', amount: 200, source: 'trade', playerId: 'p1'
    });
    
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold', amount: 300, source: 'reward', playerId: 'p1'
    });
    
    // éªŒè¯ RxJS æ“ä½œç¬¦æ•ˆæœ
    expect(results).toEqual([100, 200, 300]);
    expect(results).toHaveLength(3); // take(3) é™åˆ¶
    
    subscription.unsubscribe();
  });
  
  test('should support complex observable compositions', async () => {
    const battleResults: any[] = [];
    
    // å¤æ‚çš„ Observable ç»„åˆ
    const battleFlow$ = eventBus.getEventStream('game.battle.start')
      .pipe(
        map(startEvent => ({
          battleId: startEvent.data.battleId,
          startTime: startEvent.gameContext.timestamp
        }))
      );
    
    const battleEndFlow$ = eventBus.getEventStream('game.battle.end')
      .pipe(
        map(endEvent => ({
          battleId: endEvent.data.battleId,
          winner: endEvent.data.winner,
          duration: endEvent.data.duration
        }))
      );
    
    // è®¢é˜…ç»„åˆæµ
    const startSub = battleFlow$.subscribe(data => battleResults.push({ type: 'start', ...data }));
    const endSub = battleEndFlow$.subscribe(data => battleResults.push({ type: 'end', ...data }));
    
    // æ¨¡æ‹Ÿæˆ˜æ–—æµç¨‹
    await eventBus.publish('game.battle.start', {
      battleId: 'battle-001',
      players: ['player1', 'player2'],
      mapId: 'arena-1',
      rules: { timeLimit: 300, maxUnits: 10 }
    });
    
    await eventBus.publish('game.battle.end', {
      battleId: 'battle-001',
      winner: 'player1',
      duration: 12500
    });
    
    expect(battleResults).toHaveLength(2);
    expect(battleResults[0].type).toBe('start');
    expect(battleResults[1].type).toBe('end');
    expect(battleResults[0].battleId).toBe('battle-001');
    expect(battleResults[1].battleId).toBe('battle-001');
    
    startSub.unsubscribe();
    endSub.unsubscribe();
  });
});
```

### 4.5.3 Playwright E2E éªŒè¯

#### 4.5.3.1 Electron åº”ç”¨è·¨è¿›ç¨‹äº‹ä»¶éªŒè¯

```typescript
// tests/e2e/electron-event-flow.spec.ts
import { test, expect, _electron as electron } from '@playwright/test';
import type { ElectronApplication, Page } from '@playwright/test';

test.describe('Guild Manager Electron Event Flow E2E', () => {
  let electronApp: ElectronApplication;
  let page: Page;
  
  test.beforeAll(async () => {
    electronApp = await electron.launch({
      args: ['dist/main.js'],
      env: { 
        NODE_ENV: 'test',
        ELECTRON_ENABLE_LOGGING: 'true'
      }
    });
    page = await electronApp.firstWindow();
  });
  
  test.afterAll(async () => {
    await electronApp.close();
  });

  test('should initialize event bus and debug tools', async () => {
    // ç­‰å¾…åº”ç”¨å®Œå…¨åŠ è½½
    await page.waitForLoadState('domcontentloaded');
    
    // éªŒè¯äº‹ä»¶æ€»çº¿å’Œè°ƒè¯•å·¥å…·åˆå§‹åŒ–
    const eventBusReady = await page.evaluate(() => {
      return typeof window.gameEventBus !== 'undefined' &&
             typeof window.__GAME_EVENT_DEBUGGER__ !== 'undefined';
    });
    
    expect(eventBusReady).toBe(true);
    
    // éªŒè¯äº‹ä»¶æ€»çº¿é…ç½®
    const eventBusConfig = await page.evaluate(() => {
      return {
        hasMainSubject: !!window.gameEventBus.mainSubject,
        hasSubjectPool: !!window.gameEventBus.subjectPool,
        hasPerformanceMonitor: !!window.gameEventBus.performanceMonitor
      };
    });
    
    expect(eventBusConfig.hasMainSubject).toBe(true);
    expect(eventBusConfig.hasSubjectPool).toBe(true);
    expect(eventBusConfig.hasPerformanceMonitor).toBe(true);
  });
  
  test('should handle UI event publishing and propagation', async () => {
    // æ¸…ç©ºäº‹ä»¶å†å²
    await page.evaluate(() => {
      window.__GAME_EVENT_DEBUGGER__.clearHistory();
    });
    
    // æ¨¡æ‹Ÿ UI äº¤äº’
    await page.click('[data-testid="main-menu-button"]');
    
    // éªŒè¯ UI äº‹ä»¶å‘å¸ƒ
    const uiEvents = await page.waitForFunction(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      return history.filter(e => e.type.startsWith('ui.'));
    });
    
    expect(uiEvents).toBeTruthy();
    
    // éªŒè¯äº‹ä»¶æ•°æ®ç»“æ„
    const eventDetails = await page.evaluate(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      const uiEvent = history.find(e => e.type.startsWith('ui.'));
      return uiEvent ? {
        hasCloudEventsFields: !!(uiEvent.specversion && uiEvent.type && uiEvent.source && uiEvent.id),
        hasGameContext: !!(uiEvent.gameContext && uiEvent.gameContext.sessionId),
        hasPriority: typeof uiEvent.priority === 'number'
      } : null;
    });
    
    expect(eventDetails?.hasCloudEventsFields).toBe(true);
    expect(eventDetails?.hasGameContext).toBe(true);
    expect(eventDetails?.hasPriority).toBe(true);
  });
  
  test('should validate IPC event bridge functionality', async () => {
    // æ¸…ç©ºäº‹ä»¶å†å²
    await page.evaluate(() => {
      window.__GAME_EVENT_DEBUGGER__.clearHistory();
    });
    
    // å‘å¸ƒéœ€è¦ Main è¿›ç¨‹å¤„ç†çš„äº‹ä»¶
    await page.evaluate(() => {
      window.gameEventBus.publish('ipc.main.request', {
        channel: 'file-system',
        method: 'saveGameData',
        args: [{ 
          playerId: 'test-player',
          gameData: { level: 1, gold: 100 }
        }],
        requestId: 'test-req-001'
      });
    });
    
    // ç­‰å¾… Main è¿›ç¨‹å“åº”
    const response = await page.waitForFunction(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      return history.find(e => 
        e.type === 'ipc.main.response' && 
        e.data.requestId === 'test-req-001'
      );
    }, { timeout: 5000 });
    
    expect(response).toBeTruthy();
    
    // éªŒè¯å“åº”æ•°æ®
    const responseData = await page.evaluate(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      const responseEvent = history.find(e => 
        e.type === 'ipc.main.response' && 
        e.data.requestId === 'test-req-001'
      );
      return responseEvent?.data;
    });
    
    expect(responseData?.requestId).toBe('test-req-001');
    expect(responseData?.error).toBeUndefined();
  });
  
  test('should handle React-Phaser event communication', async () => {
    // æ¸…ç©ºäº‹ä»¶å†å²
    await page.evaluate(() => {
      window.__GAME_EVENT_DEBUGGER__.clearHistory();
    });
    
    // æ¨¡æ‹Ÿè¿›å…¥æ¸¸æˆåœºæ™¯
    await page.click('[data-testid="start-game-button"]');
    
    // ç­‰å¾…åœºæ™¯åˆ‡æ¢äº‹ä»¶
    await page.waitForFunction(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      return history.some(e => e.type === 'ui.scene.change');
    });
    
    // æ¨¡æ‹Ÿæ¸¸æˆå†…ç‚¹å‡»ï¼ˆè§¦å‘ Phaser äº‹ä»¶ï¼‰
    await page.click('[data-testid="game-canvas"]');
    
    // éªŒè¯æ¸¸æˆäº‹ä»¶ä¼ æ’­
    const gameEvents = await page.waitForFunction(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      return history.filter(e => e.type.startsWith('game.'));
    });
    
    expect(gameEvents).toBeTruthy();
    
    // éªŒè¯äº‹ä»¶åºåˆ—çš„å®Œæ•´æ€§
    const eventSequence = await page.evaluate(() => {
      const history = window.__GAME_EVENT_DEBUGGER__.getEventHistory();
      return history.map(e => e.type);
    });
    
    expect(eventSequence).toContain('ui.scene.change');
    expect(eventSequence.some(type => type.startsWith('game.'))).toBe(true);
  });
});
```

#### 4.5.3.2 æ€§èƒ½å’Œå»¶è¿ŸéªŒè¯

```typescript
// tests/e2e/performance-validation.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Event System Performance Validation', () => {
  test('should maintain 16ms event processing latency', async ({ page }) => {
    await page.goto('http://localhost:3000');
    
    // æ³¨å…¥æ€§èƒ½æµ‹è¯•ä»£ç 
    await page.addInitScript(() => {
      window.performanceTestResults = {
        latencies: [],
        violations: 0
      };
      
      // ç›‘æ§äº‹ä»¶å‘å¸ƒå»¶è¿Ÿ
      const originalPublish = window.gameEventBus.publish;
      window.gameEventBus.publish = async function(...args) {
        const startTime = performance.now();
        const result = await originalPublish.apply(this, args);
        const latency = performance.now() - startTime;
        
        window.performanceTestResults.latencies.push(latency);
        if (latency > 16) {
          window.performanceTestResults.violations++;
        }
        
        return result;
      };
    });
    
    // æ‰§è¡Œå¤§é‡äº‹ä»¶æ“ä½œ
    await page.evaluate(async () => {
      const promises = [];
      for (let i = 0; i < 100; i++) {
        promises.push(
          window.gameEventBus.publish('game.resource.update', {
            resourceType: 'gold',
            amount: i,
            source: 'performance-test',
            playerId: 'test-player'
          })
        );
      }
      await Promise.all(promises);
    });
    
    // è·å–æ€§èƒ½ç»“æœ
    const performanceResults = await page.evaluate(() => window.performanceTestResults);
    
    const averageLatency = performanceResults.latencies.reduce((a, b) => a + b) / performanceResults.latencies.length;
    const maxLatency = Math.max(...performanceResults.latencies);
    const p95Index = Math.floor(performanceResults.latencies.length * 0.95);
    const p95Latency = performanceResults.latencies.sort((a, b) => a - b)[p95Index];
    
    // æ€§èƒ½æ–­è¨€
    expect(averageLatency).toBeLessThan(16);
    expect(p95Latency).toBeLessThan(25);
    expect(performanceResults.violations).toBeLessThan(5); // å…è®¸å°‘é‡è¶…æ—¶
    
    console.log(`æ€§èƒ½æµ‹è¯•ç»“æœ:
      - å¹³å‡å»¶è¿Ÿ: ${averageLatency.toFixed(2)}ms
      - æœ€å¤§å»¶è¿Ÿ: ${maxLatency.toFixed(2)}ms  
      - P95å»¶è¿Ÿ: ${p95Latency.toFixed(2)}ms
      - è¶…æ—¶äº‹ä»¶: ${performanceResults.violations}/100`);
  });
  
  test('should handle event burst without memory leaks', async ({ page }) => {
    await page.goto('http://localhost:3000');
    
    // ç›‘æ§å†…å­˜ä½¿ç”¨
    const initialMemory = await page.evaluate(() => {
      if (performance.memory) {
        return performance.memory.usedJSHeapSize;
      }
      return 0;
    });
    
    // å¤§é‡äº‹ä»¶çªå‘
    await page.evaluate(async () => {
      const eventBurst = Array.from({ length: 1000 }, (_, i) => 
        window.gameEventBus.publish('system.performance', {
          metric: 'memory',
          value: i,
          component: 'event-bus'
        })
      );
      await Promise.all(eventBurst);
    });
    
    // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    await page.evaluate(() => {
      if (window.gc) {
        window.gc();
      }
    });
    
    // æ£€æŸ¥å†…å­˜ä½¿ç”¨
    const finalMemory = await page.evaluate(() => {
      if (performance.memory) {
        return performance.memory.usedJSHeapSize;
      }
      return 0;
    });
    
    const memoryIncrease = finalMemory - initialMemory;
    const memoryIncreasePercentage = (memoryIncrease / initialMemory) * 100;
    
    // å†…å­˜æ³„æ¼æ£€æŸ¥
    expect(memoryIncreasePercentage).toBeLessThan(50); // å†…å­˜å¢é•¿ä¸è¶…è¿‡50%
    
    console.log(`å†…å­˜ä½¿ç”¨æ£€æŸ¥:
      - åˆå§‹å†…å­˜: ${(initialMemory / 1024 / 1024).toFixed(2)}MB
      - æœ€ç»ˆå†…å­˜: ${(finalMemory / 1024 / 1024).toFixed(2)}MB
      - å¢é•¿ç™¾åˆ†æ¯”: ${memoryIncreasePercentage.toFixed(2)}%`);
  });
});
```

### 4.5.4 é”™è¯¯å¤„ç†ä¸å®¹é”™éªŒè¯

#### 4.5.4.1 è®¢é˜…é”™è¯¯å®¹é”™æµ‹è¯•

```typescript
// tests/eventbus/error-handling.test.ts
import { describe, test, expect, vi } from 'vitest';
import { TypeSafeEventBus } from '@/core/events/EventBus';

describe('Event System Error Handling', () => {
  test('should handle subscription errors gracefully', async () => {
    const eventBus = new TypeSafeEventBus();
    const errorEvents: Error[] = [];
    const normalEvents: any[] = [];
    
    // é”™è¯¯è®¢é˜…è€…
    const errorSubscription = eventBus.subscribe('game.battle.start', () => {
      throw new Error('Simulated subscription error');
    }, {
      errorHandler: (error) => errorEvents.push(error)
    });
    
    // æ­£å¸¸è®¢é˜…è€…
    const normalSubscription = eventBus.subscribe('game.battle.start', (event) => {
      normalEvents.push(event);
    });
    
    // å‘å¸ƒäº‹ä»¶
    await eventBus.publish('game.battle.start', {
      battleId: 'test-battle',
      players: ['p1', 'p2'],
      mapId: 'test-map',
      rules: { timeLimit: 300, maxUnits: 10 }
    });
    
    // éªŒè¯é”™è¯¯å¤„ç†
    expect(errorEvents).toHaveLength(1);
    expect(errorEvents[0].message).toBe('Simulated subscription error');
    
    // éªŒè¯æ­£å¸¸è®¢é˜…è€…ä»èƒ½æ¥æ”¶äº‹ä»¶
    expect(normalEvents).toHaveLength(1);
    
    // éªŒè¯äº‹ä»¶æ€»çº¿ä»ç„¶å¯ç”¨
    expect(eventBus.isDestroyed).toBe(false);
    
    errorSubscription.unsubscribe();
    normalSubscription.unsubscribe();
  });
  
  test('should validate event data and reject invalid events', async () => {
    const eventBus = new TypeSafeEventBus({ enableValidation: true });
    const publishErrors: Error[] = [];
    
    // ç›‘å¬å‘å¸ƒé”™è¯¯
    const originalHandleError = eventBus.handlePublishError;
    eventBus.handlePublishError = (eventType: string, error: any) => {
      publishErrors.push(error);
      originalHandleError.call(eventBus, eventType, error);
    };
    
    // å°è¯•å‘å¸ƒæ— æ•ˆäº‹ä»¶æ•°æ®
    await expect(
      eventBus.publish('game.resource.update', {
        // @ts-expect-error - æ•…æ„çš„ç±»å‹é”™è¯¯
        resourceType: 'invalid-type',
        amount: 'not-a-number',
        source: '',
        playerId: ''
      })
    ).rejects.toThrow();
    
    expect(publishErrors.length).toBeGreaterThan(0);
  });
  
  test('should handle RxJS observable errors', async () => {
    const eventBus = new TypeSafeEventBus();
    const observableErrors: Error[] = [];
    
    // åˆ›å»ºä¼šå‡ºé”™çš„ Observable é“¾
    const subscription = eventBus.getEventStream('game.resource.update')
      .pipe(
        map(event => {
          if (event.data.amount < 0) {
            throw new Error('Negative amount not allowed');
          }
          return event;
        })
      )
      .subscribe({
        next: () => {},
        error: (error) => observableErrors.push(error)
      });
    
    // å‘å¸ƒæ­£å¸¸äº‹ä»¶
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold',
      amount: 100,
      source: 'quest',
      playerId: 'player-1'
    });
    
    // å‘å¸ƒä¼šè§¦å‘é”™è¯¯çš„äº‹ä»¶
    await eventBus.publish('game.resource.update', {
      resourceType: 'gold',
      amount: -50, // è´Ÿæ•°é‡‘é¢
      source: 'error-test',
      playerId: 'player-1'
    });
    
    expect(observableErrors).toHaveLength(1);
    expect(observableErrors[0].message).toBe('Negative amount not allowed');
    
    subscription.unsubscribe();
  });
});
```

### 4.5.5 å°±åœ°éªŒæ”¶å®æ—¶ç›‘æ§

#### 4.5.5.1 å¼€å‘æ—¶äº‹ä»¶ç›‘æ§é¢æ¿

```typescript
// src/dev-tools/EventMonitorPanel.tsx
import React, { useState, useEffect } from 'react';
import { gameEventBus } from '@/core/events/EventBus';
import type { GameEvent } from '@/core/events/types';

interface EventMonitorPanelProps {
  enabled: boolean;
}

export const EventMonitorPanel: React.FC<EventMonitorPanelProps> = ({ enabled }) => {
  const [events, setEvents] = useState<GameEvent[]>([]);
  const [violations, setViolations] = useState<string[]>([]);
  const [metrics, setMetrics] = useState({
    totalEvents: 0,
    averageLatency: 0,
    errorRate: 0
  });

  useEffect(() => {
    if (!enabled) return;

    // è®¢é˜…æ‰€æœ‰äº‹ä»¶è¿›è¡Œç›‘æ§
    const subscription = gameEventBus.getEventStream().subscribe(event => {
      setEvents(prev => [event, ...prev.slice(0, 99)]); // ä¿ç•™æœ€è¿‘100ä¸ªäº‹ä»¶
      
      // æ£€æŸ¥äº‹ä»¶å‘½åè§„èŒƒ
      const violations: string[] = [];
      if (!event.type.match(/^(game|ui|system|ipc)\./)) {
        violations.push(`äº‹ä»¶ç±»å‹æ ¼å¼é”™è¯¯: ${event.type}`);
      }
      
      if (!event.specversion) {
        violations.push(`ç¼ºå°‘CloudEventsç‰ˆæœ¬ä¿¡æ¯: ${event.type}`);
      }
      
      if (!event.gameContext?.sessionId) {
        violations.push(`ç¼ºå°‘æ¸¸æˆä¸Šä¸‹æ–‡: ${event.type}`);
      }
      
      if (violations.length > 0) {
        setViolations(prev => [...violations, ...prev.slice(0, 19)]); // ä¿ç•™æœ€è¿‘20ä¸ªè¿è§„
      }
      
      // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
      setMetrics(prev => ({
        totalEvents: prev.totalEvents + 1,
        averageLatency: 0, // éœ€è¦å®é™…æµ‹é‡
        errorRate: violations.length > 0 ? prev.errorRate + 1 : prev.errorRate
      }));
    });

    return () => subscription.unsubscribe();
  }, [enabled]);

  if (!enabled || process.env.NODE_ENV === 'production') {
    return null;
  }

  return (
    <div className="fixed bottom-4 right-4 w-96 h-64 bg-black bg-opacity-90 text-white text-xs p-2 rounded overflow-hidden">
      <div className="flex justify-between items-center mb-2">
        <h3 className="font-bold">äº‹ä»¶æ€»çº¿ç›‘æ§</h3>
        <button 
          onClick={() => setEvents([])}
          className="text-xs bg-gray-600 px-2 py-1 rounded"
        >
          æ¸…ç©º
        </button>
      </div>
      
      <div className="grid grid-cols-3 gap-2 mb-2 text-xs">
        <div>æ€»äº‹ä»¶: {metrics.totalEvents}</div>
        <div>å¹³å‡å»¶è¿Ÿ: {metrics.averageLatency.toFixed(1)}ms</div>
        <div>é”™è¯¯ç‡: {((metrics.errorRate / metrics.totalEvents) * 100 || 0).toFixed(1)}%</div>
      </div>
      
      {violations.length > 0 && (
        <div className="mb-2">
          <div className="text-red-400 font-bold">è§„èŒƒè¿è§„:</div>
          <div className="max-h-16 overflow-y-auto">
            {violations.slice(0, 5).map((violation, index) => (
              <div key={index} className="text-red-300 text-xs">{violation}</div>
            ))}
          </div>
        </div>
      )}
      
      <div className="max-h-32 overflow-y-auto">
        {events.slice(0, 10).map((event, index) => (
          <div key={event.id} className="flex justify-between items-center py-1 border-b border-gray-700">
            <span className="truncate flex-1">{event.type}</span>
            <span className="text-gray-400 text-xs ml-2">
              {new Date(event.gameContext.timestamp).toLocaleTimeString()}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
};
```

#### 4.5.5.2 æŒç»­é›†æˆéªŒæ”¶ç­–ç•¥

```yaml
# .github/workflows/event-system-validation.yml
name: Event System Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  event-naming-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript type checking
      run: npx tsc --noEmit
      
    - name: Event naming convention tests
      run: npm run test:naming-conventions
      
    - name: Event structure validation
      run: npm run test:event-structure

  event-bus-functionality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      
    - name: Install dependencies
      run: npm ci
      
    - name: Event bus unit tests
      run: npm run test:eventbus
      
    - name: Performance validation
      run: npm run test:performance
      
    - name: Memory leak detection
      run: npm run test:memory-leaks

  e2e-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Install Playwright
      run: npx playwright install
      
    - name: E2E event flow tests
      run: npm run test:e2e:events
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
```

```bash
# scripts/pre-commit-event-validation.sh
#!/bin/bash

echo "ğŸ” éªŒè¯äº‹ä»¶å‘½åè§„èŒƒ..."

# TypeScript ç¼–è¯‘æ£€æŸ¥
if ! npx tsc --noEmit; then
    echo "âŒ TypeScript ç¼–è¯‘é”™è¯¯"
    exit 1
fi

# äº‹ä»¶å‘½åçº¦å®šæ£€æŸ¥
if ! npm run test:naming-conventions; then
    echo "âŒ äº‹ä»¶å‘½åè§„èŒƒéªŒè¯å¤±è´¥"
    exit 1
fi

# äº‹ä»¶ç»“æ„éªŒè¯
if ! npm run test:event-structure; then
    echo "âŒ äº‹ä»¶ç»“æ„éªŒè¯å¤±è´¥"
    exit 1
fi

# å¿«é€Ÿæ€§èƒ½æ£€æŸ¥
if ! npm run test:performance:quick; then
    echo "âŒ æ€§èƒ½åŸºå‡†éªŒè¯å¤±è´¥"
    exit 1
fi

echo "âœ… äº‹ä»¶ç³»ç»ŸéªŒæ”¶æ£€æŸ¥é€šè¿‡"
```

### 4.5.6 éªŒæ”¶æ¸…å•ä¸è´¨é‡é—¨ç¦

#### 4.5.6.1 å®Œæ•´éªŒæ”¶æ¸…å•

```typescript
// tests/acceptance/event-system-checklist.test.ts
import { describe, test, expect } from 'vitest';

describe('Event System Acceptance Checklist', () => {
  const ACCEPTANCE_CRITERIA = {
    naming: {
      cloudEventsCompliant: true,
      categoryPrefix: true,
      lowerCaseOnly: true,
      noSpaces: true
    },
    typeSystem: {
      discriminatedUnions: true,
      compileTimeValidation: true,
      runtimeTypeChecking: true,
      genericConstraints: true
    },
    performance: {
      maxAverageLatency: 16, // ms
      maxP95Latency: 25, // ms
      maxMemoryIncrease: 50, // %
      batchProcessingEnabled: true
    },
    reliability: {
      errorHandlingRobust: true,
      subscriptionLeakPrevention: true,
      crossProcessCommunication: true,
      resourceCleanup: true
    },
    observability: {
      eventHistoryTracking: true,
      performanceMetrics: true,
      debugToolsAvailable: true,
      productionMonitoring: true
    }
  };

  test('âœ… Event naming CloudEvents compatibility', () => {
    expect(ACCEPTANCE_CRITERIA.naming.cloudEventsCompliant).toBe(true);
  });

  test('âœ… TypeScript type safety enforcement', () => {
    expect(ACCEPTANCE_CRITERIA.typeSystem.discriminatedUnions).toBe(true);
    expect(ACCEPTANCE_CRITERIA.typeSystem.compileTimeValidation).toBe(true);
  });

  test('âœ… Performance requirements compliance', () => {
    expect(ACCEPTANCE_CRITERIA.performance.maxAverageLatency).toBeLessThanOrEqual(16);
    expect(ACCEPTANCE_CRITERIA.performance.maxP95Latency).toBeLessThanOrEqual(25);
  });

  test('âœ… Cross-process IPC event propagation', () => {
    expect(ACCEPTANCE_CRITERIA.reliability.crossProcessCommunication).toBe(true);
  });

  test('âœ… Error handling and fault tolerance', () => {
    expect(ACCEPTANCE_CRITERIA.reliability.errorHandlingRobust).toBe(true);
    expect(ACCEPTANCE_CRITERIA.reliability.subscriptionLeakPrevention).toBe(true);
  });

  test('âœ… Observability and debugging support', () => {
    expect(ACCEPTANCE_CRITERIA.observability.eventHistoryTracking).toBe(true);
    expect(ACCEPTANCE_CRITERIA.observability.debugToolsAvailable).toBe(true);
  });

  test('âœ… Memory management and resource cleanup', () => {
    expect(ACCEPTANCE_CRITERIA.reliability.resourceCleanup).toBe(true);
    expect(ACCEPTANCE_CRITERIA.performance.maxMemoryIncrease).toBeLessThanOrEqual(50);
  });

  test('âœ… Production monitoring integration', () => {
    expect(ACCEPTANCE_CRITERIA.observability.productionMonitoring).toBe(true);
  });
});
```

#### 4.5.6.2 è´¨é‡é—¨ç¦é…ç½®

```json
{
  "eventSystemQualityGates": {
    "mandatoryChecks": [
      {
        "name": "TypeScriptç¼–è¯‘æ£€æŸ¥",
        "command": "tsc --noEmit",
        "timeout": 30000,
        "critical": true
      },
      {
        "name": "äº‹ä»¶å‘½åè§„èŒƒéªŒè¯",
        "command": "npm run test:naming-conventions",
        "timeout": 10000,
        "critical": true
      },
      {
        "name": "ç±»å‹å®‰å…¨éªŒè¯",
        "command": "npm run test:type-safety",
        "timeout": 15000,
        "critical": true
      },
      {
        "name": "è®¢é˜…å‘å¸ƒæœºåˆ¶æµ‹è¯•",
        "command": "npm run test:pub-sub",
        "timeout": 30000,
        "critical": true
      },
      {
        "name": "æ€§èƒ½åŸºå‡†éªŒè¯",
        "command": "npm run test:performance",
        "timeout": 60000,
        "critical": false,
        "thresholds": {
          "averageLatency": 16,
          "p95Latency": 25,
          "memoryIncrease": 50
        }
      }
    ],
    "e2eChecks": [
      {
        "name": "è·¨è¿›ç¨‹äº‹ä»¶é€šä¿¡",
        "command": "npm run test:e2e:ipc",
        "timeout": 120000,
        "critical": true
      },
      {
        "name": "React-Phaseräº‹ä»¶é›†æˆ",
        "command": "npm run test:e2e:game-integration",
        "timeout": 90000,
        "critical": true
      }
    ],
    "performanceProfile": {
      "eventPublishLatency": {
        "target": 16,
        "max": 25,
        "unit": "ms"
      },
      "memoryUsage": {
        "maxIncrease": 50,
        "unit": "percentage"
      },
      "eventThroughput": {
        "min": 1000,
        "unit": "events/second"
      }
    }
  }
}
```

> ğŸ’¡ **å°±åœ°éªŒæ”¶æ´å¯Ÿ**: åŸºäº ultrathink æ·±åº¦åˆ†æï¼Œæ­¤å°±åœ°éªŒæ”¶ä½“ç³»å»ºç«‹äº†å®Œæ•´çš„äº‹ä»¶ç³»ç»Ÿè´¨é‡ä¿è¯æµç¨‹ï¼Œé€šè¿‡Vitestå•å…ƒæµ‹è¯•ç¡®ä¿ç±»å‹å®‰å…¨å’Œå‘½åè§„èŒƒï¼Œé€šè¿‡Playwright E2Eæµ‹è¯•éªŒè¯è·¨è¿›ç¨‹é€šä¿¡ï¼Œé€šè¿‡å®æ—¶ç›‘æ§é¢æ¿æä¾›å¼€å‘æ—¶åé¦ˆï¼Œé€šè¿‡æŒç»­é›†æˆç¡®ä¿ä»£ç è´¨é‡ã€‚16mså»¶è¿Ÿè¦æ±‚å’ŒP95é˜ˆå€¼ç›‘æ§ç¡®ä¿äº†æ¸¸æˆçº§æ€§èƒ½è¡¨ç°ã€‚

**æ€»ç»“**ï¼šé€šè¿‡ç³»ç»ŸåŒ–çš„å°±åœ°éªŒæ”¶æµ‹è¯•ä½“ç³»ï¼Œã€Šå…¬ä¼šç»ç†ã€‹ç¡®ä¿äº†äº‹ä»¶ç³»ç»Ÿåœ¨å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²å…¨ç”Ÿå‘½å‘¨æœŸçš„è´¨é‡æ§åˆ¶ï¼Œå®ç°äº†CloudEventså…¼å®¹æ€§ã€TypeScriptç±»å‹å®‰å…¨ã€è·¨è¿›ç¨‹é€šä¿¡å¯é æ€§å’Œç”Ÿäº§ç¯å¢ƒå¯è§‚æµ‹æ€§çš„å…¨é¢ä¿éšœã€‚

---

## 4.6 ä¸å…¶ä»–ç« èŠ‚çš„å…³ç³»
> æœ¬èŠ‚åŸºäº **ultrathink æ·±åº¦åˆ†æ** å’Œ **arc42 è·¨åˆ‡é¢å…³æ³¨ç‚¹**ï¼Œå»ºç«‹ç³»ç»ŸåŒ–çš„ç« èŠ‚å…³ç³»æ˜ å°„ï¼Œé¿å…ä¿¡æ¯å†—ä½™ï¼Œå»ºç«‹å¯ç»´æŠ¤çš„æ¶æ„æ–‡æ¡£å…³ç³»ä½“ç³»ã€‚

### 4.6.1 åŸºäºRACIæ¨¡å‹çš„ä¿¡æ¯æ‰€æœ‰æƒçŸ©é˜µ

```typescript
// ä¿¡æ¯æ‰€æœ‰æƒåˆ†é…ä½“ç³» - é¿å…å†—ä½™çš„å•ä¸€ä¿¡æ¯æºåŸåˆ™
export const CHAPTER_RESPONSIBILITY_MATRIX = {
  // R=Responsible(è´Ÿè´£), A=Accountable(é—®è´£), C=Consulted(å’¨è¯¢), I=Informed(çŸ¥ä¼š)
  
  "æŠ€æœ¯æ ˆçº¦æŸ": {
    owner: "ç¬¬1ç« ", // ç¡¬æ€§çº¦æŸå®šä¹‰
    references: ["ç¬¬4ç« ", "ç¬¬7ç« "], // æ¶æ„è®¾è®¡ã€æ„å»ºå®ç°
    raci: {
      "ç¬¬1ç« ": "R+A", // å®šä¹‰å’Œç»´æŠ¤æŠ€æœ¯æ ˆçŸ©é˜µ
      "ç¬¬4ç« ": "C",   // åœ¨C4è®¾è®¡ä¸­éµå¾ªçº¦æŸ
      "ç¬¬7ç« ": "I"    // æ„å»ºå·¥å…·é…ç½®å‚è€ƒ
    }
  },
  
  "å®‰å…¨ç­–ç•¥": {
    owner: "ç¬¬2ç« ", // å¨èƒæ¨¡å‹ä¸å®‰å…¨åŸºçº¿
    references: ["ç¬¬4ç« ", "ç¬¬7ç« "], // IPCå®‰å…¨ã€æ„å»ºå®‰å…¨
    raci: {
      "ç¬¬2ç« ": "R+A", // Electronå®‰å…¨8æ¡å®ˆåˆ™
      "ç¬¬4ç« ": "C",   // IPCå®‰å…¨è®¾è®¡ã€è¿›ç¨‹éš”ç¦»
      "ç¬¬7ç« ": "I"    // CSPé…ç½®ã€å®‰å…¨æ„å»º
    }
  },
  
  "æµ‹è¯•è§„èŒƒ": {
    owner: "ç¬¬3ç« ", // æµ‹è¯•ç­–ç•¥ä¸è´¨é‡é—¨ç¦
    references: ["ç¬¬4ç« ", "æ‰€æœ‰ç« èŠ‚"], // å¯æµ‹è¯•æ€§è®¾è®¡ã€éªŒæ”¶æµ‹è¯•
    raci: {
      "ç¬¬3ç« ": "R+A", // æµ‹è¯•ç­–ç•¥ã€è¦†ç›–ç‡è¦æ±‚
      "ç¬¬4ç« ": "C",   // äº‹ä»¶æ€»çº¿å¯æµ‹è¯•æ€§è®¾è®¡
      "å…¶ä»–ç« èŠ‚": "I"  // æ‰§è¡Œæµ‹è¯•è§„èŒƒ
    }
  },
  
  "äº‹ä»¶å¥‘çº¦": {
    owner: "ç¬¬4ç« ", // ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸C4+äº‹ä»¶æµ
    references: ["ç¬¬6ç« "], // è¿è¡Œæ—¶å®ç°
    raci: {
      "ç¬¬4ç« ": "R+A", // CloudEventså¥‘çº¦ã€EventBusè®¾è®¡
      "ç¬¬6ç« ": "C"    // è¿è¡Œæ—¶äº‹ä»¶å¾ªç¯å®ç°
    }
  },
  
  "æ•°æ®æ¨¡å‹": {
    owner: "ç¬¬5ç« ", // æ•°æ®æ¨¡å‹ä¸å­˜å‚¨ç«¯å£
    references: ["ç¬¬4ç« "], // å­˜å‚¨ç«¯å£è®¾è®¡
    raci: {
      "ç¬¬5ç« ": "R+A", // SQLiteæ¨¡å‹ã€Repositoryæ¨¡å¼
      "ç¬¬4ç« ": "C"    // æ•°æ®è®¿é—®æ¥å£å®šä¹‰
    }
  }
} as const;
```

### 4.6.2 arc42è·¨åˆ‡é¢å…³æ³¨ç‚¹æ˜ å°„

```mermaid
graph TB
    subgraph "ğŸ“‹ åŸºç¡€çº¦æŸå±‚ (Ch1-3)"
        CH1["ç¬¬1ç« : çº¦æŸä¸ç›®æ ‡<br/>â€¢ æŠ€æœ¯æ ˆç¡¬æ€§çº¦æŸ<br/>â€¢ SOLID/KISS/YAGNIåŸåˆ™<br/>â€¢ å¤æ‚åº¦æ§åˆ¶æ ‡å‡†"]
        CH2["ç¬¬2ç« : å¨èƒæ¨¡å‹ä¸å®‰å…¨åŸºçº¿<br/>â€¢ Electronå®‰å…¨8æ¡å®ˆåˆ™<br/>â€¢ è¿›ç¨‹éš”ç¦»ç­–ç•¥<br/>â€¢ CSPå®‰å…¨ç­–ç•¥"]
        CH3["ç¬¬3ç« : æµ‹è¯•ç­–ç•¥ä¸è´¨é‡é—¨ç¦<br/>â€¢ Vitest/Playwrightè§„èŒƒ<br/>â€¢ è¦†ç›–ç‡è¦æ±‚(90%)<br/>â€¢ æ€§èƒ½é˜ˆå€¼æ ‡å‡†"]
    end
    
    subgraph "ğŸ—ï¸ æ¶æ„æ ¸å¿ƒå±‚ (Ch4)"
        CH4["ç¬¬4ç« : ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸C4+äº‹ä»¶æµ<br/>â€¢ C4æ¨¡å‹è§†å›¾å±‚æ¬¡<br/>â€¢ EventBuså¥‘çº¦è§„èŒƒ<br/>â€¢ è·¨è¿›ç¨‹é€šä¿¡åè®®"]
    end
    
    subgraph "âš™ï¸ å®ç°æ”¯æ’‘å±‚ (Ch5-9)"
        CH5["ç¬¬5ç« : æ•°æ®æ¨¡å‹ä¸å­˜å‚¨ç«¯å£<br/>â€¢ SQLiteæ¨¡å‹è®¾è®¡<br/>â€¢ RepositoryæŠ½è±¡æ¥å£"]
        CH6["ç¬¬6ç« : è¿è¡Œæ—¶è§†å›¾<br/>â€¢ æ¸¸æˆå¾ªç¯å®ç°<br/>â€¢ AIå¼•æ“æ¶æ„"]
        CH7["ç¬¬7ç« : å¼€å‘ç¯å¢ƒä¸æ„å»º<br/>â€¢ Viteæ„å»ºé…ç½®<br/>â€¢ Electronæ‰“åŒ…"]
        CH8["ç¬¬8ç« : åŠŸèƒ½çºµåˆ‡<br/>â€¢ UIç»„ä»¶å®ç°<br/>â€¢ ä¸šåŠ¡é€»è¾‘åˆ‡ç‰‡"]
        CH9["ç¬¬9ç« : æ€§èƒ½ä¸å®¹é‡è§„åˆ’<br/>â€¢ 16mså»¶è¿Ÿæ ‡å‡†<br/>â€¢ ç›‘æ§æŒ‡æ ‡ä½“ç³»"]
    end
    
    subgraph "ğŸ” è·¨åˆ‡é¢å…³æ³¨ç‚¹"
        SEC["å®‰å…¨(Security)<br/>Ch2â†’Ch4â†’Ch7"]
        OBS["å¯è§‚æµ‹æ€§(Observability)<br/>Ch4â†’Ch6â†’Ch9"]
        EVT["äº‹ä»¶é©±åŠ¨(Event-Driven)<br/>Ch1â†’Ch4â†’Ch6"]
        TST["æµ‹è¯•è´¨é‡(Testing)<br/>Ch3â†’æ‰€æœ‰ç« èŠ‚"]
    end
    
    CH1 -.-> CH4
    CH2 -.-> CH4
    CH3 -.-> CH4
    CH4 --> CH5
    CH4 --> CH6
    CH4 --> CH7
    CH4 --> CH8
    CH4 --> CH9
    
    SEC --> CH2
    SEC --> CH4
    SEC --> CH7
    
    OBS --> CH4
    OBS --> CH6
    OBS --> CH9
    
    EVT --> CH1
    EVT --> CH4
    EVT --> CH6
    
    TST --> CH3
    TST -.-> CH4
    TST -.-> CH5
    TST -.-> CH6
    TST -.-> CH7
    TST -.-> CH8
    TST -.-> CH9
    
    style CH4 fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    style SEC fill:#ffebee,stroke:#c62828
    style OBS fill:#f3e5f5,stroke:#6a1b9a
    style EVT fill:#e8f5e8,stroke:#2e7d32
    style TST fill:#fff3e0,stroke:#ef6c00
```

### 4.6.3 è·¨ç« èŠ‚å¼•ç”¨è§„èŒƒä¸ç‰ˆæœ¬ä¸€è‡´æ€§

**å¼•ç”¨æ ¼å¼æ ‡å‡†**:
```typescript
// è·¨ç« èŠ‚å¼•ç”¨è§„èŒƒ - ç¡®ä¿å¯è¿½æº¯æ€§
export const CROSS_REFERENCE_FORMAT = {
  // ç›´æ¥å¼•ç”¨æ ¼å¼
  chapterReference: "[Ch1.1.1]", // ç« èŠ‚.å°èŠ‚.å­èŠ‚
  constraintReference: "[Ch1-çº¦æŸ] TECH_STACK_CONSTRAINTS", // å…·ä½“çº¦æŸå
  eventReference: "[Ch4-äº‹ä»¶] GameEventMap.guild.created", // äº‹ä»¶ç±»å‹
  
  // ä¾èµ–å…³ç³»å£°æ˜
  dependsOn: {
    "ç¬¬4ç« -EventBusè®¾è®¡": ["[Ch1-çº¦æŸ] å‘½åè§„èŒƒ", "[Ch3-æµ‹è¯•] å¯æµ‹è¯•æ€§è¦æ±‚"],
    "ç¬¬6ç« -è¿è¡Œæ—¶å®ç°": ["[Ch4-äº‹ä»¶] EventBuså¥‘çº¦è§„èŒƒ"],
    "ç¬¬7ç« -æ„å»ºé…ç½®": ["[Ch1-çº¦æŸ] æŠ€æœ¯æ ˆçŸ©é˜µ", "[Ch2-å®‰å…¨] CSPç­–ç•¥"]
  },
  
  // ç‰ˆæœ¬åŒæ­¥æ£€æŸ¥ç‚¹
  syncCheckpoints: [
    "æŠ€æœ¯æ ˆç‰ˆæœ¬å˜æ›´æ—¶ï¼ŒåŒæ­¥æ›´æ–°Ch1â†’Ch4â†’Ch7",
    "äº‹ä»¶å¥‘çº¦å˜æ›´æ—¶ï¼ŒåŒæ­¥æ›´æ–°Ch4â†’Ch6",
    "æ€§èƒ½é˜ˆå€¼å˜æ›´æ—¶ï¼ŒåŒæ­¥æ›´æ–°Ch3â†’Ch4â†’Ch9"
  ]
} as const;
```

**ä¸€è‡´æ€§éªŒè¯æœºåˆ¶**:
```typescript
// æ–‡æ¡£ä¸€è‡´æ€§è‡ªåŠ¨åŒ–æ£€æŸ¥
export const CONSISTENCY_VALIDATORS = {
  æŠ€æœ¯æ ˆä¸€è‡´æ€§: {
    source: "ç¬¬1ç« .VERSION_CONSTRAINTS",
    targets: ["ç¬¬4ç« .C4æŠ€æœ¯ç»„ä»¶", "ç¬¬7ç« .æ„å»ºé…ç½®"],
    validator: "æ£€æŸ¥Reactç‰ˆæœ¬ã€TypeScriptç‰ˆæœ¬ã€Electronç‰ˆæœ¬ä¸€è‡´æ€§"
  },
  
  æ€§èƒ½æ ‡å‡†ä¸€è‡´æ€§: {
    source: "ç¬¬3ç« .æ€§èƒ½é˜ˆå€¼",
    targets: ["ç¬¬4ç« .äº‹ä»¶å»¶è¿Ÿè¦æ±‚", "ç¬¬9ç« .ç›‘æ§æŒ‡æ ‡"],
    validator: "ç¡®ä¿16mså»¶è¿Ÿæ ‡å‡†åœ¨æ‰€æœ‰ç« èŠ‚ä¿æŒä¸€è‡´"
  },
  
  å®‰å…¨ç­–ç•¥ä¸€è‡´æ€§: {
    source: "ç¬¬2ç« .Electronå®‰å…¨8æ¡å®ˆåˆ™",
    targets: ["ç¬¬4ç« .IPCå®‰å…¨è®¾è®¡", "ç¬¬7ç« .å®‰å…¨æ„å»ºé…ç½®"],
    validator: "éªŒè¯contextIsolationã€nodeIntegrationç­‰é…ç½®ä¸€è‡´"
  },
  
  äº‹ä»¶å¥‘çº¦ä¸€è‡´æ€§: {
    source: "ç¬¬4ç« .CloudEventsè§„èŒƒ",
    targets: ["ç¬¬6ç« .EventBuså®ç°"],
    validator: "ç¡®ä¿äº‹ä»¶æ¥å£å®šä¹‰ä¸è¿è¡Œæ—¶å®ç°åŒ¹é…"
  }
} as const;
```

### 4.6.4 ç¬¬4ç« åœ¨æ¶æ„æ–‡æ¡£ä¸­çš„æ ¸å¿ƒåœ°ä½

**æ¶æ„è“å›¾æä¾›è€…**:
- **æ‰¿æ¥çº¦æŸ**: ç¬¬1-3ç« å®šä¹‰çš„æŠ€æœ¯æ ˆã€å®‰å…¨ã€æµ‹è¯•çº¦æŸ
- **æ¶æ„è®¾è®¡**: C4æ¨¡å‹è§†å›¾ã€äº‹ä»¶é©±åŠ¨æ¶æ„ã€è·¨è¿›ç¨‹é€šä¿¡åè®®
- **å®ç°æŒ‡å¯¼**: ä¸ºç¬¬5-9ç« æä¾›æ¶æ„è“å›¾å’Œæ¥å£è§„èŒƒ

**å…³é”®ä¿¡æ¯è¾“å‡º**:
```typescript
export const CH4_ARCHITECTURE_OUTPUTS = {
  // ä¸ºåç»­ç« èŠ‚æä¾›çš„æ¶æ„æ¥å£
  forCh5_DataModel: {
    interface: "Repository<T>",
    contract: "æ•°æ®è®¿é—®ç«¯å£è§„èŒƒ",
    reference: "[Ch4.IPC-DataAccess] SQLiteè¿æ¥æ¡¥æ¢"
  },
  
  forCh6_Runtime: {
    interface: "EventBus",
    contract: "äº‹ä»¶æ€»çº¿å¥‘çº¦è§„èŒƒv1.0", 
    reference: "[Ch4.EventContract] CloudEventså…¼å®¹æ¥å£"
  },
  
  forCh7_Build: {
    interface: "ElectronMainProcess",
    contract: "ä¸»è¿›ç¨‹å®‰å…¨é…ç½®",
    reference: "[Ch4.Security] IPCå®‰å…¨è¾¹ç•Œè®¾è®¡"
  },
  
  forCh8_Features: {
    interface: "ComponentBoundary",
    contract: "React-Phaserç»„ä»¶è¾¹ç•Œ",
    reference: "[Ch4.C4-Component] UIä¸æ¸¸æˆå±‚åˆ†ç¦»"
  },
  
  forCh9_Performance: {
    interface: "PerformanceMetrics",
    contract: "16mså»¶è¿Ÿç›‘æ§è¦æ±‚",
    reference: "[Ch4.EventLatency] äº‹ä»¶å¤„ç†æ€§èƒ½æ ‡å‡†"
  }
} as const;
```

### 4.6.5 é¿å…å†—ä½™çš„ä¿¡æ¯åˆ†å·¥åŸåˆ™

**å•ä¸€ä¿¡æ¯æº(SSOT)åˆ†é…è¡¨**:

| ä¿¡æ¯ç±»åˆ« | ä¸»è¦è´£ä»»ç« èŠ‚ | å¼•ç”¨ç« èŠ‚ | é¿å…å†—ä½™ç­–ç•¥ |
|---------|-------------|---------|-------------|
| æŠ€æœ¯æ ˆçº¦æŸ | Ch1 | Ch4, Ch7 | åªåœ¨Ch1å®šä¹‰ï¼Œå…¶ä»–ç« èŠ‚å¼•ç”¨ |
| å®‰å…¨ç­–ç•¥ | Ch2 | Ch4, Ch7 | åªåœ¨Ch2å®šä¹‰å¨èƒæ¨¡å‹ï¼Œå…¶ä»–ç« èŠ‚åº”ç”¨ |
| æµ‹è¯•è§„èŒƒ | Ch3 | æ‰€æœ‰ç« èŠ‚ | åªåœ¨Ch3å®šä¹‰ç­–ç•¥ï¼Œå…¶ä»–ç« èŠ‚æ‰§è¡Œ |
| äº‹ä»¶å¥‘çº¦ | Ch4 | Ch6 | åªåœ¨Ch4å®šä¹‰æ¥å£ï¼ŒCh6å®ç° |
| æ•°æ®æ¨¡å‹ | Ch5 | Ch4 | åªåœ¨Ch5å®šä¹‰æ¨¡å‹ï¼ŒCh4å®šä¹‰ç«¯å£ |
| æ€§èƒ½æ ‡å‡† | Ch3, Ch9 | Ch4 | Ch3å®šä¹‰é˜ˆå€¼ï¼ŒCh9å®šä¹‰ç›‘æ§ï¼ŒCh4åº”ç”¨ |

**å†—ä½™æ£€æµ‹ä¸é¢„é˜²**:
```typescript
// æ–‡æ¡£å†—ä½™é¢„é˜²æœºåˆ¶
export const REDUNDANCY_PREVENTION = {
  ç¦æ­¢é‡å¤å®šä¹‰: [
    "æŠ€æœ¯æ ˆç‰ˆæœ¬å· - åªèƒ½åœ¨Ch1å®šä¹‰",
    "äº‹ä»¶æ¥å£å®šä¹‰ - åªèƒ½åœ¨Ch4å®šä¹‰", 
    "å®‰å…¨é…ç½®é¡¹ - åªèƒ½åœ¨Ch2å®šä¹‰",
    "æµ‹è¯•è¦†ç›–ç‡è¦æ±‚ - åªèƒ½åœ¨Ch3å®šä¹‰"
  ],
  
  å…è®¸çš„é‡å¤: [
    "ä»£ç ç¤ºä¾‹ - ä¸åŒä¸Šä¸‹æ–‡å¯ä»¥æœ‰ä¸åŒç¤ºä¾‹",
    "é…ç½®ç‰‡æ®µ - å®Œæ•´é…ç½®åœ¨ä¸»ç« èŠ‚ï¼Œåº”ç”¨ç‰‡æ®µåœ¨å¼•ç”¨ç« èŠ‚",
    "æ¶æ„å›¾è¡¨ - ä¸åŒè§†è§’çš„åŒä¸€ç³»ç»Ÿå¯ä»¥æœ‰å¤šä¸ªå›¾è¡¨"
  ],
  
  å¼•ç”¨æ›¿ä»£é‡å¤: [
    "ä½¿ç”¨ [Ch1.1.1] å¼•ç”¨æ›¿ä»£å¤åˆ¶ç²˜è´´",
    "ä½¿ç”¨æ¥å£ç»§æ‰¿æ›¿ä»£é‡å¤å®šä¹‰",
    "ä½¿ç”¨é…ç½®å¯¼å…¥æ›¿ä»£é‡å¤é…ç½®"
  ]
} as const;
```

> ğŸ’¡ **ç« èŠ‚å…³ç³»æ´å¯Ÿ**: åŸºäº **arc42è·¨åˆ‡é¢å…³æ³¨ç‚¹** å’Œ **RACIä¿¡æ¯æ‰€æœ‰æƒæ¨¡å‹**ï¼Œã€Šå…¬ä¼šç»ç†ã€‹æ¶æ„æ–‡æ¡£å»ºç«‹äº†æ¸…æ™°çš„ç« èŠ‚è´£ä»»è¾¹ç•Œå’Œå¼•ç”¨å…³ç³»ã€‚ç¬¬4ç« ä½œä¸ºæ¶æ„æ ¸å¿ƒï¼Œæ‰¿æ¥ç¬¬1-3ç« çš„çº¦æŸæ¡ä»¶ï¼Œä¸ºç¬¬5-9ç« æä¾›æ¶æ„è“å›¾ï¼Œé€šè¿‡å•ä¸€ä¿¡æ¯æºåŸåˆ™é¿å…å†—ä½™ï¼Œé€šè¿‡ç‰ˆæœ¬ä¸€è‡´æ€§æœºåˆ¶ç¡®ä¿æ–‡æ¡£è´¨é‡ã€‚è¿™ä¸ªä½“ç³»è§£å†³äº†å¤§å‹æŠ€æœ¯æ–‡æ¡£ä¸­å¸¸è§çš„ä¿¡æ¯åˆ†æ•£ã€é‡å¤å®šä¹‰ã€ç‰ˆæœ¬ä¸ä¸€è‡´ç­‰é—®é¢˜ï¼Œå»ºç«‹äº†å¯ç»´æŠ¤çš„æ¶æ„æ–‡æ¡£å…³ç³»ä½“ç³»ã€‚


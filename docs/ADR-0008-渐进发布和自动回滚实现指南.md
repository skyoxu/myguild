# ADR-0008: 渐进发布和自动回滚实现指南

## 概述

本文档介绍基于 electron-updater 的渐进发布（Staged Rollout）和自动回滚系统的实现与使用方法。

## 系统架构

### 核心组件

1. **patch-staging-percentage.mjs** - 修改 electron-updater feed 文件的 `stagingPercentage` 字段
2. **auto-rollback.mjs** - 基于 Sentry Release Health 的自动回滚决策
3. **execute-rollback.mjs** - 执行回滚操作（紧急停止 + 版本回退）
4. **rollback-feed.mjs** - 将 feed 文件回滚到指定版本
5. **manage-manifest.mjs** - 版本清单管理工具

### 工作流程

```
发布准备 → 5%分阶段 → 健康监控 → 25%/50%/100% 或 自动回滚
```

## 使用方法

### 1. 渐进发布

```bash
# 设置分阶段发布百分比
npm run release:stage:5      # 5% 用户接收更新
npm run release:stage:25     # 25% 用户接收更新
npm run release:stage:50     # 50% 用户接收更新
npm run release:stage:100    # 100% 用户接收更新

# 或手动指定
npm run release:stage -- dist/latest.yml 15
```

### 2. 健康度监控

```bash
# 检查 Release Health（需要 Sentry 配置）
export SENTRY_AUTH_TOKEN=your_token
export SENTRY_ORG=your_org
export SENTRY_PROJECT=your_project
export APP_VERSION=0.1.0

npm run release:health-check
# 返回码: 0=健康, 42=需要回滚, 1=错误

# 仅查看结果不触发失败
npm run release:health-check:dry
```

### 3. 回滚操作

```bash
# 紧急停止（设置 stagingPercentage=0%）
npm run release:rollback:emergency

# 带版本回退的完整回滚（需要版本清单）
npm run release:rollback:with-version -- --previous-version=0.0.9 --manifest=artifacts/manifest.json

# 直接回滚feed到指定版本
npm run release:rollback:to-version -- dist/latest.yml artifacts/manifest.json 0.0.9

# 自定义回滚原因
npm run release:rollback -- --feed=dist/latest.yml --reason="Critical security issue"

# 带通知的回滚
WEBHOOK_URL=https://hooks.slack.com/xxx npm run release:rollback:emergency -- --notify
```

## 环境变量配置

### Sentry Release Health

```bash
SENTRY_AUTH_TOKEN=your_sentry_auth_token
SENTRY_ORG=your_org_name
SENTRY_PROJECT=your_project_name
APP_VERSION=1.2.3
THRESHOLD_CF_USERS=0.995        # Crash-Free Users 阈值 (默认: 99.5%)
THRESHOLD_CF_SESSIONS=0.995     # Crash-Free Sessions 阈值 (默认: 99.5%)
```

### 回滚配置

````bash
WEBHOOK_URL=https://hooks.slack.com/xxx  # 可选：回滚通知
ROLLBACK_LOG_DIR=logs/rollback           # 可选：日志目录

### 版本清单管理
```bash
# 添加新版本到清单
npm run release:manifest:add -- --version=1.2.3 --path=dist/app-1.2.3.exe

# 列出所有版本
npm run release:manifest:list

# 验证清单格式
npm run release:manifest:validate

# 清理旧版本（保留最新5个）
npm run release:manifest:cleanup -- --keep=5
````

## CI/CD 集成

### GitHub Actions 工作流

本系统提供了完整的 GitHub Actions 工作流支持：

#### 1. **Release Preparation** (`release-prepare.yml`)

发布准备工作流，用于初始化版本和创建 feed 文件：

```bash
# 手动触发发布准备
# GitHub UI: Actions → Release Preparation → Run workflow
# 参数:
#   - version: 1.2.3 (语义化版本号)
#   - artifact_path: dist/app.exe (应用文件路径)
#   - create_feeds: true (创建所有平台 feed 文件)
```

#### 2. **Release Ramp** (`release-ramp.yml`)

核心渐进发布工作流，支持分阶段发布和自动回滚：

```bash
# 手动触发渐进发布
# GitHub UI: Actions → Release Ramp → Run workflow
# 参数:
#   - stage: ["5", "25", "50", "100"] (发布百分比)
#   - feed_file: dist/latest.yml (目标 feed 文件)
#   - skip_health_check: false (是否跳过健康检查)
```

**工作流程**：

1. 设置分阶段发布百分比
2. 等待指标收集（5-10分钟）
3. Sentry Release Health 检查
4. 健康检查失败时自动回滚
5. 提交并推送变更

#### 3. **Release Monitor** (`release-monitor.yml`)

持续监控工作流，每15分钟检查发布健康度：

```bash
# 自动执行（定时任务）: 每15分钟
# 手动触发: Actions → Release Monitor → Run workflow
# 参数:
#   - version: (监控版本，默认使用环境变量)
#   - force_check: false (强制检查，忽略时间限制)
```

**监控逻辑**：

- 仅在工作时间监控（UTC 6:00-22:00）
- 仅监控活跃的渐进发布（stagingPercentage 1-99%）
- 检测到问题时触发紧急回滚

#### 4. **Emergency Rollback** (`release-emergency-rollback.yml`)

紧急回滚工作流，用于手动或自动触发回滚：

```bash
# 手动触发: Actions → Emergency Rollback → Run workflow
# 自动触发: 由监控工作流触发
# 参数:
#   - reason: "Critical security issue" (回滚原因)
#   - target_version: 0.0.9 (回滚目标版本)
#   - feed_files: ["all", "dist/latest.yml"] (回滚文件范围)
```

### GitHub Actions 环境配置

#### 必需的环境变量 (Repository Variables)

```bash
# Sentry 配置
SENTRY_ORG=your-organization-name
SENTRY_PROJECT=vitegame
APP_VERSION=1.2.3                    # 当前发布版本
PREV_GA_VERSION=1.1.0               # 上一稳定版本（回滚目标）

# 健康度阈值
THRESHOLD_CF_USERS=0.995            # Crash-Free Users 阈值 (99.5%)
THRESHOLD_CF_SESSIONS=0.995         # Crash-Free Sessions 阈值 (99.5%)
```

#### 必需的环境密钥 (Repository Secrets)

```bash
# Sentry API 认证
SENTRY_AUTH_TOKEN=your_sentry_api_token

# 可选：通知 Webhook
WEBHOOK_URL=https://hooks.slack.com/services/xxx/yyy/zzz
```

#### GitHub Actions 使用示例

**完整渐进发布流程**：

```yaml
# 1. 发布准备
name: Complete Release Flow
on:
  release:
    types: [published]

jobs:
  prepare:
    uses: ./.github/workflows/release-prepare.yml
    with:
      version: ${{ github.event.release.tag_name }}
      artifact_path: 'dist/app-${{ github.event.release.tag_name }}.exe'

  stage_5:
    needs: prepare
    uses: ./.github/workflows/release-ramp.yml
    with:
      stage: '5'

  stage_25:
    needs: stage_5
    uses: ./.github/workflows/release-ramp.yml
    with:
      stage: '25'

  stage_50:
    needs: stage_25
    uses: ./.github/workflows/release-ramp.yml
    with:
      stage: '50'

  stage_100:
    needs: stage_50
    uses: ./.github/workflows/release-ramp.yml
    with:
      stage: '100'
```

## 日志和监控

### 回滚日志位置

- **日志目录**: `logs/rollback/`
- **文件格式**: `rollback-YYYY-MM-DD.json`
- **日志内容**: 回滚操作详情、时间戳、原因等

### 日志示例

```json
[
  {
    "action": "rollback",
    "feedFile": "dist/latest.yml",
    "previousVersion": null,
    "reason": "Automated rollback due to health check failure",
    "success": true,
    "steps": [
      {
        "step": "emergency_stop",
        "result": {
          "ok": true,
          "feedFile": "dist/latest.yml",
          "stagingPercentage": 0
        },
        "success": true
      }
    ],
    "timestamp": "2025-08-29T10:30:00.000Z"
  }
]
```

## 故障排除

### 常见问题

1. **Sentry API 403 错误**
   - 检查 `SENTRY_AUTH_TOKEN` 是否正确
   - 确认 token 有访问指定项目的权限

2. **健康数据不可用**
   - 版本发布后需要等待数据收集（通常5-10分钟）
   - 确认 Sentry Releases 已正确创建

3. **YAML 文件格式错误**
   - 使用 `js-yaml` 库确保 YAML 格式正确
   - 检查文件权限和路径

4. **回滚操作失败**
   - 检查日志目录权限
   - 确认 feed 文件路径正确

### 调试模式

```bash
# 启用详细日志
DEBUG=* npm run release:health-check

# 仅模拟运行不实际回滚
DRY_RUN=true npm run release:health-check
```

## 安全考虑

1. **API 密钥管理**: 使用环境变量或密钥管理系统，避免硬编码
2. **权限控制**: Sentry token 仅授予必要的读取权限
3. **通知安全**: Webhook URL 应使用 HTTPS
4. **日志安全**: 避免在日志中记录敏感信息

### 版本清单格式

版本清单文件 (`artifacts/manifest.json`) 格式：

```json
{
  "1.2.3": {
    "path": "app-1.2.3.exe",
    "sha512": "sha512-base64hash...",
    "size": 52428800,
    "releaseDate": "2025-08-29T10:00:00.000Z",
    "files": [
      {
        "url": "app-1.2.3.exe",
        "sha512": "sha512-base64hash...",
        "size": 52428800
      }
    ]
  }
}
```

### 版本清单工作流

```bash
# 构建新版本后，添加到清单
npm run build:electron
npm run release:manifest:add -- --version=$(node -p "require('./package.json').version") --path=dist/app.exe

# 验证清单完整性
npm run release:manifest:validate

# 定期清理旧版本
npm run release:manifest:cleanup -- --keep=10
```

## 扩展功能

### 自定义健康指标

可扩展 `auto-rollback.mjs` 支持更多指标：

- 用户反馈评分
- 性能指标 (响应时间、内存使用)
- 业务指标 (转换率、活跃度)

### 多平台支持

脚本支持多个 electron-updater feed 文件：

- `latest.yml` (Windows)
- `latest-mac.yml` (macOS)
- `latest-linux.yml` (Linux)

### 集成监控系统

- Grafana 仪表盘
- PagerDuty 告警
- Slack/Teams 通知

## 相关文档

- [ADR-0002: Electron Security Baseline](./ADR-0002-electron-security.md)
- [ADR-0003: Observability and Release Health](./ADR-0003-observability.md)
- [electron-updater Documentation](https://www.electron.build/auto-update)
- [Sentry Release Health](https://docs.sentry.io/product/releases/health/)

# Electronå®‰å…¨åŸºçº¿ä¿®å¤å»ºè®®

## 1. ç»Ÿä¸€CSPç­–ç•¥é…ç½®

### æ–°å»ºç»Ÿä¸€CSPé…ç½®æ¨¡å—

```typescript
// electron/security/csp-policy.ts
interface CSPDirectives {
  'default-src': string[];
  'script-src': string[];
  'style-src': string[];
  'img-src': string[];
  'connect-src': string[];
  'font-src': string[];
  'object-src': string[];
  'frame-ancestors': string[];
  'base-uri': string[];
  'form-action': string[];
}

export class CSPManager {
  private static basePolicy: CSPDirectives = {
    'default-src': ["'none'"],
    'script-src': ["'self'"],
    'style-src': ["'self'"],
    'img-src': ["'self'", 'data:', 'blob:'],
    'connect-src': ["'self'"],
    'font-src': ["'self'"],
    'object-src': ["'none'"],
    'frame-ancestors': ["'none'"],
    'base-uri': ["'none'"],
    'form-action': ["'self'"],
  };

  static generateCSP(environment: 'development' | 'production', nonce?: string): string {
    const policy = { ...this.basePolicy };
    
    if (environment === 'development') {
      // å¼€å‘ç¯å¢ƒæ·»åŠ å¿…éœ€çš„æº
      policy['script-src'] = ["'self'", "'unsafe-inline'", 'localhost:*', '127.0.0.1:*'];
      policy['connect-src'] = ["'self'", 'localhost:*', '127.0.0.1:*', 'ws:', 'wss:'];
    }
    
    if (nonce) {
      // æ·»åŠ nonceæ”¯æŒï¼Œç§»é™¤unsafe-inline
      policy['script-src'] = policy['script-src']
        .filter(src => src !== "'unsafe-inline'")
        .concat([`'nonce-${nonce}'`]);
    }
    
    // ç”Ÿäº§ç¯å¢ƒæ·»åŠ å¿…è¦çš„å¤–éƒ¨è¿æ¥ï¼ˆå¦‚Sentryï¼‰
    if (environment === 'production') {
      policy['connect-src'].push('https://sentry.io', 'https://*.sentry.io');
    }

    return Object.entries(policy)
      .map(([directive, sources]) => `${directive} ${sources.join(' ')}`)
      .join('; ');
  }

  static validateCSP(csp: string): boolean {
    // éªŒè¯å…³é”®å®‰å…¨æŒ‡ä»¤å­˜åœ¨
    const requiredDirectives = ['default-src', 'script-src', 'object-src'];
    return requiredDirectives.every(directive => csp.includes(directive));
  }
}
```

### ä¿®æ”¹main.tsä½¿ç”¨ç»Ÿä¸€CSP

```diff
// electron/main.ts
+ import { CSPManager } from './security/csp-policy';

  // CSPç­–ç•¥ï¼šå¼€å‘ç¯å¢ƒä½¿ç”¨webRequestæ³¨å…¥ï¼Œç”Ÿäº§ç¯å¢ƒä¾èµ–index.html metaæ ‡ç­¾
  if (is.dev) {
-   // å¼€å‘ç¯å¢ƒï¼šåŠ¨æ€æ³¨å…¥CSPä»¥æ”¯æŒçƒ­æ›´æ–°å’Œå¼€å‘å·¥å…·
    mainWindow.webContents.session.webRequest.onHeadersReceived(
      (details, callback) => {
-       // ä¸ºæ¯æ¬¡å¯¼èˆªç”Ÿæˆå”¯ä¸€nonce
        const crypto = require('crypto');
        const nonce = crypto.randomBytes(16).toString('base64');
+       const cspPolicy = CSPManager.generateCSP('development', nonce);

        callback({
          responseHeaders: {
            ...details.responseHeaders,
-           'Content-Security-Policy': [
-             "default-src 'none'; " +
-               `script-src 'self' 'nonce-${nonce}'; ` +
-               "style-src 'self'; " +
-               "img-src 'self' data: blob:; " +
-               "connect-src 'self'; " +
-               "font-src 'self'; " +
-               "object-src 'none'; " +
-               "frame-ancestors 'none'; " +
-               "base-uri 'none'; " +
-               "form-action 'self'",
-           ],
+           'Content-Security-Policy': [cspPolicy],
            'X-CSP-Nonce': [nonce],
          },
        });
      }
    );
  }
```

### æ›´æ–°index.htmlä½¿ç”¨ä¸€è‡´çš„CSP

```diff
<!-- index.html -->
    <meta
      http-equiv="Content-Security-Policy"
-     content="default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://sentry.io; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';"
+     content="default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' https://sentry.io https://*.sentry.io; object-src 'none'; base-uri 'none'; form-action 'self'; frame-ancestors 'none';"
    />
```

## 2. åŠ å¼ºæµ‹è¯•æ¨¡å¼å®‰å…¨æ€§

```diff
// electron/main.ts
  // åœ¨æµ‹è¯•æ¨¡å¼ä¸‹æš´éœ²å®‰å…¨é…ç½®ä¾›éªŒè¯
  if (process.env.SECURITY_TEST_MODE === 'true') {
+   // é™åˆ¶æš´éœ²çš„ä¿¡æ¯ï¼Œä»…åŒ…å«æµ‹è¯•å¿…éœ€çš„æ•°æ®
    (global as any).__SECURITY_PREFS__ = {
-     ...SECURITY_PREFERENCES,
-     windowId: mainWindow.id,
-     createdAt: new Date().toISOString(),
+     nodeIntegration: SECURITY_PREFERENCES.nodeIntegration,
+     contextIsolation: SECURITY_PREFERENCES.contextIsolation,
+     sandbox: SECURITY_PREFERENCES.sandbox,
+     webSecurity: SECURITY_PREFERENCES.webSecurity,
+     testMode: true,
+     windowId: `window-${Math.random().toString(36).substr(2, 9)}`, // åŒ¿ååŒ–ID
    };

-   // æš´éœ²å®‰å…¨ç­–ç•¥ç®¡ç†å™¨é…ç½®
-   (global as any).__SECURITY_POLICY_CONFIG__ = {
-     config: securityPolicyManager.getConfig(),
-     isProduction: process.env.NODE_ENV === 'production',
-     testMode: true,
-     exposedAt: new Date().toISOString(),
-   };
+   // ä»…æš´éœ²å¿…è¦çš„ç­–ç•¥éªŒè¯ä¿¡æ¯
+   (global as any).__SECURITY_POLICY_ENABLED__ = {
+     permissionHandler: true,
+     navigationHandler: true,
+     windowOpenHandler: true,
+     cspEnabled: true,
+   };

-   // æš´éœ²CSPé…ç½®ä¿¡æ¯
-   (global as any).__CSP_CONFIG__ = {
-     enabled: true,
-     policies: [
-       "default-src 'none'",
-       "script-src 'self' 'nonce-*'",
-       "style-src 'self'",
-       "img-src 'self' data: blob:",
-       "connect-src 'self'",
-       "font-src 'self'",
-       "object-src 'none'",
-       "frame-ancestors 'none'",
-       "base-uri 'none'",
-       "form-action 'self'",
-     ],
-     nonceGeneration: true,
-     configuredAt: new Date().toISOString(),
-   };
-
-   // æš´éœ²å®‰å…¨å¤„ç†å™¨çŠ¶æ€
-   (global as any).__SECURITY_HANDLERS__ = {
-     permissionHandler: {
-       enabled: true,
-       type: 'setPermissionRequestHandler',
-       scope: 'session.defaultSession',
-     },
-     navigationHandler: {
-       enabled: true,
-       events: ['will-navigate', 'will-attach-webview'],
-     },
-     windowOpenHandler: {
-       enabled: true,
-       type: 'setWindowOpenHandler',
-       policy: 'deny-new-windows-redirect-external',
-     },
-     webRequestFiltering: {
-       enabled: true,
-       type: 'onBeforeRequest',
-       scope: 'session.defaultSession.webRequest',
-     },
-     configuredAt: new Date().toISOString(),
-   };
  }
```

## 3. å¢å¼ºæƒé™ç®¡ç†å™¨å®‰å…¨æ€§

```diff
// electron/security/permissions.ts
class SecurityPolicyManager {
  /**
   * ç»Ÿä¸€æƒé™è¯·æ±‚å¤„ç†å™¨
   */
  private setupPermissionHandler(): void {
    session.defaultSession.setPermissionRequestHandler(
      (_webContents, permission, callback, details) => {
+       // è®°å½•æƒé™è¯·æ±‚ç”¨äºå®‰å…¨å®¡è®¡
+       console.log(`ğŸ” æƒé™è¯·æ±‚: ${permission} from ${details.requestingUrl}`);
+       
        const requestingOrigin = new URL(details.requestingUrl).origin;

        // æ£€æŸ¥æºæ˜¯å¦è¢«å…è®¸
        const isOriginAllowed = this.config.allowedOrigins.some(origin =>
          requestingOrigin.startsWith(origin)
        );

        // æ£€æŸ¥æƒé™æ˜¯å¦è¢«å…è®¸
        const isPermissionAllowed =
          this.config.allowedPermissions.includes(permission);

        const shouldAllow = isOriginAllowed && isPermissionAllowed;

+       // å¯¹äºæ•æ„Ÿæƒé™ï¼Œå³ä½¿é…ç½®å…è®¸ä¹Ÿè¦é¢å¤–æ£€æŸ¥
+       const sensitivePermissions = ['media', 'geolocation', 'notifications'];
+       if (sensitivePermissions.includes(permission)) {
+         // ç”Ÿäº§ç¯å¢ƒé»˜è®¤æ‹’ç»æ•æ„Ÿæƒé™
+         if (this.isProduction) {
+           console.warn(`âŒ ç”Ÿäº§ç¯å¢ƒæ‹’ç»æ•æ„Ÿæƒé™: ${permission}`);
+           callback(false);
+           return;
+         }
+       }

        if (shouldAllow) {
          console.log(
            `âœ… å…è®¸æƒé™è¯·æ±‚: ${permission} from ${requestingOrigin}`
          );
        } else {
          console.warn(
            `âŒ æ‹’ç»æƒé™è¯·æ±‚: ${permission} from ${requestingOrigin}`
          );
          console.warn(
            `   - æºå…è®¸: ${isOriginAllowed}, æƒé™å…è®¸: ${isPermissionAllowed}`
          );
        }

        callback(shouldAllow);
      }
    );
  }
}
```

## 4. é¢„åŠ è½½è„šæœ¬å®‰å…¨åŠ å›º

```diff
// electron/preload.ts
+ // éªŒè¯ä¸Šä¸‹æ–‡éš”ç¦»æ˜¯å¦æ­£ç¡®å¯ç”¨
+ if (!process.contextIsolated) {
+   throw new Error('Context isolation must be enabled for security');
+ }

if (process.contextIsolated) {
  try {
+   // éªŒè¯æ²™ç›’æ¨¡å¼çŠ¶æ€
+   const isSandboxed = process.sandboxed;
+   if (!isSandboxed) {
+     console.warn('âš ï¸ Sandbox is not enabled - security may be compromised');
+   }
+   
    // ç»Ÿä¸€ä½¿ç”¨ electronAPI å‘½åï¼Œä¸æµ‹è¯•ä¿æŒä¸€è‡´
    contextBridge.exposeInMainWorld('electronAPI', {
      // åŸºç¡€ç³»ç»Ÿä¿¡æ¯
      platform: process.platform,
      version: process.versions.electron,
+     isSandboxed: process.sandboxed,
+     contextIsolated: process.contextIsolated,

      // æ‰©å±•@electron-toolkitæä¾›çš„API
      ...electronAPI,
    });

+   // å®‰å…¨é…ç½®éªŒè¯APIï¼ˆä»…æµ‹è¯•æ¨¡å¼ï¼‰
+   if (process.env.SECURITY_TEST_MODE === 'true') {
+     contextBridge.exposeInMainWorld('__SECURITY_VALIDATION__', {
+       isSandboxed: process.sandboxed,
+       contextIsolated: process.contextIsolated,
+       nodeIntegrationDisabled: typeof require === 'undefined',
+       exposedAt: new Date().toISOString(),
+     });
+   }

    // åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯ - ç”¨äºSentry Release Health
    contextBridge.exposeInMainWorld(
      '__APP_VERSION__',
      process.env.APP_VERSION || '0.1.1'
    );

-   // ä¸ºäº†æµ‹è¯•éªŒè¯ï¼Œé¢å¤–æš´éœ²ä¸€ä¸ªè‡ªå®šä¹‰APIæ ‡è¯†
-   contextBridge.exposeInMainWorld('__CUSTOM_API__', {
-     preloadExposed: true,
-     exposedAt: new Date().toISOString(),
-   });
+   // ç®€åŒ–çš„æµ‹è¯•APIæ ‡è¯†ï¼ˆå‡å°‘ä¿¡æ¯æ³„éœ²ï¼‰
+   contextBridge.exposeInMainWorld('__CUSTOM_API__', {
+     preloadExposed: true,
+   });
  } catch (error) {
    console.error('Failed to expose API:', error);
+   // é¢„åŠ è½½å¤±è´¥æ—¶ä¸åº”å›é€€åˆ°ééš”ç¦»æ¨¡å¼
+   throw error;
  }
} else {
- // ééš”ç¦»æ¨¡å¼å·²å¼ƒç”¨ï¼Œä¸åº”ä½¿ç”¨
+ throw new Error('Context isolation is required and must be enabled');
}
```
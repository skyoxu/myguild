# ç»Ÿä¸€çš„npmå®‰è£…åŠ å›ºæ¨¡æ¿
# ç”¨äºä¿®å¤ç³»ç»Ÿæ€§çš„npm ciå¤±è´¥é—®é¢˜
# åº”ç”¨äºæ‰€æœ‰åŒ…å«npm ciçš„GitHub Actionså·¥ä½œæµ

# 1. npmç½‘ç»œé…ç½®åŠ å›º
- name: âš™ï¸ å‡†å¤‡npmç½‘ç»œé…ç½®
  run: |
    npm config set fetch-retries 5
    npm config set fetch-retry-factor 2
    npm config set fetch-timeout 300000
    npm config set registry https://registry.npmjs.org/
    echo "npmç‰ˆæœ¬: $(npm --version)"
    echo "nodeç‰ˆæœ¬: $(node --version)"

# 2. åŠ å›ºçš„ä¾èµ–å®‰è£…ï¼ˆç¦ç”¨ç”Ÿäº§è£å‰ª+é‡è¯•ï¼‰
- name: ğŸ”§ å®‰è£…ä¾èµ– (åŠ å›ºç‰ˆ)
  env:
    NODE_ENV: development
    NPM_CONFIG_PRODUCTION: 'false'
  run: |
    for i in 1 2 3; do 
      echo "ç¬¬ $i æ¬¡å®‰è£…ä¾èµ–å°è¯•..."
      npm ci --no-audit --no-fund && break || {
        echo "ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
        sleep 10
      }
    done
    echo "ä¾èµ–å®‰è£…å®Œæˆ"

# 3. å·¥å…·å¯ç”¨æ€§éªŒè¯æ¢é’ˆ
- name: ğŸ”§ éªŒè¯å¼€å‘å·¥å…·å¯ç”¨æ€§
  run: |
    echo "éªŒè¯å¼€å‘å·¥å…·å®‰è£…çŠ¶æ€..."
    node -v && npm -v
    echo "æ£€æŸ¥ESLintå¯ç”¨æ€§..."
    npx eslint -v || { 
      echo "âŒ ESLintæœªæ­£ç¡®å®‰è£…"
      echo "devDependenciesçŠ¶æ€:"
      npm ls eslint --depth=0 || true
      echo "package.jsonä¸­çš„eslintå®šä¹‰:"
      cat package.json | grep -A2 -B2 '"eslint"' || echo "æœªæ‰¾åˆ°eslinté…ç½®"
      exit 1
    }
    echo "æ£€æŸ¥TypeScriptç¼–è¯‘å™¨..."
    npx tsc -v || {
      echo "âŒ TypeScriptç¼–è¯‘å™¨æœªæ­£ç¡®å®‰è£…"
      npm ls typescript --depth=0 || true
      exit 1
    }
    echo "âœ… æ‰€æœ‰å¼€å‘å·¥å…·éªŒè¯é€šè¿‡"

# å¯é€‰ï¼šç¼“å­˜æ¸…ç†é™çº§æ­¥éª¤ï¼ˆä»…åœ¨åå¤å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
# - name: ğŸ§¹ æ¸…ç†npmç¼“å­˜ (é™çº§æ­¥éª¤)
#   if: failure()
#   run: |
#     echo "æ¸…ç†npmç¼“å­˜ä»¥è§£å†³æŒç»­å¤±è´¥..."
#     rm -rf ~/.npm/_cacache
#     npm cache clean --force

# ä½¿ç”¨è¯´æ˜ï¼š
# 1. å°†ä¸Šè¿°æ­¥éª¤å¤åˆ¶åˆ°éœ€è¦ä¿®å¤çš„å·¥ä½œæµä¸­ï¼Œæ›¿æ¢åŸæœ‰çš„npmå®‰è£…æ­¥éª¤
# 2. ç¡®ä¿åœ¨setup-nodeæ­¥éª¤ä¹‹åä½¿ç”¨
# 3. æ ¹æ®å…·ä½“å·¥ä½œæµéœ€æ±‚è°ƒæ•´å·¥å…·éªŒè¯éƒ¨åˆ†
# 4. å¯¹äºä¸éœ€è¦ESLintçš„å·¥ä½œæµï¼Œå¯ä»¥ç§»é™¤ç›¸å…³éªŒè¯

# ç›®æ ‡ä¿®å¤çš„å·¥ä½œæµæ–‡ä»¶ï¼š
# - build-and-test.yml âœ… (å·²ä¿®å¤)
# - ci.yml (å¤šä¸ªjobéœ€è¦ä¿®å¤)
# - config-management.yml
# - observability-gate.yml
# - pr-performance-check.yml
# - å…¶ä»–åŒ…å«npm ciçš„å·¥ä½œæµ

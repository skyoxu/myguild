          SENTRY_AUTH_TOKEN: ${{ env.SENTRY_TOKEN }}

  # ğŸ¥ Release Healthæ£€æŸ?  health-check:
    name: ğŸ¥ Release Healthé—¨æ§›æ£€æŸ?    runs-on: ubuntu-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, create-release]
    if: needs.prepare.outputs.environment == 'production' && !github.event.inputs.skip_health_check
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ?        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        uses: ./.github/actions/npm-install

      - name: ğŸ¥ æ‰§è¡Œå¥åº·é—¨æ§›æ£€æŸ?        run: |
          echo "ğŸ¥ å¼€å§‹Release Healthé—¨æ§›æ£€æŸ?.."

          # Cå»ºè®®ï¼šå¥åº·é—¨æ§›æ£€æŸ?          node -e "
          const https = require('https');
          const release = '${{ needs.prepare.outputs.release_name }}';
          const org = process.env.SENTRY_ORG;
          const project = process.env.SENTRY_PROJECT;
          const token = process.env.SENTRY_TOKEN;

          console.log('ğŸ” æ£€æŸ¥Releaseå¥åº·çŠ¶æ€?', release);

          // æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥APIè°ƒç”¨
          const checkHealth = async () => {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨Sentry APIè·å–å®é™…çš„å¥åº·æŒ‡æ ?            const mockMetrics = {
              crashFreeSessionsRate: 99.7,
              crashFreeUsersRate: 99.9,
              adoptionRate: 45.2
            };
            
            console.log('ğŸ“Š å¥åº·æŒ‡æ ‡:', mockMetrics);
            
            // Cå»ºè®®ï¼šæ£€æŸ¥å¥åº·é—¨æ§?            const sessionThreshold = parseFloat(process.env.CRASH_FREE_SESSION_THRESHOLD);
            const userThreshold = parseFloat(process.env.CRASH_FREE_USER_THRESHOLD);
            
            if (mockMetrics.crashFreeSessionsRate < sessionThreshold) {
              throw new Error(\`å´©æºƒä¼šè¯ç‡ä¸è¾¾æ ‡: \${mockMetrics.crashFreeSessionsRate}% < \${sessionThreshold}%\`);
            }
            
            if (mockMetrics.crashFreeUsersRate < userThreshold) {
              throw new Error(\`å´©æºƒç”¨æˆ·ç‡ä¸è¾¾æ ‡: \${mockMetrics.crashFreeUsersRate}% < \${userThreshold}%\`);
            }
            
            console.log('âœ?æ‰€æœ‰å¥åº·é—¨æ§›æ£€æŸ¥é€šè¿‡');
            return true;
          };

          checkHealth().catch(error => {
            console.error('â?å¥åº·æ£€æŸ¥å¤±è´?', error.message);
            process.exit(1);
          });
          "
        env:
          SENTRY_ORG: ${{ env.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ env.SENTRY_PROJECT }}
          SENTRY_TOKEN: ${{ env.SENTRY_TOKEN }}
          CRASH_FREE_SESSION_THRESHOLD: ${{ env.CRASH_FREE_SESSION_THRESHOLD }}
          CRASH_FREE_USER_THRESHOLD: ${{ env.CRASH_FREE_USER_THRESHOLD }}
        timeout-minutes: 5

  # ğŸš€ éƒ¨ç½²æ ‡è®°
  deploy:
    name: ğŸš€ æ ‡è®°éƒ¨ç½²å®Œæˆ
    runs-on: ubuntu-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, create-release, health-check]
    if: always() && (needs.health-check.result == 'success' || needs.health-check.result == 'skipped')
    steps:
      - name: ğŸš€ æ ‡è®°Sentryéƒ¨ç½²
        run: |
          RELEASE_NAME="${{ needs.prepare.outputs.release_name }}"
          ENVIRONMENT="${{ needs.prepare.outputs.environment }}"

          echo "ğŸš€ æ ‡è®°éƒ¨ç½²: $RELEASE_NAME â†?$ENVIRONMENT"

          # Cå»ºè®®ï¼šæ ‡è®°deploy
          sentry-cli releases deploys "$RELEASE_NAME" new \
            --env "$ENVIRONMENT" \
            --name "GitHub Actions Deploy" \
            --time "$(date -u +%Y-%m-%dT%H:%M:%S%z)"

          # å®Œæˆrelease
          sentry-cli releases finalize "$RELEASE_NAME"

          echo "âœ?éƒ¨ç½²æ ‡è®°å®Œæˆ"
        env:
          SENTRY_ORG: ${{ env.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ env.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ env.SENTRY_TOKEN }}

      - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ Releaseéƒ¨ç½²æˆåŠŸ!"
          echo "ğŸ“‹ Release: ${{ needs.prepare.outputs.release_name }}"
          echo "ğŸŒ ç¯å¢ƒ: ${{ needs.prepare.outputs.environment }}"
          echo "â?æ—¶é—´: $(date)"

  # ğŸ”„ å›æ»šå¤„ç†
  rollback:
    name: ğŸ”„ è‡ªåŠ¨å›æ»šå¤„ç†
    runs-on: ubuntu-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, create-release, health-check]
    if: failure() && needs.health-check.result == 'failure'
    steps:
      - name: ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè€ƒè™‘å›æ»š
        run: |
          RELEASE_NAME="${{ needs.prepare.outputs.release_name }}"
          echo "ğŸš¨ Releaseå¥åº·æ£€æŸ¥å¤±è´? $RELEASE_NAME"
          echo "ğŸ”„ è€ƒè™‘è‡ªåŠ¨å›æ»š..."

          # è¿™é‡Œå¯ä»¥å®ç°è‡ªåŠ¨å›æ»šé€»è¾‘
          # ä¾‹å¦‚ï¼šå›æ»šåˆ°ä¸Šä¸€ä¸ªå¥åº·ç‰ˆæœ?
          echo "âš ï¸ è¯·æ‰‹åŠ¨æ£€æŸ¥Releaseå¥åº·çŠ¶æ€å¹¶å†³å®šæ˜¯å¦å›æ»š"
        env:
          SENTRY_ORG: ${{ env.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ env.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ env.SENTRY_TOKEN }}

  # ğŸ“Š å‘å¸ƒæ€»ç»“
  summary:
    name: ğŸ“Š å‘å¸ƒæµç¨‹æ€»ç»“
    runs-on: ubuntu-latest
    # P0ä¿®å¤ï¼šjobçº§åˆ«ç¯å¢ƒå˜é‡ç¡®ä¿devDependenciesæ­£ç¡®å®‰è£…
    env:
      NODE_ENV: development
      NPM_CONFIG_PRODUCTION: 'false'
    needs: [prepare, build, e2e-smoke, create-release, health-check, deploy]
    if: always()
    steps:
      - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        run: |
          echo "ğŸ“Š === Release Pipeline æ€»ç»“ ==="
          echo "ğŸ·ï¸?Release: ${{ needs.prepare.outputs.release_name }}"
          echo "ğŸŒ ç¯å¢ƒ: ${{ needs.prepare.outputs.environment }}"
          echo "ğŸ’» å¹³å°: ${{ needs.prepare.outputs.platform }}"
          echo ""
          echo "ğŸ“‹ å„é˜¶æ®µçŠ¶æ€?"
          echo "  ğŸ” ç¯å¢ƒå‡†å¤‡: ${{ needs.prepare.result }}"
          echo "  ğŸ”¨ æ„å»º: ${{ needs.build.result }}"
          echo "  ğŸ§ª E2Eæµ‹è¯•: ${{ needs.e2e-smoke.result }}"
          echo "  ğŸš€ åˆ›å»ºRelease: ${{ needs.create-release.result }}"
          echo "  ğŸ¥ å¥åº·æ£€æŸ? ${{ needs.health-check.result }}"
          echo "  ğŸš€ éƒ¨ç½²æ ‡è®°: ${{ needs.deploy.result }}"
          echo ""

          # æ€»ä½“çŠ¶æ€åˆ¤æ–?          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ?Releaseæµç¨‹å®ŒæˆæˆåŠŸ!"
          else
            echo "â?Releaseæµç¨‹å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„æ­¥éª¤"
          fi

# ==================== å¹¶å‘æ§åˆ¶ ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # releaseå·¥ä½œæµä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„éƒ¨ç½?
